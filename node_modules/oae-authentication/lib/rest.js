/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 * 
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var passport = require('passport');

var OAE = require('oae-util/lib/oae');

var AuthenticationAPI = require('oae-authentication');

/**
 * Returns a function that can be called when passport runs out of authentication
 * strategies to try.
 * Passport's default behaviour is to throw an error which gets picked up by the global
 * error handler. We catch it here and return a 401, which is semantically more correct.
 *
 * @param  {Response} res The ExpressJS response object.
 */
var handlePassportError = function(req, res, next) {
    return function(err) {
        if (err && err.message.indexOf('no strategy registered under name') > -1) {
            return res.send(401, 'Authentication strategy disabled.');
        }

        // Not much we can do here.
        next(err);
    };
};


// All of the strategies run at some URL under /api/auth/*
// When a login fails, the user is redirected to / where he
// will than be shown a login page with all the installed strategies.

//////////////////
// DIRECT LOGIN //
//////////////////

OAE.globalAdminServer.post('/api/auth/login', passport.authenticate('local'), function(req, res) {
    req.telemetryUrl = '/api/auth/login';
    // This callback only gets called when we log in succesfully.
    return res.send(200, req.user);
});

OAE.globalAdminServer.post('/api/auth/logout', function(req, res) {
    req.telemetryUrl = '/api/auth/logout';
    req.logOut();
    res.send(200);
});

OAE.tenantServer.post('/api/auth/login', passport.authenticate('local'), function(req, res) {
    req.telemetryUrl = '/api/auth/login';
    // This callback only gets called when we log in succesfully.
    return res.send(200, req.user);
});

OAE.tenantServer.post('/api/auth/logout', function(req, res) {
    req.telemetryUrl = '/api/auth/logout';
    req.logOut();
    res.send(200);
});

/////////////////
// SIGNED AUTH //
/////////////////

OAE.globalAdminServer.get('/api/auth/signed', function(req, res) {
    req.telemetryUrl = '/api/auth/signed';
    AuthenticationAPI.getSignedToken(req.ctx, req.query.tenant, function(err, data) {
        if (err) {
            return res.send(err.code, err.msg);
        }
        res.send(data);
    });
});

OAE.tenantServer.post('/api/auth/signed', function(req, res, next) {
    req.telemetryUrl = '/api/auth/signed';
    passport.authenticate('signed', { 'successRedirect': '/',
                                      'failureRedirect': '/' })(req, res, handlePassportError(req, res, next));
});

//////////////
//  GOOGLE  //
//////////////

// Redirect the user to Google for authentication.  When complete, Google
// will redirect the user back to the application at
// /api/auth/google/return
OAE.tenantServer.get('/api/auth/google', function(req, res, next) {
    req.telemetryUrl = '/api/auth/google';
    var stratName = 'google-' + req.tenant.alias;
    passport.authenticate(stratName)(req, res, handlePassportError(req, res, next));
});

// Google will redirect the user to this URL after authentication.  Finish
// the process by verifying the assertion.  If valid, the user will be
// logged in.  Otherwise, authentication has failed.
OAE.tenantServer.get('/api/auth/google/callback', function(req, res, next) {
    req.telemetryUrl = '/api/auth/google/callback';
    var stratName = 'google-' + req.tenant.alias;
    passport.authenticate(stratName, { 'successRedirect': '/',
                                       'failureRedirect': '/' })(req, res, handlePassportError(req, res, next));
});


///////////////
//  TWITTER  //
///////////////

// Redirect the user to Twitter for authentication.  When complete, Twitter
// will redirect the user back to the application at
// /api/auth/twitter/callback
OAE.tenantServer.get('/api/auth/twitter', function(req, res, next) {
    req.telemetryUrl = '/api/auth/twitter';
    var stratName = 'twitter-' + req.tenant.alias;
    passport.authenticate(stratName)(req, res, handlePassportError(req, res, next));
});

// Twitter will redirect the user to this URL after approval.  Finish the
// authentication process by attempting to obtain an access token.  If
// access was granted, the user will be logged in.  Otherwise,
// authentication has failed.
OAE.tenantServer.get('/api/auth/twitter/callback', function(req, res, next) {
    req.telemetryUrl = '/api/auth/twitter/callback';
    var stratName = 'twitter-' + req.tenant.alias;
    passport.authenticate(stratName, { 'successRedirect': '/',
                                       'failureRedirect': '/' })(req, res, handlePassportError(req, res, next));
});


////////////////
//  FACEBOOK  //
////////////////

// Redirect the user to Facebook for authentication.  When complete,
// Facebook will redirect the user back to the application at
// /api/auth/facebook/callback
OAE.tenantServer.get('/api/auth/facebook', function(req, res, next) {
    req.telemetryUrl = '/api/auth/facebook';
    var stratName = 'facebook-' + req.tenant.alias;
    passport.authenticate(stratName)(req, res, handlePassportError(req, res, next));
});

// Facebook will redirect the user to this URL after approval.  Finish the
// authentication process by attempting to obtain an access token.  If
// access was granted, the user will be logged in.  Otherwise,
// authentication has failed.
OAE.tenantServer.get('/api/auth/facebook/callback', function(req, res, next) {
    req.telemetryUrl = '/api/auth/facebook/callback';
    var stratName = 'facebook-' + req.tenant.alias;
    passport.authenticate(stratName, { 'successRedirect': '/',
                                       'failureRedirect': '/' })(req, res, handlePassportError(req, res, next));
});

OAE.tenantServer.get('/api/auth/saml2', function(req, res, next) {
    req.telemetryUrl = '/api/auth/saml2';
    var stratName = 'wsfed-saml2-' + req.tenant.alias;
    passport.authenticate(stratName)(req, res, handlePassportError(req, res, next));
});

OAE.tenantServer.post('/api/auth/saml2/callback', function(req, res, next) {
    req.telemetryUrl = '/api/auth/saml2/callback';
    var stratName = 'wsfed-saml2-' + req.tenant.alias;
    passport.authenticate(stratName, { 'successRedirect': '/',
                                       'failureRedirect': '/' })(req, res, handlePassportError(req, res, next));
});

OAE.tenantServer.get('/api/auth/cas', function(req, res, next) {
    req.telemetryUrl = '/api/auth/cas';
    var stratName = 'cas-' + req.tenant.alias;
    passport.authenticate(stratName)(req, res, handlePassportError(req, res, next));
});

OAE.tenantServer.get('/api/auth/cas/callback', function(req, res, next) {
    req.telemetryUrl = '/api/auth/cas/callback';
    var stratName = 'cas-' + req.tenant.alias;
    passport.authenticate(stratName, { 'successRedirect': '/',
                                       'failureRedirect': '/' })(req, res, handlePassportError(req, res, next));
});

/////////////////////////
// PASSWORD MANAGEMENT //
/////////////////////////

OAE.globalAdminServer.post('/api/user/:id/password', function(req, res) {
    req.telemetryUrl = '/api/user/id/password';
    AuthenticationAPI.changePassword(req.ctx, req.params.id, req.body.oldPassword, req.body.newPassword, function(err, changed) {
        if (err) {
            return res.send(err.code, err.msg);
        }

        res.send(200);
    });
});

OAE.tenantServer.post('/api/user/:id/password', function(req, res) {
    req.telemetryUrl = '/api/user/id/password';
    AuthenticationAPI.changePassword(req.ctx, req.params.id, req.body.oldPassword, req.body.newPassword, function(err, changed) {
        if (err) {
            return res.send(err.code, err.msg);
        }

        res.send(200);
    });
});

/*!
 * Checks whether or not a user id exists
 */
OAE.tenantServer.get('/api/auth/exists/:username', function(req, res) {
    req.telemetryUrl = '/api/auth/exists/username';
    AuthenticationAPI.loginIdExists(req.ctx, req.params.username, function(err, exists) {
        if (err) {
            return res.send(err.code, err.msg);
        }

        // If the login id doesn't exist yet, we send back a 404
        if (exists) {
            res.send(200);
        } else {
            res.send(404);
        }
    });
});
