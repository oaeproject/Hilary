/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _  = require('underscore');

var AuthzSearch = require('oae-authz/lib/search');
var SearchAPI = require('oae-search');

var CollectionsAPI = require('oae-collections');
var CollectionsConstants = require('oae-collections/lib/constants').CollectionsConstants;

/*!
 * When a collection is created, fire a task to update the memberships search documents of the
 * members of the collection
 */
CollectionsAPI.on(CollectionsConstants.events.CREATED_COLLECTION, function(ctx, collection, members) {
    AuthzSearch.fireMembershipUpdateTasks(_.keys(members));
});

/*!
 * When the members of a collection are updated, fire a task to update the memberships search
 * documents of those whose roles have changed
 */
CollectionsAPI.on(CollectionsConstants.events.UPDATED_COLLECTION_MEMBERS, function(ctx, collection, roleChanges) {
    AuthzSearch.fireMembershipUpdateTasks(_.keys(roleChanges));
});

/*!
 * When content items are added to a collection, fire a task to update the members search document
 * of the content items that were added
 */
CollectionsAPI.on(CollectionsConstants.events.ADDED_CONTENT_ITEMS, function(ctx, collection, contentItems) {
    contentItems = _.map(contentItems, function(contentItem) {
        return _.pick(contentItem, 'id');
    });

    SearchAPI.postIndexTask('content', contentItems, {
        'children': {
            'resource_members': true
        }
    });
});
