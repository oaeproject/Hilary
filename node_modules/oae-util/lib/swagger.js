/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');

var log = require('oae-logger').logger('oae-swagger');
var OAE = require('./oae');
var OAEServer = require('./server');

var constants = module.exports.constants = {
    'apiVersion': '0.1',
    'swaggerVersion': '1.2',
    'basePath': '/api/'
};

/**
 * Get the swagger resources list
 *
 * @param  {Context}         ctx    The context of the request
 * @return {ResourceList}           See https://github.com/wordnik/swagger-core/wiki/Resource-Listing
 */
var getResources = module.exports.getResources = function(ctx) {
    var resources = _getSwaggerResources(ctx);
    var r = {
        'apiVersion': constants.apiVersion,
        'swaggerVersion': constants.swaggerVersion,
        'apis': []
    };
    _.each(resources, function(value, key) {
        var p = '/' + key;
        r.apis.push({
            'path': p,
            'description': 'none'
        });
    });
    return r;
};

/**
 * Get the swagger api declaration for a resource
 *
 * @param  {Context}       ctx  The context of the request
 * @param  {String}        id   The resource id
 * @return {ApiDeclaration}     See https://github.com/wordnik/swagger-core/wiki/API-Declaration
 */
var getApi = module.exports.getApi = function(ctx, id) {
    var resources = _getSwaggerResources(ctx);
    var allModels = _getSwaggerModels(ctx);
    var protocol = OAEServer.useHttps() ? 'https://' : 'http://';
    var url = protocol + ctx.tenant().host + '/api';
    var api = resources[id];
    api.resourcePath = id + '/';
    api.basePath = url;
    var requiredModels = [];
    _.each(api.apis, function(api) {
        _.each(api.operations, function(operation) {
            _addModelsFromBody(operation, requiredModels);
            _addModelsFromResponse(operation, requiredModels);
        });
    });

    // Add required models to api
    _.each(requiredModels, function (modelName) {
        var model = allModels[modelName];
        if (model) {
            api.models[modelName] = model;
        }
    });
    // Look in object graph
    _.each(api.models, function (model) {
        if (model && model.properties) {
            _.each(model.properties, function (property) {
                var type = property.type;

                switch (type) {
                    case 'array':
                    case 'Array':
                        if (property.items) {
                            var ref = property.items.$ref;
                            if (ref && requiredModels.indexOf(ref) < 0) {
                                requiredModels.push(ref);
                            }
                        }
                        break;
                    case 'string':
                    case 'long':
                        break;
                    default:
                        if (requiredModels.indexOf(type) < 0) {
                            requiredModels.push(type);
                        }
                        break;
                }
            });
        }
    });
    _.each(requiredModels, function (modelName) {
        if (!api.models[modelName]) {
            var model = allModels[modelName];
            if (model) {
                api.models[modelName] = model;
            }
        }
    });

    return api;
};

/**
 * Get all the swagger resources for the appropriate tenant
 *
 * @param  {Context}       ctx  The request context
 * @return {Object}             An object containing all the swagger resource info associated to the tenant
 * @api private
 */
var _getSwaggerResources = function(ctx) {
    var resources;
    if (ctx.tenant().isGlobalAdminServer) {
        resources = OAE.globalAdminServer.locals['swagger-resources'];
    } else {
        resources = OAE.tenantServer.locals['swagger-resources'];
    }
    return resources;
};

/**
 * Get all the swagger models for the appropriate tenant
 *
 * @param  {Context}       ctx  The request context
 * @return {Object}             An object containing all the swagger models associated to the tenant
 * @api private
 */
var _getSwaggerModels = function(ctx) {
    var resources;
    if (ctx.tenant().isGlobalAdminServer) {
        models = OAE.globalAdminServer.locals['swagger-models'];
    } else {
        models = OAE.tenantServer.locals['swagger-models'];
    }
    return models;
};

/**
 * Parse the body parameters and list all referenced models
 *
 * @param  {String}    operation   The operation object from the swagger api declaration to parse
 * @param  {String[]}  models      The list of referenced models, any newly referenced models will be appended
 * @api private
 */
var _addModelsFromBody = function(operation, models) {
    if (operation.parameters) {
        _.each(operation.parameters, function (param) {
            if (param.paramType == 'body' && param.dataType) {
                var model = param.dataType.replace(/^List\[/, '').replace(/\]/, '');
                models.push(model);
            }
        });
    }
};

/**
 * Parse the response type and list all referenced models
 *
 * @param  {String}    operation   The operation object from the swagger api declaration to parse
 * @param  {String[]}  models      The list of referenced models, any newly referenced models will be appended
 * @api private
 */
var _addModelsFromResponse = function(operation, models) {
    var responseModel = operation.responseClass;
    if (responseModel) {
        responseModel = responseModel.replace(/^List\[/, '').replace(/\]/, '');
        if (models.indexOf(responseModel) < 0) {
            models.push(responseModel);
        }
    }
};
