/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');

var ConfigTestUtil = require('oae-config/lib/test/util');
var EmailAPI = require('oae-email');
var EmailTestsUtil = require('oae-email/lib/test/util');
var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');

describe('Users', function() {

    // Rest contexts that can be used to make requests as different types of users
    var anonymousRestContext = null;
    var camAdminRestContext = null;
    var gtAdminRestContext = null;

    /**
     * Set up the rest contexts and drain the email queue. Note that
     * this needs to happen before each test
     */
    beforeEach(function(callback) {
        // Set up the rest contexts
        anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        gtAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);

        // Drain the email queue
        EmailTestsUtil.clearEmailCollections(callback);
    });

    describe('Email tokens', function() {

        describe('Events', function() {
            /**
             * Test that verifies that an email token is sent when creating a user account through the REST api
             */
            it('verify a verification email is sent when creating a user account through the REST api', function(callback) {
                // Disable recaptcha so we can create a user
                ConfigTestUtil.updateConfigAndWait(camAdminRestContext, null, {'oae-principals/recaptcha/enabled': false}, function(err) {
                    assert.ok(!err);

                    var username = TestsUtil.generateTestUserId();
                    var email = TestsUtil.generateTestEmailAddress(username);
                    RestAPI.User.createUser(anonymousRestContext, username, 'password', 'Test User', {'email': email}, function(err) {
                        assert.ok(!err);
                    });

                    EmailAPI.once('debugSent', function(message) {
                        // Assert we've sent an email to the correct user
                        assert.strictEqual(message.to.length, 1);
                        assert.strictEqual(message.to[0].address, email);

                        // Assert that the email contains both plain text and html
                        assert.ok(message.html);
                        assert.ok(message.text);

                        // Assert a URL is included that can be used to verify the email address
                        assert.ok(message.html.match(/\?token=[a-zA-Z0-9]{32}/));
                        assert.ok(message.text.match(/\?token=[a-zA-Z0-9]{32}/));

                        // Assert the email is not verified yet
                        var restContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, username, 'password');
                        RestAPI.User.getMe(restContext, function(err, me) {
                            assert.ok(!err);
                            assert.strictEqual(me.email, email);
                            assert.strictEqual(me.emailVerified, false);

                            // Enable re-captcha again
                            ConfigTestUtil.updateConfigAndWait(camAdminRestContext, null, {'oae-principals/recaptcha/enabled': true}, function(err) {
                                assert.ok(!err);
                                return callback();
                            });
                        });
                    });
                });
            });

            /**
             * Test that verifies that an email token is sent when a user updates his email address
             */
            it('verify a verification email is sent when a user updates his email address', function(callback) {
                TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);

                    var email = TestsUtil.generateTestEmailAddress();
                    RestAPI.User.updateUser(simong.restContext, simong.user.id, {'email': email}, function(err) {
                        assert.ok(!err);
                    });

                    EmailAPI.once('debugSent', function(message) {
                        // Assert we've sent an email to the correct user
                        assert.strictEqual(message.to.length, 1);
                        assert.strictEqual(message.to[0].address, email);

                        // Assert that the email contains both plain text and html
                        assert.ok(message.html);
                        assert.ok(message.text);

                        // Assert a URL is included that can be used to verify the email address
                        assert.ok(message.html.match(/\?token=[a-zA-Z0-9]{32}/));
                        assert.ok(message.text.match(/\?token=[a-zA-Z0-9]{32}/));

                        // Assert the email is not verified yet
                        RestAPI.User.getMe(simong.restContext, function(err, me) {
                            assert.ok(!err);
                            assert.strictEqual(me.email, email);
                            assert.strictEqual(me.emailVerified, false);

                            return callback();
                        });
                    });
                });
            });
        });

        describe('Verifying email tokens', function() {

            /**
             * Test that verifies that an email token can be used to verify an email address
             */
            it('verify an email token can be used to verify an email address', function(callback) {
                TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);

                    var email = TestsUtil.generateTestEmailAddress();
                    RestAPI.User.updateUser(simong.restContext, simong.user.id, {'email': email}, function(err) {
                        assert.ok(!err);
                    });

                    EmailAPI.once('debugSent', function(message) {
                        assert.ok(message.text);

                        // Get the token from the email
                        var token = message.text.match(/\?token=([a-zA-Z0-9]{32})/)[1];
                        assert.ok(token);

                        // Verify the token
                        RestAPI.User.verifyEmailToken(simong.restContext, token, function(err) {
                            assert.ok(!err);

                            // Assert that the email was verified
                            RestAPI.User.getMe(simong.restContext, function(err, me) {
                                assert.ok(!err);
                                assert.strictEqual(me.emailVerified, true);

                                return callback();
                            });
                        });
                    });
                });
            });

            /**
             * Test that verifies the email tokens are validated
             */
            it('verify validation', function(callback) {
                TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);

                    RestAPI.User.verifyEmailToken(simong.restContext, null, function(err) {
                        assert.strictEqual(err.code, 400);

                        RestAPI.User.verifyEmailToken(simong.restContext, 'non existing token', function(err) {
                            assert.strictEqual(err.code, 404);
                            return callback();
                        });
                    });
                });
            });
        });

        describe('Resending email tokens', function(callback) {

            /**
             * Test that verifies parameters are validated
             */
            it('verify validation', function(callback) {
                TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                    assert.ok(!err);
                    // Invalid user id
                    RestAPI.User.resendEmailToken(simong.restContext, 'not a user id', function(err, bla, body) {
                        assert.strictEqual(err.code, 400);

                        return callback();
                    });
                });
            });

            /**
             * Test that verifies that unauthorized users cannot resend email tokens
             */
            it('verify authorization', function(callback) {
                TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                    assert.ok(!err);

                    // Anonymous users cannot resend tokens
                    RestAPI.User.resendEmailToken(anonymousRestContext, simong.user.id, function(err) {
                        assert.strictEqual(err.code, 401);

                        // Users cannot resend tokens for other users
                        RestAPI.User.resendEmailToken(simong.restContext, nico.user.id, function(err) {
                            assert.strictEqual(err.code, 401);
                            return callback();
                        });
                    });
                });
            });

            /**
             * Test that verifies that an email token can be resent by a user
             */
            it('verify an email token can be resent by a user', function(callback) {
                TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);

                    RestAPI.User.resendEmailToken(simong.restContext, simong.user.id, function(err) {
                        assert.ok(!err);
                    });

                    EmailAPI.once('debugSent', function(message) {
                        assert.strictEqual(message.to[0].address, simong.user.email);
                        return callback();
                    });
                });
            });

            /**
             * Test that verifies that an email token can be resent by a tenant admin
             */
            it('verify an email token can be resent by a tenant admin', function(callback) {
                TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);

                    RestAPI.User.resendEmailToken(camAdminRestContext, simong.user.id, function(err) {
                        assert.ok(!err);
                    });

                    EmailAPI.once('debugSent', function(message) {
                        assert.strictEqual(message.to[0].address, simong.user.email);
                        return callback();
                    });
                });
            });

            /**
             * Test that verifies that an email token can be resent by a global admin
             */
            it('verify an email token can be resent by a global admin', function(callback) {
                TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);

                    var globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
                    RestAPI.User.resendEmailToken(globalAdminRestContext, simong.user.id, function(err) {
                        assert.ok(!err);
                    });

                    EmailAPI.once('debugSent', function(message) {
                        assert.strictEqual(message.to[0].address, simong.user.email);
                        return callback();
                    });
                });
            });
        });
    });
});
