/*
 * Copyright 2015 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var fs = require('fs');
var util = require('util');

var AuthenticationTestUtil = require('oae-authentication/lib/test/util');
var AuthzInvitationsDAO = require('oae-authz/lib/invitations/dao');
var ConfigTestUtil = require('oae-config/lib/test/util');
var EmailTestsUtil = require('oae-email/lib/test/util');
var RestAPI = require('oae-rest');
var TenantsTestUtil = require('oae-tenants/lib/test/util');
var TestsUtil = require('oae-tests');

var PrincipalsAPI = require('oae-principals');
var PrincipalsTestUtil = require('oae-principals/lib/test/util');


describe('User emails', function() {

    // REST contexts we can use to do REST requests
    var camAdminRestContext = null;
    var gtAdminRestContext = null;
    var anonymousRestContext = null;
    var globalAdminRestContext = null;

    beforeEach(function(callback) {
        anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        gtAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();

        // Disable reCaptcha so anonymous users can create accounts
        ConfigTestUtil.updateConfigAndWait(camAdminRestContext, null, {'oae-principals/recaptcha/enabled': false}, function(err) {
            assert.ok(!err);

            // Drain the email queue
            return EmailTestsUtil.clearEmailCollections(callback);
        });
    });

    after(function(callback) {
        // Re-enable reCaptcha
        ConfigTestUtil.updateConfigAndWait(camAdminRestContext, null, {'oae-principals/recaptcha/enabled': true}, function(err) {
            assert.ok(!err);
            return callback();
        });
    });

    describe('Verification', function() {

        /**
         * Test that verifies validation when verifying an email address
         */
        it('verify validation when verifying an email address', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
            var params = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': email
            };
            var restContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
            PrincipalsTestUtil.assertCreateUserSucceeds(restContext, params, function(user, token) {
                AuthenticationTestUtil.assertLocalLoginSucceeds(restContext, params.username, params.password, function() {
                    // Invalid user id
                    PrincipalsTestUtil.assertVerifyEmailFails(restContext, 'not a user id', token, 400, function() {
                        // Missing token
                        PrincipalsTestUtil.assertVerifyEmailFails(restContext, user.id, null, 400, function() {
                            // Invalid token
                            PrincipalsTestUtil.assertVerifyEmailFails(restContext, user.id, 'more than [7-14] characters', 400, function() {
                                // Incorrect token
                                PrincipalsTestUtil.assertVerifyEmailFails(restContext, user.id, '123456789', 401, function() {
                                    // Sanity-check
                                    PrincipalsTestUtil.assertVerifyEmailSucceeds(restContext, user.id, token, function() {
                                        // A token can only be verified once
                                        PrincipalsTestUtil.assertVerifyEmailFails(restContext, user.id, token, 404, function() {
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization when verifying an email address
         */
        it('verify authorization when verifying an email address', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
            var params = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': email
            };
            var restContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
            PrincipalsTestUtil.assertCreateUserSucceeds(restContext, params, function(user, token) {

                // Anonymous users cannot verify an email address
                PrincipalsTestUtil.assertVerifyEmailFails(anonymousRestContext, user.id, token, 401, function() {

                    // Other users cannot verify an email address
                    TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, badGuy) {
                        assert.ok(!err);
                        PrincipalsTestUtil.assertVerifyEmailFails(badGuy.restContext, user.id, token, 401, function() {

                            // Tenant admins from other tenants cannot verify an email address
                            PrincipalsTestUtil.assertVerifyEmailFails(gtAdminRestContext, user.id, token, 401, function() {

                                // The user can verify their email address if they've signed in
                                AuthenticationTestUtil.assertLocalLoginSucceeds(restContext, params.username, params.password, function() {
                                    PrincipalsTestUtil.assertVerifyEmailSucceeds(restContext, user.id, token, function() {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a token from another user cannot be used
         */
        it('verify a token from another user cannot be used', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var paramsUser1 = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0])
            };
            var restContextUser1 = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
            PrincipalsTestUtil.assertCreateUserSucceeds(restContextUser1, paramsUser1, function(user1, tokenUser1) {
                AuthenticationTestUtil.assertLocalLoginSucceeds(restContextUser1, paramsUser1.username, 'password', function() {
                    var paramsUser2 = {
                        'username': TestsUtil.generateTestUserId(),
                        'password': 'password',
                        'displayName': TestsUtil.generateRandomText(1),
                        'email': TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0])
                    };
                    var restContextUser2 = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
                    PrincipalsTestUtil.assertCreateUserSucceeds(restContextUser2, paramsUser2, function(user2, tokenUser2) {
                        AuthenticationTestUtil.assertLocalLoginSucceeds(restContextUser2, paramsUser2.username, 'password', function() {

                            // Assert we cannot user the token from the first user
                            PrincipalsTestUtil.assertVerifyEmailFails(restContextUser2, user2.id, tokenUser1, 401, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that an email address can be re-used by other users
         */
        it('verify an email address can be re-used by other users', function(callback) {
            var tenantAlias = TenantsTestUtil.generateTestTenantAlias();
            var tenantHost = TenantsTestUtil.generateTestTenantHost();
            TestsUtil.createTenantWithAdmin(tenantAlias, tenantHost, function(err, tenant, tenantAdminRestContext, tenantAdmin) {
                assert.ok(!err);

                // Disable reCaptcha for this tenant
                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, tenantAlias, {'oae-principals/recaptcha/enabled': false}, function(err) {
                    assert.ok(!err);

                    var username1 = TestsUtil.generateTestUserId();
                    var username2 = TestsUtil.generateTestUserId();
                    var email = TestsUtil.generateTestEmailAddress(null, tenantHost);
                    var paramsUser1 = {
                        'displayName': 'Test user 1',
                        'email': email,
                        'password': 'password',
                        'username': TestsUtil.generateTestUserId()
                    };
                    var paramsUser2 = {
                        'displayName': 'Test user 2',
                        'email': email,
                        'password': 'password',
                        'username': TestsUtil.generateTestUserId()
                    };

                    // Create the first user as a tenant admin so the email address is considered verified
                    PrincipalsTestUtil.assertCreateUserSucceeds(tenantAdminRestContext, paramsUser1, function(user1) {

                        // Verify there's a mapping for the first user
                        PrincipalsTestUtil.assertUserEmailMappingEquals(email, [user1.id], function() {

                            // Create the second user as an anonymous user so the email address is not verified
                            var restContext = TestsUtil.createTenantRestContext(tenantHost);
                            PrincipalsTestUtil.assertCreateUserSucceeds(restContext, paramsUser2, function(user2, token) {

                                // Verify there's no mapping yet for the second user as the email address
                                // hasn't been verified yet
                                PrincipalsTestUtil.assertUserEmailMappingEquals(email, [user1.id], function() {

                                    // Verify the email address
                                    AuthenticationTestUtil.assertLocalLoginSucceeds(restContext, paramsUser2.username, paramsUser2.password, function() {
                                        PrincipalsTestUtil.assertVerifyEmailSucceeds(restContext, user2.id, token, function() {

                                            // The second user should now also be mapped to the email address
                                            PrincipalsTestUtil.assertUserEmailMappingEquals(email, [user1.id, user2.id], function() {
                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that local accounts need to verify their email address
         */
        it('verify local user accounts need to verify their email address', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
            var params = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': email
            };
            PrincipalsTestUtil.assertCreateUserSucceeds(anonymousRestContext, params, function(user, token) {

                // Sanity check the user has no `email` property yet
                RestAPI.User.getUser(camAdminRestContext, user.id, function(err, user) {
                    assert.ok(!err);
                    assert.ok(!user.email);

                    // Assert that there's no mapping yet for the email address
                    PrincipalsTestUtil.assertUserEmailMappingEquals(email, [], function() {

                        // Verify the email address
                        var restContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
                        AuthenticationTestUtil.assertLocalLoginSucceeds(restContext, params.username, params.password, function() {
                            PrincipalsTestUtil.assertVerifyEmailSucceeds(restContext, user.id, token, function() {

                                // Assert the mapping has been created
                                PrincipalsTestUtil.assertUserEmailMappingEquals(email, [user.id], function() {
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that activity emails are not sent to unverified email addresses
         */
        it('verify activity emails are not sent to unverified email addresses', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
            var params = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': email
            };
            PrincipalsTestUtil.assertCreateUserSucceeds(anonymousRestContext, params, function(user, token) {

                // Generate some more users who will be part of the activity
                TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, mrvisser) {
                    assert.ok(!err);

                    RestAPI.Content.createLink(simong.restContext, 'Google', 'Google', 'public', 'http://www.google.ca', [], [user.id, mrvisser.user.id], [], function(err, link) {
                        assert.ok(!err);

                        // Mrvisser should've received an email, but not the user with the unverified email address
                        EmailTestsUtil.collectAndFetchAllEmails(function(messages) {
                            assert.equal(messages.length, 1);
                            assert.strictEqual(messages[0].to.length, 1);
                            assert.equal(messages[0].to[0].address, mrvisser.user.email);
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that local users accounts created by a tenant administrator do not need to verify their email address
         */
        it('verify local user accounts created by a tenant administrator do not need to verify their email address', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
            var params = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': email
            };
            PrincipalsTestUtil.assertCreateUserSucceeds(camAdminRestContext, params, function(user) {

                // Verify the user doesn't need to verify their email address
                RestAPI.User.getUser(camAdminRestContext, user.id, function(err, user) {
                    assert.ok(!err);
                    assert.strictEqual(user.email, email.toLowerCase());

                    // Assert that there's a mapping for the email address
                    PrincipalsTestUtil.assertUserEmailMappingEquals(email, [user.id], function() {
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies when a user follows an invitation into creating
         * an external account, where the external provider does not provide an
         * email address (e.g., Facebook), that they receive the email associated
         * with the invitation as a pre-verified email
         */
        it('verify user accounts created following invitation with external login do not require email verification', function(callback) {
            // Create a tenant and enable Facebook authentication on it
            var tenantAlias = TenantsTestUtil.generateTestTenantAlias();
            var tenantHost = TenantsTestUtil.generateTestTenantHost();
            TestsUtil.createTenantWithAdmin(tenantAlias, tenantHost, function(err, tenant, tenantAdminRestContext) {
                assert.ok(!err);
                AuthenticationTestUtil.assertUpdateAuthConfigSucceeds(tenantAdminRestContext, null, {'oae-authentication/facebook/enabled': true}, function() {

                    // Remove the tenant's email domain so we can sign in through Facebook
                    TenantsTestUtil.updateTenantAndWait(globalAdminRestContext, tenant.alias, {'emailDomains': ''}, function() {

                        // First make sure authenticating without email and no
                        // invitation results in a user without an email
                        AuthenticationTestUtil.assertFacebookLoginSucceeds(tenant.host, null, function(restContext, me) {
                            assert.ok(!me.email);

                            // Create an invitation
                            var email = TestsUtil.generateTestEmailAddress(null, tenant.emailDomains[0]);
                            PrincipalsTestUtil.assertCreateGroupSucceeds(tenantAdminRestContext, 'My Group', 'My description', 'public', 'yes', [email], null, function(group) {
                                email = email.toLowerCase();

                                // Get the invitation info so we can make a redirect url
                                AuthzInvitationsDAO.getTokensByEmails([email], function(err, tokensByEmail) {
                                    assert.ok(!err);
                                    var token = tokensByEmail[email];

                                    // Authenticate without an email while following the redirect url
                                    var redirectUrl = util.format('/signup?invitationToken=%s&invitationEmail=%s', encodeURIComponent(token), encodeURIComponent(email));
                                    AuthenticationTestUtil.assertFacebookLoginSucceeds(tenant.host, {'redirectUrl': redirectUrl}, function(restContext, me) {
                                        assert.strictEqual(me.email, email);
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that user accounts created through trusted external SSO sources do not need to verify their email address
         */
        it('verify user accounts created through trusted external SSO sources do not need to verify their email address', function(callback) {
            // Create a tenant and enable google authentication on it
            var tenantAlias = TenantsTestUtil.generateTestTenantAlias();
            var tenantHost = TenantsTestUtil.generateTestTenantHost();
            TestsUtil.createTenantWithAdmin(tenantAlias, tenantHost, function(err, tenant, tenantAdminRestContext) {
                assert.ok(!err);
                AuthenticationTestUtil.assertUpdateAuthConfigSucceeds(tenantAdminRestContext, null, {'oae-authentication/google/enabled': true}, function() {

                    // Sign in through google
                    var email = TestsUtil.generateTestEmailAddress(null, tenant.emailDomains[0]);
                    AuthenticationTestUtil.assertGoogleLoginSucceeds(tenant.host, email, function(restContext, response) {

                        // As google is considered an authoritative source, the user shouldn't have
                        // to verify their email address
                        RestAPI.User.getMe(restContext, function(err, me) {
                            assert.ok(!err);
                            assert.ok(!me.anon);
                            assert.strictEqual(me.email, email.toLowerCase());

                            // Assert that there's a mapping for the email address
                            PrincipalsTestUtil.assertUserEmailMappingEquals(email, [me.id], function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that user accounts created with a valid invitation token whose email
         * matches the specified email do not need to verify their email address
         */
        it('verify user accounts created with a valid invitation token are automatically verified', function(callback) {
            // Create a tenant in which to create a user, and ensure there are no pending emails
            var tenantAlias = TenantsTestUtil.generateTestTenantAlias();
            var tenantHost = TenantsTestUtil.generateTestTenantHost();
            TestsUtil.createTenantWithAdmin(tenantAlias, tenantHost, function(err, tenant, tenantAdminRestContext) {
                assert.ok(!err);

                // Create 2 email addresses that have tokens associated to them
                var email1 = TestsUtil.generateTestEmailAddress(null, tenant.emailDomains[0]);
                var email2 = TestsUtil.generateTestEmailAddress(null, tenant.emailDomains[0]);
                AuthzInvitationsDAO.getOrCreateTokensByEmails([email1, email2], function(err, emailTokens) {
                    assert.ok(!err);

                    // Try to create a profile with email1, using email2's token. It should
                    // work, but it shouldn't auto-verify the email address
                    var profile = {
                        'username': TestsUtil.generateTestUserId(),
                        'password': 'password',
                        'displayName': TestsUtil.generateRandomText(),
                        'email': email1,
                        'invitationToken': emailTokens[email2]
                    };

                    // Ensure we get a user with an unverified email, as well as one email which
                    // is a verification email for email1
                    EmailTestsUtil.startCollectingEmail(function(stopCollectingEmail) {
                        PrincipalsTestUtil.assertCreateUserSucceeds(TestsUtil.createTenantRestContext(tenantHost), profile, function(user) {
                            assert.ok(!user.email);

                            stopCollectingEmail(function(messages) {
                                assert.strictEqual(_.size(messages), 1);

                                // Now create a profile with the matching email1 token and ensure
                                // email is automatically verified
                                _.extend(profile, {
                                    'username': TestsUtil.generateTestUserId(),
                                    'invitationToken': emailTokens[email1]
                                });

                                EmailTestsUtil.startCollectingEmail(function(stopCollectingEmail) {
                                    // We should get a profile with a verified email and no verification
                                    // email
                                    PrincipalsTestUtil.assertCreateUserSucceeds(TestsUtil.createTenantRestContext(tenantHost), profile, function(user) {
                                        assert.strictEqual(user.email, email1.toLowerCase());
                                        stopCollectingEmail(function(messages) {
                                            assert.ok(_.isEmpty(messages));
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Return a function that gets a stream to a file in the 'data' directory of the current test directory
         *
         * @param  {String}     filename    The name of the file in the test data directory to be loaded
         * @return {Function}               A function that, when executed without parameters, returns a stream to the file in the test data directory with the provided filename
         */
        var getDataFileStream = function(filename) {
            return function() {
                return fs.createReadStream(util.format('%s/data/%s', __dirname, filename));
            };
        };

        /**
         * Test that verifies that user accounts created or updated through a CSV import do not need to verify their email address
         */
        it('verify user accounts created or updated through a CSV import do not need to verify their email address', function(callback) {
            var tenantAlias = TenantsTestUtil.generateTestTenantAlias();
            var tenantHost = 'users.emails.com';
            TestsUtil.createTenantWithAdmin(tenantAlias, tenantHost, function(err, tenant, tenantAdminRestContext) {
                assert.ok(!err);

                // Import users as a global admin using a local authentication strategy
                PrincipalsTestUtil.importUsers(globalAdminRestContext, tenant.alias, getDataFileStream('users-emails.csv'), 'local', null, function(err) {
                    assert.ok(!err);

                    // Verify the user's email address is verified
                    var restContext = TestsUtil.createTenantRestContext(tenant.host, 'users-emails-abc123', 'password');
                    RestAPI.User.getMe(restContext, function(err, user) {
                        assert.ok(!err);
                        assert.strictEqual(user.email, 'foo@users.emails.com');

                        // Assert there's a mapping for the email address
                        PrincipalsTestUtil.assertUserEmailMappingEquals('foo@users.emails.com', [user.id], function() {

                            // Update the email address through a CSV import
                            PrincipalsTestUtil.importUsers(globalAdminRestContext, tenant.alias, getDataFileStream('users-emails-updated.csv'), 'local', true, function(err) {
                                assert.ok(!err);

                                RestAPI.User.getMe(restContext, function(err, user) {
                                    assert.ok(!err);
                                    assert.strictEqual(user.email, 'bar@users.emails.com');

                                    // Assert there's a mapping for the new email address
                                    PrincipalsTestUtil.assertUserEmailMappingEquals('bar@users.emails.com', [user.id], function() {

                                        // Assert there's no mapping for the old email address
                                        PrincipalsTestUtil.assertUserEmailMappingEquals('foo@users.emails.com', [], function() {
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that users updating their email address need to verify it
         */
        it('verify users updating their email address need to verify it', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);
                var oldEmailAddress = simong.user.email;

                // Sanity-check the email address is verified
                RestAPI.User.getMe(simong.restContext, function(err, me) {
                    assert.ok(!err);
                    assert.strictEqual(me.email, oldEmailAddress);

                    // Sanity-check there's a mapping for it
                    PrincipalsTestUtil.assertUserEmailMappingEquals(me.email, [me.id], function() {

                        // Update the email address
                        var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                        PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email}, function(user, token) {

                            // Assert the old mapping is still in place
                            PrincipalsTestUtil.assertUserEmailMappingEquals(oldEmailAddress, [me.id], function() {

                                // Assert there's no mapping for the new email address as it hasn't been verified yet
                                PrincipalsTestUtil.assertUserEmailMappingEquals(email, [], function() {

                                    // The old email address should still be in place as the new one hasn't been verified yet
                                    RestAPI.User.getMe(simong.restContext, function(err, me) {
                                        assert.ok(!err);
                                        assert.strictEqual(me.email, oldEmailAddress);

                                        // Assert we can verify the email address
                                        PrincipalsTestUtil.assertVerifyEmailSucceeds(simong.restContext, simong.user.id, token, function() {

                                            // Assert the old mapping is gone
                                            PrincipalsTestUtil.assertUserEmailMappingEquals(oldEmailAddress, [], function() {

                                                // Assert the new mapping is there
                                                PrincipalsTestUtil.assertUserEmailMappingEquals(email, [me.id], function() {

                                                    // The new email address should be confirmed
                                                    RestAPI.User.getMe(simong.restContext, function(err, me) {
                                                        assert.ok(!err);
                                                        assert.strictEqual(me.email, email.toLowerCase());
                                                        return callback();
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that admin updates to a user's email address trigger a different email message
         */
        it('verify admin updates to a user\'s email address trigger a different email message', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);
                var oldEmailAddress = simong.user.email;

                // Let an administrator update the email address
                var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                PrincipalsTestUtil.assertUpdateUserSucceeds(camAdminRestContext, simong.user.id, {'email': email}, function(user, token) {

                    // The email address still has to be verified
                    assert.strictEqual(user.email, oldEmailAddress);
                    return callback();
                });
            });
        });

        /**
         * Test that verifies that users can only verify their last updated email address
         */
        it('verify users can only verify their last updated email address', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);
                var oldEmailAddress = simong.user.email;

                // Update the email address for the first time
                var email1 = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email1}, function(user, token1) {

                    // Update the email address again (with a second email address)
                    var email2 = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                    PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email2}, function(user, token2) {

                        // Using the first token to verify the email address should fail
                        PrincipalsTestUtil.assertVerifyEmailFails(simong.restContext, simong.user.id, token1, 401, function() {

                            // Using the second token we can verify the email address
                            PrincipalsTestUtil.assertVerifyEmailSucceeds(simong.restContext, simong.user.id, token2, function() {

                                // Assert the old mapping is gone
                                PrincipalsTestUtil.assertUserEmailMappingEquals(oldEmailAddress, [], function() {

                                    // Assert no mapping was created for the first email address
                                    PrincipalsTestUtil.assertUserEmailMappingEquals(email1, [], function() {

                                        // Assert a mapping for the second email address is created
                                        PrincipalsTestUtil.assertUserEmailMappingEquals(email2, [simong.user.id], function() {

                                            // The second email address should be confirmed
                                            RestAPI.User.getMe(simong.restContext, function(err, me) {
                                                assert.ok(!err);
                                                assert.strictEqual(me.email, email2.toLowerCase());
                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Resending an email verification token', function() {

        /**
         * Test that verifies that an email verification token can be resent
         */
        it('verify an email verification token can be resent', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
            var params = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': email
            };
            var restContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
            PrincipalsTestUtil.assertCreateUserSucceeds(restContext, params, function(user, token) {
                RestAPI.Authentication.login(restContext, params.username, 'password', function(err) {
                    assert.ok(!err);

                    // Verify we can resend the email verification token
                    PrincipalsTestUtil.assertResendEmailTokenSucceeds(restContext, user.id, function(newToken) {
                        // Assert we've sent the same token
                        assert.strictEqual(newToken, token);

                        // Sanity-check we can use this new token to verify the email address
                        PrincipalsTestUtil.assertVerifyEmailSucceeds(restContext, user.id, newToken, function() {
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation when resending an email verification token
         */
        it('verify validation when resending an email verification token', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
            var params = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': email
            };
            var restContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
            PrincipalsTestUtil.assertCreateUserSucceeds(restContext, params, function(user, token) {
                RestAPI.Authentication.login(restContext, params.username, 'password', function(err) {
                    assert.ok(!err);

                    // Invalid user id
                    PrincipalsTestUtil.assertResendEmailTokenFails(restContext, 'not a user id', 400, function() {
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies authorization when resending an email verification token
         */
        it('verify authorization when resending an email verification token', function(callback) {
            // We can't use TestsUtil.generateTestUsers as that would do the verification process for us
            var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
            var params = {
                'username': TestsUtil.generateTestUserId(),
                'password': 'password',
                'displayName': TestsUtil.generateRandomText(1),
                'email': email
            };
            var restContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
            PrincipalsTestUtil.assertCreateUserSucceeds(restContext, params, function(user, token) {
                RestAPI.Authentication.login(restContext, params.username, 'password', function(err) {
                    assert.ok(!err);

                    // Anonymous users can't resend a token
                    PrincipalsTestUtil.assertResendEmailTokenFails(anonymousRestContext, user.id, 401, function() {

                        // Users cannot resend a token for someone else
                        TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, otherUser) {
                            assert.ok(!err);
                            PrincipalsTestUtil.assertResendEmailTokenFails(otherUser.restContext, user.id, 401, function() {

                                // Tenant administrators from another tenant cannot resend a token
                                PrincipalsTestUtil.assertResendEmailTokenFails(gtAdminRestContext, user.id, 401, function() {

                                    // Tenant administrators from the same tenant as the user can resend a token
                                    PrincipalsTestUtil.assertResendEmailTokenSucceeds(camAdminRestContext, user.id, function(newToken) {

                                        // Global administrators can resend a token
                                        PrincipalsTestUtil.assertResendEmailTokenSucceeds(globalAdminRestContext, user.id, function(newToken) {
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a token can only be resent when there is a pending verification
         */
        it('verify that a token can only be resent when there is a pending verification', function(callback) {
            // Create a user who has no pending email verification token
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Resending a token should fail as there is no token to resend
                PrincipalsTestUtil.assertResendEmailTokenFails(simong.restContext, simong.user.id, 404, function() {

                    // Update the email address so we get a token
                    var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                    PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email}, function(user, token) {

                        // Resending a token now should be OK
                        PrincipalsTestUtil.assertResendEmailTokenSucceeds(simong.restContext, simong.user.id, function(newToken) {

                            // Use the token to verify the new email address
                            PrincipalsTestUtil.assertVerifyEmailSucceeds(simong.restContext, simong.user.id, newToken, function() {

                                // Resending a token should now fail as the token has been used and should be removed
                                PrincipalsTestUtil.assertResendEmailTokenFails(simong.restContext, simong.user.id, 404, function() {
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Has pending email verification token', function() {

        /**
         * Test that verifies the has pending email verification token functionality
         */
        it('verify has pending email verification token functionality', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Verify no email is returned when the user has no pending verification
                PrincipalsTestUtil.assertGetEmailTokenSucceeds(simong.restContext, simong.user.id, function(email) {
                    assert.ok(!email);

                    // Update the user's email address
                    email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                    PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email}, function() {

                        // Verify the user as a token
                        PrincipalsTestUtil.assertGetEmailTokenSucceeds(simong.restContext, simong.user.id, function(emailForToken) {
                            assert.strictEqual(emailForToken, email.toLowerCase());

                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation when checking for a pending email verification token
         */
        it('verify validation when checking for a pending email verification token', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Invalid user id
                PrincipalsTestUtil.assertGetEmailTokenFails(simong.restContext, 'not a user id', 400, function() {
                    PrincipalsTestUtil.assertGetEmailTokenFails(simong.restContext, 'g:camtest:1234234', 400, function() {
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies authorization when checking for a pending email verification token
         */
        it('verify authorization when checking for a pending email verification token', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, mrvisser) {
                assert.ok(!err);

                // Update simon's email address so he has a verification token
                var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email}, function() {

                    // Anonymous users cannot check anything
                    PrincipalsTestUtil.assertGetEmailTokenFails(anonymousRestContext, simong.user.id, 401, function() {

                        // Users cannot check other users their email tokens
                        PrincipalsTestUtil.assertGetEmailTokenFails(mrvisser.restContext, simong.user.id, 401, function() {

                            // Tenant administrator cannot check users from another tenant their email token
                            PrincipalsTestUtil.assertGetEmailTokenFails(gtAdminRestContext, simong.user.id, 401, function() {

                                // A user can check his own pending email verification token
                                PrincipalsTestUtil.assertGetEmailTokenSucceeds(simong.restContext, simong.user.id, function(emailForToken) {

                                    // A tenant admin can check the pending email verification token for users of their tenant
                                    PrincipalsTestUtil.assertGetEmailTokenSucceeds(camAdminRestContext, simong.user.id, function(emailForToken) {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Delete an email verification token', function() {

        /**
         * Test that verifies the delete email verification functionality
         */
        it('verify delete email verification token functionality', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Update the email address
                var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email}, function() {

                    // Delete the token
                    PrincipalsTestUtil.assertDeleteEmailTokenSucceeds(simong.restContext, simong.user.id, function() {

                        // Verify a token can't be deleted twice
                        PrincipalsTestUtil.assertDeleteEmailTokenFails(simong.restContext, simong.user.id, 404, function() {
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation when deleting a pending email verification token
         */
        it('verify validation when deleting a pending email verification token', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Invalid user id
                PrincipalsTestUtil.assertDeleteEmailTokenFails(simong.restContext, 'not a user id', 400, function() {
                    PrincipalsTestUtil.assertDeleteEmailTokenFails(simong.restContext, 'g:camtest:1234234', 400, function() {

                        // No token should return a 404
                        PrincipalsTestUtil.assertDeleteEmailTokenFails(simong.restContext, simong.user.id, 404, function() {
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization when deleting a pending email verification token
         */
        it('verify authorization when deleting a pending email verification token', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, mrvisser) {
                assert.ok(!err);

                // Update simon's email address so he has a verification token
                var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email}, function() {

                    // Anonymous users cannot delete anything
                    PrincipalsTestUtil.assertDeleteEmailTokenFails(anonymousRestContext, simong.user.id, 401, function() {

                        // Users cannot delete other users their email tokens
                        PrincipalsTestUtil.assertDeleteEmailTokenFails(mrvisser.restContext, simong.user.id, 401, function() {

                            // Tenant administrator cannot delete users from another tenant their email token
                            PrincipalsTestUtil.assertDeleteEmailTokenFails(gtAdminRestContext, simong.user.id, 401, function() {

                                // A user can delete his own pending email verification token
                                PrincipalsTestUtil.assertDeleteEmailTokenSucceeds(simong.restContext, simong.user.id, function(emailForToken) {

                                    email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);
                                    PrincipalsTestUtil.assertUpdateUserSucceeds(simong.restContext, simong.user.id, {'email': email}, function() {
                                        // A tenant admin can delete the pending email verification token for users of their tenant
                                        PrincipalsTestUtil.assertDeleteEmailTokenSucceeds(camAdminRestContext, simong.user.id, function(emailForToken) {
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
