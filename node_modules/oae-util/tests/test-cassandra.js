var CassandraTypes = require('cassandra-client/lib/gen-nodejs/cassandra_types');

cassandraUtil = require('oae-util/lib/cassandra');


var KEYSPACE = 'oae';

module.exports.setUp = function(callback) {
    KEYSPACE = "keyspace" + Math.floor(Math.random()*1000000);
    cassandraUtil.createKeyspace(KEYSPACE, function(err, created) {
        if (err || !created) {
            callback(err);
        }
        else {
            cassandraUtil.configure({'keyspace': KEYSPACE});
            callback();
        }
     });
};


module.exports.tearDown = function(callback) {
    cassandraUtil.dropKeyspace(KEYSPACE, function(err, dropped) {
        if (err || !dropped) {
            console.log("Couldn't drop keyspace: " + KEYSPACE);
            console.log(err);
        }
        
        cassandraUtil.close(function(err) {
            if (err) {
                console.log("Couldn't close connections to cassandra.");
                console.log(err);
                callback(err);
            }
            else {
                callback();
            }
        });
    });
};


module.exports.testKeyspaceExists = function(test) {
    test.expect(2);
    cassandraUtil.keyspaceExists(KEYSPACE, function(err, exists) {
        test.ok(!err);
        test.ok(exists);

        test.done();
    });
};

module.exports.testColumnFamily = function(test) {
    test.expect(7);
    // Create a new CF.
    var name = "testcf" + Math.floor(Math.random()*100000);
    cassandraUtil.runQuery("CREATE TABLE " + name + " (test_id text primary key)", false, function(err){
        test.ok(!err);

        // Check if it exists.
        cassandraUtil.columnFamilyExists(name, function(err, exists) {
            test.ok(!err);
            test.ok(exists);

            // Drop it.
            cassandraUtil.dropColumnFamily(name, function(err, dropped) {
                test.ok(!err);
                test.ok(dropped);

                // Make sure it's gone.
                cassandraUtil.columnFamilyExists(name, function(err, exists) {
                    test.ok(!err);
                    test.ok(!exists);

                    test.done();
                });
            });
        });
    });
};