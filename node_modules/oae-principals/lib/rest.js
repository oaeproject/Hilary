/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 * 
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var reCaptcha = require('recaptcha-async').reCaptcha;
var time = require('time');
var rolesAPI = require('oae-roles/lib/api');
var principalAPI = require('./api');
var rolesUtil = require('oae-roles/lib/util');

module.exports = function(tenant) {

    // @todo, get these from the tenant config.
    var captchaKeys = {
        'public': '6LcFWdYSAAAAAFRwq3uKrt134ujkWsIpWJX-HdoS',
        'private': '6LcFWdYSAAAAANrHjt2Y5VJXoICHa95PFDarVcGs'
    };

    //////////////
    //  USERS   //
    //////////////

    tenant.server.get('/api/me', function(req, res) {
        if (req.ctx.user() === null) {
            return res.send(200, {'anon': true});
        }

        principalAPI.getBasicProfile(req.ctx, req.user.id, function(err, data) {
            if (err) {
                return res.send(err.code, err.msg);
            }


            // calculate timezone offset in hours.
            var now = new time.Date();
            now.setTimezone(req.user.timezone);
            var offset = -1 * now.getTimezoneOffset() / 60;

            data.locale = {
                'locale': req.user.locale,
                'timezone': {
                    'name': req.user.timezone,
                    'offset': offset
                }
            };

            res.send(200, data);
        });
    });

    tenant.server.post('/api/users/create', function(req, res) {
        var createUser = function() {
            principalAPI.createUser(req.ctx, req.body.username, req.body.password, req.body.visibility, req.body.locale, req.body.timezone, req.body.firstName, req.body.lastName, req.body.displayName, function(err, user) {
                if (err) {
                    return res.send(err.code, err.msg);
                }

                res.send(201, user);
            });
        };

        if (req.ctx.user() === null) {
            // An anonymous user, do the recaptcha check.
            var recaptcha = new reCaptcha();
            recaptcha.on('data', function (reCaptchaResponse) {
                if (reCaptchaResponse.is_valid) {
                    createUser();
                } else {
                    return res.send(400, {'msg': 'Invalid reCaptcha token.'});
                }
            });

            recaptcha.checkAnswer(captchaKeys.private,
                                    req.connection.remoteAddress,
                                    req.body.recaptcha_challenge,
                                    req.body.recaptcha_response);
        }
        else {
            // We only allow a logged in user to create a user account
            // if he or she is a tenant/global admin.
            principalAPI.isTenantAdmin(tenant.alias, req.user, function(tenantErr, hasTenantAdminRole) {
                principalAPI.isGlobalAdmin(req.user, function(systemErr, hasSystemAdminRole) {

                    if (tenantErr || systemErr) {
                        return res.send(500, {'msg': 'Could not determine your role.'});
                    }

                    if (hasTenantAdminRole || hasSystemAdminRole) {
                        // If the current user is an admin,
                        // don't bother with reCaptcha.
                        return createUser();
                    } else {
                        // Non-admin users cannot create accounts.
                        return res.send(401);
                    }
                });
            });
        }
    });

    tenant.server.get('/api/users/:id', function(req, res) {
        principalAPI.getBasicProfile(req.ctx, req.params.id, function(err, profile) {
            if (err) {
                return res.send(err.code, err.msg);
            }

            res.send(200, profile);
        });
    });

    tenant.server.post('/api/users/:id', function(req, res) {
        principalAPI.updateUser(req.ctx, req.params.id, req.body.visibility, req.body.locale, req.body.timezone, req.body.firstName, req.body.lastName, req.body.displayName, function(err) {
            if (err) {
                return res.send(err.code, err.msg);
            }

            res.send(200, '');
        });
    });

    tenant.server.get('/api/users/:id/memberships', function(req, res) {
        var limit = parseInt(req.query.limit || 100, 10);
        principalAPI.memberOf(req.params.id, true, req.query.start, limit, function(err, memberships) {
            if (err) {
                return res.send(err.code, err.msg);
            }

            res.send(200, memberships);
        });
    });

    tenant.server.post('/api/users/:id/password', function(req, res) {
        principalAPI.changePassword(req.ctx, req.params.id, req.body.oldPassword, req.body.newPassword, function(err, changed) {
            if (err) {
                return res.send(err.code, err.msg);
            }

            res.send(200);
        });
    });

};