/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var BearerStrategy = require('passport-http-bearer').Strategy;
var passport = require('passport');

var AuthzUtil = require('oae-authz/lib/util');
var Context = require('oae-context').Context;
var OAE = require('oae-util/lib/oae');
var PrincipalsDAO = require('oae-principals/lib/internal/dao');
var Telemetry = require('oae-telemetry').telemetry('oauth');
var User = require('oae-principals/lib/model').User;

var OAuthDAO = require('./internal/dao');


module.exports = function() {

    /*!
     * This strategy is used to authenticate users based on an access token (aka a bearer token).
     *
     * @see http://tools.ietf.org/html/rfc6750
     */
    passport.use(new BearerStrategy(function(accessToken, callback) {
        OAuthDAO.AccessTokens.getAccessToken(accessToken, function(err, token) {
            if (err) {
                return callback(err);
            } else if (!token) {
                return callback(null, false);
            }

            // The access token exists in the DB, authenticate the request with the associated user ID
            PrincipalsDAO.getPrincipal(token.userId, function(err, user) {
                if (err && err.code === 404) {
                    return callback(null, false);
                } else if (err) {
                    return callback(err);
                }

                // Although OAE doesn't use OAuth scopes, we need to pass one in the callback
                return callback(null, user, {'scope': '*'});
            });
        });
    }));

    // Used to check if the authorization header starts with "Bearer "
    var BEARER_REGEX = /^Bearer /i;

    /*!
     * This middleware will apply "OAuth: Bearer Token" authentication if it detects
     * that there is a token in the request. This needs to run before any other middleware that does something with
     * the user, as this middleware will put the `user` object on the request.
     */
    OAE.tenantServer.use(function(req, res, next) {
        // Only attempt the bearer strategy if we detect it in the request
        if ( (req.query && req.query.access_token) ||
             (req.body && req.body.access_token) ||
             (req.headers && req.headers.authorization && BEARER_REGEX.test(req.headers.authorization))
            ) {
            passport.authenticate(['bearer'], { 'session': false })(req, res, function() {
                if (req.user) {
                    Telemetry.incr('success');

                    // If the user has authenticated via OAuth, we can skip the CSRF validation check
                    req._checkCSRF = false;
                } else {
                    Telemetry.incr('fail');
                }

                // In either case, we need to move on to the next middleware
                return next();
            });
        } else {
            return next();
        }
    });
};
