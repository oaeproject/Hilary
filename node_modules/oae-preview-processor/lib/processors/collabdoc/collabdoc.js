/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var fs = require('fs');

var ImageUtil = require('oae-util/lib/image');
var IO = require('oae-util/lib/io');
var log = require('oae-logger').logger('oae-preview-processor');
var RestAPI = require('oae-rest');

var LinkProcessorUtil = require('oae-preview-processor/lib/processors/link/util');
var PreviewConstants = require('oae-preview-processor/lib/constants');
var webshot = require('oae-preview-processor/lib/internal/webshot');

var options = {
    // Show the etherpad container, but hide the editorbar.
    'script': function() {
        // Set the language as etherpad otherwise barfs..
        navigator.language = 'en-US';
        document.body.style.backgroundColor = '#ffffff';
        $('#editbar').css('display', 'none');
        $('#editorcontainer').css('top', '0px');
    },
    'windowSize': {
        'width': PreviewConstants.SIZES.IMAGE.WIDE_WIDTH,
        'height': PreviewConstants.SIZES.IMAGE.WIDE_HEIGHT
    }
};

/**
 * @borrows Interface.test as CollabDocProcessor.test
 */
var test = module.exports.test = function(ctx, contentObj, callback) {
    if (contentObj.resourceSubType === 'collabdoc') {
        callback(null, 10);
    } else {
        callback(null, -1);
    }
};

/**
 * @borrows Interface.generatePreviews as CollabDocProcessor.generatePreviews
 */
var generatePreviews = module.exports.generatePreviews = function(ctx, contentObj, callback) {
    // Do a check to see if this document has been published yet.
    // If there is more then 1 revision it has been published.
    RestAPI.Content.getRevisions(ctx.tenantRestContext, contentObj.id, null, 2, function(err, revisions) {
        if (err) {
            return callback(err);
        } else if (revisions.length === 1) {
            // Only 1 revision => unpublished document.
            // Ignore it for now.
            return callback(null, true);
        }

        // Get a session in etherpad and load it in a headless browser.
        RestAPI.Content.joinCollabDoc(ctx.tenantRestContext, contentObj.id, function(err, data) {
            if (err) {
                return callback(err);
            }

            // Generate a screenshot that is suitable to display in the activity feed.
            var path = ctx.baseDir + '/wide.png';
            webshot.getImage(data.url, path, options, function (err) {
                if (err) {
                    log().error({'err': err, 'contentId': ctx.contentId}, 'Could not generate an image.');
                    return callback(err);
                }

                ctx.addPreview(path, 'wide');

                // Crop out a thumbnail, manually since we know the image is 1070x500.
                // We'll crop out a top-left box.
                var selectedArea = {
                    'x': 0,
                    'y': 0,
                    'width': PreviewConstants.SIZES.IMAGE.WIDE_HEIGHT,
                    'height': PreviewConstants.SIZES.IMAGE.WIDE_HEIGHT
                };
                ImageUtil.cropAndResize(path, selectedArea, [ {'width': PreviewConstants.SIZES.IMAGE.THUMBNAIL, 'height': PreviewConstants.SIZES.IMAGE.THUMBNAIL} ], function(err, files) {
                    if (err) {
                        log().error({'err': err}, 'Could not crop the image.');
                        return callback(err);
                    }

                    // Move the files to the thumbnail path
                    var key = PreviewConstants.SIZES.IMAGE.THUMBNAIL + 'x' + PreviewConstants.SIZES.IMAGE.THUMBNAIL;
                    var thumbnailPath = ctx.baseDir + '/thumbnail.png';
                    IO.moveFile(files[key].path, thumbnailPath, function(err) {
                        if (err) {
                            return callback(err);
                        }

                        ctx.setThumbnail(thumbnailPath);
                        callback();
                    });
                });
            });
        });
    });
};
