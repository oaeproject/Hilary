/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var util = require('util');

var AuthenticationAPI = require('oae-authentication');
var AuthzConstants = require('oae-authz/lib/constants').AuthzConstants;
var Cassandra = require('oae-util/lib/cassandra');
var Context = require('oae-context').Context;
var TenantsAPI = require('oae-tenants');
var User = require('oae-principals/lib/model').User;

var PrincipalsAPI = require('oae-principals');

module.exports = function(config, callback) {

    // Initialize activity capabilities
    require('oae-principals/lib/activity');

    // Initialize search capabilities
    require('oae-principals/lib/search');

    // Initialize invitations capabilities
    require('oae-principals/lib/invitations');

    // Initialize members and memberships library capabilities
    require('oae-principals/lib/libraries/members');
    require('oae-principals/lib/libraries/memberships');

    // Initialize principals delete capabilities
    require('oae-principals/lib/delete');

    _ensureSchema(function(err) {
        if (err) {
            return callback(err);
        }

        return _ensureGlobalAdmin(config, callback);
    });
};

/**
 * Ensure that the all of the principal-related schemas are created. If they already exist, this method will not
 * do anything
 *
 * @param  {Function}    callback       Standard callback function
 * @param  {Object}      callback.err   An error that occurred, if any
 * @api private
 */
var _ensureSchema = function(callback) {
    // Both user and group information will be stored inside of the Principals CF
    Cassandra.createColumnFamilies({
        'Principals': 'CREATE TABLE "Principals" ("principalId" text PRIMARY KEY, "tenantAlias" text, "displayName" text, "description" text, "email" text, "emailPreference" text, "visibility" text, "joinable" text, "lastModified" text, "locale" text, "publicAlias" text, "largePictureUri" text, "mediumPictureUri" text, "smallPictureUri" text, "admin:global" text, "admin:tenant" text, "notificationsUnread" text, "notificationsLastRead" text, "acceptedTC" text, "createdBy" text, "created" timestamp, "deleted" timestamp, "lastLog" timestamp)',

        // Map an email address to user ids. An e-mail address can be used by *multiple* users
        'PrincipalsByEmail': 'CREATE TABLE "PrincipalsByEmail" ("email" text, "principalId" text, PRIMARY KEY ("email", "principalId"))',

        // Map a user id to a desired email address and verification token
        'PrincipalsEmailToken': 'CREATE TABLE "PrincipalsEmailToken" ("principalId" text PRIMARY KEY, "email" text, "token" text)',

        // Track user visits to groups they are members of
        'UsersGroupVisits': 'CREATE TABLE "UsersGroupVisits" ("userId" text, "groupId" text, "latestVisit" text, PRIMARY KEY ("userId", "groupId"))'
    }, function(err) {
        if (err) {
            return callback(err);
        }
        Cassandra.runQuery('CREATE INDEX IF NOT EXISTS ON "Principals" ("tenantAlias")', [], callback);
    });
};

/**
 * Ensure that the default global administrative user exists with username "administrator", and create
 * them if they do not
 *
 * @param  {Object}      config          The server configuration
 * @param  {Function}    callback        Standard callback function
 * @param  {Object}      callback.err    An error that occurred, if any
 * @api private
 */
var _ensureGlobalAdmin = function(config, callback) {
    // Mock a global admin request context so we can create a proper global administrator in the system
    var globalTenant = TenantsAPI.getTenant(config.servers.globalAdminAlias);
    var globalAdminId = util.format('u:%s:admin', globalTenant.alias);
    var globalAdmin = new User(globalTenant.alias, globalAdminId, 'Global Administrator', null, {
        'visibility': AuthzConstants.visibility.PRIVATE,
        'isGlobalAdmin': true
    });
    var globalContext = new Context(globalTenant, globalAdmin);

    // Create the global admin user if they don't exist yet with the username "administrator"
    return AuthenticationAPI.getOrCreateGlobalAdminUser(globalContext, 'administrator', 'administrator', globalAdmin.displayName, globalAdmin, callback);
};
