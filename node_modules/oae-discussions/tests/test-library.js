/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */


var _ = require('underscore');
var assert = require('assert');

var LibraryAPI = require('oae-library');
var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');

var DiscussionsDAO = require('oae-discussions/lib/internal/dao');
var DiscussionsTestUtil = require('oae-discussions/lib/test/util');

describe('Discussion libraries', function() {

    /**
     * Checks a principal library.
     *
     * @param  {RestContext}    restCtx         The context to use to do the request
     * @param  {String}         libraryOwnerId  The principal for which to retrieve the library
     * @param  {Boolean}        expectAccess    Whether or not retrieving the library should be successfull
     * @param  {Discussion[]}   expectedItems   The expected discussions that should return
     * @param  {Function}       callback        Standard callback function
     */
    var checkLibrary = function(restCtx, libraryOwnerId, expectAccess, expectedItems, callback) {
        RestAPI.Discussions.getDiscussionsLibrary(restCtx, libraryOwnerId, null, null, function(err, items) {
            if (!expectAccess) {
                assert.equal(err.code, 401);
                assert.ok(!items);
            } else {
                assert.ok(!err);

                // Make sure only the expected items are returned.
                assert.equal(items.results.length, expectedItems.length);
                _.each(expectedItems, function(expectedDiscussion) {
                    assert.ok(_.filter(items.results, function(discussion) { return discussion.id === expectedDiscussion.id; }));
                });
            }
            callback();
        });
    };

    /**
     * Creates a user and fills his library with discussion items.
     *
     * @param  {RestContext}    restCtx                         The context with which to create the user and content
     * @param  {String}         userVisibility                  The visibility for the new user
     * @param  {Function}       callback                        Standard callback function
     * @param  {User}           callback.user                   The created user
     * @param  {Discussion}     callback.privateDiscussion      The private discussion
     * @param  {Discussion}     callback.loggedinDiscussion     The loggedin discussion
     * @param  {Discussion}     callback.publicDiscussion       The public discussion
     */
    var createUserAndLibrary = function(restCtx, userVisibility, callback) {
        // Create a user with the proper visibility
        TestsUtil.generateTestUsers(restCtx, 1, function(err, users) {
            var user = _.values(users)[0];
            RestAPI.User.updateUser(user.restContext, user.user.id, {'visibility': userVisibility}, function(err) {
                assert.ok(!err);

                // Fill up this user his library with 3 discussion items.
                RestAPI.Discussions.createDiscussion(user.restContext, 'name', 'description', 'private', null, null, function(err, privateDiscussion) {
                    assert.ok(!err);
                    RestAPI.Discussions.createDiscussion(user.restContext, 'name', 'description', 'loggedin', null, null, function(err, loggedinDiscussion) {
                        assert.ok(!err);
                        RestAPI.Discussions.createDiscussion(user.restContext, 'name', 'description', 'public', null, null, function(err, publicDiscussion) {
                            assert.ok(!err);
                            callback(user, privateDiscussion, loggedinDiscussion, publicDiscussion);
                        });
                    });
                });
            });
        });
    };

    /**
     * Creates a group with the supplied visibility and fill its library with 3 discussions.
     *
     * @param  {RestContext}    restCtx                         The context with which to create the group and discusion
     * @param  {String}         groupVisibility                 The visibility for the new group
     * @param  {Function}       callback                        Standard callback function
     * @param  {Group}          callback.group                  The created group
     * @param  {Discussion}     callback.privateDiscussion      The private discussion
     * @param  {Discussion}     callback.loggedinDiscussion     The loggedin discussion
     * @param  {Discussion}     callback.publicDiscussion       The public discussion
     */
    var createGroupAndLibrary = function(restCtx, groupVisibility, callback) {
        RestAPI.Group.createGroup(restCtx, 'displayName', 'description', groupVisibility, 'no', [], [], function(err, group) {
            assert.ok(!err);

            // Fill up the group library with 3 discussion items.
            RestAPI.Discussions.createDiscussion(restCtx, 'name', 'description', 'private', [group.id], null, function(err, privateDiscussion) {
                assert.ok(!err);
                RestAPI.Discussions.createDiscussion(restCtx, 'name', 'description', 'loggedin', [group.id], null, function(err, loggedinDiscussion) {
                    assert.ok(!err);
                    RestAPI.Discussions.createDiscussion(restCtx, 'name', 'description', 'public', [group.id], null, function(err, publicDiscussion) {
                        assert.ok(!err);
                        callback(group, privateDiscussion, loggedinDiscussion, publicDiscussion);
                    });
                });
            });

        });
    };

    var camAnonymousRestCtx = null;
    var camAdminRestCtx = null;
    var gtAnonymousRestCtx = null;
    var gtAdminRestCtx = null;

    beforeEach(function() {
        camAnonymousRestCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        camAdminRestCtx = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        gtAnonymousRestCtx = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        gtAdminRestCtx = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
    });

    /**
     * A testcase that the correct library stream is returned and the library user's visibility
     * settings are respected.
     */
    it('verify user libraries', function(callback) {
        // We'll create a private, loggedin and public user, each user's library will contain a private, loggedin and public discussion item.
        createUserAndLibrary(camAdminRestCtx, 'private', function(privateUser, privateUserPrivateDiscussion, privateUserLoggedinDiscussion, privateUserPublicDiscussion) {
            createUserAndLibrary(camAdminRestCtx, 'loggedin', function(loggedinUser, loggedinUserPrivateDiscussion, loggedinUserLoggedinDiscussion, loggedinUserPublicDiscussion) {
                createUserAndLibrary(camAdminRestCtx, 'public', function(publicUser, publicUserPrivateDiscussion, publicUserLoggedinDiscussion, publicUserPublicDiscussion) {

                    // Each user should be able to see all the items in his library.
                    checkLibrary(privateUser.restContext, privateUser.user.id, true, [privateUserPublicDiscussion, privateUserLoggedinDiscussion, privateUserPrivateDiscussion], function() {
                        checkLibrary(loggedinUser.restContext, loggedinUser.user.id, true, [loggedinUserPublicDiscussion, loggedinUserLoggedinDiscussion, loggedinUserPrivateDiscussion], function() {
                            checkLibrary(publicUser.restContext, publicUser.user.id, true, [publicUserPublicDiscussion, publicUserLoggedinDiscussion, publicUserPrivateDiscussion], function() {

                                // The anonymous user can only see the public stream of the public user.
                                checkLibrary(camAnonymousRestCtx, publicUser.user.id, true, [publicUserPublicDiscussion], function() {
                                    checkLibrary(camAnonymousRestCtx, loggedinUser.user.id, false, [], function() {
                                        checkLibrary(camAnonymousRestCtx, privateUser.user.id, false, [], function() {

                                            checkLibrary(gtAnonymousRestCtx, publicUser.user.id, true, [publicUserPublicDiscussion], function() {
                                                checkLibrary(gtAnonymousRestCtx, loggedinUser.user.id, false, [], function() {
                                                    checkLibrary(gtAnonymousRestCtx, privateUser.user.id, false, [], function() {

                                                        // A loggedin user on the same tenant can see the loggedin stream for the public and loggedin user.
                                                        TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users) {
                                                            var anotherUser = _.values(users)[0];
                                                            checkLibrary(anotherUser.restContext, publicUser.user.id, true, [publicUserPublicDiscussion, publicUserLoggedinDiscussion], function() {
                                                                checkLibrary(anotherUser.restContext, loggedinUser.user.id, true, [loggedinUserPublicDiscussion, loggedinUserLoggedinDiscussion], function() {
                                                                    checkLibrary(anotherUser.restContext, privateUser.user.id, false, [], function() {

                                                                        // A loggedin user on *another* tenant can only see the public stream for the public user.
                                                                        TestsUtil.generateTestUsers(gtAdminRestCtx, 1, function(err, users) {
                                                                            var otherTenantUser = _.values(users)[0];
                                                                            checkLibrary(otherTenantUser.restContext, publicUser.user.id, true, [publicUserPublicDiscussion], function() {
                                                                                checkLibrary(otherTenantUser.restContext, loggedinUser.user.id, false, [], function() {
                                                                                    checkLibrary(otherTenantUser.restContext, privateUser.user.id, false, [], function() {

                                                                                        // The cambridge tenant admin can see all the things.
                                                                                        checkLibrary(camAdminRestCtx, publicUser.user.id, true, [publicUserPublicDiscussion, publicUserLoggedinDiscussion, publicUserPrivateDiscussion], function() {
                                                                                            checkLibrary(camAdminRestCtx, loggedinUser.user.id, true, [loggedinUserPublicDiscussion, loggedinUserLoggedinDiscussion, loggedinUserPrivateDiscussion], function() {
                                                                                                checkLibrary(camAdminRestCtx, privateUser.user.id, true, [privateUserPublicDiscussion, privateUserLoggedinDiscussion, privateUserPrivateDiscussion], function() {

                                                                                                    // The GT tenant admin can only see the public stream for the public user.
                                                                                                    checkLibrary(gtAdminRestCtx, publicUser.user.id, true, [publicUserPublicDiscussion], function() {
                                                                                                        checkLibrary(gtAdminRestCtx, loggedinUser.user.id, false, [], function() {
                                                                                                            checkLibrary(gtAdminRestCtx, privateUser.user.id, false, [], callback);
                                                                                                        });
                                                                                                    });
                                                                                                });
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    /**
     * A testcase that the correct library stream is returned for a group.
     */
    it('verify group libraries', function(callback) {
        // Create three groups: private, loggedin, public
        TestsUtil.generateTestUsers(camAdminRestCtx, 2, function(err, users) {
            assert.ok(!err);
            var groupCreator = _.values(users)[0];
            var anotherUser = _.values(users)[1];
            createGroupAndLibrary(groupCreator.restContext, 'private', function(privateGroup, privateGroupPrivateDiscussion, privateGroupLoggedinDiscussion, privateGroupPublicDiscussion) {
                createGroupAndLibrary(groupCreator.restContext, 'loggedin', function(loggedinGroup, loggedinGroupPrivateDiscussion, loggedinGroupLoggedinDiscussion, loggedinGroupPublicDiscussion) {
                    createGroupAndLibrary(groupCreator.restContext, 'public', function(publicGroup, publicGroupPrivateDiscussion, publicGroupLoggedinDiscussion, publicGroupPublicDiscussion) {

                        // An anonymous user can only see the public stream for the public group.
                        checkLibrary(camAnonymousRestCtx, publicGroup.id, true, [publicGroupPublicDiscussion], function() {
                            checkLibrary(camAnonymousRestCtx, loggedinGroup.id, false, [], function() {
                                checkLibrary(camAnonymousRestCtx, privateGroup.id, false, [], function() {

                                    checkLibrary(gtAnonymousRestCtx, publicGroup.id, true, [publicGroupPublicDiscussion], function() {
                                        checkLibrary(gtAnonymousRestCtx, loggedinGroup.id, false, [], function() {
                                            checkLibrary(gtAnonymousRestCtx, privateGroup.id, false, [], function() {

                                                // A loggedin user on the same tenant can see the loggedin stream for the public and loggedin group.
                                                checkLibrary(anotherUser.restContext, publicGroup.id, true, [publicGroupPublicDiscussion, publicGroupLoggedinDiscussion], function() {
                                                    checkLibrary(anotherUser.restContext, loggedinGroup.id, true, [loggedinGroupPublicDiscussion, loggedinGroupLoggedinDiscussion], function() {
                                                        checkLibrary(anotherUser.restContext, privateGroup.id, false, [], function() {

                                                            // A loggedin user on *another* tenant can only see the public stream for the public user.
                                                            TestsUtil.generateTestUsers(gtAdminRestCtx, 1, function(err, users) {
                                                                var otherTenantUser = _.values(users)[0];
                                                                checkLibrary(otherTenantUser.restContext, publicGroup.id, true, [publicGroupPublicDiscussion], function() {
                                                                    checkLibrary(otherTenantUser.restContext, loggedinGroup.id, false, [], function() {
                                                                        checkLibrary(otherTenantUser.restContext, privateGroup.id, false, [], function() {


                                                                            // The cambridge tenant admin can see all the things.
                                                                            checkLibrary(camAdminRestCtx, publicGroup.id, true, [publicGroupPublicDiscussion, publicGroupLoggedinDiscussion, publicGroupPrivateDiscussion], function() {
                                                                                checkLibrary(camAdminRestCtx, loggedinGroup.id, true, [loggedinGroupPublicDiscussion, loggedinGroupLoggedinDiscussion, loggedinGroupPrivateDiscussion], function() {
                                                                                    checkLibrary(camAdminRestCtx, privateGroup.id, true, [privateGroupPrivateDiscussion, privateGroupLoggedinDiscussion, privateGroupPrivateDiscussion], function() {

                                                                                        // The GT tenant admin can only see the public stream for the public user.
                                                                                        checkLibrary(gtAdminRestCtx, publicGroup.id, true, [publicGroupPublicDiscussion], function() {
                                                                                            checkLibrary(gtAdminRestCtx, loggedinGroup.id, false, [], function() {
                                                                                                checkLibrary(gtAdminRestCtx, privateGroup.id, false, [], function() {

                                                                                                    // If we make the cambridge user a member of the private group he should see everything.
                                                                                                    var changes = {};
                                                                                                    changes[anotherUser.user.id] = 'member';
                                                                                                    RestAPI.Group.setGroupMembers(groupCreator.restContext, privateGroup.id, changes, function(err) {
                                                                                                        assert.ok(!err);
                                                                                                        checkLibrary(anotherUser.restContext, privateGroup.id, true, [privateGroupPrivateDiscussion, privateGroupLoggedinDiscussion, privateGroupPrivateDiscussion], function() {

                                                                                                            // If we make the GT user a member of the private group, he should see everything.
                                                                                                            changes = {};
                                                                                                            changes[otherTenantUser.user.id] = 'member';
                                                                                                            RestAPI.Group.setGroupMembers(groupCreator.restContext, privateGroup.id, changes, function(err) {
                                                                                                                assert.ok(!err);
                                                                                                                checkLibrary(otherTenantUser.restContext, privateGroup.id, true, [privateGroupPrivateDiscussion, privateGroupLoggedinDiscussion, privateGroupPrivateDiscussion], callback);
                                                                                                            });
                                                                                                        });
                                                                                                    });
                                                                                                });
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    /**
     * Test that verifies when user permissions are set on a discussion, the discussion is properly added into their library
     */
    it('verify setting permissions of discussion results in discussion showing up in the user\'s library', function(callback) {
        TestsUtil.generateTestUsers(camAdminRestCtx, 2, function(err, users, mrvisser, nicolaas) {
            assert.ok(!err);

            // Create a discussion as mrvisser
            RestAPI.Discussions.createDiscussion(mrvisser.restContext, 'name', 'descr', 'public', null, null, function(err, discussion) {
                assert.ok(!err);

                // Seed mrvisser's and nicolaas' discussion libraries to ensure it does not get built from scratch
                RestAPI.Discussions.getDiscussionsLibrary(mrvisser.restContext, mrvisser.user.id, null, null, function(err, result) {
                    assert.ok(!err);
                    RestAPI.Discussions.getDiscussionsLibrary(nicolaas.restContext, nicolaas.user.id, null, null, function(err, result) {
                        assert.ok(!err);

                        // Make nicolaas a member of the discussion
                        var memberUpdates = {};
                        memberUpdates[nicolaas.user.id] = 'member';
                        DiscussionsTestUtil.assertUpdateDiscussionMembersSucceeds(mrvisser.restContext, mrvisser.restContext, discussion.id, memberUpdates, function(err) {
                            assert.ok(!err);

                            // Ensure the discussion is still in mrvisser's and nicolaas' discussion libraries
                            RestAPI.Discussions.getDiscussionsLibrary(mrvisser.restContext, mrvisser.user.id, null, null, function(err, result) {
                                assert.ok(!err);
                                var libraryEntry = result.results[0];
                                assert.ok(libraryEntry);
                                assert.strictEqual(libraryEntry.id, discussion.id);

                                RestAPI.Discussions.getDiscussionsLibrary(nicolaas.restContext, nicolaas.user.id, null, null, function(err, result) {
                                    assert.ok(!err);
                                    var libraryEntry = result.results[0];
                                    assert.ok(libraryEntry);
                                    assert.strictEqual(libraryEntry.id, discussion.id);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    /**
     * Test that verifies that a library can be rebuilt from a dirty authz table
     */
    it('verify a library can be rebuilt from a dirty authz table', function(callback) {
        createUserAndLibrary(camAdminRestCtx, 'private', function(simong, privateDiscussion, loggedinDiscussion, publicDiscussion) {

            // Ensure all the items are in the user's library
            checkLibrary(simong.restContext, simong.user.id, true, [privateDiscussion, loggedinDiscussion, publicDiscussion], function() {

                // Remove a discussion through the DAO. This will leave a pointer
                // in the Authz table that points to nothing. The library re-indexer
                // should be able to deal with this
                DiscussionsDAO.deleteDiscussion(privateDiscussion.id, function(err) {
                    assert.ok(!err);

                    // Purge the library so that it has to be rebuild on the next request
                    LibraryAPI.Index.purge('discussions:discussions', simong.user.id, function(err) {
                        assert.ok(!err);

                        // We should be able to rebuild the library on-the-fly. The private
                        // discussion item should not be returned as it has been removed
                        checkLibrary(simong.restContext, simong.user.id, true, [loggedinDiscussion, publicDiscussion], callback);
                    });
                });
            });
        });
    });
});
