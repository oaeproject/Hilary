/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');

var AuthenticationConstants = require('oae-authentication/lib/constants').AuthenticationConstants;
var ConfigTestUtil = require('oae-config/lib/test/util');
var Context = require('oae-context').Context;
var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');

var ConfigAPI = require('oae-config');


describe('Configuration', function() {

    // Rest context that can be used for anonymous requests on the cambridge tenant
    var anonymousCamRestContext = null;
    // Rest context that can be used for anonymous requests on the global tenant
    var anonymousGlobalRestContext = null;
    // Rest context that can be used every time we need to make a request as a tenant admin
    var camAdminRestContext = null;
    // Rest context that can be used every time we need to make a request as a global admin
    var globalAdminRestContext = null;
    // Rest context for a user that will be used inside of the tests
    var johnRestContext = null;

    /**
     * Function that will fill up the global admin, tenant admin and anymous rest context
     */
    before(function(callback) {
        // Fill up the anonymous cam rest context
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        // Fill up the anonymous global rest context
        anonymousGlobalRestContext = TestsUtil.createGlobalRestContext();
        // Fill up tenant admin rest context
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        // Fill up the global admin rest context
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
        // Fill up the rest context for our test user
        var userId = TestsUtil.generateTestUserId('john');
        RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'John Doe', null, function(err, createdUser) {
            johnRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, userId, 'password');
            callback();
        });
    });


    describe('Schema', function() {
        
        /**
         * Test that verifies that the configuration schema can be retrieved on the global admin server
         */
        it('verify get schema global', function(callback) {
            RestAPI.Config.getSchema(globalAdminRestContext, function(err, schema) {
                assert.ok(!err);
                assert.ok(schema);
                assert.ok(schema['oae-authentication'].title);
                assert.strictEqual(schema['oae-authentication']['twitter'].elements['enabled'].defaultValue, true);
                
                // Verify that the anonymous users can't retrieve the schema
                RestAPI.Config.getSchema(anonymousGlobalRestContext, function(err, schema) {
                    assert.ok(err);
                    assert.equal(err.code, 401);
                    assert.ok(!schema);
                    callback();
                });
            });
        });

        /**
         * Test that verifies that the configuration schema can be retrieved on the tenant server
         */
        it('verify get schema tenant', function(callback) {
            RestAPI.Config.getSchema(camAdminRestContext, function(err, schema) {
                assert.ok(!err);
                assert.ok(schema);
                assert.ok(schema['oae-authentication'].title);
                assert.strictEqual(schema['oae-authentication']['twitter'].elements['enabled'].defaultValue, true);
                
                // Verify that regular tenant users can't retrieve the schema
                RestAPI.Config.getSchema(johnRestContext, function(err, schema) {
                    assert.ok(err);
                    assert.equal(err.code, 401);
                    assert.ok(!schema);
                    
                    // Verify that only anonymous users can't retrieve the schema
                    RestAPI.Config.getSchema(anonymousCamRestContext, function(err, schema) {
                        assert.ok(err);
                        assert.equal(err.code, 401);
                        assert.ok(!schema);
                        callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that the configuration schema for a global admin has `globalAdminOnly` values and
         * that the schema for a tenant admin excludes `globalAdminOnly` values.
         */
        it('verify globalAdminOnly', function(callback) {
            RestAPI.Config.getSchema(globalAdminRestContext, function(err, schema) {
                assert.ok(!err);
                assert.ok(schema);
                assert.ok(schema['oae-content'].title);
                assert.equal(schema['oae-content']['storage'].elements['amazons3-access-key'].defaultValue, '<access-key>');

                RestAPI.Config.getSchema(camAdminRestContext, function(err, schema) {
                    assert.ok(!err);
                    assert.ok(schema);
                    assert.ok(schema['oae-content'].title);
                    assert.equal(schema['oae-content']['storage'].elements['amazons3-access-key'], undefined);
                    callback();
                });
            });
        });

    });


    describe('Internal Configuration API', function() {
        
        /**
         * Test that verifies that a single configuration value can be retrieved from the cached configuration
         */
        it('verify get single config value', function(callback) {
            var AuthenticationConfig = ConfigAPI.config('oae-authentication');
            var PrincipalsConfig = ConfigAPI.config('oae-principals');
            // Retrieve a non-existing value
            assert.equal(AuthenticationConfig.getValue(global.oaeTests.tenants.cam.alias, 'sso', 'enabled'), null);
            // Retrieve a boolean value
            assert.equal(AuthenticationConfig.getValue(global.oaeTests.tenants.cam.alias, 'twitter', 'enabled'), true);
            // Retrieve a string value
            assert.equal(PrincipalsConfig.getValue(global.oaeTests.tenants.cam.alias, 'user', 'defaultLanguage'), 'en_GB');
            // Retrieve a suppressed value
            assert.equal(PrincipalsConfig.getValue(global.oaeTests.tenants.cam.alias, 'recaptcha', 'privateKey'), '6LcFWdYSAAAAANrHjt2Y5VJXoICHa95PFDarVcGs');
            callback();
        });

        /**
         * Test that verifies the validation for retrieving a config value from the cached configuration
         */
        it('verify validation', function(callback) {
            // Verify that initializing a config factory needs a module name. This should throw an error
            assert.throws(function() {
                ConfigAPI.config()
            });
            // Verify that a feature needs to be provided when getting a config value
            var AuthenticationConfig = ConfigAPI.config('oae-authentication');
            assert.equal(AuthenticationConfig.getValue(global.oaeTests.tenants.cam.alias), null);
            // Verify that an element needs to be provided when getting a config value
            assert.equal(AuthenticationConfig.getValue(global.oaeTests.tenants.cam.alias, 'twitter'), null);
            callback();
        });

    });


    describe('REST Configuration API', function() {

        /**
         * Test that verifies that the configuration can be retrieved on the global server
         */
        it('verify get config global', function(callback) {
            // Get the config as an admin user
            RestAPI.Config.getTenantConfig(globalAdminRestContext, null, function(err, config) {
                assert.ok(!err);
                assert.ok(config);
                // Verify that a public value is present
                assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                // Verify that a suppressed value is present
                assert.equal(config['oae-principals']['recaptcha']['privateKey'], '6LcFWdYSAAAAANrHjt2Y5VJXoICHa95PFDarVcGs');
                // Verify that a globalAdminOnly value is present
                assert.equal(config['oae-content']['storage']['amazons3-access-key'], '<access-key>');

                // Get the config as an anonymous user
                RestAPI.Config.getTenantConfig(anonymousGlobalRestContext, null, function(err, config) {
                    assert.ok(!err);
                    assert.ok(config);
                    // Verify that a public value is present
                    assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                    // Verify that a suppressed value is not present
                    assert.equal(config['oae-principals']['recaptcha']['privateKey'], null);
                    // Verify that a globalAdminOnly value is not present
                    assert.ok(!config['oae-content']['storage'].elements, true);
                    callback();
                });
            });
        });

        /**
         * Test that verifies that the configuration can be retrieved on the tenant server
         */
        it('verify get config tenant', function(callback) {
            // Get the config as an admin user
            RestAPI.Config.getTenantConfig(camAdminRestContext, null, function(err, config) {
                assert.ok(!err);
                assert.ok(config);
                // Verify that a public value is present
                assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                // Verify that a suppressed value is present
                assert.equal(config['oae-principals']['recaptcha']['privateKey'], '6LcFWdYSAAAAANrHjt2Y5VJXoICHa95PFDarVcGs');
                // Verify that a globalAdminOnly value is not present
                assert.ok(!config['oae-content']['storage'].elements, true);

                // Get the config as a logged in user
                RestAPI.Config.getTenantConfig(johnRestContext, null, function(err, config) {
                    assert.ok(!err);
                    assert.ok(config);
                    // Verify that a public value is present
                    assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                    // Verify that a suppressed value is not present
                    assert.equal(config['oae-principals']['recaptcha']['privateKey'], null);
                    // Verify that a globalAdminOnly value is not present
                    assert.ok(!config['oae-content']['storage'].elements, true);
                    
                    // Get the config as an anonymous user
                    RestAPI.Config.getTenantConfig(anonymousCamRestContext, null, function(err, config) {
                        assert.ok(!err);
                        assert.ok(config);
                        // Verify that a public value is present
                        assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                        // Verify that a suppressed value is not present
                        assert.equal(config['oae-principals']['recaptcha']['privateKey'], null);
                        // Verify that a globalAdminOnly value is not present
                        assert.ok(!config['oae-content']['storage'].elements, true);
                        callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that the configuration can be retrieved for the tenant server through the global admin
         */
        it('verify get config tenant through global', function(callback) {
            // Get the config as an admin user
            RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                assert.ok(!err);
                assert.ok(config);
                // Verify that a public value is present
                assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                // Verify that a suppressed value is present
                assert.equal(config['oae-principals']['recaptcha']['privateKey'], '6LcFWdYSAAAAANrHjt2Y5VJXoICHa95PFDarVcGs');
                // Verify that a globalAdminOnly value is present
                assert.equal(config['oae-content']['storage']['amazons3-access-key'], '<access-key>');

                // Get the config as an anonymous user
                RestAPI.Config.getTenantConfig(anonymousGlobalRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                    assert.ok(!err);
                    assert.ok(config);
                    // Verify that a public value is present
                    assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                    // Verify that a suppressed value is not present
                    assert.equal(config['oae-principals']['recaptcha']['privateKey'], null);
                    // Verify that a globalAdminOnly value is not present
                    assert.ok(!config['oae-content']['storage'].elements, true);
                    callback();
                });
            });
        });

        /**
         * Test that verifies that a global configuration value can be persisted
         */
        it('verify set config value global', function(callback) {
            ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, 'oae-authentication/twitter/enabled', false, function(err) {
                assert.ok(!err);

                // Validate that the change has been made
                RestAPI.Config.getTenantConfig(globalAdminRestContext, null, function(err, config) {
                    assert.ok(!err);
                    assert.ok(config);
                    assert.equal(config['oae-authentication']['twitter']['enabled'], false);
                    
                    // Validate that the tenant admin can see this as well
                    RestAPI.Config.getTenantConfig(camAdminRestContext, null, function(err, config) {
                        assert.ok(!err);
                        assert.ok(config);
                        assert.equal(config['oae-authentication']['twitter']['enabled'], false);
                        
                        // Set a new value for a suppressed config value
                        ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, 'oae-principals/recaptcha/privateKey', 'newKey', function(err) {
                            assert.ok(!err);
            
                            // Validate that the change has been made
                            RestAPI.Config.getTenantConfig(globalAdminRestContext, null, function(err, config) {
                                assert.ok(!err);
                                assert.ok(config);
                                assert.equal(config['oae-principals']['recaptcha']['privateKey'], 'newKey');
                                
                                // Validate that the tenant admin can see this as well
                                RestAPI.Config.getTenantConfig(camAdminRestContext, null, function(err, config) {
                                    assert.ok(!err);
                                    assert.ok(config);
                                    assert.equal(config['oae-principals']['recaptcha']['privateKey'], 'newKey');
                                    
                                    // Validate that a non-admin user can still not see this
                                    RestAPI.Config.getTenantConfig(johnRestContext, null, function(err, config) {
                                        assert.ok(!err);
                                        assert.ok(config);
                                        assert.equal(config['oae-principals']['recaptcha']['privateKey'], null);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a tenant configuration value can be persisted
         */
        it('verify set config value tenant', function(callback) {
            ConfigTestUtil.updateConfigAndWait(camAdminRestContext, null, 'oae-authentication/twitter/enabled', true, function(err) {
                assert.ok(!err);

                // Validate that the change has been made and has overriden the global config
                RestAPI.Config.getTenantConfig(camAdminRestContext, null, function(err, config) {
                    assert.ok(!err);
                    assert.ok(config);
                    assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                    
                    // Validate that the new value can be retrieved through the global admin
                    RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                        assert.ok(!err);
                        assert.ok(config);
                        assert.equal(config['oae-authentication']['twitter']['enabled'], true);
                        
                        // Set a new value for a suppressed config value
                        ConfigTestUtil.updateConfigAndWait(camAdminRestContext, null, 'oae-principals/recaptcha/privateKey', 'newTenantKey', function(err) {
                            assert.ok(!err);
            
                            // Validate that the tenant admin can see this as well
                            RestAPI.Config.getTenantConfig(camAdminRestContext, null, function(err, config) {
                                assert.ok(!err);
                                assert.ok(config);
                                assert.equal(config['oae-principals']['recaptcha']['privateKey'], 'newTenantKey');
                                    
                                // Validate that a non-admin user can still not see this
                                RestAPI.Config.getTenantConfig(johnRestContext, null, function(err, config) {
                                    assert.ok(!err);
                                    assert.ok(config);
                                    assert.equal(config['oae-principals']['recaptcha']['privateKey'], null);
                                        
                                    // Validate that the global admin still has the old values
                                    RestAPI.Config.getTenantConfig(globalAdminRestContext, null, function(err, config) {
                                        assert.ok(!err);
                                        assert.ok(config);
                                        assert.equal(config['oae-authentication']['twitter']['enabled'], false);
                                        assert.equal(config['oae-principals']['recaptcha']['privateKey'], 'newKey');
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a tenant configuration value can be persisted through the global server
         */
        it('verify set tenant config value global', function(callback) {
            ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-authentication/twitter/enabled', false, function(err) {
                assert.ok(!err);

                // Validate that the change has been made from the global admin
                RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                    assert.ok(!err);
                    assert.ok(config);
                    assert.equal(config['oae-authentication']['twitter']['enabled'], false);
                    
                    // Validate that the change has been made from the tenant admin
                    RestAPI.Config.getTenantConfig(camAdminRestContext, null, function(err, config) {
                        assert.ok(!err);
                        assert.ok(config);
                        assert.equal(config['oae-authentication']['twitter']['enabled'], false);
                        callback();
                    });
                });
            });
        });

        /**
         * Test that boolean and non-boolean values are coerced correctly
         */
        it('verify config value coercion', function(callback) {
            // Get Boolean config value that's supposed to be `true`
            RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                assert.ok(!err);
                assert.ok(config);
                assert.strictEqual(config['oae-authentication']['local']['enabled'], true);

                // Change the value to false using '0', which would be used by checkboxes
                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-authentication/local/enabled', '0', function(err) {
                    assert.ok(!err);
                    RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                        assert.ok(!err);
                        assert.ok(config);
                        assert.strictEqual(config['oae-authentication']['local']['enabled'], false);

                        // Change the value to true using '1', which would be used by checkboxes
                        ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-authentication/local/enabled', '1', function(err) {
                            assert.ok(!err);
                            RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                                assert.ok(!err);
                                assert.ok(config);
                                assert.strictEqual(config['oae-authentication']['local']['enabled'], true);

                                // Change the value to false using the 'false' string
                                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-authentication/local/enabled', 'false', function(err) {
                                    assert.ok(!err);
                                    RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                                        assert.ok(!err);
                                        assert.ok(config);
                                        assert.strictEqual(config['oae-authentication']['local']['enabled'], false);

                                        // Change the value back to true using the 'true' string
                                        ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-authentication/local/enabled', 'true', function(err) {
                                            assert.ok(!err);
                                            RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                                                assert.ok(!err);
                                                assert.ok(config);
                                                assert.strictEqual(config['oae-authentication']['local']['enabled'], true);

                                                // Get non-Boolean config value
                                                RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                                                    assert.ok(!err);
                                                    assert.ok(config);
                                                    var originalValue = config['oae-authentication']['signed']['expires'];
                                                    assert.ok(originalValue);

                                                    // Change the value to '1'
                                                    ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-authentication/signed/expires', '1', function(err) {
                                                        assert.ok(!err);
                                                        RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                                                            assert.ok(!err);
                                                            assert.ok(config);
                                                            assert.strictEqual(config['oae-authentication']['signed']['expires'], '1');

                                                            // Change the value to '0'
                                                            ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-authentication/signed/expires', '0', function(err) {
                                                                assert.ok(!err);
                                                                RestAPI.Config.getTenantConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, config) {
                                                                    assert.ok(!err);
                                                                    assert.ok(config);
                                                                    assert.strictEqual(config['oae-authentication']['signed']['expires'], '0');

                                                                    // Revert the value back to the original value
                                                                    ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-authentication/signed/expires', originalValue, function(err) {
                                                                        assert.ok(!err);
                                                                        callback();
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation on setting and retrieving config
         */
        it('verify validation', function(callback) {
            // Missing configField
            ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, null, false, function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);

                // Missing configValue
                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, 'oae-authentication/twitter/enabled', null, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 400);

                    // Try changing the config with an invalid tenant id
                    ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, ' ', 'oae-authentication/twitter/enabled', 'moops', function(err) {
                        assert.ok(err);
                        assert.equal(err.code, 400);

                        // Try updating a non-existing configuration option
                        ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, 'oae-non/existing/options', 'moops', function(err) {
                            assert.ok(err);
                            assert.equal(err.code, 401);

                            // Try changing the tenant config as a regular user (non-admin).
                            ConfigTestUtil.updateConfigAndWait(johnRestContext, null, 'oae-authentication/twitter/enabled', 'moops', function(err) {
                                assert.ok(err);
                                assert.equal(err.code, 401);

                                // Try changing the tenant config as an anonymous user
                                ConfigTestUtil.updateConfigAndWait(anonymousCamRestContext, null, 'oae-authentication/twitter/enabled', 'moops', function(err) {
                                    assert.ok(err);
                                    assert.equal(err.code, 401);

                                    // Try changing the global config as an anonymous user
                                    ConfigTestUtil.updateConfigAndWait(anonymousGlobalRestContext, null, 'oae-authentication/twitter/enabled', 'moops', function(err) {
                                        assert.ok(err);
                                        assert.equal(err.code, 401);

                                        // Try changing the global config as a regular user (non-admin)
                                        ConfigTestUtil.updateConfigAndWait(johnRestContext, null, 'oae-content/storage/amazons3-access-key', 'moops', function(err) {
                                            assert.ok(err);
                                            assert.equal(err.code, 401);

                                            // Try changing a config option that is not editable by a tenant (tenantOverride=false) as a tenant admin.
                                            ConfigTestUtil.updateConfigAndWait(camAdminRestContext, null, 'oae-authentication/signed/expires', 'moops', function(err) {
                                                assert.ok(err);
                                                assert.equal(err.code, 401);

                                                // Verify that a global administrator can update `tenantOverride=false` configuration options
                                                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, 'oae-authentication/signed/expires', 'moops', function(err) {
                                                    assert.ok(!err);

                                                    // Verify getting tenant configuration through the global server needs a valid ID
                                                    RestAPI.Config.getTenantConfig(globalAdminRestContext, ' ', function(err, config) {
                                                        assert.ok(err);
                                                        assert.equal(err.code, 400);
                                                        callback();
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

    });
});
