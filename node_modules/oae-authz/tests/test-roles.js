/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 * 
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var AuthzAPI = require('oae-authz');
var AuthzUtil = require('oae-authz/lib/util');

describe('Authz-Roles', function() {

    var PrincipalTypes = { USER: 'u', GROUP: 'g' };
    var ResourceTypes = { CONTENT: 'c', GROUP: 'g' };

    /**
     * Load roles for a number of generated content items.
     *
     * @param {String}      principalUuid       The UUID of the principal to assign the role
     * @param {String}      baseContentId       The base content id of the content to generate
     * @param {String}      resourceType        The resource type associated to the content
     * @param {Integer}     numContentItems     The number of content items to generate and assign roles for
     * @param {String}      role                The role to assign to the principal on the generated content
     * @param {Function()}  callback            The function invoked when the process is complete
     */
    var loadContentRoles = function(principalUuid, baseContentId, resourceType, numContentItems, role, callback) {
        if (numContentItems === 0) {
            callback();
            return;
        }

        var tenantId = AuthzUtil.getPrincipalFromUuid(principalUuid).tenantId;
        var resourceUuid = AuthzUtil.toUuid(resourceType, tenantId, baseContentId+'-'+numContentItems);
        AuthzAPI.applyRoleChanges(resourceUuid, makeChange(principalUuid, role), function(err) {
            if (err) {
                throw err;
            }
            loadContentRoles(principalUuid, baseContentId, resourceType, numContentItems-1, role, callback);
        });
    };

    /**
     * Make a single membership change object to apply to a group membership.
     *
     * @param  {String} principalUuid   The principalUuid whose membership to change
     * @param  {String} role            The role to change to
     * @return {Object}                 The change JSON Object to apply to the group
     */
    var makeChange = function(principalUuid, role) {
        var change = {};
        change[principalUuid] = role;
        return change;
    }

    describe('#getRole()', function() {

        it('verify role separation between tenants', function(callback) {
            var principalUuidA = AuthzUtil.toUuid(PrincipalTypes.USER, 'testTenantSeparationA', 'mrvisser');
            var principalUuidB = AuthzUtil.toUuid(PrincipalTypes.USER, 'testTenantSeparationB', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid(ResourceTypes.CONTENT, 'cam', 'testTenantSeparationContent');

            AuthzAPI.applyRoleChanges(resourceUuid, makeChange(principalUuidA, 'manager'), function(err) {
                assert.ok(!err);

                // verify tenant B user does not have a role on that content
                AuthzAPI.getRole(principalUuidB, resourceUuid, function(err, role) {
                    assert.ok(!err);
                    assert.ok(!role);

                    // add 'viewer' for security context B
                    AuthzAPI.applyRoleChanges(resourceUuid, makeChange(principalUuidB, 'viewer'), function(err) {
                        assert.ok(!err);

                        // ensure user from tenant A is still manager, not viewer
                        AuthzAPI.hasRole(principalUuidA, resourceUuid, 'manager', function(err, hasRole) {
                            assert.ok(!err);
                            assert.ok(hasRole);

                            // ensure user from context B is a viewer, not manager
                            AuthzAPI.hasRole(principalUuidB, resourceUuid, 'viewer', function(err, hasRole) {
                                assert.ok(!err);
                                assert.ok(hasRole);
                                callback();
                            });
                        });
                    });
                });
            });
        });
    });

    describe('#getAllRoles()', function() {

        it('verify invalid principal uuid error', function(callback) {
            AuthzAPI.getAllRoles('not a uuid', 'c:cam:Foo.docx', function(err, roles) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it('verify non-principal uuid error', function(callback) {
            AuthzAPI.getAllRoles('c:cam:mrvisser', 'c:cam:Foo.docx', function(err, roles) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it('verify invalid resource uuid error', function(callback) {
            AuthzAPI.getAllRoles('u:cam:mrvisser', 'not a uuid', function(err, roles) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it('verify empty data', function(callback) {
            var userUuid = AuthzUtil.toUuid('u', 'gar-empty', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid('c', 'gar-empty', 'SomeContent');
            AuthzAPI.getAllRoles(userUuid, resourceUuid, function(err, roles) {
                assert.ok(!err);
                assert.equal(_.keys(roles).length, 0);
                callback();
            });
        });

        it('verify direct single role association', function(callback) {
            var userUuid = AuthzUtil.toUuid('u', 'gar-direct', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid('c', 'gar-direct', 'SomeContent');
            AuthzAPI.applyRoleChanges(resourceUuid, makeChange(userUuid, 'viewer'), function(err) {
                assert.ok(!err);
                AuthzAPI.getAllRoles(userUuid, resourceUuid, function(err, roles) {
                    assert.ok(!err);
                    assert.equal(_.keys(roles).length, 1);
                    assert.ok(roles['viewer']);
                    callback();
                });
            });
        });

        it('verify indirect single role association', function(callback) {
            var groupUuid = AuthzUtil.toUuid('g', 'gar-indirect-one', 'oae-team');
            var userUuid = AuthzUtil.toUuid('u', 'gar-indirect-one', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid('c', 'gar-indirect-one', 'SomeContent');

            AuthzAPI.applyGroupMembershipChanges(groupUuid, makeChange(userUuid, 'member'), function(err) {
                assert.ok(!err);
                AuthzAPI.applyRoleChanges(resourceUuid, makeChange(groupUuid, 'viewer'), function(err) {
                    assert.ok(!err);
                    AuthzAPI.getAllRoles(userUuid, resourceUuid, function(err, roles) {
                        assert.ok(!err);
                        assert.equal(_.keys(roles).length, 1);
                        assert.ok(roles['viewer']);
                        callback();
                    });
                });
            });
        });

        it('verify indirect two role association', function(callback) {
            var groupUuid = AuthzUtil.toUuid('g', 'gar-indirect-one', 'oae-team');
            var userUuid = AuthzUtil.toUuid('u', 'gar-indirect-one', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid('c', 'gar-indirect-one', 'SomeContent');

            AuthzAPI.applyGroupMembershipChanges(groupUuid, makeChange(userUuid, 'member'), function(err) {
                assert.ok(!err);
                var changes = {};
                changes[groupUuid] = 'viewer';
                changes[userUuid] = 'editor';
                AuthzAPI.applyRoleChanges(resourceUuid, changes, function(err) {
                    assert.ok(!err);
                    AuthzAPI.getAllRoles(userUuid, resourceUuid, function(err, roles) {
                        assert.ok(!err);
                        assert.equal(_.keys(roles).length, 2);
                        assert.ok(roles['viewer']);
                        assert.ok(roles['editor']);
                        callback();
                    });
                });
            });
        });

        it('verify multi-indirect two role association', function(callback) {
            var groupUuid1 = AuthzUtil.toUuid('g', 'ia-multi', 'oae-team');
            var groupUuid2 = AuthzUtil.toUuid('g', 'ia-multi', 'oae-backend-team');
            var userUuid = AuthzUtil.toUuid('u', 'ia-multi', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid('c', 'ia-multi', 'SomeContent');

            AuthzAPI.applyGroupMembershipChanges(groupUuid1, makeChange(userUuid, 'member'), function(err) {
                assert.ok(!err);
                AuthzAPI.applyGroupMembershipChanges(groupUuid2, makeChange(userUuid, 'member'), function(err) {
                    assert.ok(!err);
                    AuthzAPI.applyRoleChanges(resourceUuid, makeChange(groupUuid1, 'viewer'), function(err) {
                        assert.ok(!err);
                        AuthzAPI.applyRoleChanges(resourceUuid, makeChange(groupUuid2, 'manager'), function(err) {
                            assert.ok(!err);
                            AuthzAPI.getAllRoles(userUuid, resourceUuid, function(err, roles) {
                                assert.ok(!err);
                                assert.equal(_.keys(roles).length, 2);
                                assert.ok(roles['viewer']);
                                assert.ok(roles['manager']);
                                callback();
                            });
                        });
                    });
                });
            });
        });

        it('verify circular group hierarchy three role association', function(callback) {
            var groupUuid1 = AuthzUtil.toUuid('g', 'ia-circ', 'oae-team');
            var groupUuid2 = AuthzUtil.toUuid('g', 'ia-circ', 'oae-backend-team');
            var groupUuid3 = AuthzUtil.toUuid('g', 'ia-circ', 'oae-ui-team');
            var userUuid = AuthzUtil.toUuid('u', 'ia-circ', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid('c', 'ia-circ', 'SomeContent');
            AuthzAPI.applyGroupMembershipChanges(groupUuid1, makeChange(userUuid, 'member'), function(err) {
                assert.ok(!err);
                AuthzAPI.applyGroupMembershipChanges(groupUuid2, makeChange(groupUuid1, 'member'), function(err) {
                    assert.ok(!err);
                    AuthzAPI.applyGroupMembershipChanges(groupUuid3, makeChange(groupUuid2, 'member'), function(err) {
                        assert.ok(!err);
                        AuthzAPI.applyGroupMembershipChanges(groupUuid1, makeChange(groupUuid3, 'member'), function(err) {
                            assert.ok(!err);
                            AuthzAPI.applyRoleChanges(resourceUuid, makeChange(groupUuid1, 'viewer'), function(err) {
                                assert.ok(!err);
                                AuthzAPI.applyRoleChanges(resourceUuid, makeChange(groupUuid2, 'manager'), function(err) {
                                    assert.ok(!err);
                                    AuthzAPI.applyRoleChanges(resourceUuid, makeChange(groupUuid3, 'editor'), function(err) {
                                        assert.ok(!err);
                                        AuthzAPI.getAllRoles(userUuid, resourceUuid, function(err, roles) {
                                            assert.ok(!err);
                                            assert.equal(_.keys(roles).length, 3);
                                            assert.ok(roles['viewer']);
                                            assert.ok(roles['manager']);
                                            assert.ok(roles['editor']);
                                            callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
    
    describe('#hasRole()', function() {

        it('verify negative check without any roles', function(callback) {
            var principalUuid = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRoleWithout', 'mrvisser');
            AuthzAPI.hasRole(principalUuid, 'c:cam:nonExistent', 'manager', function(err, hasRole) {
                assert.ok(!err);
                assert.ok(!hasRole);
                callback();
            });
        });

        it('verify positive check with a role', function(callback) {
            var principalUuid = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRole', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid(ResourceTypes.CONTENT, 'testHasRole', 'testHasRoleContent');
            
            // add the 'manager' role
            AuthzAPI.applyRoleChanges(resourceUuid, makeChange(principalUuid, 'manager'), function(err) {
                assert.ok(!err);

                // verify that hasRole reports that the user has the manager role
                AuthzAPI.hasRole(principalUuid, resourceUuid, 'manager', function(err, hasRole) {
                    assert.ok(!err);
                    assert.ok(hasRole);
                    callback();
                });
            });
        });

        it('verify negative check when role has been removed', function(callback) {
            var principalUuid = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRole', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid(ResourceTypes.CONTENT, 'testHasRole', 'testHasRoleContent');
            // add the 'manager' role
            AuthzAPI.applyRoleChanges(resourceUuid, makeChange(principalUuid, 'manager'), function(err) {
                assert.ok(!err);

                // verify that hasRole reports that the user has the manager role
                AuthzAPI.hasRole(principalUuid, resourceUuid, 'manager', function(err, hasRole) {
                    assert.ok(!err);
                    assert.ok(hasRole);

                    // remove the role from the user
                    AuthzAPI.applyRoleChanges(resourceUuid, makeChange(principalUuid, false), function(err) {
                        assert.ok(!err);

                        // verify that the user no longer has the role
                        AuthzAPI.hasRole(principalUuid, resourceUuid, 'manager', function(err, hasRole) {
                            assert.ok(!err);
                            assert.ok(!hasRole);
                            callback();
                        });
                    });
                });
            });
        });
    });

    describe('#applyRoleChanges()', function() {

        it('verify update existing role', function(callback) {
            var principalUuid = AuthzUtil.toUuid(PrincipalTypes.USER, 'testUpdateRole', 'mrvisser');
            var resourceUuid = AuthzUtil.toUuid(ResourceTypes.CONTENT, 'testUpdateRole', 'Foo.docx');

            // 1. set role to viewer and sanity check
            AuthzAPI.applyRoleChanges(resourceUuid, makeChange(principalUuid, 'viewer'), function(err) {
                assert.ok(!err);
                AuthzAPI.hasRole(principalUuid, resourceUuid, 'viewer', function(err, hasRole) {
                    assert.ok(!err);
                    assert.ok(hasRole);
                    AuthzAPI.applyRoleChanges(resourceUuid, makeChange(principalUuid, 'manager'), function(err) {
                        assert.ok(!err);
                        AuthzAPI.hasRole(principalUuid, resourceUuid, 'manager', function(err, hasRole) {
                            assert.ok(!err);
                            assert.ok(hasRole);
                            callback();
                        });
                    });
                });
            });
        });

        it('verify general functionality', function(callback) {
            var principalUuid1 = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRole', 'mrvisser');
            var principalUuid2 = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRole', 'nm417');
            var principalUuid3 = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRole', 'simong');
            var principalUuid4 = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRole', 'PhysX');
            var resourceUuid1 = AuthzUtil.toUuid(ResourceTypes.CONTENT, 'testHasRole', 'testHasRoleContent1');
            var resourceUuid2 = AuthzUtil.toUuid(ResourceTypes.CONTENT, 'testHasRole', 'testHasRoleContent2');
            var resourceUuid3 = AuthzUtil.toUuid(ResourceTypes.CONTENT, 'testHasRole', 'testHasRoleContent3');

            // Make 1 user a manager
            var roles = {};
            roles[principalUuid1] = 'manager';
            AuthzAPI.applyRoleChanges(resourceUuid1, roles, function(err) {
                assert.ok(!err);
                AuthzAPI.hasRole(principalUuid1, resourceUuid1, 'manager', function(err, hasRole) {
                    assert.ok(!err);
                    assert.ok(hasRole);
                    AuthzAPI.hasRole(principalUuid2, resourceUuid1, 'manager', function(err, hasRole) {
                        assert.ok(!err);
                        assert.ok(!hasRole);

                        // Make 2 users a manager
                        roles = {};
                        roles[principalUuid1] = 'manager';
                        roles[principalUuid2] = 'manager';
                        AuthzAPI.applyRoleChanges(resourceUuid2, roles, function(err) {
                            assert.ok(!err);
                            AuthzAPI.hasRole(principalUuid1, resourceUuid2, 'manager', function(err, hasRole) {
                                assert.ok(!err);
                                assert.ok(hasRole);
                                AuthzAPI.hasRole(principalUuid2, resourceUuid2, 'manager', function(err, hasRole) {
                                    assert.ok(!err);
                                    assert.ok(hasRole);

                                    // Make 2 users a manager, 1 a member
                                    roles = {};
                                    roles[principalUuid1] = 'manager';
                                    roles[principalUuid2] = 'manager';
                                    roles[principalUuid3] = 'member';
                                    AuthzAPI.applyRoleChanges(resourceUuid3, roles, function(err) {
                                        assert.ok(!err);
                                        AuthzAPI.hasRole(principalUuid1, resourceUuid3, 'manager', function(err, hasRole) {
                                            assert.ok(!err);
                                            assert.ok(hasRole);
                                            AuthzAPI.hasRole(principalUuid2, resourceUuid3, 'manager', function(err, hasRole) {
                                                assert.ok(!err);
                                                assert.ok(hasRole);
                                                AuthzAPI.hasRole(principalUuid3, resourceUuid3, 'member', function(err, hasRole) {
                                                    assert.ok(!err);
                                                    assert.ok(hasRole);
                                                    AuthzAPI.hasRole(principalUuid4, resourceUuid3, 'member', function(err, hasRole) {
                                                        assert.ok(!err);
                                                        assert.ok(!hasRole);

                                                        // Try to remove 1 role
                                                        roles = {};
                                                        roles[principalUuid3] = false;
                                                        AuthzAPI.applyRoleChanges(resourceUuid3, roles, function(err) {
                                                            assert.ok(!err);
                                                            AuthzAPI.hasRole(principalUuid1, resourceUuid3, 'manager', function(err, hasRole) {
                                                                assert.ok(!err);
                                                                assert.ok(hasRole);
                                                                AuthzAPI.hasRole(principalUuid3, resourceUuid3, 'member', function(err, hasRole) {
                                                                    assert.ok(!err);
                                                                    assert.ok(!hasRole);

                                                                    // Try to remove 2 roles and add 1 at the same time
                                                                    roles = {};
                                                                    roles[principalUuid1] = false;
                                                                    roles[principalUuid2] = false;
                                                                    roles[principalUuid3] = 'manager';
                                                                    AuthzAPI.applyRoleChanges(resourceUuid3, roles, function(err) {
                                                                        assert.ok(!err);
                                                                        AuthzAPI.hasRole(principalUuid1, resourceUuid3, 'manager', function(err, hasRole) {
                                                                            assert.ok(!err);
                                                                            assert.ok(!hasRole);
                                                                            AuthzAPI.hasRole(principalUuid2, resourceUuid3, 'member', function(err, hasRole) {
                                                                                assert.ok(!err);
                                                                                assert.ok(!hasRole);
                                                                                AuthzAPI.hasRole(principalUuid3, resourceUuid3, 'manager', function(err, hasRole) {
                                                                                    assert.ok(!err);
                                                                                    assert.ok(hasRole);
                                                                                    callback();
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        it('verify validation', function(callback) {
            var principalUuid1 = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRole', 'mrvisser');
            var principalUuid2 = AuthzUtil.toUuid(PrincipalTypes.USER, 'testHasRole', 'nm417');
            var resourceUuid1 = AuthzUtil.toUuid(ResourceTypes.CONTENT, 'testHasRole', 'testHasRoleContent1');

            var roles = {};
            roles[principalUuid1] = 'manager';
            roles[principalUuid2] = 'manager';
            // Try applyRoleChanges without resourceId
            AuthzAPI.applyRoleChanges(null, roles, function(err) {
                assert.ok(err);
                // Try applyRolesChanges with empty roles
                AuthzAPI.applyRoleChanges(resourceUuid1, {}, function(err) {
                    assert.ok(err);
                    callback();
                });
            });
        });

    });

    describe('#getRolesForPrincipalsAndResourceType()', function() {
        it('verify general functionality', function(callback) {
            var baseViewerContentId = 'contentIView';
            var baseManagerContentId = 'contentIManage';
            var principalUuid1 = AuthzUtil.toUuid(PrincipalTypes.USER, 'testGetRolesForPrincipalsAndResourceType', 'mrvisser');
            var principalUuid2 = AuthzUtil.toUuid(PrincipalTypes.GROUP, 'testGetRolesForPrincipalsAndResourceType', 'simong');

            // mrvisser has 'viewer' role on a bunch of groups
            loadContentRoles(principalUuid1, baseViewerContentId, ResourceTypes.CONTENT, 300, 'viewer', function() {

                // simong has 'manager' role on some of the groups that mrvisser has 'viewer' on. this is to test aggregation of roles
                loadContentRoles(principalUuid2, baseViewerContentId, ResourceTypes.CONTENT, 50, 'manager', function() {

                    // simong has 'manager' role on a bunch of groups
                    loadContentRoles(principalUuid2, baseManagerContentId, ResourceTypes.CONTENT, 300, 'manager', function() {

                        // make sure they work together
                        AuthzAPI.getRolesForPrincipalsAndResourceType([principalUuid1, principalUuid2], ResourceTypes.CONTENT, 1000, function(err, entries) {
                            assert.ok(!err);

                            // simong is a member of 350, mrvisser is a member of 300, but 50 of those overlap, so should be 600 unique entries
                            assert.equal(Object.keys(entries).length, 600);

                            // verify that for the 50 overlapping content items, both 'manager' and 'viewer' are present
                            for (var i = 1; i <= 50; i++) {
                                var resourceUuid = 'c:testGetRolesForPrincipalsAndResourceType:'+baseViewerContentId+'-'+i;
                                assert.ok(entries[resourceUuid]['manager'], 'Expected the "manager" role to be available on each overlapping content item.');
                                assert.ok(entries[resourceUuid]['viewer'], 'Expected the "viewer" role to be available on each overlapping content item.');
                            }


                            // make sure they work individually
                            AuthzAPI.getRolesForPrincipalsAndResourceType([principalUuid1], ResourceTypes.CONTENT, 1000, function(err, entries) {
                                assert.ok(!err);
                                assert.equal(Object.keys(entries).length, 300);

                                AuthzAPI.getRolesForPrincipalsAndResourceType([principalUuid2], ResourceTypes.CONTENT, 1000, function(err, entries) {
                                    assert.ok(!err);
                                    assert.equal(Object.keys(entries).length, 350);

                                    // test per-principal limitations
                                    AuthzAPI.getRolesForPrincipalsAndResourceType([principalUuid1, principalUuid2], ResourceTypes.CONTENT, 100, function(err, entries) {
                                        assert.ok(!err);
                                        assert.equal(Object.keys(entries).length, 200);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        it('verify validation', function(callback) {
            var principalUuid1 = AuthzUtil.toUuid(PrincipalTypes.USER, 'testGetRolesForPrincipalsAndResourceType', 'mrvisser');
            // Try it with no provided principals
            AuthzAPI.getRolesForPrincipalsAndResourceType(null, ResourceTypes.CONTENT, 1000, function(err, entries) {
                assert.ok(err);
                assert.ok(!entries);
                // Try it with no resource type
                AuthzAPI.getRolesForPrincipalsAndResourceType([principalUuid1], null, 1000, function(err, entries) {
                    assert.ok(err);
                    assert.ok(!entries);
                    callback();
                });
            });
        });

    });
});
