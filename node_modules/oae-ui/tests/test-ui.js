/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');

var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var TestsUtil = require('oae-tests');
var UIConstants = require('oae-ui/lib/constants').UIConstants;


describe('UI', function() {

    // Rest context that can be used every time we need to make a request as an anonymous user to the cambridge tenant
    var anonymousCamRestContext = null;
    // Rest context that can be used every time we need to make a request as an anonymous user to the cambridge tenant
    var anonymousGTRestContext = null;
    // Rest context that can be used for anonymous requests on the global tenant
    var anonymousGlobalRestContext = null;
    // Rest context that can be used for authenticated requests on the global tenant
    var globalAdminRestContext = null;

    /**
     * Function that will fill up the anonymous tenant and global REST context
     */
    before(function(callback) {
        // Fill up anonymous rest contexts
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        anonymousGTRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host);
        // Fill up the anonymous global rest context
        anonymousGlobalRestContext = TestsUtil.createGlobalRestContext();
        // Fill up the authenticated global rest context
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
        // Fill up the cambridge administrator rest context
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        callback();
    });

    describe('Widget config aggregation', function() {

        /**
         * Test that verifies that the aggregated widget configs can be retrieved
         */
        it('verify widget configs', function(callback) {
            // Get the widget configs on the global admin server
            RestAPI.UI.getWidgetManifests(anonymousGlobalRestContext, function(err, data) {
                assert.ok(!err);
                assert.ok(data['topnavigation']);
                assert.equal(data['topnavigation'].id, 'topnavigation');
                assert.equal(data['topnavigation'].path, 'oae-core/topnavigation/');
                assert.ok(data['topnavigation']['i18n']);

                // Get the widget configs on the tenant server
                RestAPI.UI.getWidgetManifests(anonymousCamRestContext, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data['topnavigation']);
                    assert.equal(data['topnavigation'].id, 'topnavigation');
                    assert.equal(data['topnavigation'].path, 'oae-core/topnavigation/');
                    assert.ok(data['topnavigation']['i18n']);
                    callback();
                });
            });
        });
    });

    describe('Batch static files', function() {

        /**
         * Test that verifies that static files can be batch requested
         */
        it('verify batch static get', function(callback) {
            var files = ['/ui/index.html', '/node_modules/oae-core/footer/js/footer.js', '/nonexisting'];
            // Get these files on the global admin server
            RestAPI.UI.getStaticBatch(anonymousGlobalRestContext, files, function(err, batch1) {
                assert.ok(!err);
                assert.equal(_.keys(batch1).length, 3);
                // Verify that the /ui/index.html file is present
                assert.ok(batch1[files[0]]);
                assert.equal(typeof batch1[files[0]], 'string');
                // Verify that the /node_modules/oae-core/footer/js/footer.js file is present
                assert.ok(batch1[files[1]]);
                assert.equal(typeof batch1[files[1]], 'string');
                // Verify that the /nonexisting file is not present
                assert.equal(batch1[files[2]], null);

                // Get these files on the tenant server
                RestAPI.UI.getStaticBatch(anonymousCamRestContext, files, function(err, batch2) {
                    assert.ok(!err);
                    assert.equal(_.keys(batch2).length, 3);
                    // Verify that the /ui/index.html file is present
                    assert.ok(batch2[files[0]]);
                    assert.equal(typeof batch2[files[0]], 'string');
                    // Verify that the /node_modules/oae-core/footer/js/footer.js file is present
                    assert.ok(batch2[files[1]]);
                    assert.equal(typeof batch2[files[1]], 'string');
                    // Verify that the /nonexisting file is not present
                    assert.equal(batch2[files[2]], null);
                    // Make sure that the files from batch1 and batch2 are the same
                    assert.equal(batch1[files[0]], batch2[files[0]]);
                    assert.equal(batch1[files[1]], batch2[files[1]]);

                    // Do another set of batch requests with some of the same files, to make sure they are being server from cache
                    files = ['/node_modules/oae-core/footer/css/footer.css', '/ui/index.html'];
                    // Get these files on the global admin server
                    RestAPI.UI.getStaticBatch(anonymousGlobalRestContext, files, function(err, batch3) {
                        assert.ok(!err);
                        assert.equal(_.keys(batch3).length, 2);
                        // Verify that the /ui/index.html file is present
                        assert.ok(batch3[files[0]]);
                        assert.equal(typeof batch3[files[0]], 'string');
                        // Verify that the /node_modules/oae-core/footer/js/footer.js file is present
                        assert.ok(batch3[files[1]]);
                        assert.equal(typeof batch3[files[1]], 'string');
                        // Make sure that /ui/index.html has the same content in both batches
                        assert.equal(batch3['/ui/index.html'], batch1['/ui/index.html']);

                        // Get these files on the tenant server
                        RestAPI.UI.getStaticBatch(anonymousCamRestContext, files, function(err, batch4) {
                            assert.ok(!err);
                            assert.equal(_.keys(batch4).length, 2);
                            // Verify that the /ui/index.html file is present
                            assert.ok(batch4[files[0]]);
                            assert.equal(typeof batch4[files[0]], 'string');
                            // Verify that the /node_modules/oae-core/footer/js/footer.js file is present
                            assert.ok(batch4[files[1]]);
                            assert.equal(typeof batch4[files[1]], 'string');
                            // Make sure that /ui/index.html has the same content in both batches
                            assert.equal(batch4['/ui/index.html'], batch2['/ui/index.html']);
                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a single file can be retrieved through a batch request
         */
        it('verify batch single file', function(callback) {
            var file = '/ui/index.html';
            // Test this on the global admin server
            RestAPI.UI.getStaticBatch(anonymousGlobalRestContext, file, function(err, data) {
                assert.ok(!err);
                assert.equal(_.keys(data).length, 1);
                assert.ok(data[file]);
                assert.equal(typeof data[file], 'string');

                // Test this on the tenant server
                RestAPI.UI.getStaticBatch(anonymousCamRestContext, file, function(err, data) {
                    assert.ok(!err);
                    assert.equal(_.keys(data).length, 1);
                    assert.ok(data[file]);
                    assert.equal(typeof data[file], 'string');
                    callback();
                });
            });
        });

        /**
         * Test that verifies that requesting an empty set of static files fails
         */
        it('verify validation', function(callback) {
            // Test on the global admin server
            RestAPI.UI.getStaticBatch(anonymousGlobalRestContext, null, function(err, data) {
                assert.ok(err);
                assert.equal(err.code, 400);
                assert.ok(!data);
                RestAPI.UI.getStaticBatch(anonymousGlobalRestContext, [], function(err, data) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    assert.ok(!data);
                    // Verify that only absolute paths can be used, and no private
                    // server files can be retrieved
                    var file = '/../Hilary/config.js';
                    RestAPI.UI.getStaticBatch(anonymousGlobalRestContext, file, function(err, data) {
                        assert.ok(err);
                        assert.equal(err.code, 400);
                        assert.ok(!data);

                        // Test on the tenant server
                        RestAPI.UI.getStaticBatch(anonymousCamRestContext, null, function(err, data) {
                            assert.ok(err);
                            assert.equal(err.code, 400);
                            assert.ok(!data);
                            RestAPI.UI.getStaticBatch(anonymousCamRestContext, [], function(err, data) {
                                assert.ok(err);
                                assert.equal(err.code, 400);
                                assert.ok(!data);
                                // Verify that only absolute paths can be used, and no private
                                // server files can be retrieved
                                RestAPI.UI.getStaticBatch(anonymousGlobalRestContext, file, function(err, data) {
                                    assert.ok(err);
                                    assert.equal(err.code, 400);
                                    assert.ok(!data);
                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Skinning', function() {

        /**
         * Reset any modifications we do to the skin.
         */
        beforeEach(function(callback) {
            RestAPI.Config.updateConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-ui/skin/variables', '{"body-background-color": "#eceae5"}', function(err) {
                assert.ok(!err);
                callback();
            });
        });

        /**
         * Checks if the output from the skin api is correct.
         * It verifies:
         *  * a 200
         *  * text/css header
         *  * minified css
         *  * The value for the body background color
         *
         * @param  {RestContext}    restCtx                 The RestContext to use.
         * @param  {String}         expectedBackgroundColor The background color we expect in the skin file for the body selector.
         * @param  {Function}       callback                Standard callback method.
         * @api private
         */
        var checkSkin = function(restCtx, expectedBackgroundColor, callback) {
            RestAPI.UI.getSkin(restCtx, function(err, css, response) {
                assert.ok(!err);
                // We should get back some CSS.
                assert.ok(css);
                assert.equal(response.headers['content-type'], 'text/css');

                // Should be minified, so no comments or linebreaks
                assert.equal(css.indexOf('\n'), -1);
                assert.equal(css.indexOf('/*'), -1);

                // Check the background color.
                var bodyBackgroundColorRegex = new RegExp('body\{background-color:#([0-9a-zA-Z]+)\}');
                var match = css.match(bodyBackgroundColorRegex);
                assert.ok(match);
                assert.equal(match[1], expectedBackgroundColor);
                callback();
            });
        };

        /**
         * Updates the skin for the cambridge tenant with the `skinConfig` value and check the skin.
         * The GT skin will be checked for no changes.
         *
         * @param  {RestContext}    restCtx                     The RestContext to use.
         * @param  {Object}         skinConfig                  The value that should be posted to the admin config.
         * @param  {String}         expectedOldBackgroundColor  The background color we expect in the skin file for the body selector.
         * @param  {String}         expectedNewBackgroundColor  The background color we expect in the skin file for the body selector.
         * @param  {Function}       callback                    Standard callback method.
         * @api private
         */
        var updateSkinAndCheck = function(restCtx, skinConfig, expectedOldBackgroundColor, expectedNewBackgroundColor, callback) {
            // Sanity-check correct parsing
            checkSkin(anonymousCamRestContext, expectedOldBackgroundColor, function() {

                // Update the cambridge skin.
                RestAPI.Config.updateConfig(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-ui/skin/variables', skinConfig, function(err) {
                    assert.ok(!err);

                    // Check the skin for the new value.
                    checkSkin(anonymousCamRestContext, expectedNewBackgroundColor, function() {

                        // Check the GT skin is unchanged.
                        checkSkin(anonymousGTRestContext, 'eceae5', callback);
                    });
                });
            });
        };

        /**
         * Gets the skin variables for a tenant and checks the structure.
         *
         * @param  {String}   tenantAlias               The alias of the tenant for which the skin variables should be checked.
         * @param  {String}   expectedBackgroundColor   The expected value for the body background color variable.
         * @param  {Function} callback                  Standard callback method.
         * @api private
         */
        var checkVariables = function(tenantAlias, expectedBackgroundColor, callback) {
            RestAPI.Admin.getSkinVariables(globalAdminRestContext, tenantAlias, function(err, data) {
                assert.ok(!err);
                // Verify the structure.
                assert.ok(data.result);
                assert.ok(data.result.length > 0);
                assert.equal(data.result[0].name, 'Page background color');
                assert.ok(data.result[0].variables.length > 0);
                assert.equal(data.result[0].variables[0].type, UIConstants.variables.types.COLOR);
                assert.equal(data.result[0].variables[0].value, expectedBackgroundColor);
                callback();
            });
        };

        /*
         * Updating the config should result in a change in the skin.
         */
        it('verify updating the skin', function(callback) {
            updateSkinAndCheck(anonymousCamRestContext, '{"body-background-color": "#123456"}', 'eceae5', '123456', callback);
        });

        /*
         * Submitting incorrect CSS values should not break the CSS skin generation.
         */
        it('verify that submitting incorrect CSS values does not break skinning', function(callback) {
            updateSkinAndCheck(anonymousCamRestContext, '{"body-background-color": "}"}', 'eceae5', 'eceae5', callback);
        });

        /**
         * As it's possible for an admin to submit whatever they want,
         * the skin generation should not break if the submitted value is not JSON.
         */
        it('verify that submitting incorrect JSON does not break skinning', function(callback) {
            updateSkinAndCheck(anonymousCamRestContext, 'totally not JSON', 'eceae5', 'eceae5', callback);
        });

        /*
         * When submitting skin values with keys that are not used,
         * this should not break skin generation.
         */
        it('verify that submitting unused key does not break skinning', function(callback) {
            updateSkinAndCheck(anonymousCamRestContext, '{"not-used": "foo"}', 'eceae5', 'eceae5', callback);
        });

        /*
         * Submitting incorrect JSON, should not result in improper variables retrieval
         */
        it('verify that submitting incorrect JSON does not break variables retrieval', function(callback) {
            updateSkinAndCheck(anonymousCamRestContext, 'totally not JSON', 'eceae5', 'eceae5', function() {
                // Check the variables.
                checkVariables(global.oaeTests.tenants.cam.alias, undefined, callback);
            });
        });

        /*
         * When you update the config with new skin values,
         * these should be returned in the variables endpoint.
         */
        it('verify that variables get updated with values from the config', function(callback) {
            // Sanity check the default value.
            checkVariables(global.oaeTests.tenants.cam.alias, '#eceae5', function() {
                // Update the skin.
                updateSkinAndCheck(anonymousCamRestContext, '{"body-background-color": "#123456"}', 'eceae5', '123456', function() {
                    // Check if the value is updated in the variables feed.
                    checkVariables(global.oaeTests.tenants.cam.alias, '#123456', callback);
                });
            });
        });

        /*
         * Only admins should be able to retrieve skin variables.
         */
        it('verify only administrators can retrieve skin variabes', function(callback) {
            RestAPI.Admin.getSkinVariables(anonymousGlobalRestContext, global.oaeTests.tenants.cam.alias, function(err, data) {
                assert.equal(err.code, 401);
                RestAPI.Admin.getSkinVariables(anonymousCamRestContext, global.oaeTests.tenants.cam.alias, function(err, data) {
                    assert.equal(err.code, 401);
                    RestAPI.Admin.getSkinVariables(globalAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, data) {
                        assert.ok(!err);
                        RestAPI.Admin.getSkinVariables(camAdminRestContext, global.oaeTests.tenants.cam.alias, function(err, data) {
                            assert.ok(!err);
                            callback();
                        });
                    });
                });
            });
        });
    });
});
