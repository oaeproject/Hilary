/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 * 
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
var _ = require('underscore');

var AuthzAPI = require('oae-authz');
var AuthzUtil = require('oae-authz/lib/util');

var getAllAuthzMembersByRole = module.exports.getAllAuthzMembersByRole = function(resourceId, callback) {
    AuthzAPI.getAuthzMembers(resourceId, null, 10000, function(err, members) {
        if (err) {
            return callback(err);
        }

        var membersByRole = {};
        var groupMembersByRole = {};

        // Gather the direct membersByRole and aggregate the groupMembersByRole so we can get their descendants
        for (var i = 0; i < members.length; i++) {
            var member = members[i];
            var id = member.id;
            var role = member.role;
            membersByRole[role] = membersByRole[role] || [];
            membersByRole[role].push(id);
            if (AuthzUtil.isGroupId(id)) {
                groupMembersByRole[role] = groupMembersByRole[role] || [];
                groupMembersByRole[role].push(id);  
            }
        }

        // Merge the descendants by role of all the group members descendants
        _getAllAuthzGroupMembersByRole(groupMembersByRole, function(err, indirectMembersByRole) {
            if (err) {
                return callback(err);
            }

            var roles = _.keys(indirectMembersByRole);
            for (var i = 0; i < roles.length; i++) {
                var role = roles[i];
                membersByRole[role] = _.uniq(_.union(membersByRole[role], indirectMembersByRole[role]));
            }

            // At this point groupMembersByRole holds a hash of all direct and indirect group members of the content, keyed by their role
            return callback(null, membersByRole);
        });
    });
};

var _getAllAuthzGroupMembersByRole = function(groupRoles, callback, membersByRole) {
    membersByRole = membersByRole || {};
    var roles = _.keys(groupRoles);
    if (roles.length === 0) {
        return callback(null, membersByRole);
    }

    // Take the first list of groups to operate on and delete it from the hash for recursion
    var role = roles[0];
    var groupIds = groupRoles[role];
    delete groupRoles[role];

    // Collect all the member descendents of current set of groups
    _getAllAuthzMembers(groupIds, function(err, members) {
        if (err) {
            return callback(err);
        }

        membersByRole[role] = members;
        return _getAllAuthzGroupMembersByRole(groupRoles, callback, membersByRole);
    });
};

var _getAllAuthzMembers = function(groupIds, callback, aggregatedMembers) {
    aggregatedMembers = aggregatedMembers || {};
    if (groupIds.length === 0) {
        return callback(null, _.keys(aggregatedMembers));
    }

    var groupId = groupIds.shift();
    AuthzAPI.getAuthzMembers(groupId, null, 10000, function(err, members) {
        if (err) {
            return callback(err);
        }

        // Aggregate the memberIds
        for (var i = 0; i < members.length; i++) {
            var memberId = members[i].id;
            if (!aggregatedMembers[memberId] && AuthzUtil.isGroupId(memberId) && _.contains(groupIds, memberId)) {
                // If this is a group and we have not aggregated it yet, add it to the groupIds
                groupIds.push(memberId);
            }

            // Aggregate the member's id
            aggregatedMembers[memberId] = true;
        }

        return _getAllAuthzMembers(groupIds, callback, aggregatedMembers);
    });
}
