/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');
var fs = require('fs');
var gm = require('gm');
var Path = require('path');

var ImageUtil = require('oae-util/lib/image');

/**
 * Most of the tests in this suite don't actually crop or resize anything.
 * Those bits of code get tested via the oae-principals/tests/test-cropping suite.
 */
describe('Image', function() {

    var generateArea = function(x, y, width, height) {
        return {
            'x': x,
            'y': y,
            'width': width,
            'height': height
        };
    };

    var generateSize = function(width, height) {
        return {
            'width': width,
            'height': height
        };
    };


    describe('#cropImage()', function() {

        /**
         * Test that verifies that the parameters get validated
         */
        it('verify parameter validation', function(callback) {
            ImageUtil.cropImage(undefined, generateArea(10, 10, 200, 200), function(err) {
                assert.equal(err.code, 400);
                ImageUtil.cropImage('some/path', generateArea(undefined, 10, 200, 200), function(err) {
                    assert.equal(err.code, 400);
                    ImageUtil.cropImage('some/path', generateArea(10, undefined, 200), function(err) {
                        assert.equal(err.code, 400);
                        ImageUtil.cropImage('some/path', generateArea(10, 10, undefined, 200), function(err) {
                            assert.equal(err.code, 400);
                            ImageUtil.cropImage('some/path', generateArea(10, 10, 200, undefined), function(err) {
                                assert.equal(err.code, 400);

                                // Verify you can't crop outside the image
                                var path = Path.resolve(__dirname + '/data/right.jpg');
                                ImageUtil.cropImage(path, generateArea(10000, 10000, 10, 10), function(err, file) {
                                    assert.equal(err.code, 400);

                                    // Sanity check
                                    ImageUtil.cropImage(path, generateArea(10, 10, 10, 10), function(err, file) {
                                        assert.ok(!err, JSON.stringify(err, null, 4));
                                        assert.ok(file);
                                        assert.ok(file.path);
                                        assert.ok(fs.existsSync(file.path));
                                        assert.ok(file.name);
                                        assert.ok(file.size > 0);
                                        gm(file.path).size(function (err, size) {
                                            assert.ok(!err);
                                            assert.strictEqual(size.width, 10);
                                            assert.strictEqual(size.height, 10);

                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Ensure that errors are being handled correctly.
         */
        it('verify error handling', function(callback) {
            // Calling cropImage, with a non-existing path should fail.
            ImageUtil.cropImage('some/path', generateArea(10, 10, 200, 200), function(err) {
                assert.equal(err.code, 500);
                callback();
            });
        });
    });

    describe('#resizeImage()', function() {

        /**
         * Simple validation checks.
         */
        it('verify parameter validation', function(callback) {
            ImageUtil.resizeImage(undefined, generateSize(200, 200), function(err) {
                assert.equal(err.code, 400);
                ImageUtil.resizeImage('some/path', generateSize(-10, 200), function(err) {
                    assert.equal(err.code, 400);
                    ImageUtil.resizeImage('some/path', generateSize(10, -200), function(err) {
                        assert.equal(err.code, 400);
                        callback();
                    });
                });
            });
        });

        /**
         * Ensure that errors are being handled correctly.
         */
        it('verify error handling', function(callback) {
            ImageUtil.resizeImage('some/path', generateSize(200, 200), function(err) {
                assert.equal(err.code, 500);
                callback();
            });
        });

        /**
         * Test that will verify the `autoOrient` function.
         */
        it('verify EXIF orientation is obeyed', function(callback) {
            var path = Path.resolve(__dirname + '/data/right.jpg');
            ImageUtil.autoOrient(path, null, function(err, file) {
                assert.ok(!err);
                assert.ok(file);
                assert.ok(file.path);
                assert.ok(file.name);
                assert.ok(file.size > 0);

                // Read the image back out with GM.
                // The image should've been rotated and it's orientation should be fixed.
                gm(file.path).identify(function(err, data) {
                    assert.ok(!err);
                    assert.equal(data.size.width, 480);
                    assert.equal(data.size.height, 640);

                    // The EXIF orientation should be removed.
                    assert.equal(data.Orientation, 'Unknown');
                    callback();
                });
            });
        });
    });

    describe('#cropAndResize()', function(callback) {

        /**
         * Simple validation checks.
         */
        it('verify parameter validation', function(callback) {
            ImageUtil.cropAndResize(undefined, generateArea(0, 0, 200, 200), [generateSize(100, 100)], function(err, files) {
                assert.equal(err.code, 400);
                assert.ok(!files);
                ImageUtil.cropAndResize('some/path', null, [generateSize(100, 100)], function(err, files) {
                    assert.equal(err.code, 400);
                    assert.ok(!files);
                    ImageUtil.cropAndResize('some/path', generateArea(-10, 0, 200, 200), [generateSize(100, 100)], function(err, files) {
                        assert.equal(err.code, 400);
                        assert.ok(!files);
                        ImageUtil.cropAndResize('some/path', generateArea(0, -10, 200, 200), [generateSize(100, 100)], function(err, files) {
                            assert.equal(err.code, 400);
                            assert.ok(!files);
                            ImageUtil.cropAndResize('some/path', generateArea(0, 0, -10, 200), [generateSize(100, 100)], function(err, files) {
                                assert.equal(err.code, 400);
                                assert.ok(!files);
                                ImageUtil.cropAndResize('some/path', generateArea(-10, 0, 200, 200), [generateSize(100, 100)], function(err, files) {
                                    assert.equal(err.code, 400);
                                    assert.ok(!files);
                                    ImageUtil.cropAndResize('some/path', generateArea(10, 0, 200, 200), null, function(err, files) {
                                        assert.equal(err.code, 400);
                                        assert.ok(!files);
                                        ImageUtil.cropAndResize('some/path', generateArea(10, 0, 200, 200), [], function(err, files) {
                                            assert.equal(err.code, 400);
                                            assert.ok(!files);
                                            ImageUtil.cropAndResize('some/path', generateArea(10, 0, 200, 200), [generateSize(-10, 10)], function(err, files) {
                                                assert.equal(err.code, 400);
                                                assert.ok(!files);
                                                ImageUtil.cropAndResize('some/path', generateArea(10, 0, 200, 200), [generateSize(10, -10)], function(err, files) {
                                                    assert.equal(err.code, 400);
                                                    assert.ok(!files);
                                                    // Sanity check.
                                                    var path = Path.resolve(__dirname + '/data/right.jpg');
                                                    ImageUtil.cropAndResize(path, generateArea(10, 0, 10, 10), [generateSize(20, 20)], function(err, files) {
                                                        assert.ok(!err);
                                                        assert.ok(files);
                                                        assert.ok(files['20x20']);
                                                        assert.ok(files['20x20']['path']);
                                                        assert.ok(fs.existsSync(files['20x20']['path']));
                                                        assert.ok(files['20x20']['name']);
                                                        assert.ok(files['20x20']['size'] > 0);
                                                        gm(files['20x20']['path']).size(function (err, size) {
                                                            assert.ok(!err);
                                                            assert.strictEqual(size.width, 20);
                                                            assert.strictEqual(size.height, 20);
                                                            callback();
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('#convertToJPG()', function() {

        /**
         * Test that verifies the parameters are validated
         */
        it('verify parameter validation', function(callback) {
            ImageUtil.convertToJPG(null, function(err, file) {
                assert.equal(err.code, 400);
                assert.ok(!file);
                ImageUtil.convertToJPG('', function(err, file) {
                    assert.equal(err.code, 400);
                    assert.ok(!file);

                    // Non existing files should result in a 500
                    ImageUtil.convertToJPG('non-existing', function(err, file) {
                        assert.equal(err.code, 500);
                        assert.ok(!file);

                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that images get properly converted to JPG
         */
        it('verify images get properly converted to JPG', function(callback) {
            var path = Path.resolve(__dirname + '../../../oae-preview-processor/tests/data/image.gif');
            ImageUtil.convertToJPG(path, function(err, file) {
                assert.ok(!err);
                assert.ok(file);

                // Check it has really been converted to a JPG
                gm(file.path).identify(function(err, data) {
                    assert.ok(!err);
                    assert.equal(data.format, 'JPEG');

                    // Clean up the file
                    fs.unlink(file.path, function(err) {
                        return callback();
                    });
                });
            });
        });
    });
});
