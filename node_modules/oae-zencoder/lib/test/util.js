/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');

var ConfigTestUtil = require('oae-config/lib/test/util');

var ZencoderUtil = require('oae-zencoder/lib/util');

/**
 * Enable the Zencoder configuration for a particular tenant
 *
 * @param  {RestContext}    globalAdminRestContext  The rest context of a global admin who will enable Zencoder
 * @param  {String}         apiKey                  The API key id for the Zencoder requests
 * @param  {Function}       callback                Standard callback function
 */
var enableZencoder = module.exports.enableZencoder = function(globalAdminRestContext, apiKey, callback) {
    var update = {
        'enabled': true,
        'apiKey': apiKey,
        'amazons3-bucket': 'zencoder-bucket',
        'amazons3-region': 'eu-test-1',
        'amazons3-access-key': 'supersecretaccesskey',
        'amazons3-secret-key': 'supersecretsecretkey',
        'watermark': 'http://watermark.image.com'
    };

    ZencoderUtil.init(update);
    return callback();
};

/**
 * Override default configuration with global config
 *
 * @param  {RestContext}    globalAdminRestContext  The rest context of a global admin who will enable Zencoder
 * @param  {Object}         overrides               The global override values
 * @param  {Function}       callback                Standard callback function
 * @throws {AssertionError}                         Thrown if an error occurs trying to configure the tenant
 */
var setGlobalOverrides = module.exports.setGlobalOverrides = function(globalAdminRestContext, overrides, callback) {
    var update = {
        'oae-zencoder/zencoder/enabled': overrides['enabled'],
        'oae-zencoder/zencoder/apiKey': overrides['apiKey'],
        'oae-zencoder/zencoder/amazons3-bucket': overrides['amazons3-bucket'],
        'oae-zencoder/zencoder/amazons3-region': overrides['amazons3-region'],
        'oae-zencoder/zencoder/amazons3-access-key': overrides['amazons3-access-key'],
        'oae-zencoder/zencoder/amazons3-secret-key': overrides['amazons3-secret-key']
    };

    ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, update, function(err) {
        assert.ok(!err);
        return callback();
    });
};

/**
 * Update Zencoder to use a custom API key for a particular tenant
 *
 * @param  {RestContext}    tenantAdminRestContext  The rest context of a tenant admin who will change Zencoder API key
 * @param  {String}         apiKey                  The API key id for the Zencoder requests
 * @param  {Function}       callback                Standard callback function
 * @throws {AssertionError}                         Thrown if an error occurs trying to configure the tenant
 */
var updateApiKey = module.exports.updateApiKey = function(tenantAdminRestContext, apiKey, callback) {
    var update = {
        'oae-zencoder/zencoder/enabled': true,
        'oae-zencoder/zencoder/apiKey': apiKey
    };

    ConfigTestUtil.updateConfigAndWait(tenantAdminRestContext, null, update, function(err) {
        assert.ok(!err);
        return callback();
    });
};

/**
 * Clear Zencoder configuration for a particular tenant
 *
 * @param  {RestContext}    globalAdminRestContext  The rest context of a global admin who will enable Zencoder
 * @param  {String}         tenantAlias             The tenant whose config we want to change
 * @param  {Function}       callback                Standard callback function
 * @throws {AssertionError}                         Thrown if an error occurs trying to configure the tenant
 */
var clearZencoderConfig = module.exports.clearZencoderConfig = function(globalAdminRestContext, tenantAlias, callback) {
    var zencoderFields = [
        'oae-zencoder/zencoder/enabled',
        'oae-zencoder/zencoder/apiKey',
        'oae-zencoder/zencoder/amazons3-bucket',
        'oae-zencoder/zencoder/amazons3-region',
        'oae-zencoder/zencoder/amazons3-access-key',
        'oae-zencoder/zencoder/amazons3-secret-key'
    ];
    ConfigTestUtil.clearConfigAndWait(globalAdminRestContext, tenantAlias, zencoderFields, function(err) {
        assert.ok(!err);
        return callback();
    });
};
