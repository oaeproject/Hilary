/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var passport = require('passport');
var util = require('util');

var log = require('oae-logger').logger('shibboleth');
var OAE = require('oae-util/lib/oae');

var AuthenticationConstants = require('oae-authentication/lib/constants').AuthenticationConstants;
var AuthenticationUtil = require('oae-authentication/lib/util');
var ShibbolethAPI = require('./api');

/**
 * @REST postAuthShibbolethTenant
 *
 * Log in using Shibboleth authentication
 *
 * @Server      tenant
 * @Method      POST
 * @Path        /auth/shibboleth
 * @Return      {void}
 */
OAE.tenantRouter.on('post', '/api/auth/shibboleth', function(req, res, next) {
    if (!ShibbolethAPI.isEnabled(req.tenant.alias)) {
        return res.redirect('/?authentication=disabled');
    }

    // Get the URL to which the user should be redirected and store it in a cookie,
    // so we can retrieve it once the user returns from the identity provider
    var redirectUrl = AuthenticationUtil.validateRedirectUrl(req.param('redirectUrl'));
    res.cookie('redirectUrl', redirectUrl);

    // Redirect the user to our SP host
    var serviceProviderUrl = ShibbolethAPI.getServiceProviderUrl(req.ctx);
    res.redirect(serviceProviderUrl);
});

/**
 * @REST getAuthShibbolethSp
 *
 * Forward the user to the configured identity provider
 *
 * @Api         private
 * @Server      tenant
 * @Method      GET
 * @Path        /auth/shibboleth/sp
 * @QueryParam  {string}                [tenantAlias]         The alias of the tenant on which the user wants to authenticate
 * @QueryParam  {string}                [signature]           The signature for the tenant alias
 * @QueryParam  {number}                [expires]             The timestamp (millis since epoch) at which the signature expires
 * @Return      {void}
 */
OAE.tenantRouter.on('get', '/api/auth/shibboleth/sp', function(req, res, next) {
    if (ShibbolethAPI.getSPHost() !== req.host) {
        return res.send(501, 'This endpoint is not enabled on a regular tenant');
    }

    var tenantAlias = req.query.tenantAlias;
    var signature = req.query.signature;
    var expires = req.query.expires;

    // Validate the parameters
    ShibbolethAPI.validateInitiateParameters(tenantAlias, signature, expires, function(err, tenant) {
        if (err) {
            return res.send(err.code, err.msg);
        }

        // Keep track of the tenant from which the user originated
        res.cookie('shibboleth', tenantAlias, {'signed': true});

        // Get the ID under which this strategy was registered for this tenant
        var strategyId = AuthenticationUtil.getStrategyId(tenant, AuthenticationConstants.providers.SHIBBOLETH);

        // Perform the initial authentication step
        AuthenticationUtil.handleExternalSetup(strategyId, null, req, res, next);
    });
});

/*!
 * The user comes back from the IdP and lands on our service provider endpoint.
 * If authentication was succesful, the user will be redirected to their tenant at
 * `/api/auth/shibboleth/callback`. This endpoint is NOT accessible from the outside world
 */

/**
 * @REST getAuthShibbolethSpCallback
 *
 * Authenticate the user and redirects back to the originating tenant
 *
 * @Api         private
 * @Server      tenant
 * @Method      GET
 * @Path        /auth/shibboleth/sp/callback
 * @Return      {void}
 */
OAE.tenantRouter.on('get', '/api/auth/shibboleth/sp/callback', function(req, res, next) {
    if (ShibbolethAPI.getSPHost() !== req.host) {
        return res.send(501, 'This endpoint is not enabled on a regular tenant');
    }

    // Get the alias of the tenant this user originated from
    var tenantAlias = req.signedCookies.shibboleth;

    // Remove the cookie
    res.clearCookie('shibboleth');

    // Get the full tenant object to allow for the full URL to be constructed
    ShibbolethAPI.getShibbolethEnabledTenant(tenantAlias, function(err, tenant) {
        if (err) {
            return res.send(err.code, err.msg);
        }

        // The base url for the tenant
        var tenantUrl = util.format('https://%s', tenant.host);

        // Get the Shibboleth strategy
        var strategyId = AuthenticationUtil.getStrategyId(tenant, AuthenticationConstants.providers.SHIBBOLETH);

        // Validate and authenticate the request
        passport.authenticate(strategyId, {}, function(err, user, challenges, status) {
            if (err) {
                log().error({'err': err, 'tenantAlias': tenantAlias}, 'Error during Shibboleth authentication');
                return res.redirect(tenantUrl + '/?authentication=failed&reason=error');
            } else if (!user) {
                // The user's credentials didn't check out. This would rarely occur in a
                // normal situation as external auth providers don't usually redirect with
                // bad parameters in the request, so somebody is probably tampering with it.
                // We bail out immediately
                log().warn({'challenges': challenges, 'status': status}, 'Possible tampering of external callback request detected');
                return res.redirect(tenantUrl + '/?authentication=failed&reason=tampering');
            }

            // The user's authentication credentials are correct and the user was created
            // or retrieved from the database. Send the user back to their own tenant and pass
            // along their user id
            var redirectUrl = ShibbolethAPI.getAuthenticatedUserRedirectUrl(tenant, user);
            res.redirect(redirectUrl);
        })(req, res);
    });
});

/**
 * @REST getAuthShibbolethTenantCallback
 *
 * Redirect an authenticated user to the home page
 *
 * @Api         private
 * @Server      tenant
 * @Method      GET
 * @Path        /auth/shibboleth/callback
 * @QueryParam  {string}                [userId]            The id of the user that needs to be signed in
 * @QueryParam  {string}                [signature]         The signature for the user id
 * @QueryParam  {number}                [expires]           The timestamp (millis since epoch) at which the signature expires
 * @Return      {void}
 */
OAE.tenantRouter.on('get', '/api/auth/shibboleth/callback', function(req, res, next) {
    if (!ShibbolethAPI.isEnabled(req.tenant.alias)) {
        return res.redirect('/?authentication=disabled');
    }

    // Get the user from the database
    var userId = req.query.userId;
    var signature = req.query.signature;
    var expires = req.query.expires;
    ShibbolethAPI.getUser(req.tenant, userId, signature, expires, function(err, user) {
        if (err) {
            return res.send(err.code, err.msg);
        }

        // Log the user in
        var strategyId = AuthenticationUtil.getStrategyId(req.tenant, AuthenticationConstants.providers.SHIBBOLETH);
        return AuthenticationUtil.handleLogin(strategyId, user, req, res, next);
    });
});
