/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var ShortId = require('shortid');
var util = require('util');

var AuthzUtil = require('oae-authz/lib/util');

/**
 * Generates a URI for a file.
 * ex:
 * options.filename = 'large.png'
 * options.resourceId = u:cam:AF1e2c_3
 * The resulting URI would be u/cam/AF/1e/2c/_3/AF1e2c_3/large.png
 *
 * @param  {File}   file                    A file object.
 * @param  {Object} [options]               Holds extra optional options.
 * @param  {String} [options.filename]      Will be stuck at the end of the URI. Some backends will use this filename as the actual filename on disk. If omitted, the actual filename will be used.
 * @param  {String} [options.resourceId]    Will be hashed up and be made part of the URI. By specifying this property and the filename one, you can overwrite an older file. If left blank a random one will be generated.
 * @return {String}                         A URI
 */
var generateUri = module.exports.generateUri = function(file, options) {
    // Default the options.
    options = options || {};
    var resourceId = options.resourceId || ShortId.generate();
    var filename = options.filename || file.name;
    var base = _hashResourceId(resourceId);
    return base + '/' + filename;
};

/**
 * Hashes a resource id (ex: u:cam:AF1e2c_3) to a partial file URI (ex: u/cam/AF/1e/2c/_3/AF1e2c_3)
 *
 * @param  {String} resourceId The resource ID to hash
 * @return {String}            The partial file URI
 */
var _hashResourceId = function(resourceId) {
    var r = AuthzUtil.getResourceFromId(resourceId);
    return util.format('%s/%s/%s/%s/%s/%s/%s', r.resourceType, r.tenantAlias, r.resourceId.substr(0, 2), r.resourceId.substr(2, 2), r.resourceId.substr(4, 2), r.resourceId.substr(6, 2), r.resourceId);
};
