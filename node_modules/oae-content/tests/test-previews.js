/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var fs = require('fs');

var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var TestsUtil = require('oae-tests');

describe('File previews', function() {

    // Rest context that can be used every time we need to make a request as a global admin
    var globalAdminRestContext = null;
    // Rest context that can be used every time we need to make a request as a global admin on the created tenant.
    var globalAdminOnTenantRestContext = null;
    // Rest context that can be used every time we need to make a request as an anonymous user on the created tenant
    var anonymousRestContext = null;


    var suitable_files = null;
    var suitable_sizes = null;

    /**
     * Fill up the contexts
     */
    before(function(callback) {
        // Fill up global admin rest context
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
        // Fill up the anonymous context
        anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.localhost.host);

        // An object that adheres to the RestAPI.Content.setPreviewItems.files parameter.
        suitable_files = {
            'file.small.jpg': getFileStream,
            'file.medium.jpg': getSakaiLogoStream,
            'thumbnail.png': getFileStream
        };
        suitable_sizes = {
            'file.small.jpg': 'small',
            'file.medium.jpg': 'medium',
            'thumbnail.png': 'thumbnail'
        };

        // Login on the camtest tenant
        RestAPI.Authentication.loginOnTenant(globalAdminRestContext, 'localhost', function(err, ctx) {
            assert.ok(!err);
            globalAdminOnTenantRestContext = ctx;

            RestAPI.User.getMe(globalAdminOnTenantRestContext, function(err, user) {
                assert.ok(!err);
                assert.ok(!user.anon);
                callback();
            });
        });
    });

    /**
     * Some of these tests modify the expiration preview settings.
     * Ensure it gets reset.
     */
    after(function(callback) {
        RestAPI.Config.updateConfig(globalAdminRestContext, null, 'oae-content/previews/expiration_minimum', 15*60, function(err) {
            assert.ok(!err);
            RestAPI.Config.updateConfig(globalAdminRestContext, null, 'oae-content/previews/expiration_maximum', 30*60, function(err) {
                assert.ok(!err);
                callback();
            });
        });
    });

    /**
     * Utility method that returns a stream that points to the sakaiger image.
     *
     * @return {Stream}     A stream that points to sakaiger that can be uploaded.
     */
    var getFileStream = function() {
        var file = __dirname + '/data/sakaiger.png';
        return fs.createReadStream(file);
    };

    /**
     * Utility method that returns a stream that points to the sakai logo.
     *
     * @return {Stream}     A stream that points to the sakai logo that can be uploaded.
     */
    var getSakaiLogoStream = function() {
        var file = __dirname + '/data/sakai-logo.png';
        return fs.createReadStream(file);
    };

    /**
     * Creates a file and adds 2 preview items
     *
     * @param {Function}    callback            Standard callback method.
     * @param {Object}      callback.contexts   contexts object.
     * @param {Object}      callback.content    Content object as returned by `RestAPI.ContentcreateFile`.
     * @param {Object}      callback.previews   Previews object as returned by `RestAPI.ContentgetPreviewItems`.
     */
    var createPreviews = function(callback) {
        TestsUtil.generateTestUsers(globalAdminOnTenantRestContext, 2, function(err, users) {
            assert.ok(!err);

            var contexts = {};
            var keys = Object.keys(users);
            contexts['nicolaas'] = users[keys[0]];
            contexts['simon'] = users[keys[1]];

            RestAPI.Content.createFile(contexts['nicolaas'].restContext, 'Test Content 2', 'Test content description 2', 'private', getFileStream, [], [], function(err, contentObj) {
                assert.ok(!err);
                assert.ok(contentObj.contentId);
                assert.equal(contentObj.previews.status, 'pending');

                // Add some preview items.
                RestAPI.Content.setPreviewItems(globalAdminOnTenantRestContext, contentObj.contentId, 'done', suitable_files, suitable_sizes, {}, function(err) {
                    assert.ok(!err);

                    // Get a list of preview items.
                    RestAPI.Content.getPreviewItems(contexts['nicolaas'].restContext, contentObj.contentId, function(err, previews) {
                        assert.ok(!err);
                        assert.equal(previews.files.length, 2);

                        // Ensure that the thumbnail and status parameters are set.
                        RestAPI.Content.getContent(contexts['nicolaas'].restContext, contentObj.contentId, function(err, updatedContentObj) {
                            assert.ok(!err);
                            assert.ok(updatedContentObj.previews.thumbnailUrl);
                            assert.equal(updatedContentObj.previews.status, 'done');
                            callback(contexts, updatedContentObj, previews);
                        });
                    });
                });
            });
        });
    };

    /**
     * Verify that only the global admin can upload a preview item and
     * that the preview links are tied to the context of the user
     * who requested the link.
     */
    it('verify uploading a preview', function(callback) {
        createPreviews(function(contexts, contentObj, previews) {
            // Only global admins should be allowed to create previews.
            RestAPI.Content.setPreviewItems(anonymousRestContext, contentObj.contentId, 'done', suitable_files, suitable_sizes, {}, function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);

                // Download one.
                RestAPI.Content.downloadPreviewItem(contexts['nicolaas'].restContext, contentObj.contentId, previews.files[0].filename, previews.signature, function(err, body, response) {
                    assert.ok(!err);
                    assert.ok(!body); // Nginx streams the actual file body, the app server just returns a 204.
                    assert.equal(response.statusCode, 204);
                    assert.ok(response.headers['x-accel-redirect']);

                    // Make sure that nobody else can see a private item, even if they have the signature.
                    RestAPI.Content.downloadPreviewItem(contexts['simon'].restContext, contentObj.contentId, previews.files[0].filename, previews.signature, function(err, body, response) {
                        assert.equal(err.code, 401);
                        assert.ok(!body);
                        callback();
                    });
                });
            });
        });
    });

    /**
     * Verify that the request parameters of adding preview items are validated.
     */
    it('verify uploading preview parameter validation', function(callback) {
        TestsUtil.generateTestUsers(globalAdminOnTenantRestContext, 1, function(err, users) {
            var simon = _.values(users)[0];
            assert.ok(!err);

            RestAPI.Content.createFile(simon.restContext, 'Test Content', 'Test content description', 'private', getFileStream, [], [], function(err, contentObj) {
                assert.ok(!err);
                assert.ok(contentObj.contentId);
                assert.equal(contentObj.previews.status, 'pending');

                // A valid call as a sanity check.
                RestAPI.Content.setPreviewItems(globalAdminOnTenantRestContext, contentObj.contentId, 'done', {}, {}, {}, function(err) {
                    assert.ok(!err);

                    // Invalid contentId.
                    RestAPI.Content.setPreviewItems(globalAdminOnTenantRestContext, 'blah', 'foo', {}, {}, {}, function(err) {
                        assert.equal(err.code, 400);

                        // Bad status parameter.
                        RestAPI.Content.setPreviewItems(globalAdminOnTenantRestContext, contentObj.contentId, 'foo', {}, {}, {}, function(err) {
                            assert.equal(err.code, 400);

                            // Non existing piece of content.
                            RestAPI.Content.setPreviewItems(globalAdminOnTenantRestContext, 'c:foo:bar', 'done', {}, {}, {}, function(err) {
                                assert.equal(err.code, 404);
                                callback();
                            });
                        });
                    });
                });
            });
        });
    });

    /**
     * Verify that setting the preview status gets propaged to the content objects.
     */
    it('verify setting preview status', function(callback) {
         TestsUtil.generateTestUsers(globalAdminOnTenantRestContext, 1, function(err, users) {
            var simon = _.values(users)[0];
            assert.ok(!err);

            RestAPI.Content.createFile(simon.restContext, 'Test Content', 'Test content description', 'private', getFileStream, [], [], function(err, contentObj) {
                assert.ok(!err);
                assert.ok(contentObj.contentId);
                assert.equal(contentObj.previews.status, 'pending');

                RestAPI.Content.setPreviewItems(globalAdminOnTenantRestContext, contentObj.contentId, 'ignored', {}, {}, {}, function(err) {
                    assert.ok(!err);

                    RestAPI.Content.getContent(simon.restContext, contentObj.contentId, function(err, updatedContentObj) {
                        assert.ok(!err);
                        assert.equal(updatedContentObj.previews.status, 'ignored');
                        callback();
                    });
                });
            });
        });
    });

    /**
     * Verify that only setting the preview status removes older preview items
     */
    it('verify setting preview status removes older preview items', function(callback) {
         createPreviews(function(contexts, contentObj, previews) {
            RestAPI.Content.setPreviewItems(globalAdminOnTenantRestContext, contentObj.contentId, 'error', {}, {}, {}, function(err) {
                assert.ok(!err);
                
                // Get a list of preview items,
                // there should be none.
                RestAPI.Content.getPreviewItems(contexts['nicolaas'].restContext, contentObj.contentId, function(err, previews) {
                    assert.ok(!err);
                    assert.equal(previews.files.length, 0);

                    RestAPI.Content.getContent(contexts['nicolaas'].restContext, contentObj.contentId, function(err, content) {
                        assert.ok(!err);
                        assert.equal(content.previews.total, 0);
                        assert.equal(content.previews.status, 'error');
                        assert.ok(!content.previews.thumbnailUri);
                        assert.ok(!content.previews.thumbnailUrl);
                        callback();
                    });
                });
            });
        });
    });

    /**
     * Verify that uploading new preview items removes the old ones.
     */
    it('verify uploading new preview items removes older preview items and the thumbnailUri', function(callback) {
         createPreviews(function(contexts, contentObj, previews) {
            var files = {'new_file.small.jpg': getFileStream};
            var sizes = {'new_file.small.jpg': 'small'};
            RestAPI.Content.setPreviewItems(globalAdminOnTenantRestContext, contentObj.contentId, 'done', files, sizes, {}, function(err) {
                assert.ok(!err);
                
                // Get a list of preview items,
                // there should only be one.
                RestAPI.Content.getPreviewItems(contexts['nicolaas'].restContext, contentObj.contentId, function(err, previews) {
                    assert.ok(!err);
                    assert.equal(previews.files.length, 1);

                    RestAPI.Content.getContent(contexts['nicolaas'].restContext, contentObj.contentId, function(err, content) {
                        assert.ok(!err);
                        assert.equal(content.previews.total, 1);
                        assert.ok(!content.previews.thumbnailUri);
                        assert.ok(!content.previews.thumbnailUrl);
                        callback();
                    });
                });
            });
        });
    });

    /**
     * Verifies that the request parameters when downloading a preview are validated.
     */
    it('verify preview download parameter validation', function(callback) {
        createPreviews(function(contexts, contentObj, previews) {

            // Ensure that the file can be downloaded.
            RestAPI.Content.downloadPreviewItem(contexts['nicolaas'].restContext, contentObj.contentId, previews.files[0].filename, previews.signature, function(err, body, response) {
                assert.ok(!err);
                assert.equal(response.statusCode, 204);

                // Missing parameters.
                RestAPI.Content.downloadPreviewItem(contexts['nicolaas'].restContext, contentObj.contentId, previews.files[0].filename, { 'signature': previews.signature.signature, 'expires': previews.signature.expires, 'lastModified': '' }, function(err, body, response) {
                    assert.ok(err.code, 400);
                    assert.ok(!body);

                    RestAPI.Content.downloadPreviewItem(contexts['nicolaas'].restContext, contentObj.contentId, previews.files[0].filename, { 'signature': previews.signature.signature, 'expires': '', 'lastModified': previews.signature.lastModified }, function(err, body, response) {
                        assert.ok(err.code, 400);
                        assert.ok(!body);

                        RestAPI.Content.downloadPreviewItem(contexts['nicolaas'].restContext, contentObj.contentId, previews.files[0].filename, { 'signature': previews.signature.signature, 'expires': '', 'lastModified': previews.signature.lastModified }, function(err, body, response) {
                            assert.ok(err.code, 400);
                            assert.ok(!body);

                            // Bad signature.
                            RestAPI.Content.downloadPreviewItem(contexts['nicolaas'].restContext, contentObj.contentId, previews.files[0].filename, { 'signature': 'wrong', 'expires': previews.signature.expires, 'lastModified': previews.signature.lastModified }, function(err, body, response) {
                                assert.ok(err.code, 401);
                                assert.ok(!body);

                                callback();
                            });
                        });
                    });
                });
            });
        });
    });

    /**
     * Sets the minimum and maximum expiration window for preview signatures
     * and checks if the signatures are still generated with expiration dates that are in the future.
     *
     * @param  {RestContext}    restCtx     The RestContext that can be used to retrieve the content object metadata.
     * @param  {String}         contentId   The ID of the content item that needs to be checked.
     * @param  {Number}         min         The minimum value
     * @param  {Number}         max         The maximum value
     * @param  {Function}       callback    Standard callback method.
     */
    var checkPreviewsConfigExpiration = function(restCtx, contentId, min, max, callback) {
        RestAPI.Config.updateConfig(globalAdminRestContext, null, 'oae-content/previews/expiration_minimum', min, function(err) {
            assert.ok(!err);
            RestAPI.Config.updateConfig(globalAdminRestContext, null, 'oae-content/previews/expiration_maximum', max, function(err) {
                assert.ok(!err);
                RestAPI.Content.getContent(restCtx, contentId, function(err, contentObj) {
                    assert.ok(!err);
                    assert.ok(contentObj.signature.expires > Date.now());
                    callback();
                });
            });
        });
    };

    /**
     * TODO: Remove/Adjust this test once the Config API has validation.
     * (Don't forget to remove the after block)
     *
     * Verifies that a preview cannot have an expiration date that is in the past.
     * Due to the Config API having no validation just yet, it's possible that
     * the min/max settings can be misconfigured which could lead to expiration dates
     * in the past. Verify that this is not possible.
     */
    it('verify negative preview expires are not possible', function(callback) {
        createPreviews(function(contexts, contentObj, previews) {
            var contentId = contentObj.contentId;

            // min > max --> should result in defaults.
            checkPreviewsConfigExpiration(contexts['nicolaas'].restContext, contentId, 100, 5, function() {
                // negative settings --> should result in defaults
                checkPreviewsConfigExpiration(contexts['nicolaas'].restContext, contentId, -10, 500, function() {
                    checkPreviewsConfigExpiration(contexts['nicolaas'].restContext, contentId, 100, -500, function () {
                        // Setting expiration with an offset of 2 and a duration of 5 should at most be valid for 7 seconds.
                        RestAPI.Config.updateConfig(globalAdminRestContext, null, 'oae-content/previews/expiration_minimum', 2, function(err) {
                            assert.ok(!err);
                            RestAPI.Config.updateConfig(globalAdminRestContext, null, 'oae-content/previews/expiration_maximum', 5, function(err) {
                                assert.ok(!err);

                                RestAPI.Content.getContent(contexts['nicolaas'].restContext, contentId, function(err, contentObj) {
                                    assert.ok(!err);
                                    assert.ok(contentObj.signature.expires > Date.now());
                                    assert.ok(contentObj.signature.expires < (Date.now() + 7001));
                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
