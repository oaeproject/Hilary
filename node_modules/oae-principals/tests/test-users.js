/*
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var fs = require('fs');

var AuthenticationAPI = require('oae-authentication');
var AuthzUtil = require('oae-authz/lib/util');
var ConfigTestUtil = require('oae-config/lib/test/util');
var Context = require('oae-context').Context;
var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var Tenant = require('oae-tenants/lib/model').Tenant;
var TestsUtil = require('oae-tests');
var TZ = require('oae-util/lib/tz');

var PrincipalsAPI = require('oae-principals');
var PrincipalsTestsUtil = require('oae-principals/lib/test/util');
var User = require('oae-principals/lib/model.user').User;


describe('Users', function() {

    // Rest contexts that can be used to make requests as different types of users
    var anonymousRestContext = null;        // anonymous user associated to a tenant
    var camAdminRestContext = null;         // cambridge tenant admin
    var gtAdminRestContext = null;          // georgia tech tenant admin
    var globalAdminRestContext = null;      // global administrator
    var anonymousGlobalRestContext = null;  // anonymous user browsing the global admin tenant
    var globalAdminContext = null;          // API context for the global admin (to be used on back-end API calls, not REST calls)

    /**
     * Function that will fill up the anonymous and the tenant admin context
     */
    before(function(callback) {
        // Fill up the request contexts
        anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        gtAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();

        var globalTenant = new Tenant('admin', 'Global tenant', 'localhost:2000');
        var mockUserId = 'u:' + globalTenant.alias + ':admin';
        globalAdminContext = new Context(globalTenant, new User(globalTenant.alias, mockUserId, 'The global admin user', { isGlobalAdmin: true }));

        anonymousGlobalRestContext = TestsUtil.createGlobalRestContext();

        callback();
    });

    describe('Full User Profile Decorators', function() {

        /**
         * Test that verifies you cannot register a duplicate profile decorator, nor can you register one without a function
         */
        it('verify register full user profile decorator error scenarios', function(callback) {
            var testId = TestsUtil.generateRandomText();
            assert.throws(function() {
                PrincipalsAPI.registerFullUserProfileDecorator(testId);
            });

            // Verify we can successfully register one with a function afterward
            PrincipalsAPI.registerFullUserProfileDecorator(testId, function(ctx, user, callback) { return callback(); });

            // Verify we cannot register a duplicate
            assert.throws(function() {
                PrincipalsAPI.registerFullUserProfileDecorator(testId, function(ctx, user, callback) { return callback(); });
            });

            return callback();
        });

        /**
         * Test that verifies the serialization of many different possible types provided by some test decorators
         */
        it('verify various user profile decorator response types', function(callback) {
            var testUndefinedNamespace = TestsUtil.generateRandomText();
            var testNullNamespace = TestsUtil.generateRandomText();
            var testZeroNamespace = TestsUtil.generateRandomText();
            var testEmptyStringNamespace = TestsUtil.generateRandomText();
            var testFalseNamespace = TestsUtil.generateRandomText();
            var testErrorNamespace = TestsUtil.generateRandomText();

            PrincipalsAPI.registerFullUserProfileDecorator(testUndefinedNamespace, function(ctx, user, callback) { return callback(); });
            PrincipalsAPI.registerFullUserProfileDecorator(testNullNamespace, function(ctx, user, callback) { return callback(null, null); });
            PrincipalsAPI.registerFullUserProfileDecorator(testZeroNamespace, function(ctx, user, callback) { return callback(null, 0); });
            PrincipalsAPI.registerFullUserProfileDecorator(testEmptyStringNamespace, function(ctx, user, callback) { return callback(null, ''); });
            PrincipalsAPI.registerFullUserProfileDecorator(testFalseNamespace, function(ctx, user, callback) { return callback(null, false); });
            PrincipalsAPI.registerFullUserProfileDecorator(testErrorNamespace, function(ctx, user, callback) { return callback({'code': 500, 'msg': 'Expected'}); });

            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, user) {
                assert.ok(!err);
                user = _.values(user)[0];

                RestAPI.User.getUser(user.restContext, user.user.id, function(err, userProfile) {
                    assert.ok(!err);

                    // Ensure the key for the undefined value or error do not get returned in the feed
                    assert.ok(!_.contains(_.keys(userProfile), testUndefinedNamespace));
                    assert.ok(!_.contains(_.keys(userProfile), testErrorNamespace));

                    // Ensure all the others return exactly as-is
                    assert.strictEqual(userProfile[testNullNamespace], null);
                    assert.strictEqual(userProfile[testZeroNamespace], 0);
                    assert.strictEqual(userProfile[testEmptyStringNamespace], '');
                    assert.strictEqual(userProfile[testFalseNamespace], false);
                    return callback();
                });
            });
        });

        /**
         * Test that verifies a user profile decorator cannot override existing properties
         */
        it('verify a user profile decorator cannot overwrite existing user properties', function(callback) {
            var testNamespace = TestsUtil.generateRandomText();

            PrincipalsAPI.registerFullUserProfileDecorator('visibility', function(ctx, user, callback) {
                // Try setting the user visibility on the fly
                user.visibility = 'loggedin';

                // Try setting the user visibility VIA using the 'visibility' property as the namespace of our decorator
                return callback(null, 'private');
            });

            // Create a public user to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, user) {
                assert.ok(!err);
                user = _.values(user)[0];

                // Verify the visibility of the user is still public
                RestAPI.User.getUser(user.restContext, user.user.id, function(err, user) {
                    assert.ok(!err);
                    assert.equal(user.visibility, 'public');
                    return callback();
                });
            });
        });
    });

    describe('Create user', function() {

        /**
         * Test that verifies that it should only be possible to create a user if there are valid reCaptcha tokens present or the current user is an admin
         */
        it('verify create user', function(callback) {
            // Try to create a user as an anonymous user with no reCaptcha tokens
            var userId = TestsUtil.generateTestUserId();
            var recaptchaTenantAlias = TestsUtil.generateTestUserId();

            // Verify recaptcha token is needed when feature is enabled
            RestAPI.Tenants.createTenant(globalAdminRestContext, recaptchaTenantAlias, recaptchaTenantAlias, recaptchaTenantAlias, function(err, recaptchaTenant) {
                assert.ok(!err);
                var recaptchaAnonymousRestContext = TestsUtil.createTenantRestContext(recaptchaTenantAlias);

                // Enable recaptcha for this tenant
                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, recaptchaTenantAlias, 'oae-principals/recaptcha/enabled', true, function(err) {
                    assert.ok(!err);

                    RestAPI.User.createUser(recaptchaAnonymousRestContext, userId, 'password', 'Test User', {'visibility': 'public'}, function(err, userObj) {
                        assert.ok(err);
                        assert.equal(err.code, 400);
                        assert.ok(!userObj);

                        RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', {'visibility': 'public'}, function(err, createdUser) {
                            assert.ok(!err);
                            assert.ok(createdUser);
                            assert.equal(createdUser.displayName, 'Test User');
                            assert.equal(createdUser.publicAlias, 'Test User');
                            assert.equal(createdUser.visibility, 'public');
                            assert.equal(createdUser.resourceType, 'user');
                            assert.equal(createdUser.profilePath, '/user/' + createdUser.tenant.alias + '/' + AuthzUtil.getResourceFromId(createdUser.id).resourceId);
                            var userRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, userId, 'password');

                            // Try creating a user with the same user id, which should fail
                            RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', null, function(err, userObj) {
                                assert.ok(err);
                                assert.ok(!userObj);

                                // Try creating a new user as the created user
                                var newUserId = TestsUtil.generateTestUserId();
                                RestAPI.User.createUser(userRestContext, newUserId, 'password', 'Test User', null, function(err, userObj) {
                                    assert.ok(err);
                                    assert.equal(err.code, 401);

                                    // We promote the created user to be a tenant admin
                                    RestAPI.User.setTenantAdmin(globalAdminRestContext, createdUser.id, true, function(err) {
                                        assert.ok(!err);

                                        // Try creating the user again
                                        RestAPI.User.createUser(userRestContext, newUserId, 'password', 'Test User', null, function(err, userObj) {
                                            assert.ok(!err);
                                            assert.ok(userObj);
                                            callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that users their usernames get lowercased.
         * See https://github.com/oaeproject/Hilary/issues/594
         */
        it('verify lowercasing of usernames', function(callback) {
            var username = TestsUtil.generateTestUserId() + 'Aa';
            var lowerCasedUsername = username.toLowerCase();
            var upperCasedUsername = username.toUpperCase();

            RestAPI.User.createUser(camAdminRestContext, username, 'password', 'Test User', null, function(err, createdUser) {
                assert.ok(!err);

                // Verify we cannot create another user account where the username only differs in the casing
                RestAPI.User.createUser(camAdminRestContext, lowerCasedUsername, 'password', 'Test User', null, function(err) {
                    assert.equal(err.code, 400);
                    RestAPI.User.createUser(camAdminRestContext, upperCasedUsername, 'password', 'Test User', null, function(err) {
                        assert.equal(err.code, 400);

                        // When logging in with the same username but in lower case we should succesfully log in
                        var userRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, lowerCasedUsername, 'password');
                        RestAPI.Authentication.login(userRestContext, lowerCasedUsername, 'password', function(err) {
                            assert.ok(!err);
                            RestAPI.User.getMe(userRestContext, function(err, meData) {
                                assert.ok(!err);
                                assert.equal(meData.id, createdUser.id);

                                // When logging in with the same username but in upper case we should succesfully log in
                                var userRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, upperCasedUsername, 'password');
                                RestAPI.Authentication.login(userRestContext, upperCasedUsername, 'password', function(err) {
                                    assert.ok(!err);
                                    RestAPI.User.getMe(userRestContext, function(err, meData) {
                                        assert.ok(!err);
                                        assert.equal(meData.id, createdUser.id);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that users created without a locale get the default tenant locale
         */
        it('verify user gets default locale', function(callback) {
            var userId1 = TestsUtil.generateTestUserId();
            var userId2 = TestsUtil.generateTestUserId();

            // Create user without locale
            RestAPI.User.createUser(camAdminRestContext, userId1, 'password', 'Test User 1', null, function(err, createdUser1) {
                assert.ok(!err);
                assert.ok(createdUser1);
                // Check that the user has been given the default locale
                assert.equal(createdUser1.locale, 'en_GB');

                // Set default language to Spanish
                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-principals/user/defaultLanguage', 'es_ES', function(err) {
                    assert.ok(!err);

                    // Create user without locale
                    RestAPI.User.createUser(camAdminRestContext, userId2, 'password', 'Test User 2', null, function(err, createdUser2) {
                        assert.ok(!err);
                        assert.ok(createdUser2);
                        // Check that the user has been given the new default locale
                        assert.equal(createdUser2.locale, 'es_ES');

                        // Check that the first user still has the old default locale
                        RestAPI.User.getUser(camAdminRestContext, createdUser1.id, function(err, user) {
                            assert.ok(!err);
                            assert.ok(user);
                            assert.equal(user.locale, 'en_GB');

                            // Set default language to British English again
                            ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, global.oaeTests.tenants.cam.alias, 'oae-principals/user/defaultLanguage', 'en_GB', function(err) {
                                assert.ok(!err);

                                // Check that the second user still has the Spanish locale
                                RestAPI.User.getUser(camAdminRestContext, createdUser2.id, function(err, user) {
                                    assert.ok(!err);
                                    assert.ok(user);
                                    assert.equal(user.locale, 'es_ES');
                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that validation on user creation is done appropriately
         */
        it('verify validation', function(callback) {
            var userId = TestsUtil.generateTestUserId();

            // Create user with no user id
            RestAPI.User.createUser(camAdminRestContext, null, 'password', 'Test User', null, function(err, userObj) {
                assert.ok(err);
                assert.ok(!userObj);

                // Create user with empty password
                RestAPI.User.createUser(camAdminRestContext, userId, null, 'Test User', null, function(err, userObj) {
                    assert.ok(err);
                    assert.ok(!userObj);

                    // Create user with short password
                    RestAPI.User.createUser(camAdminRestContext, userId, 'short', 'Test User', null, function(err, userObj) {
                        assert.ok(err);
                        assert.ok(!userObj);

                        // Create user with no display name
                        RestAPI.User.createUser(camAdminRestContext, userId, 'password', null, null, function(err, userObj) {
                            assert.ok(err);
                            assert.ok(!userObj);

                            // Create user with unkown visibility setting
                            RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', {'visibility': 'unknown'}, function(err, userObj) {
                                assert.ok(err);
                                assert.ok(!userObj);

                                // Create user with invalid timezone
                                RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', {'timezone': 'Plopsa/Land'}, function(err, userObj) {
                                    assert.ok(err);
                                    assert.ok(!userObj);

                                    // Create user with displayName that is longer than the maximum allowed size
                                    var longDisplayName = TestsUtil.generateRandomText(100);
                                    RestAPI.User.createUser(camAdminRestContext, userId, 'password', longDisplayName, {}, function(err, userObj) {
                                        assert.ok(err);
                                        assert.equal(err.code, 400);
                                        assert.ok(!userObj);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Import users', function() {

        /**
         * Utility method that returns a stream that points to a CSV user import file with passwords, meaning
         * that it can be used for a local authentication provider.
         *
         * @return {Stream}     A stream that points to a CSV user import file with passwords
         */
        var getCSVWithPasswordStream = function() {
            var file = __dirname + '/data/users-with-password.csv';
            return fs.createReadStream(file);
        };

        /**
         * Utility method that returns a stream that points to a CSV user import file without passwords, meaning
         * that it can be used for external authentication providers.
         *
         * @return {Stream}     A stream that points to a CSV user import file without passwords
         */
        var getCSVWithoutPasswordStream = function() {
            var file = __dirname + '/data/users-without-password.csv';
            return fs.createReadStream(file);
        };

        /*!
         * Test that verifies that a CSV user file can be imported using a local authentication strategy and that a user's
         * display name will be overridden when the account already exists and the display name is the same as the user's
         * external id
         */
        it('verify import local users and display name override', function(callback) {
            // Import users as a global admin using a local authentication strategy
            PrincipalsTestsUtil.importUsers(globalAdminRestContext, global.oaeTests.tenants.cam.alias, getCSVWithPasswordStream, 'local', function(err) {
                assert.ok(!err);

                // Verify that all imported users have been created
                var nicolaasRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, 'user-zfdHliPLa', 'password1');
                RestAPI.User.getMe(nicolaasRestContext, function(err, nicolaasMeObj) {
                    assert.ok(!err);
                    assert.ok(nicolaasMeObj);
                    assert.equal(nicolaasMeObj.displayName, 'Nicolaas Matthijs');
                    assert.equal(nicolaasMeObj.email, 'nicolaas@test.com');

                    // User with missing first name
                    var simonRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, 'user-HlKKreaDP', 'password4');
                    RestAPI.User.getMe(simonRestContext, function(err, simonMeObj) {
                        assert.ok(!err);
                        assert.ok(simonMeObj);
                        assert.equal(simonMeObj.displayName, 'Gaeremynck');
                        assert.equal(simonMeObj.email, 'simon@test.com');

                        // User with more complex display name
                        var stuartRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, 'user-IrewPDSAw', 'password5');
                        RestAPI.User.getMe(stuartRestContext, function(err, stuartMeObj) {
                            assert.ok(!err);
                            assert.ok(stuartMeObj);
                            assert.equal(stuartMeObj.displayName, 'Stuart D. Freeman');
                            assert.equal(stuartMeObj.email, 'stuart@test.com');

                            // Update a user's display name to be the same as its external id
                            RestAPI.User.updateUser(nicolaasRestContext, nicolaasMeObj.id, {'displayName': 'user-zfdHliPLa'}, function (err, user) {
                                assert.ok(!err);
                                assert.ok(user);
                                assert.equal(user.id, nicolaasMeObj.id);
                                assert.equal(user.displayName, 'user-zfdHliPLa');

                                // Verify that the update is reflected in the me feed
                                RestAPI.User.getMe(nicolaasRestContext, function(err, nicolaasMeObj) {
                                    assert.ok(!err);
                                    assert.ok(nicolaasMeObj);
                                    assert.equal(nicolaasMeObj.displayName, 'user-zfdHliPLa');
                                    assert.equal(nicolaasMeObj.email, 'nicolaas@test.com');

                                    // Re-import the users to verify that the displayName is reverted back to the display name
                                    // provided in the CSV file. This time, the import is attempted as a tenant admin
                                    PrincipalsTestsUtil.importUsers(camAdminRestContext, null, getCSVWithPasswordStream, 'local', function(err) {
                                        assert.ok(!err);

                                        // Verify that the display name is correctly reverted
                                        RestAPI.User.getMe(nicolaasRestContext, function(err, nicolaasMeObj) {
                                            assert.ok(!err);
                                            assert.ok(nicolaasMeObj);
                                            assert.equal(nicolaasMeObj.displayName, 'Nicolaas Matthijs');
                                            assert.equal(nicolaasMeObj.email, 'nicolaas@test.com');

                                            // Update the user's display name to a different real display name
                                            RestAPI.User.updateUser(nicolaasRestContext, nicolaasMeObj.id, {'displayName': 'N. Matthijs'}, function (err, user) {
                                                assert.ok(!err);
                                                assert.ok(user);
                                                assert.equal(user.id, nicolaasMeObj.id);
                                                assert.equal(user.displayName, 'N. Matthijs');

                                                // Verify that the update is reflected in the me feed
                                                RestAPI.User.getMe(nicolaasRestContext, function(err, nicolaasMeObj) {
                                                    assert.ok(!err);
                                                    assert.ok(nicolaasMeObj);
                                                    assert.equal(nicolaasMeObj.displayName, 'N. Matthijs');
                                                    assert.equal(nicolaasMeObj.email, 'nicolaas@test.com');

                                                    // Re-import the users as a tenant admin to verify that the displayName is not reverted
                                                    // back to the display name provided in the CSV file
                                                    PrincipalsTestsUtil.importUsers(camAdminRestContext, null, getCSVWithPasswordStream, 'local', function(err) {
                                                        assert.ok(!err);

                                                        // Verify that the display name has not been reverted
                                                        RestAPI.User.getMe(nicolaasRestContext, function(err, nicolaasMeObj) {
                                                            assert.ok(!err);
                                                            assert.ok(nicolaasMeObj);
                                                            assert.equal(nicolaasMeObj.displayName, 'N. Matthijs');
                                                            assert.equal(nicolaasMeObj.email, 'nicolaas@test.com');
                                                            callback();
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /*!
         * Test that verifies that a CSV user file can be imported using an external authentication strategy
         */
        it('verify import external users', function(callback) {
            // Import users as a global admin using the CAS authentication strategy
            PrincipalsTestsUtil.importUsers(globalAdminRestContext, global.oaeTests.tenants.cam.alias, getCSVWithoutPasswordStream, 'cas', function(err) {
                assert.ok(!err);

                // Verify that the users have been created and a CAS login id has been associated to those accounts.
                // We have to use the internal APIs for this as there is no REST endpoint that exposes this
                AuthenticationAPI.getUserIdFromLoginId(global.oaeTests.tenants.cam.alias, 'cas', 'user-TGdDSdadW', function(err, nicolaasUserId) {
                    assert.ok(!err);
                    assert.ok(nicolaasUserId);
                    // Verify that the external id is not associated to a different authentication strategy
                    AuthenticationAPI.getUserIdFromLoginId(global.oaeTests.tenants.cam.alias, 'ldap', 'user-TGdDSdadW', function(err) {
                        assert.ok(err);
                        assert.equal(err.code, 404);
                        // Verify that the user has the appropriate basic profile information
                        RestAPI.User.getUser(camAdminRestContext, nicolaasUserId, function(err, nicolaasUserObj) {
                            assert.ok(!err);
                            assert.ok(nicolaasUserObj);
                            assert.equal(nicolaasUserObj.displayName, 'Nicolaas Matthijs');
                            assert.equal(nicolaasUserObj.email, 'nicolaas@test.com');

                            // User with missing first name
                            AuthenticationAPI.getUserIdFromLoginId(global.oaeTests.tenants.cam.alias, 'cas', 'user-PQasQsaWQ', function(err, simonUserId) {
                                assert.ok(!err);
                                assert.ok(simonUserId);
                                // Verify that the external id is not associated to a different authentication strategy
                                AuthenticationAPI.getUserIdFromLoginId(global.oaeTests.tenants.cam.alias, 'shibboleth', 'user-PQasQsaWQ', function(err) {
                                    assert.ok(err);
                                    assert.equal(err.code, 404);
                                    // Verify that the user has the appropriate basic profile information
                                    RestAPI.User.getUser(camAdminRestContext, simonUserId, function(err, simonUserObj) {
                                        assert.ok(!err);
                                        assert.ok(simonUserObj);
                                        assert.equal(simonUserObj.displayName, 'Gaeremynck');
                                        assert.equal(simonUserObj.email, 'simon@test.com');

                                        // User with more complex display name
                                        AuthenticationAPI.getUserIdFromLoginId(global.oaeTests.tenants.cam.alias, 'cas', 'user-CXzsaWasX', function(err, stuartUserId) {
                                            assert.ok(!err);
                                            assert.ok(nicolaasUserId);
                                            // Verify that the external id is not associated to a different authentication strategy
                                            AuthenticationAPI.getUserIdFromLoginId(global.oaeTests.tenants.cam.alias, 'facebook', 'user-CXzsaWasX', function(err) {
                                                assert.ok(err);
                                                assert.equal(err.code, 404);
                                                // Verify that the user has the appropriate basic profile information
                                                RestAPI.User.getUser(camAdminRestContext, stuartUserId, function(err, stuartUserObj) {
                                                    assert.ok(!err);
                                                    assert.ok(stuartUserObj);
                                                    assert.equal(stuartUserObj.displayName, 'Stuart D. Freeman');
                                                    assert.equal(stuartUserObj.email, 'stuart@test.com');

                                                    // Update a user's display name to be the same as its external id
                                                    RestAPI.User.updateUser(camAdminRestContext, nicolaasUserId, {'displayName': 'user-TGdDSdadW'}, function (err, user) {
                                                        assert.ok(!err);
                                                        assert.ok(user);
                                                        assert.equal(user.id, nicolaasUserId);
                                                        assert.equal(user.displayName, 'user-TGdDSdadW');

                                                        // Verify that the update is reflected when getting the user
                                                        RestAPI.User.getUser(camAdminRestContext, nicolaasUserId, function(err, nicolaasUserObj) {
                                                            assert.ok(!err);
                                                            assert.ok(nicolaasUserObj);
                                                            assert.equal(nicolaasUserObj.displayName, 'user-TGdDSdadW');
                                                            assert.equal(nicolaasUserObj.email, 'nicolaas@test.com');

                                                            // Re-import the users to verify that the displayName is reverted back to the display name
                                                            // provided in the CSV file. This time, the import is attempted as a tenant admin
                                                            PrincipalsTestsUtil.importUsers(camAdminRestContext, null, getCSVWithoutPasswordStream, 'cas', function(err) {
                                                                assert.ok(!err);

                                                                // Verify that the display name is correctly reverted
                                                                RestAPI.User.getUser(camAdminRestContext, nicolaasUserId, function(err, nicolaasUserObj) {
                                                                    assert.ok(!err);
                                                                    assert.ok(nicolaasUserObj);
                                                                    assert.equal(nicolaasUserObj.displayName, 'Nicolaas Matthijs');
                                                                    assert.equal(nicolaasUserObj.email, 'nicolaas@test.com');

                                                                    // Update the user's display name to a different real display name
                                                                    RestAPI.User.updateUser(camAdminRestContext, nicolaasUserId, {'displayName': 'N. Matthijs'}, function (err, user) {
                                                                        assert.ok(!err);
                                                                        assert.ok(user);
                                                                        assert.equal(user.id, nicolaasUserId);
                                                                        assert.equal(user.displayName, 'N. Matthijs');

                                                                        // Verify that the update is reflected when getting the user
                                                                        RestAPI.User.getUser(camAdminRestContext, nicolaasUserId, function(err, nicolaasUserObj) {
                                                                            assert.ok(!err);
                                                                            assert.ok(nicolaasUserObj);
                                                                            assert.equal(nicolaasUserObj.displayName, 'N. Matthijs');
                                                                            assert.equal(nicolaasUserObj.email, 'nicolaas@test.com');

                                                                            // Re-import the users as a tenant admin to verify that the displayName is not reverted
                                                                            // back to the display name provided in the CSV file
                                                                            PrincipalsTestsUtil.importUsers(camAdminRestContext, null, getCSVWithoutPasswordStream, 'cas', function(err) {
                                                                                assert.ok(!err);

                                                                                // Verify that the display name has not been reverted
                                                                                RestAPI.User.getUser(camAdminRestContext, nicolaasUserId, function(err, nicolaasUserObj) {
                                                                                    assert.ok(!err);
                                                                                    assert.ok(nicolaasUserObj);
                                                                                    assert.equal(nicolaasUserObj.displayName, 'N. Matthijs');
                                                                                    assert.equal(nicolaasUserObj.email, 'nicolaas@test.com');
                                                                                    callback();
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that parameters are validated appropriately when importing users from a CSV file
         */
        it('verify parameter validation', function(callback) {
            // Verify that an existing tenant alias is required
            PrincipalsTestsUtil.importUsers(globalAdminRestContext, 'foobar', getCSVWithoutPasswordStream, 'cas', function(err) {
                assert.ok(err);
                assert.ok(err.code, 400);

                // Verify that an authentication method is required
                PrincipalsTestsUtil.importUsers(globalAdminRestContext, global.oaeTests.tenants.cam.alias, getCSVWithoutPasswordStream, null, function(err) {
                    assert.ok(err);
                    assert.ok(err.code, 400);

                    // Verify that an existing authentication method is required
                    PrincipalsTestsUtil.importUsers(globalAdminRestContext, global.oaeTests.tenants.cam.alias, getCSVWithoutPasswordStream, 'foobar', function(err) {
                        assert.ok(err);
                        assert.ok(err.code, 400);

                        // Verify that a CSV file is required
                        PrincipalsTestsUtil.importUsers(globalAdminRestContext, global.oaeTests.tenants.cam.alias, null, 'cas', function(err) {
                            assert.ok(err);
                            assert.ok(err.code, 400);
                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that only global or tenant administrators are able to import users from CSV
         */
        it('verify only admins can import users', function(callback) {
            // Verify that an anonymous user on the global admin tenant cannot import users
            PrincipalsTestsUtil.importUsers(anonymousGlobalRestContext, global.oaeTests.tenants.cam.alias, getCSVWithoutPasswordStream, 'cas', function(err) {
                assert.ok(err);
                assert.ok(err.code, 401);

                // Verify that an anonymous user on a user tenant cannot import users
                PrincipalsTestsUtil.importUsers(anonymousRestContext, null, getCSVWithoutPasswordStream, 'cas', function(err) {
                    assert.ok(err);
                    assert.ok(err.code, 401);

                    // Create a non-admin user on a user tenant
                    var userId = TestsUtil.generateTestUserId();
                    RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', {'visibility': 'public'}, function(err, createdUser) {
                        assert.ok(!err);
                        assert.ok(createdUser);
                        assert.equal(createdUser.displayName, 'Test User');
                        var userRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, userId, 'password');

                        // Verify that an authenticated non-admin user on a user tenant cannot import users
                        PrincipalsTestsUtil.importUsers(userRestContext, null, getCSVWithoutPasswordStream, 'cas', function(err) {
                            assert.ok(err);
                            assert.ok(err.code, 401);
                            callback();
                        });
                    });
                });
            });
        });
    });

    describe('Get user', function() {

        /**
         * Test that verifies that a user's basic profile can be retrieved
         */
        it('verify get user', function(callback) {
            // Create a test user
            var userId = TestsUtil.generateTestUserId();
            var opts = {
                'visibility': 'public'
            };

            RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', opts, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);
                assert.equal(userObj.displayName, 'Test User');
                assert.equal(userObj.resourceType, 'user');
                assert.equal(userObj.profilePath, '/user/' + userObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(userObj.id).resourceId);

                // Get the user
                RestAPI.User.getUser(anonymousRestContext, userObj.id, function(err, retrievedUser) {
                    assert.ok(!err);
                    assert.ok(retrievedUser);
                    assert.equal(retrievedUser.visibility, 'public');
                    assert.equal(retrievedUser.displayName, 'Test User');
                    assert.equal(retrievedUser.resourceType, 'user');
                    assert.equal(retrievedUser.profilePath, '/user/' + retrievedUser.tenant.alias + '/' + AuthzUtil.getResourceFromId(retrievedUser.id).resourceId);
                    assert.ok(_.isObject(retrievedUser.tenant));
                    assert.equal(_.keys(retrievedUser.tenant).length, 2);
                    assert.equal(retrievedUser.tenant.displayName, global.oaeTests.tenants.cam.displayName);
                    assert.equal(retrievedUser.tenant.alias, global.oaeTests.tenants.cam.alias);
                    callback();
                });
            });
        });

        /**
         * Test that verifies the tenant data is returned in the me feed.
         */
        it('verify that the me feed returns the full tenant object', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users) {
                assert.ok(!err);
                var userCtx = _.values(users)[0].restContext;

                // Verify it for a regular user
                RestAPI.User.getMe(userCtx, function(err, meData) {
                    assert.ok(!err);
                    assert.ok(!meData.anon);
                    assert.ok(_.isObject(meData.tenant));
                    assert.equal(_.keys(meData.tenant).length, 2);
                    assert.equal(meData.tenant.displayName, global.oaeTests.tenants.cam.displayName);
                    assert.equal(meData.tenant.alias, global.oaeTests.tenants.cam.alias);

                    // Now verify it for an anonymous user.
                    RestAPI.User.getMe(anonymousRestContext, function(err, meData) {
                        assert.ok(!err);
                        assert.ok(meData.anon);
                        assert.ok(_.isObject(meData.tenant));
                        assert.equal(_.keys(meData.tenant).length, 2);
                        assert.equal(meData.tenant.displayName, global.oaeTests.tenants.cam.displayName);
                        assert.equal(meData.tenant.alias, global.oaeTests.tenants.cam.alias);
                        callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that a user with an ugly username and a UTF-8 username can be retrieved
         */
        it('verify get user by ugly username', function(callback) {
            // Create a test user with an ugly user name
            var userId1 = TestsUtil.generateTestUserId('some.weird@`user\\name');
            RestAPI.User.createUser(camAdminRestContext, userId1, 'password', 'Test User', {'visibility': 'public'},  function(err, userObj1) {
                assert.ok(!err);
                assert.ok(userObj1);

                // Get the user
                RestAPI.User.getUser(anonymousRestContext, userObj1.id, function(err, retrievedUser1) {
                    assert.ok(!err);
                    assert.ok(retrievedUser1);
                    assert.equal(retrievedUser1.visibility, 'public');
                    assert.equal(retrievedUser1.displayName, 'Test User');
                    assert.equal(retrievedUser1.resourceType, 'user');
                    assert.equal(retrievedUser1.profilePath, '/user/' + retrievedUser1.tenant.alias + '/' + AuthzUtil.getResourceFromId(retrievedUser1.id).resourceId);

                    // Create a test user with a UTF-8 username
                    var userId2 = TestsUtil.generateTestUserId('стремился');
                    RestAPI.User.createUser(camAdminRestContext, userId2, 'password', 'Кругом шумел', {'visibility': 'public'}, function(err, userObj2) {
                        assert.ok(!err);
                        assert.ok(userObj2);

                        // Get the user
                        RestAPI.User.getUser(anonymousRestContext, userObj2.id, function(err, retrievedUser2) {
                            assert.ok(!err);
                            assert.ok(retrievedUser2);
                            assert.equal(retrievedUser2.visibility, 'public');
                            assert.equal(retrievedUser2.displayName, 'Кругом шумел');
                            assert.equal(retrievedUser2.resourceType, 'user');
                            assert.equal(retrievedUser2.profilePath, '/user/' + retrievedUser2.tenant.alias + '/' + AuthzUtil.getResourceFromId(retrievedUser2.id).resourceId);
                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a non-existing user cannot be retrieved
         */
        it('verify get a bad userId', function(callback) {
            // Try and get an invalid user id
            RestAPI.User.getUser(anonymousRestContext, 'totally-not-a-valid-id', function(err, retrievedUser) {
                assert.ok(err);
                assert.equal(err.code, 400);
                assert.ok(!retrievedUser);

                // Try and get an almost-valid user id
                RestAPI.User.getUser(anonymousRestContext, 'u:camtotally-not-a-valid-id', function(err, retrievedUser) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    assert.ok(!retrievedUser);

                    // Try and get a non-existent user id
                    RestAPI.User.getUser(anonymousRestContext, 'u:cam:totally-not-existing', function(err, retrievedUser) {
                        assert.ok(err);
                        assert.equal(err.code, 404);
                        assert.ok(!retrievedUser);
                        return callback();
                    });
                });
            });
        });
    });


    describe('Update user', function() {
        /**
        * @return {Stream} A stream to jpg image.
        */
        var getPictureStream = function() {
            var file = __dirname + '/data/restroom.jpg';
            return fs.createReadStream(file);
        };

        /**
         * Test that verifies that it is possible for a user to update its own basic profile, including non standard fields
         */
        it('verify update user', function(callback) {
            // Create a test user
            var testUserId = TestsUtil.generateTestUserId();
            RestAPI.User.createUser(camAdminRestContext, testUserId, 'password', 'Test User', {'visibility': 'public', 'locale': 'en_GB', 'timezone': 'Europe/London'}, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);
                assert.equal(userObj.visibility, 'public');
                assert.equal(userObj.displayName, 'Test User');
                assert.equal(userObj.locale, 'en_GB');
                assert.equal(userObj.timezone, 'Europe/London');
                assert.equal(userObj.resourceType, 'user');
                assert.equal(userObj.profilePath, '/user/' + userObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(userObj.id).resourceId);
                var testUserRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, testUserId, 'password');
                // Set a profile picture
                RestAPI.User.uploadPicture(camAdminRestContext, userObj.id, getPictureStream, null, function(err) {
                    assert.ok(!err);

                    // Update the user
                    var updateValues = {
                        'displayName': 'displayname',
                        'publicAlias': 'publicalias',
                        'visibility': 'private',
                        'locale': 'nl_NL',
                        'timezone': 'Europe/Amsterdam',
                        'non-standard-field': 'Custom data'
                    };
                    RestAPI.User.updateUser(testUserRestContext, userObj.id, updateValues, function (err, user) {
                        assert.ok(!err);
                        assert.ok(user);
                        assert.equal(user.visibility, 'private');
                        assert.equal(user.displayName, 'displayname');
                        assert.equal(user.publicAlias, 'publicalias');
                        assert.equal(user.extra['non-standard-field'], 'Custom data');
                        assert.equal(user.locale, 'nl_NL');
                        assert.equal(user.timezone, 'Europe/Amsterdam');
                        assert.equal(user.resourceType, 'user');
                        assert.equal(user.profilePath, '/user/' + user.tenant.alias + '/' + AuthzUtil.getResourceFromId(user.id).resourceId);
                        assert.ok(user.picture.large);

                        // Get the user's me feed
                        RestAPI.User.getMe(testUserRestContext, function(err, meObj) {
                            assert.ok(!err);
                            assert.ok(meObj);
                            assert.equal(meObj.visibility, 'private');
                            assert.equal(meObj.displayName, 'displayname');
                            assert.equal(meObj.publicAlias, 'publicalias');
                            assert.equal(meObj.extra['non-standard-field'], 'Custom data');
                            assert.equal(meObj.locale.locale, 'nl_NL');
                            assert.equal(meObj.locale.timezone.name, 'Europe/Amsterdam');
                            assert.equal(meObj.resourceType, 'user');
                            assert.equal(meObj.profilePath, '/user/' + meObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(meObj.id).resourceId);

                            // Get the user's basic profile
                            RestAPI.User.getUser(testUserRestContext, userObj.id, function(err, userObj) {
                                assert.ok(!err);
                                assert.ok(userObj);
                                assert.equal(userObj.visibility, 'private');
                                assert.equal(userObj.displayName, 'displayname');
                                assert.equal(userObj.publicAlias, 'publicalias');
                                assert.equal(userObj.extra['non-standard-field'], 'Custom data');
                                assert.equal(userObj.resourceType, 'user');
                                assert.equal(userObj.profilePath, '/user/' + userObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(userObj.id).resourceId);

                                callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that it is not possible for a user to be updated with restricted fields being set
         */
        it('verify cannot update user to tenant admin', function(callback) {
            // Create a test user
            var testUserId = TestsUtil.generateTestUserId();
            RestAPI.User.createUser(camAdminRestContext, testUserId, 'password', 'Test User', {'visibility': 'public', 'locale': 'en_GB', 'timezone': 'Europe/London'}, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);
                assert.equal(userObj.visibility, 'public');
                assert.equal(userObj.displayName, 'Test User');
                assert.equal(userObj.locale, 'en_GB');
                assert.equal(userObj.timezone, 'Europe/London');
                assert.equal(userObj.resourceType, 'user');
                assert.equal(userObj.profilePath, '/user/' + userObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(userObj.id).resourceId);
                var testUserRestContext =  TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, testUserId, 'password');

                // Update the user
                var updateValues = {
                    'admin:tenant': 'true'
                };

                RestAPI.User.updateUser(testUserRestContext, userObj.id, updateValues, function (err) {
                    assert.ok(err);

                    updateValues = {
                        'admin:global': 'true'
                    };

                    RestAPI.User.updateUser(testUserRestContext, userObj.id, updateValues, function (err) {
                        assert.ok(err);

                        PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), userObj.id, function(err, userObj) {
                            assert.ok(!err);
                            assert.ok(userObj);
                            assert.ok(!userObj.isTenantAdmin(global.oaeTests.tenants.cam.alias), 'Expected user to not be update-able to tenant or global admin');
                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that updating a user fails when:
         *
         *  * no parameters are provided; or
         *  * a user is trying to update a different user's basic profile; or
         *  * an anonymous user tries to update a user's profile; or
         *  * a user tries to update a non-existing user's profile
         */
        it('verify failed update', function(callback) {
            // Create a test user
            var testUserId = TestsUtil.generateTestUserId();
            RestAPI.User.createUser(camAdminRestContext, testUserId, 'password', 'Test User', {'visibility': 'public'}, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);
                var testUserRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, testUserId, 'password');

                // Update a non-existing variation of a valid user id (so we know it is a valid id..)
                RestAPI.User.updateUser(camAdminRestContext, userObj.id+'nonexisting', {'displayName': 'Casper, the friendly horse'}, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 404);

                    // Try to update the user's profile without parameters
                    var updateValues = {};
                    RestAPI.User.updateUser(testUserRestContext, userObj.id, updateValues, function(err) {
                        assert.ok(err);
                        assert.equal(err.code, 400);

                        // Try to update the user's profile as a different user. Create this user first
                        var updaterUserId = TestsUtil.generateTestUserId();
                        RestAPI.User.createUser(camAdminRestContext, updaterUserId, 'password', 'Test User', null, function(err, updaterUserObj) {
                            assert.ok(!err);
                            assert.ok(updaterUserObj);
                            var updateUserRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, updaterUserId, 'password');
                            updateValues = {
                                'displayName': 'Stinky John LOL'
                            };
                            RestAPI.User.updateUser(updateUserRestContext, userObj.id, updateValues, function(err) {
                                assert.ok(err);
                                assert.equal(err.code, 401);

                                // Try to update the user's profile as the anonymous user
                                RestAPI.User.updateUser(anonymousRestContext, userObj.id, updateValues, function(err) {
                                    assert.ok(err);
                                    assert.equal(err.code, 401);

                                     // Create user with displayName that is longer than the maximum allowed size
                                    var longDisplayName = TestsUtil.generateRandomText(100);
                                    RestAPI.User.updateUser(updateUserRestContext, userObj.id, {'displayName': longDisplayName}, function(err) {
                                        assert.ok(err);
                                        assert.equal(err.code, 400);
                                        assert.ok(err.msg.indexOf('1000') > 0);

                                        // Create user with an empty displayName
                                        RestAPI.User.updateUser(updateUserRestContext, userObj.id, {'displayName': '\n'}, function(err) {
                                            assert.ok(err);
                                            assert.equal(err.code, 400);

                                            // Make sure that the user's basic profile is unchanged
                                            RestAPI.User.getUser(testUserRestContext, userObj.id, function(err, userObj) {
                                                assert.ok(!err);
                                                assert.ok(userObj);
                                                assert.equal(userObj.visibility, 'public');
                                                assert.equal(userObj.displayName, 'Test User');
                                                assert.equal(userObj.resourceType, 'user');
                                                assert.equal(userObj.profilePath, '/user/' + userObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(userObj.id).resourceId);
                                                callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

    });


    describe('User visibility', function() {

        /*!
         * Verifies the profile permissions of the provided user, according to the given criteria.
         *
         * @param  {RestContext}   restContext             The RestContext to use to fetch the user
         * @param  {String}        userToCheck             The id of the user to check
         * @param  {Boolean}       expectAccess            Whether or not we should expect the context have full access to the user
         * @param  {String}        expectedDisplayName     The expected display name of the user
         * @param  {String}        expectedPublicAlias     The expected public alias of the user
         * @param  {String}        expectedVisibility      The expected visibility of the user, one of 'public', 'loggedin', 'private'
         * @param  {Function}      callback                Invoked when the checks have completed. If an assertion error has occurred, this will not be invoked, rather it will be thrown to the test handler
         */
        var verifyProfilePermissions = function(restContext, userToCheck, expectAccess, expectedDisplayName, expectedPublicAlias, expectedVisibility, callback) {
            // Try to get user 1 as an anonymous user and a logged in user. Both should work
            RestAPI.User.getUser(restContext, userToCheck, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);
                assert.equal(userObj.visibility, expectedVisibility);
                assert.equal(userObj.displayName, expectedDisplayName);
                assert.equal(userObj.publicAlias, expectedPublicAlias);
                assert.equal(userObj.resourceType, 'user');
                // The profile path should only be present if you're allowed to view the user
                if (!expectAccess) {
                    assert.equal(userObj.profilePath, undefined);
                } else {
                    assert.equal(userObj.profilePath, '/user/' + userObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(userObj.id).resourceId);
                }
                callback();
            });
        };

        /**
         * Test that verifies that user visibility settings work as expected. Public users should be visibile to everyone. Loggedin users should be
         * visible to all users, other than the anonymous user. Private user should only be visibile to the user himself. When a user is not visible,
         * only the display name should be visible
         */
        it('verify user permissions', function(callback) {
            // Create 2 public test users
            var jackUserId = TestsUtil.generateTestUserId();
            var jackOpts = {
                'visibility': 'public',
                'publicAlias': 'Jack'
            };

            RestAPI.User.createUser(camAdminRestContext, jackUserId, 'password', 'Jack Doe', jackOpts, function(err, jack) {
                assert.ok(!err);
                assert.ok(jack);
                var jackRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUserId, 'password');

                var janeUserId = TestsUtil.generateTestUserId();
                RestAPI.User.createUser(camAdminRestContext, janeUserId, 'password', 'Jane Doe', {'visibility': 'public'}, function(err, jane) {
                    assert.ok(!err);
                    assert.ok(jane);
                    var janeRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, janeUserId, 'password');

                    // Try to get jack as an anonymous user and a logged in user and the user himself. All should work
                    verifyProfilePermissions(anonymousRestContext, jack.id, true, 'Jack Doe', undefined, 'public', function() {
                        verifyProfilePermissions(janeRestContext, jack.id, true, 'Jack Doe', undefined, 'public', function() {
                            verifyProfilePermissions(jackRestContext, jack.id, true, 'Jack Doe', 'Jack', 'public', function() {

                                // Set jack's visibility to logged in
                                RestAPI.User.updateUser(jackRestContext, jack.id, {'visibility': 'loggedin'}, function(err) {
                                    assert.ok(!err);

                                    // Try to get jack as an anonymous user and a logged in user and the user himself. The anonymous user
                                    // should only be able to get the display name
                                    verifyProfilePermissions(anonymousRestContext, jack.id, false, 'Jack', undefined, 'loggedin', function() {
                                        verifyProfilePermissions(janeRestContext, jack.id, true, 'Jack Doe', undefined, 'loggedin', function() {
                                            verifyProfilePermissions(jackRestContext, jack.id, true, 'Jack Doe', 'Jack', 'loggedin', function() {

                                                // Set jack's visibility to private
                                                RestAPI.User.updateUser(jackRestContext, jack.id, {'visibility': 'private'}, function(err) {
                                                    assert.ok(!err);

                                                    // Try to get jack as an anonymous user and a logged in user and the user himself. The anonymous user
                                                    // and the logged in user should only be able to get the display name
                                                    verifyProfilePermissions(anonymousRestContext, jack.id, false, 'Jack', undefined, 'private', function() {
                                                        verifyProfilePermissions(janeRestContext, jack.id, false, 'Jack', undefined, 'private', function() {
                                                            verifyProfilePermissions(jackRestContext, jack.id, true, 'Jack Doe', 'Jack', 'private', function() {

                                                                // Set jack's visibility to an invalid option
                                                                RestAPI.User.updateUser(jackRestContext, jack.id, {'visibility': 'non-existing'}, function(err) {
                                                                    assert.ok(err);

                                                                    // Make sure that the jack's visibility has not changed
                                                                    verifyProfilePermissions(anonymousRestContext, jack.id, false, 'Jack', undefined, 'private', function() {
                                                                        verifyProfilePermissions(janeRestContext, jack.id, false, 'Jack', undefined, 'private', function() {
                                                                            verifyProfilePermissions(jackRestContext, jack.id, true, 'Jack Doe', 'Jack', 'private', callback);
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a public user's profile is fully visible beyond the tenant scope.
         */
        it('verify public user is visible beyond tenant scope', function(callback) {
            var usernameA = TestsUtil.generateTestUserId();
            var usernameB = TestsUtil.generateTestUserId();

            // Create user in tenant A
            RestAPI.User.createUser(camAdminRestContext, usernameA, 'password', 'Public User', {'visibility': 'public'}, function(err, userA) {
                assert.ok(!err);
                var restCtxA = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, usernameA, 'password');

                // Create user B in GT tenant
                RestAPI.User.createUser(gtAdminRestContext, usernameB, 'password', 'Private User', null, function(err, userB) {
                    assert.ok(!err);
                    restCtxB = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host, usernameB, 'password');

                    verifyProfilePermissions(restCtxB, userA.id, true, userA.displayName, undefined, 'public', callback);
                });
            });
        });

        /**
         * Test that verifies that a user's basic profile is hidden when their visibility is restricted to 'loggedin' users and they are
         * accessed by an authenticated user from a different tenant.
         */
        it('verify loggedin user is hidden beyond tenant scope', function(callback) {
            var usernameA = TestsUtil.generateTestUserId();
            var usernameB = TestsUtil.generateTestUserId();

            // Create user in tenant A
            var loggedInUserOpts = {
                'visibility': 'loggedin',
                'publicAlias': 'A user.'
            };

            RestAPI.User.createUser(camAdminRestContext, usernameA, 'password', 'LoggedIn User', loggedInUserOpts, function(err, userA) {
                assert.ok(!err);
                var restCtxA = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, usernameA, 'password');

                // Create user B in GT tenant
                RestAPI.User.createUser(gtAdminRestContext, usernameB, 'password', 'Private User', null, function(err, userB) {
                    assert.ok(!err);
                    restCtxB = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host, usernameB, 'password');

                    verifyProfilePermissions(restCtxB, userA.id, false, 'A user.', undefined, 'loggedin', callback);
                });
            });
        });
    });


    describe('User timezone', function() {

        /**
         * Test that verifies that we respect the user timezone.
         */
        it('Test timezones', function(callback) {
            // Create a test user
            var testUserId = TestsUtil.generateTestUserId();
            RestAPI.User.createUser(camAdminRestContext, testUserId, 'password', 'Test User', null, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);
                var testUserRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, testUserId, 'password');

                // Change the timezone and checks its validaty
                RestAPI.User.updateUser(testUserRestContext, userObj.id, {'timezone': 'America/Argentina/ComodRivadavia'}, function(err) {
                    assert.ok(!err);
                    RestAPI.User.getMe(testUserRestContext, function(err, meObj) {
                        assert.ok(!err);
                        // We should get America/Argentina/Buenos_Aires here because that's the closest rails zone
                        assert.equal(meObj.locale.timezone.name, 'America/Argentina/Buenos_Aires');
                        assert.equal(meObj.locale.timezone.offset, -3);

                        // Test another more complex timezone
                        RestAPI.User.updateUser(testUserRestContext, userObj.id, {'timezone': 'Asia/Kathmandu'}, function(err) {
                            assert.ok(!err);
                            RestAPI.User.getMe(testUserRestContext, function(err, meObj) {
                                assert.ok(!err);
                                assert.equal(meObj.locale.timezone.name, 'Asia/Kathmandu');
                                assert.equal(meObj.locale.timezone.offset, 5.75);

                                // Test a non-existing timezone. This should revert back to BST
                                RestAPI.User.updateUser(testUserRestContext, userObj.id, {'timezone': 'Jurassic/Park'}, function(err) {
                                    assert.ok(err);
                                    assert.equal(err.code, 400);
                                    RestAPI.User.getMe(testUserRestContext, function(err, meObj) {
                                        assert.ok(!err);
                                        assert.equal(meObj.locale.timezone.name, 'Asia/Kathmandu');
                                        assert.equal(meObj.locale.timezone.offset, 5.75);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test to verify that we can get a list of supported timezones with
         * offsets from UTC in hours and pretty display names
         */
        it('verify getting a list of timezones with offsets', function(callback) {
            RestAPI.User.getTimezones(anonymousRestContext, function(err, zones) {
                assert.ok(!err);
                assert.equal(zones['Australia/Sydney'].displayName, 'Sydney');
                assert.equal(zones['Australia/Sydney'].offset, new TZ.Date('Australia/Sydney').getTimezoneOffset() / 60);
                callback();
            });
        });
    });

    describe('Global and tenant admin', function() {

        /**
         * Test that verifies valid and invalid access to making users global or tenant admins. setGlobalAdmin will use the internal APIs as there
         * is not yet a way in which global admins can be set through the REST endpoints
         */
        it('verify making someone an admin', function(callback) {
            // Create 2 test users
            var jackUserId = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUserId, 'password', 'Jack Doe', null, function(err, jack) {
                assert.ok(!err);
                assert.ok(jack);
                var jackContext = new Context(global.oaeTests.tenants.cam, jack);

                var janeUserId = TestsUtil.generateTestUserId('jane');
                RestAPI.User.createUser(camAdminRestContext, janeUserId, 'password', 'Jane Doe', null, function(err, jane) {
                    assert.ok(!err);
                    assert.ok(jane);
                    var janeContext = new Context(global.oaeTests.tenants.cam, jane);

                    // Verify an anonymous user cannot promote someone to global admin
                    PrincipalsAPI.setGlobalAdmin(new Context(global.oaeTests.tenants.cam), jack.id, true, function(err) {
                        assert.ok(err);
                        assert.equal(err.code, 401);

                        // Verify an anonymous user-tenant user cannot promote someone to tenant admin
                        RestAPI.User.setTenantAdmin(anonymousRestContext, jack.id, true, function(err) {
                            assert.ok(err);
                            assert.equal(err.code, 401);

                            // Verify that anonymous admin-tenant users cannot make users tenant-admin
                            RestAPI.User.setTenantAdmin(anonymousGlobalRestContext, jack.id, true, function(err) {
                                assert.ok(err);
                                assert.equal(err.code, 401);

                                // Jack will try to make himself and Jane an admin. Both should fail.
                                PrincipalsAPI.setGlobalAdmin(jackContext, jack.id, true, function(err) {
                                    assert.ok(err);
                                    assert.equal(err.code, 401);
                                    PrincipalsAPI.setGlobalAdmin(jackContext, jane.id, true, function(err) {
                                        assert.ok(err);
                                        assert.equal(err.code, 401);

                                        // We make Jack a global admin
                                        PrincipalsAPI.setGlobalAdmin(globalAdminContext, jack.id, true, function(err) {
                                            assert.ok(!err);
                                            // Verify that Jack is a global admin
                                            PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), jack.id, function(err, user) {
                                                assert.ok(!err);
                                                assert.equal(user.isGlobalAdmin(), true);
                                                assert.equal(user.isAdmin(global.oaeTests.tenants.cam.alias), true);
                                                assert.equal(user.isTenantAdmin(global.oaeTests.tenants.cam.alias), false);
                                                jackContext = new Context(global.oaeTests.tenants.cam, user);

                                                // Jack will make Jane a global admin
                                                PrincipalsAPI.setGlobalAdmin(jackContext, jane.id, true, function(err) {
                                                    assert.ok(!err);

                                                    // Check that Jane is a global admin
                                                    PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), jane.id, function(err, user) {
                                                        assert.ok(!err);
                                                        assert.equal(user.isGlobalAdmin(), true);
                                                        assert.equal(user.isAdmin(global.oaeTests.tenants.cam.alias), true);
                                                        assert.equal(user.isTenantAdmin(global.oaeTests.tenants.cam.alias), false);
                                                        janeContext = new Context(global.oaeTests.tenants.cam, user);

                                                        // Revoke Jack's global admin rights
                                                        PrincipalsAPI.setGlobalAdmin(globalAdminContext, jack.id, false, function(err) {
                                                            assert.ok(!err);

                                                            // Check that Jack is no longer an admin
                                                            PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), jack.id, function(err, user) {
                                                                assert.ok(!err);
                                                                assert.equal(user.isGlobalAdmin(), false);
                                                                assert.equal(user.isAdmin(global.oaeTests.tenants.cam.alias), false);
                                                                assert.equal(user.isTenantAdmin(global.oaeTests.tenants.cam.alias), false);
                                                                jackContext = new Context(global.oaeTests.tenants.cam, user);

                                                                // Make sure that Jack can no longer revoke the admin rights of Jane
                                                                PrincipalsAPI.setGlobalAdmin(jackContext, jane.id, false, function(err) {
                                                                    assert.ok(err);
                                                                    assert.equal(err.code, 401);

                                                                    // Make sure that Jane is still an admin
                                                                    PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), jane.id, function(err, user) {
                                                                        assert.ok(!err);
                                                                        assert.equal(user.isGlobalAdmin(), true);
                                                                        assert.equal(user.isAdmin(global.oaeTests.tenants.cam.alias), true);
                                                                        assert.equal(user.isTenantAdmin(global.oaeTests.tenants.cam.alias), false);
                                                                        callback();
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the access restrictions for revoking admin access from users.
         */
        it('verify revoking admin rights access restrictions', function(callback) {
            // Create 3 test users
            var jackUserId = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUserId, 'password', 'Jack Doe', null, function(err, jack) {
                assert.ok(!err);

                var janeUserId = TestsUtil.generateTestUserId('jane');
                RestAPI.User.createUser(camAdminRestContext, janeUserId, 'password', 'Jane Doe', null, function(err, jane) {
                    assert.ok(!err);

                    var samUserId = TestsUtil.generateTestUserId('sam');
                    RestAPI.User.createUser(camAdminRestContext, samUserId, 'password', 'Jane Doe', null, function(err, sam) {
                        assert.ok(!err);

                        // Make jane a tenant admin and verify it worked
                        RestAPI.User.setTenantAdmin(globalAdminRestContext, jane.id, true, function(err) {
                            assert.ok(!err);

                            PrincipalsAPI.getUser(globalAdminContext, jane.id, function(err, jane) {
                                assert.ok(!err);
                                assert.ok(jane.isTenantAdmin(global.oaeTests.tenants.cam.alias));

                                // Make sam a global admin and verify it worked
                                PrincipalsAPI.setGlobalAdmin(globalAdminContext, sam.id, true, function(err) {
                                    assert.ok(!err);

                                    PrincipalsAPI.getUser(globalAdminContext, sam.id, function(err, sam) {
                                        assert.ok(!err);
                                        assert.ok(sam.isGlobalAdmin());

                                        // Get jack's API user so we can build an API context later
                                        PrincipalsAPI.getUser(globalAdminContext, jack.id, function(err, jack) {
                                            assert.ok(!err);
                                            var jackCtx = new Context(global.oaeTests.tenants.cam, jack);
                                            var jackRestCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUserId, 'password');

                                            // Verify an anonymous user (user-tenant or admin-tenant) or auth user cannot revoke jane's tenant-admin rights
                                            RestAPI.User.setTenantAdmin(anonymousRestContext, jane.id, false, function(err) {
                                                assert.ok(err);
                                                assert.equal(err.code, 401);

                                                RestAPI.User.setTenantAdmin(anonymousGlobalRestContext, jane.id, false, function(err) {
                                                    assert.ok(err);
                                                    assert.equal(err.code, 401);

                                                    RestAPI.User.setTenantAdmin(jackRestCtx, jane.id, false, function(err) {
                                                        assert.ok(err);
                                                        assert.equal(err.code, 401);

                                                        // Verify an anonymous user (user-tenant or admin-tenant) or auth user cannot revoke sam's global-admin rights
                                                        PrincipalsAPI.setGlobalAdmin(new Context(global.oaeTests.tenants.cam), sam.id, false, function(err) {
                                                            assert.ok(err);
                                                            assert.equal(err.code, 401);

                                                            PrincipalsAPI.setGlobalAdmin(new Context(global.oaeTests.tenants.global), sam.id, false, function(err) {
                                                                assert.ok(err);
                                                                assert.equal(err.code, 401);

                                                                PrincipalsAPI.setGlobalAdmin(jackCtx, sam.id, false, function(err) {
                                                                    assert.ok(err);
                                                                    assert.equal(err.code, 401);

                                                                    // Ensure jane and sam have their admin rights
                                                                    PrincipalsAPI.getUser(globalAdminContext, jane.id, function(err, jane) {
                                                                        assert.ok(!err);
                                                                        assert.ok(jane.isTenantAdmin(global.oaeTests.tenants.cam.alias));

                                                                        PrincipalsAPI.getUser(globalAdminContext, sam.id, function(err, sam) {
                                                                            assert.ok(!err);
                                                                            assert.ok(sam.isGlobalAdmin());
                                                                            return callback();
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a tenant admin cannot make a user a global admin.
         */
        it('verify tenant admin restrictions', function(callback) {
            // Create a test user
            var jackUserId = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUserId, 'password', 'Jack Doe', null, function(err, jack) {
                assert.ok(!err);
                assert.ok(jack);
                var jackContext = new Context(global.oaeTests.tenants.cam, jack);

                // We make Jack a tenant admin
                RestAPI.User.setTenantAdmin(globalAdminRestContext, jack.id, true, function(err) {
                    assert.ok(!err);
                    // Verify that Jack is a tenant admin
                    PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), jack.id, function(err, user) {
                        assert.ok(!err);
                        assert.equal(user.isGlobalAdmin(), false);
                        assert.equal(user.isAdmin(global.oaeTests.tenants.cam.alias), true);
                        assert.equal(user.isTenantAdmin(global.oaeTests.tenants.cam.alias), true);
                        jackContext = new Context(global.oaeTests.tenants.cam, user);

                        // Jack will try to make herself a global admin. This should fail
                        PrincipalsAPI.setGlobalAdmin(jackContext, jack.id, true, function(err) {
                            assert.ok(err);
                            assert.equal(err.code, 401);
                            // Verify that Jack is not a global admin
                            PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), jack.id, function(err, user) {
                                assert.ok(!err);
                                assert.equal(user.isGlobalAdmin(), false);
                                assert.equal(user.isAdmin(global.oaeTests.tenants.cam.alias), true);
                                assert.equal(user.isTenantAdmin(global.oaeTests.tenants.cam.alias), true);
                                callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that unknown users and groups cannot be made admins
         */
        it('verify admin parameter validation', function(callback) {
            // Try to make an invalid user an admin
            RestAPI.User.setTenantAdmin(globalAdminRestContext, 'invalid-id', true, function(err) {
                assert.ok(err);
                assert.equal(err.code, 400);

                // Try to make a non-existing user an admin
                RestAPI.User.setTenantAdmin(globalAdminRestContext, 'u:cam:non-existing', true, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 404);

                    // Try to make a group an admin
                    RestAPI.User.setTenantAdmin(globalAdminRestContext, 'g:cam:group', true, function(err) {
                        assert.ok(err);
                        assert.equal(err.code, 400);
                        callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that tenant admins can only update items inside of their own tenant.
         */
        it('Verify tenant admin separation', function(callback) {
            // We create 3 users: jack, jane and joe. Jack and Joe are in tenant A, Jane is in tenant B.
            // We promote John to a tenant admin (for A) and try to update the profile info for Jack and Jane.
            // It should only work for Jack.
            var jackUserId = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUserId, 'password', 'Jack Doe', null, function(err, jack) {
                assert.ok(!err);
                assert.ok(jack);
                var jackRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUserId, 'password');

                var joeUserId = TestsUtil.generateTestUserId('joe');
                RestAPI.User.createUser(camAdminRestContext, joeUserId, 'password', 'Joe Doe', null, function(err, joe) {
                    assert.ok(!err);
                    assert.ok(joe);
                    var joeRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, joeUserId, 'password');

                    var janeUserId = TestsUtil.generateTestUserId('jane');
                    RestAPI.User.createUser(gtAdminRestContext, janeUserId, 'password', 'Jane Doe', null, function(err, jane) {
                        assert.ok(!err);
                        assert.ok(jane);
                        var janeRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host, janeUserId, 'password');

                        // Make Jack a tenant admin
                        RestAPI.User.setTenantAdmin(camAdminRestContext, jack.id, true, function(err) {
                            assert.ok(!err);
                            // Verify that Jack is a tenant admin
                            PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), jack.id, function(err, user) {
                                assert.ok(!err);
                                assert.equal(user.isGlobalAdmin(), false);
                                assert.equal(user.isAdmin(global.oaeTests.tenants.cam.alias), true);
                                assert.equal(user.isTenantAdmin(global.oaeTests.tenants.cam.alias), true);
                                jackContext = new Context(global.oaeTests.tenants.cam, user);

                                // Update Joe
                                var updateData = {
                                    'locale': 'en_CA',
                                    'displayName': 'Foo Bar'
                                };
                                RestAPI.User.updateUser(jackRestContext, joe.id, updateData, function(err) {
                                    assert.ok(!err);
                                    // Verify that the update has worked
                                    RestAPI.User.getMe(joeRestContext, function(err, meObj) {
                                        assert.ok(!err);
                                        assert.ok(meObj);
                                        assert.equal(meObj.displayName, 'Foo Bar');
                                        assert.equal(meObj.locale.locale, 'en_CA');
                                        assert.equal(meObj.resourceType, 'user');
                                        assert.equal(meObj.profilePath, '/user/' + meObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(meObj.id).resourceId);

                                        // Try to update Jane
                                        RestAPI.User.updateUser(jackRestContext, jane.id, updateData, function(err) {
                                            assert.ok(err);
                                            // Verify that the update has not happened
                                            RestAPI.User.getMe(janeRestContext, function(err, meObj) {
                                                assert.ok(!err);
                                                assert.ok(meObj);
                                                assert.equal(meObj.displayName, 'Jane Doe');
                                                assert.equal(meObj.locale.locale, 'en_GB');
                                                assert.equal(meObj.resourceType, 'user');
                                                assert.equal(meObj.profilePath, '/user/' + meObj.tenant.alias + '/' + AuthzUtil.getResourceFromId(meObj.id).resourceId);

                                                // Disable Jack's admin status
                                                RestAPI.User.setTenantAdmin(camAdminRestContext, jack.id, false, function(err) {
                                                    assert.ok(!err);

                                                    // Verify he is no longer an admin
                                                    PrincipalsAPI.getUser(new Context(global.oaeTests.tenants.cam), jack.id, function(err, user) {
                                                        assert.ok(!err);
                                                        assert.equal(user.isGlobalAdmin(), false);
                                                        assert.equal(user.isAdmin(global.oaeTests.tenants.cam.alias), false);
                                                        assert.equal(user.isTenantAdmin(global.oaeTests.tenants.cam.alias), false);
                                                        callback();
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
