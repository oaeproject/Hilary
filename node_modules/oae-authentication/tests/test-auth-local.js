/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 * 
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');
var request = require('request');

var Context = require('oae-context').Context;
var PrincipalsAPI = require('oae-principals');
var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var TestsUtil = require('oae-tests');

var AuthenticationAPI = require('oae-authentication');
var AuthenticationConstants = require('oae-authentication/lib/constants').AuthenticationConstants;
var LoginId = require('oae-authentication/lib/model').LoginId;

describe('Authentication', function() {

    // Rest context that can be used for anonymous requests on the cambridge tenant
    var anonymousCamRestContext = null;
    // Rest context that can be used for anonymous requests on the georgia tech tenant
    var anonymousGtRestContext = null;
    // Rest context that can be used every time we need to make a request as a tenant admin
    var camAdminRestContext = null;

    /**
     * Function that will fill up the tenant admin and anymous rest context
     */
    before(function(callback) {
        // Fill up the anonymous cam rest context
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        // Fill up the anonymous gt rest context
        anonymousGtRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host);
        // Fill up global admin rest context
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        callback();
    });


    describe('Local authentication', function() {

        /**
         * Test that verifies that users can log into the system using a local authorization strategy
         */
        it('verify local authentication', function(callback) {
            // Create a test user
            var userId = TestsUtil.generateTestUserId();
            RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', null, function(err, createdUser) {
                assert.ok(!err);
                assert.ok(createdUser);
                var userRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, userId, 'password');

                // Log the user out first, to make sure that the cookie jar for the user is empty
                RestAPI.Authentication.logout(userRestContext, function(err) {
                    assert.ok(!err);

                    // Login without a user id
                    RestAPI.Authentication.login(userRestContext, null, 'password', function(err) {
                        assert.ok(err);

                        // Log in with the wrong password
                        RestAPI.Authentication.login(userRestContext, userId, 'wrong-password', function(err) {
                            assert.ok(err);
    
                            // Log in with the correct password
                            RestAPI.Authentication.login(userRestContext, userId, 'password', function(err) {
                                assert.ok(!err);
                            
                                // Verify that we are actually logged in
                                RestAPI.User.getMe(userRestContext, function(err, meObj) {
                                    assert.ok(!err);
                                    assert.ok(meObj);
                                    assert.equal(meObj.userId, createdUser.id);
                                    
                                    // Logout
                                    RestAPI.Authentication.logout(userRestContext, function(err) {
                                        assert.ok(!err);
                                        
                                        // Verify that we are now logged out
                                        RestAPI.User.getMe(userRestContext, function(err, meObj) {
                                            assert.ok(!err);
                                            assert.ok(meObj);
                                            assert.equal(meObj.anon, true);
                                            callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
        
        /**
         * Test that verifies that loggin in with a non-existing user doesn't work
         */
        it('verify failed authentication', function(callback) {
            // Try to log in as an invalid user
            RestAPI.Authentication.login(anonymousCamRestContext, 'invalid-user', 'password', function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);
                
                // Try to log in as a non-existing user
                RestAPI.Authentication.login(anonymousCamRestContext, 'u:cam:non-existing-user', 'password', function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 401);
                    callback();
                });
            });
        });
    
        /**
         * Test that verifies that logging in is properly separated by tenant
         */
        it('verify tenant login separation', function(callback) {
            // Create a test user
            var userId = TestsUtil.generateTestUserId();
            RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', null, function(err, createdUser) {
                assert.ok(!err);
                assert.ok(createdUser);
                var userRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, userId, 'password');

                // Verify that we cannot login on tenant B
                RestAPI.Authentication.login(anonymousGtRestContext, userId, 'password', function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 401);
                    
                    // Verify that we can login on tenant A
                    RestAPI.Authentication.login(anonymousCamRestContext, userId, 'password', function(err) {
                        assert.ok(!err);
                        callback();
                    });
                });
            });
        });

    });
    
    
    describe('Admin login', function() {
        
        /**
         * Test that verifies that a global administrator can successfully login on the global admin tenant
         */
        it('verify global administrator authentication', function(callback) {
            var globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
            
            // Get the me feed, this should log in the global admin as well
            RestAPI.User.getMe(globalAdminRestContext, function(err, meObj) {
                assert.ok(!err);
                assert.ok(meObj);
                assert.equal(meObj.isGlobalAdmin, true);

                // Logout
                RestAPI.Authentication.logout(globalAdminRestContext, function(err) {
                    assert.ok(!err);
                    
                    // Verify that the global admin has been logged out
                    RestAPI.User.getMe(globalAdminRestContext, function(err, meObj) {
                        assert.ok(!err);
                        assert.ok(meObj);
                        assert.equal(meObj.anon, true);

                        // Log the global admin back in so the cookie jar can be restored
                        RestAPI.Authentication.login(globalAdminRestContext, globalAdminRestContext.userId, globalAdminRestContext. userPassword, function(err) {
                            assert.ok(!err);
                            callback();
                        });
                    });
                });
            });
        });
        
    });

    describe('#getOrCreateUser', function() {
       
        /**
         * Test that verifies the working of the getOrCreateUser function. This will use the internal
         * API as this would normally be called by Facebook, Twitter, etc. authentication
         */
        it('verify getOrCreateUser', function(callback) {
            var userId = TestsUtil.generateTestUserId();
            var ctx = new Context(global.oaeTests.tenants.cam);

            AuthenticationAPI.getOrCreateUser(ctx, AuthenticationConstants.providers.TWITTER, userId, 'Nicolaas Matthijs', null, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);
                
                // Get the user again through the same function
                AuthenticationAPI.getOrCreateUser(ctx, AuthenticationConstants.providers.TWITTER, userId, 'Branden Visser', null, function(err, userObj) {
                    assert.ok(!err);
                    assert.ok(userObj);
                    assert.equal(userObj.displayName, 'Nicolaas Matthijs');
                    callback();
                });
            });
        });
    });

    describe('#createUser', function() {

        it ('verify create without login id', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            AuthenticationAPI.createUser(ctx, null, 'Branden Visser', null, function(err, userObj) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it ('verify create without tenant id', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            var userId = TestsUtil.generateTestUserId();
            var loginId = new LoginId(null, AuthenticationConstants.providers.LOCAL, userId, { password: 'password' });
            AuthenticationAPI.createUser(ctx, loginId, 'Branden Visser', null, function(err, userObj) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it ('verify create without provider', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            var userId = TestsUtil.generateTestUserId();
            var loginId = new LoginId(ctx.tenant().alias, null, userId, { password: 'password' });
            AuthenticationAPI.createUser(ctx, loginId, 'Branden Visser', null, function(err, userObj) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it ('verify create without external id', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, null, { password: 'password' });
            AuthenticationAPI.createUser(ctx, loginId, 'Branden Visser', null, function(err, userObj) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it ('verify create local without password', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            var userId = TestsUtil.generateTestUserId();
            var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId);
            AuthenticationAPI.createUser(ctx, loginId, 'Branden Visser', null, function(err, userObj) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it ('verify create local with short password', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            var userId = TestsUtil.generateTestUserId();
            var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, { password: '12345' });
            AuthenticationAPI.createUser(ctx, loginId, 'Branden Visser', null, function(err, userObj) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        it ('verify create user with local loginId', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            var userId = TestsUtil.generateTestUserId();
            var userRestContext = new RestContext(global.oaeTests.tenants.cam.baseUrl, userId, 'password');
            var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, { password: 'password' });
            AuthenticationAPI.createUser(ctx, loginId, 'Branden Visser', null, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);

                // verify we can log in as this user
                RestAPI.Authentication.login(anonymousCamRestContext, userId, 'password', function(err) {
                    assert.ok(!err);
                    // Verify that we are actually logged in
                    RestAPI.User.getMe(userRestContext, function(err, meObj) {
                        assert.ok(!err);
                        assert.ok(meObj);
                        assert.equal(meObj.userId, userObj.id);
                        callback();
                    });
                });
            });
        });

        it ('verify create user with non-local loginId', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            var userId = TestsUtil.generateTestUserId();
            var userRestContext = new RestContext(global.oaeTests.tenants.cam.baseUrl, userId, 'password');
            var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.TWITTER, userId);
            AuthenticationAPI.createUser(ctx, loginId, 'Branden Visser', null, function(err, userObj) {
                assert.ok(!err);
                assert.ok(userObj);

                // verify the mapping exists
                AuthenticationAPI.getUserIdFromLoginId(ctx.tenant().alias, AuthenticationConstants.providers.TWITTER, userId, function(err, userId) {
                    assert.ok(!err);
                    assert.equal(userId, userObj.id);
                    callback();
                });
            });
        });
    });

    describe('#associateLoginId', function() {

        it('verify associate without loginId', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId();
                ctx = new Context(global.oaeTests.tenants.cam, user);

                // associate a login id to the user, with no provider
                AuthenticationAPI.associateLoginId(ctx, null, user.id, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    callback();
                });
            });
        });

        it('verify associate without tenant', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId();
                ctx = new Context(global.oaeTests.tenants.cam, user);
                var loginId = new LoginId(null, AuthenticationConstants.providers.LOCAL, userId, { password: 'password' });

                // associate a login id to the user, with no provider
                AuthenticationAPI.associateLoginId(ctx, loginId, user.id, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    callback();
                });
            });
        });

        it('verify associate without provider', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId();
                ctx = new Context(global.oaeTests.tenants.cam, user);
                var loginId = new LoginId(ctx.tenant().alias, null, userId, { password: 'password' });

                // associate a login id to the user, with no provider
                AuthenticationAPI.associateLoginId(ctx, loginId, user.id, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    callback();
                });
            });
        });

        it('verify associate without external id', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId();
                ctx = new Context(global.oaeTests.tenants.cam, user);
                var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, null, { password: 'password' });

                // associate a login id to the user, with no provider
                AuthenticationAPI.associateLoginId(ctx, loginId, user.id, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    callback();
                });
            });
        });

        it('verify associate without user id', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId();
                ctx = new Context(global.oaeTests.tenants.cam, user);
                var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, { password: 'password' });

                // associate a login id to the user, with no provider
                AuthenticationAPI.associateLoginId(ctx, loginId, null, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    callback();
                });
            });
        });

        it('verify associate local without password', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId();
                ctx = new Context(global.oaeTests.tenants.cam, user);
                var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId);

                // associate a login id to the user, with no provider
                AuthenticationAPI.associateLoginId(ctx, loginId, user.id, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    callback();
                });
            });
        });

        it('verify associate local with short password', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId();
                ctx = new Context(global.oaeTests.tenants.cam, user);
                var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, { password: '12345' });

                // associate a login id to the user, with no provider
                AuthenticationAPI.associateLoginId(ctx, loginId, user.id, function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    callback();
                });
            });
        });

        it('verify associate login id to self', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId();
                ctx = new Context(global.oaeTests.tenants.cam, user);
                var loginId = new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, { password: 'password' });

                // associate a login id to the user
                AuthenticationAPI.associateLoginId(ctx, loginId, user.id, function(err) {
                    assert.ok(!err);

                    // verify the login id is mapped
                    AuthenticationAPI.getUserIdFromLoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, function(err, userId) {
                        assert.ok(!err);
                        assert.equal(user.id, userId);
                        callback();
                    });
                });
            });
        });

        it('verify associate multiple login ids to self', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId() + ':withcolon';
                var twitterId = TestsUtil.generateTestUserId() + ':withcolon';
                ctx = new Context(global.oaeTests.tenants.cam, user);

                // associate a login id to the user
                AuthenticationAPI.associateLoginId(ctx, new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, { password: 'password' }), user.id, function(err) {
                    assert.ok(!err);

                    // associate a second twitter id to the user
                    AuthenticationAPI.associateLoginId(ctx, new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.TWITTER, twitterId), user.id, function(err) {
                        assert.ok(!err);

                        // verify the local login id is mapped
                        AuthenticationAPI.getUserIdFromLoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, function(err, userId) {
                            assert.ok(!err);
                            assert.equal(user.id, userId);

                            // verify the twitter login id is mapped
                            AuthenticationAPI.getUserIdFromLoginId(ctx.tenant().alias, AuthenticationConstants.providers.TWITTER, twitterId, function(err, userId) {
                                assert.ok(!err);
                                assert.equal(user.id, userId);
                                callback();
                            });
                        });
                    });
                });
            });
        });

        it('verify admin associate login id', function(callback) {
            var ctx = TestsUtil.createTenantAdminContext(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId() + ':withcolon';

                // associate a login id to the user
                AuthenticationAPI.associateLoginId(ctx, new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, { password: 'password' }), user.id, function(err) {
                    assert.ok(!err);

                    // verify the local login id is mapped
                    AuthenticationAPI.getUserIdFromLoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, function(err, userId) {
                        assert.ok(!err);
                        assert.equal(user.id, userId);
                        callback();
                    });
                });
            });
        });

        it('verify another user cannot associate login id', function(callback) {
            var ctx = TestsUtil.createTenantAdminContext(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, mrvisser) {
                assert.ok(!err);
                var mrvisserUsername = TestsUtil.generateTestUserId() + ':withcolon';

                PrincipalsAPI.createUser(ctx, 'Bert Pareyn', null, function(err, bert) {
                    assert.ok(!err);
                    var bertCtx = new Context(global.oaeTests.tenants.cam, bert);

                    // associate a login id to the user
                    AuthenticationAPI.associateLoginId(bertCtx, new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, mrvisserUsername, { password: 'password' }), mrvisser.id, function(err) {
                        assert.ok(err);
                        assert.equal(err.code, 401);

                        // verify the local login id is mapped
                        AuthenticationAPI.getUserIdFromLoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, mrvisserUsername, function(err, mrvisserId) {
                            assert.ok(!err);
                            assert.ok(!mrvisserId);
                            callback();
                        });
                    });
                });
            });
        });

        it('verify cannot associate multiple login ids of same type', function(callback) {
            var ctx = new Context(global.oaeTests.tenants.cam);
            PrincipalsAPI.createUser(ctx, 'Branden Visser', null, function(err, user) {
                assert.ok(!err);
                var userId = TestsUtil.generateTestUserId() + ':withcolon';
                var userId2 = TestsUtil.generateTestUserId() + ':withcolon';
                ctx = new Context(global.oaeTests.tenants.cam, user);

                // associate a login id to the user
                AuthenticationAPI.associateLoginId(ctx, new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, { password: 'password' }), user.id, function(err) {
                    assert.ok(!err);

                    // associate a second twitter id to the user
                    AuthenticationAPI.associateLoginId(ctx, new LoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId2, { password: 'password' }), user.id, function(err) {
                        assert.ok(err);
                        assert.equal(err.code, 400);

                        // verify the first local login id is mapped
                        AuthenticationAPI.getUserIdFromLoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId, function(err, userId) {
                            assert.ok(!err);
                            assert.equal(user.id, userId);

                            // verify the second local login id is not mapped
                            AuthenticationAPI.getUserIdFromLoginId(ctx.tenant().alias, AuthenticationConstants.providers.LOCAL, userId2, function(err, userId) {
                                assert.ok(!err);
                                assert.ok(!userId);
                                callback();
                            });
                        });
                    });
                });
            });
        });

        it('verify admin re-associate login id', function(callback) {
            var adminCtx = TestsUtil.createTenantAdminContext(global.oaeTests.tenants.cam);
            var mrvisserUsername = TestsUtil.generateTestUserId() + ':withcolon';
            var mrvisserLoginId = new LoginId(global.oaeTests.tenants.cam.alias, AuthenticationConstants.providers.TWITTER, mrvisserUsername);
            var bertUsername = TestsUtil.generateTestUserId() + ':withcolon';
            var bertLoginId = new LoginId(global.oaeTests.tenants.cam.alias, AuthenticationConstants.providers.LOCAL, bertUsername, { password: 'password' });
            AuthenticationAPI.createUser(adminCtx, mrvisserLoginId, 'Branden Visser', null, function(err, mrvisser) {
                assert.ok(!err);

                AuthenticationAPI.createUser(adminCtx, bertLoginId, 'Bert Pareyn', null, function(err, bert) {
                    assert.ok(!err);

                    AuthenticationAPI.associateLoginId(adminCtx, new LoginId(adminCtx.tenant().alias, AuthenticationConstants.providers.TWITTER, mrvisserUsername), bert.id, function(err) {
                        assert.ok(!err);

                        AuthenticationAPI.getUserIdFromLoginId(adminCtx.tenant().alias, AuthenticationConstants.providers.TWITTER, mrvisserUsername, function(err, userId) {
                            assert.ok(!err);
                            assert.equal(userId, bert.id);
                            callback();
                        });
                    });
                });
            });
        });

        it('verify non-admin cannot re-associate login id', function(callback) {
            var tenant = global.oaeTests.tenants.cam;
            var adminCtx = TestsUtil.createTenantAdminContext(tenant);
            var mrvisserUsername = TestsUtil.generateTestUserId();
            var mrvisserLoginId = new LoginId(tenant.alias, AuthenticationConstants.providers.TWITTER, mrvisserUsername);
            var bertUsername = TestsUtil.generateTestUserId();
            var bertLoginId = new LoginId(tenant.alias, AuthenticationConstants.providers.LOCAL, bertUsername, { password: 'password' });
            AuthenticationAPI.createUser(adminCtx, mrvisserLoginId, 'Branden Visser', null, function(err, mrvisser) {
                assert.ok(!err);

                AuthenticationAPI.createUser(adminCtx, bertLoginId, 'Bert Pareyn', null, function(err, bert) {
                    assert.ok(!err);
                    var bertCtx = new Context(tenant, bert);

                    AuthenticationAPI.associateLoginId(bertCtx, new LoginId(tenant.alias, AuthenticationConstants.providers.TWITTER, mrvisserUsername), bert.id, function(err) {
                        assert.ok(err);
                        assert.ok(err.code, 401);

                        AuthenticationAPI.getUserIdFromLoginId(tenant.alias, AuthenticationConstants.providers.TWITTER, mrvisserUsername, function(err, userId) {
                            assert.ok(!err);
                            assert.equal(userId, mrvisser.id);
                            callback();
                        });
                    });
                });
            });
        });
    });
});
