/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var fs = require('fs');
var util = require('util');

var AuthzAPI = require('oae-authz');
var AuthzTestUtil = require('oae-authz/lib/test/util');
var ConfigTestUtil = require('oae-config/lib/test/util');
var ContentTestUtil = require('oae-content/lib/test/util');
var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');

var FoldersContentLibrary = require('oae-folders/lib/internal/contentLibrary');
var FoldersFolderLibrary = require('oae-folders/lib/internal/foldersLibrary');
var FoldersLibrary = require('oae-folders/lib/library');
var FoldersTestUtil = require('oae-folders/lib/test/util');

describe('Folders', function() {

    var globalAdminRestContext = null;
    var camAdminRestContext = null;
    var camAnonymousRestContext = null;
    var gtAdminRestContext = null;
    var gtAnonymousRestContext = null;

    /*!
     * Set up all the REST contexts for admin and anonymous users with which we
     * will invoke requests
     */
    before(function(callback) {
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        camAnonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        gtAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        gtAnonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host);
        callback();
    });

    /*!
     * After each test, ensure the default folder visibility is the default value
     */
    afterEach(function(callback) {
        // Ensure the default folder visibility always starts fresh
        ConfigTestUtil.clearConfigAndWait(globalAdminRestContext, null, ['oae-folders/visibility/folder'], function(err) {
            assert.ok(!err);
            return callback();
        });
    });

    /*!
     * Create a member update object whose key is the provided principal id and the value is the
     * role change. This is simply a convenience for performing individual role updates on
     * folders
     *
     * @param  {String|Object}      principalInfo   The id of the principal whose role to change, or a principalInfo object. If an object, the `role` key will be added so it can be used in assert test utilities for updating membership
     * @param  {String|Boolean}     roleChange      The change to make to the principal's role. Should either be a role (`manager` or `viewer`, or `false` to remove them)
     */
    var _memberUpdate = function(principalInfo, roleChange) {
        roleChange = (_.isUndefined(roleChange)) ? 'viewer' : roleChange;

        var memberUpdate = {};
        if (_.isObject(principalInfo)) {
            // If the principal info is an object, then it contains the restContext and the profile,
            // and we extend the info object with the role change
            var profile = principalInfo.user || principalInfo.group;
            memberUpdate[profile.id] = _.extend({}, principalInfo, {'role': roleChange});
        } else {
            // If the principal info is not an object, it should be a string, representing the
            // id of the principal whose role to change
            memberUpdate[principalInfo] = roleChange;
        }

        return memberUpdate;
    };

    /**
     * Utility method that returns a stream that points to a text file
     *
     * @return {Stream}     A stream that points to a text file that can be uploaded
     */
    var _getFileStream = function() {
        var file = __dirname + '/data/file.txt';
        return fs.createReadStream(file);
    };

    describe('Create Folder', function() {

        /**
         * Test that verifies creation of a folder
         */
        it('verify folder creation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, mrvisser, stuartf, sathomas) {
                assert.ok(!err);

                FoldersTestUtil.assertCreateFolderSucceeds(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf], [sathomas], function(createdFolder) {
                    // Ensure the returned folder model is accurate
                    assert.ok(createdFolder);
                    assert.ok(createdFolder.tenant);
                    assert.equal(createdFolder.tenant.alias, global.oaeTests.tenants.cam.alias);
                    assert.equal(createdFolder.tenant.displayName, global.oaeTests.tenants.cam.displayName);
                    assert.ok(createdFolder.id);
                    assert.ok(createdFolder.groupId);
                    assert.equal(createdFolder.displayName, 'test displayName');
                    assert.equal(createdFolder.description, 'test description');
                    assert.equal(createdFolder.visibility, 'private');
                    assert.ok(createdFolder.created);
                    assert.strictEqual(createdFolder.lastModified, createdFolder.created);
                    assert.equal(createdFolder.profilePath, util.format('/folder/%s/%s', global.oaeTests.tenants.cam.alias, createdFolder.id.split(':').pop()));
                    assert.equal(createdFolder.resourceType, 'folder');

                    // Sanity check that the folder was created
                    FoldersTestUtil.assertGetFolderSucceeds(mrvisser.restContext, createdFolder.id, function(fetchedFolder) {
                        // Ensure the fetched folder model is consistent with the created one
                        assert.ok(fetchedFolder);
                        assert.ok(fetchedFolder.tenant);
                        assert.equal(fetchedFolder.tenant.alias, createdFolder.tenant.alias);
                        assert.equal(fetchedFolder.tenant.displayName, createdFolder.tenant.displayName);
                        assert.equal(fetchedFolder.id, createdFolder.id);
                        assert.equal(fetchedFolder.groupId, createdFolder.groupId);
                        assert.equal(fetchedFolder.displayName, createdFolder.displayName);
                        assert.equal(fetchedFolder.description, createdFolder.description);
                        assert.equal(fetchedFolder.visibility, createdFolder.visibility);
                        assert.equal(fetchedFolder.created, createdFolder.created);
                        assert.equal(fetchedFolder.lastModified, createdFolder.lastModified);
                        assert.equal(fetchedFolder.profilePath, createdFolder.profilePath);
                        assert.equal(fetchedFolder.resourceType, createdFolder.resourceType);

                        // Ensure createdBy user model is consistent with the user who created it
                        assert.ok(fetchedFolder.createdBy);
                        assert.equal(fetchedFolder.createdBy.tenant.alias, mrvisser.user.tenant.alias);
                        assert.equal(fetchedFolder.createdBy.tenant.displayName, mrvisser.user.tenant.displayName);
                        assert.equal(fetchedFolder.createdBy.id, mrvisser.user.id);
                        assert.equal(fetchedFolder.createdBy.displayName, mrvisser.user.displayName);
                        assert.equal(fetchedFolder.createdBy.visibility, mrvisser.user.visibility);
                        assert.equal(fetchedFolder.createdBy.email, mrvisser.user.email);
                        assert.equal(fetchedFolder.createdBy.locale, mrvisser.user.locale);
                        assert.equal(fetchedFolder.createdBy.timezone, mrvisser.user.timezone);
                        assert.equal(fetchedFolder.createdBy.publicAlias, mrvisser.user.publicAlias);
                        assert.equal(fetchedFolder.createdBy.profilePath, mrvisser.user.profilePath);
                        assert.equal(fetchedFolder.createdBy.resourceType, mrvisser.user.resourceType);
                        assert.equal(fetchedFolder.createdBy.acceptedTC, mrvisser.user.acceptedTC);

                        // Ensure the initial roles are accurate, including the creator being a manager
                        var expectedRoles = {};
                        expectedRoles[stuartf.user.id] = 'manager';
                        expectedRoles[sathomas.user.id] = 'viewer';
                        expectedRoles[mrvisser.user.id] = 'manager';
                        return FoldersTestUtil.assertFullFolderMembersEquals(mrvisser.restContext, createdFolder.id, expectedRoles, callback);
                    });
                });
            });
        });

        /**
         * Test that verifies the validation of creating a folder
         */
        it('verify folder creation validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, mrvisser, stuartf, sathomas) {
                assert.ok(!err);

                // Ensure displayName is required
                FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, '', 'test description', 'private', [stuartf.user.id], [sathomas.user.id], 400, function() {
                    var longDisplayName = TestsUtil.generateRandomText(83);
                    assert.ok(longDisplayName.length > 1000);

                    // Ensure displayName must be less than 1000 characters
                    FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, longDisplayName, 'test description', 'private', [stuartf.user.id], [sathomas.user.id], 400, function() {
                        var longDescription = TestsUtil.generateRandomText(833);
                        assert.ok(longDescription.length > 10000);

                        // Ensure description must be less than 10000 characters
                        FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', longDescription, 'private', [stuartf.user.id], [sathomas.user.id], 400, function() {

                            // Ensure visibility must be valid
                            FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'notvalid', [stuartf.user.id], [sathomas.user.id], 400, function() {

                                // Ensure manager id must be a valid resource id
                                FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', ['notaresourceid'], [sathomas.user.id], 400, function() {

                                    // Ensure manager id must be a principal id
                                    FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', ['c:oaetest:contentid'], [sathomas.user.id], 400, function() {

                                        // Ensure manager id must be an existing principal id
                                        FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', ['u:oaetest:nonexistinguserid'], [sathomas.user.id], 400, function() {
                                            FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', ['g:oaetest:nonexistinggroupid'], [sathomas.user.id], 400, function() {

                                                // Ensure viewer id must be a valid resource id
                                                FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf.user.id], ['notaresourceid'], 400, function() {

                                                    // Ensure viewer id must be a principal id
                                                    FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf.user.id], ['c:oaetest:contentid'], 400, function() {

                                                        // Ensure viewer id must be an existing principal id
                                                        FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf.user.id], ['u:oaetest:nonexistinguserid'], 400, function() {
                                                            FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf.user.id], ['g:oaetest:nonexistinggroupid'], 400, function() {

                                                                // Sanity check that creating a folder works with base input
                                                                FoldersTestUtil.assertCreateFolderSucceeds(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf], [sathomas], function() {
                                                                    return callback();
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the authorization of creating a folder and associating it with users
         */
        it('verify folder creation authorization', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant, privateTenant1) {

                // Ensure an anonymous user cannot create a folder
                FoldersTestUtil.assertCreateFolderFails(camAnonymousRestContext, 'test', 'test', 'private', null, null, 401, function() {

                    // Ensure a user cannot create a folder with a private user from the same tenant as a viewer
                    FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.loggedinUser.restContext, 'test', 'test', 'private', [publicTenant.publicUser], null, function() {
                        FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.loggedinUser], null, function() {
                            FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.privateUser.user.id], null, 401, function() {

                                // Ensure a user cannot create a folder with a loggedin or private user from another tenant as a viewer
                                FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant1.publicUser], null, function() {
                                    FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant1.loggedinUser.user.id], null, 401, function() {
                                        FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant1.privateUser.user.id], null, 401, function() {

                                            // Ensure a user cannot create a folder with any user from a private tenant as a viewer
                                            FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [privateTenant.publicUser.user.id], null, 401, function() {
                                                FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [privateTenant.loggedinUser.user.id], null, 401, function() {
                                                    FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [privateTenant.privateUser.user.id], null, 401, function() {

                                                        // Ensure a user from a private tenant cannot create a folder with any outside user
                                                        FoldersTestUtil.assertCreateFolderFails(privateTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.publicUser.user.id], null, 401, function() {
                                                            FoldersTestUtil.assertCreateFolderFails(privateTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.loggedinUser.user.id], null, 401, function() {
                                                                FoldersTestUtil.assertCreateFolderFails(privateTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.privateUser.user.id], null, 401, function() {

                                                                    // Ensure an admin can create a folder with a private user from the same tenant as a viewer
                                                                    FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.publicUser], null, function() {
                                                                        FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.loggedinUser], null, function() {
                                                                            FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.privateUser], null, function() {

                                                                                // Ensure an admin cannot create a folder with a loggedin or private user from another tenant as a viewer
                                                                                FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant1.publicUser], null, function() {
                                                                                    FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant1.loggedinUser.user.id], null, 401, function() {
                                                                                        FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant1.privateUser.user.id], null, 401, function() {

                                                                                            // Ensure an admin cannot create a folder with any user from a private tenant as a viewer
                                                                                            FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [privateTenant.publicUser.user.id], null, 401, function() {
                                                                                                FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [privateTenant.loggedinUser.user.id], null, 401, function() {
                                                                                                    FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [privateTenant.privateUser.user.id], null, 401, function() {

                                                                                                        // Ensure an admin from a private tenant cannot create a folder with any outside user
                                                                                                        FoldersTestUtil.assertCreateFolderFails(privateTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.publicUser.user.id], null, 401, function() {
                                                                                                            FoldersTestUtil.assertCreateFolderFails(privateTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.loggedinUser.user.id], null, 401, function() {
                                                                                                                return FoldersTestUtil.assertCreateFolderFails(privateTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.privateUser.user.id], null, 401, callback);
                                                                                                            });
                                                                                                        });
                                                                                                    });
                                                                                                });
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the visibility of a folder defaults to the tenant configuration
         */
        it('verify folder visibility defaults to the configured tenant default', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);

                // Ensure a folder created without a visibility defaults to public
                RestAPI.Folders.createFolder(mrvisser.restContext, 'test', 'test', null, null, null, function(err, createdFolder) {
                    assert.ok(!err);
                    assert.equal(createdFolder.visibility, 'public');

                    // Set the default privacy to private
                    ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, {'oae-folders/visibility/folder': 'private'}, function(err) {
                        assert.ok(!err);

                        // Ensure a folder created without a visibility now defaults to private
                        RestAPI.Folders.createFolder(mrvisser.restContext, 'test', 'test', null, null, null, function(err, createdFolder) {
                            assert.ok(!err);
                            assert.equal(createdFolder.visibility, 'private');
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Create a folder with a given set of managers and viewers. Then check if
         * the user who created the folder was given explicit manager rights.
         *
         * @param  {Object}         user                The user who should create the folder
         * @param  {String[]}       managers            The ids of the principals who should be managers
         * @param  {String[]}       viewers             The ids of the principals who should be viewers
         * @param  {Boolean}        expectedManager     Whether or not the folder creator should be an explicit manager
         * @param  {Function}       callback            Standard callback function
         */
        var createAndVerifyManager = function(user, managers, viewers, expectedManager, callback) {
            RestAPI.Folders.createFolder(user.restContext, 'test', 'test', null, managers, viewers, function(err, folder) {
                assert.ok(!err);

                FoldersTestUtil.getAllFolderMembers(user.restContext, folder.id, null, function(members) {
                    if (expectedManager) {
                        var member = _.find(members, function(member) {
                            return (member.profile.id === user.user.id && member.role === 'manager');
                        });
                        assert.ok(member);
                    }
                    return callback();
                });
            });
        };

        /**
         * Test that verifies that the folder creator is only made an explicit manager if he cannot manage the folder indirectly
         */
        it('verify the creator is only made a manager when he cannot manage indirectly', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, simong, nico, stuart) {
                assert.ok(!err);
                TestsUtil.generateTestGroups(simong.restContext, 1, function(simongGroup) {
                    TestsUtil.generateTestGroups(nico.restContext, 6, function(nicoGroup1, nicoGroup2, nicoGroup3, nicoGroup4, nicoGroup5, nicoGroup6) {
                        TestsUtil.generateGroupHierarchy(nico.restContext, [nicoGroup1.group.id, nicoGroup2.group.id, nicoGroup3.group.id], 'member', function() {
                            TestsUtil.generateGroupHierarchy(nico.restContext, [nicoGroup4.group.id, nicoGroup5.group.id, nicoGroup6.group.id], 'manager', function() {
                                var roleChange = AuthzTestUtil.createRoleChange([stuart.user.id], 'member');
                                RestAPI.Group.setGroupMembers(nico.restContext, nicoGroup3.group.id, roleChange, function(err) {
                                    assert.ok(!err);
                                    var roleChange = AuthzTestUtil.createRoleChange([stuart.user.id], 'manager');
                                    RestAPI.Group.setGroupMembers(nico.restContext, nicoGroup6.group.id, roleChange, function(err) {
                                        assert.ok(!err);


                                        createAndVerifyManager(simong, null, null, true, function() {
                                            createAndVerifyManager(simong, [nico.user.id], null, true, function() {
                                                createAndVerifyManager(simong, null, [simongGroup.group.id], true, function() {
                                                    createAndVerifyManager(simong, [simongGroup.group.id], null, false, function() {
                                                        createAndVerifyManager(simong, [simongGroup.group.id, nicoGroup1.group.id], null, false, function() {
                                                            // Verify a mix of users and groups that Simon can't manage
                                                            createAndVerifyManager(simong, [nico.user.id, simongGroup.group.id, nicoGroup1.group.id], null, false, function() {

                                                                // Stuart is an indirect member of group 1, he should be
                                                                // made a manager of the folder as he cannot manage nicoGroup1
                                                                createAndVerifyManager(stuart, [nicoGroup1.group.id], null, true, function() {
                                                                    // Stuart is an indirect manager of group 4, he should not be made
                                                                    // a manager of the folder as he can manage nicoGroup4 (indirectly)
                                                                    createAndVerifyManager(stuart, [nicoGroup4.group.id], null, false, function() {
                                                                        return callback();
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Update Folder', function() {

        /**
         * Test that verifies the parameters are validated
         */
        it('verify parameter validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Create a folder
                FoldersTestUtil.assertCreateFolderSucceeds(simong.restContext, 'test displayName', 'test description', 'public', [], [], function(folder) {

                    // Invalid folder id
                    FoldersTestUtil.assertUpdateFolderFails(simong.restContext, 'not a folder id', {'displayName': 'new'}, 400, function() {

                        // Missing folder
                        FoldersTestUtil.assertUpdateFolderFails(simong.restContext, 'f:camtest:no', {'displayName': 'new'}, 404, function() {

                            // Missing update values
                            FoldersTestUtil.assertUpdateFolderFails(simong.restContext, folder.id, null, 400, function() {

                                // Unused update values
                                FoldersTestUtil.assertUpdateFolderFails(simong.restContext, folder.id, {'not': 'right'}, 400, function() {

                                    // Invalid displayName
                                    var longDisplayName = TestsUtil.generateRandomText(83);
                                    FoldersTestUtil.assertUpdateFolderFails(simong.restContext, folder.id, {'displayName': longDisplayName}, 400, function() {

                                        // Invalid description
                                        var longDescription = TestsUtil.generateRandomText(833);
                                        FoldersTestUtil.assertUpdateFolderFails(simong.restContext, folder.id, {'description': longDescription}, 400, function() {

                                            // Invalid visibility
                                            FoldersTestUtil.assertUpdateFolderFails(simong.restContext, folder.id, {'visibility': 'noowpe'}, 400, function() {

                                                // Sanity check nothing changed
                                                FoldersTestUtil.assertGetFolderSucceeds(simong.restContext, folder.id, function(checkFolder) {
                                                    assert.strictEqual(checkFolder.displayName, folder.displayName);
                                                    assert.strictEqual(checkFolder.description, folder.description);
                                                    assert.strictEqual(checkFolder.visibility, folder.visibility);
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies only managers can update a folder
         */
        it('verify update folder authorization', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, simong, nico, bert) {
                assert.ok(!err);

                // Create a folder and make Nico a member of it
                FoldersTestUtil.assertCreateFolderSucceeds(simong.restContext, 'test displayName', 'test description', 'public', [], [nico], function(folder) {

                    // Anonymous users cannot update folders
                    FoldersTestUtil.assertUpdateFolderFails(camAnonymousRestContext, folder.id, {'visibility': 'private'}, 401, function() {

                        // Unrelated users cannot update folders
                        FoldersTestUtil.assertUpdateFolderFails(bert.restContext, folder.id, {'visibility': 'private'}, 401, function() {

                            // Members cannot update folders
                            FoldersTestUtil.assertUpdateFolderFails(nico.restContext, folder.id, {'visibility': 'private'}, 401, function() {

                                // Tenant admins from other tenants cannot update the folder
                                FoldersTestUtil.assertUpdateFolderFails(gtAdminRestContext, folder.id, {'visibility': 'private'}, 401, function() {

                                    // Sanity check the folder was not updated
                                    FoldersTestUtil.assertGetFolderSucceeds(simong.restContext, folder.id, function(checkFolder) {
                                        assert.strictEqual(folder.visibility, checkFolder.visibility);
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies only managers can update a folder
         */
        it('verify update folder content visibility authorization', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, simong, nico, bert) {
                assert.ok(!err);

                // Create a folder and make Nico a member of it
                FoldersTestUtil.assertCreateFolderSucceeds(simong.restContext, 'test displayName', 'test description', 'public', [], [nico], function(folder) {

                    // Anonymous users cannot update folders
                    FoldersTestUtil.assertUpdateFolderContentVisibilityFails(camAnonymousRestContext, folder.id, 'private', 401, function() {

                        // Unrelated users cannot update folders
                        FoldersTestUtil.assertUpdateFolderContentVisibilityFails(bert.restContext, folder.id, 'private', 401, function() {

                            // Members cannot update folders
                            FoldersTestUtil.assertUpdateFolderContentVisibilityFails(nico.restContext, folder.id, 'private', 401, function() {

                                // Tenant admins from other tenants cannot update the folder
                                FoldersTestUtil.assertUpdateFolderContentVisibilityFails(gtAdminRestContext, folder.id, 'private', 401, function() {

                                    // Sanity check the folder was not updated
                                    FoldersTestUtil.assertGetFolderSucceeds(simong.restContext, folder.id, function(checkFolder) {
                                        assert.strictEqual(folder.visibility, checkFolder.visibility);
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that updating a folder's visibility updates the member folder libraries
         */
        it('verify updating a folder\'s visibility updates the folder libraries', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, bert) {
                assert.ok(!err);

                // Create a folder
                FoldersTestUtil.assertCreateFolderSucceeds(simong.restContext, 'test displayName', 'test description', 'public', [], [], function(folder) {

                    // When Bert lists the folder library for Simon, he can see the folder
                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(camAnonymousRestContext, simong.user.id, null, null, function(result) {
                        assert.strictEqual(result.results.length, 1);
                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(bert.restContext, simong.user.id, null, null, function(result) {
                            assert.strictEqual(result.results.length, 1);
                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(simong.restContext, simong.user.id, null, null, function(result) {
                                assert.strictEqual(result.results.length, 1);

                                // Make the folder loggedin only
                                FoldersTestUtil.assertUpdateFolderSucceeds(simong.restContext, folder.id, {'visibility': 'loggedin'}, function(folder) {

                                    // Anonymous users cannot see the folder anymore
                                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(camAnonymousRestContext, simong.user.id, null, null, function(result) {
                                        assert.strictEqual(result.results.length, 0);
                                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(bert.restContext, simong.user.id, null, null, function(result) {
                                            assert.strictEqual(result.results.length, 1);
                                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(simong.restContext, simong.user.id, null, null, function(result) {
                                                assert.strictEqual(result.results.length, 1);

                                                // Make the folder private
                                                FoldersTestUtil.assertUpdateFolderSucceeds(simong.restContext, folder.id, {'visibility': 'private'}, function(folder) {

                                                    // Bert can no longer see the folder
                                                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(camAnonymousRestContext, simong.user.id, null, null, function(result) {
                                                        assert.strictEqual(result.results.length, 0);
                                                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(bert.restContext, simong.user.id, null, null, function(result) {
                                                            assert.strictEqual(result.results.length, 0);
                                                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(simong.restContext, simong.user.id, null, null, function(result) {
                                                                assert.strictEqual(result.results.length, 1);

                                                                return callback();
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of updating a folder
         */
        it('verify a folder\'s metadata can be updated', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Create a folder
                FoldersTestUtil.assertCreateFolderSucceeds(simong.restContext, 'test displayName', 'test description', 'public', [], [], function(folder) {

                    // Update the folder's metadata
                    var updates = {
                        'displayName': 'wowzors',
                        'description': 'mega',
                        'visibility': 'private'
                    };
                    RestAPI.Folders.updateFolder(simong.restContext, folder.id, updates, function(err, folder) {
                        assert.ok(!err);
                        assert.ok(folder);
                        assert.strictEqual(folder.displayName, updates.displayName);
                        assert.strictEqual(folder.description, updates.description);
                        assert.strictEqual(folder.visibility, updates.visibility);

                        // Sanity-check the full folder profile was returned
                        assert.strictEqual(folder.canShare, true);
                        assert.strictEqual(folder.canManage, true);
                        assert.strictEqual(folder.canAddItem, true);
                        assert.ok(_.isObject(folder.createdBy));
                        assert.strictEqual(folder.createdBy.id, simong.user.id);

                        // Sanity check the updates are persisted
                        FoldersTestUtil.assertGetFolderSucceeds(simong.restContext, folder.id, function(newFolder) {
                            assert.strictEqual(newFolder.displayName, updates.displayName);
                            assert.strictEqual(newFolder.description, updates.description);
                            assert.strictEqual(newFolder.visibility, updates.visibility);
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that updating a folder's visibility can update the content inside the folder
         */
        it('verify updating a folder\'s content items', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);

                FoldersTestUtil.assertCreateFolderSucceeds(simong.restContext, 'test displayName', 'test description', 'public', [], [], function(folder) {

                    // Both users create a content item
                    RestAPI.Content.createLink(simong.restContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, simonsLink) {
                        assert.ok(!err);
                        RestAPI.Content.createLink(nico.restContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, nicosLink) {
                            assert.ok(!err);

                            // Simon adds the two items to the folder
                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, [simonsLink.id, nicosLink.id], function() {

                                // Change the visibility of the folder to loggedin AND change the content items
                                var updates = {'visibility': 'loggedin'};
                                RestAPI.Folders.updateFolder(simong.restContext, folder.id, updates, function(err, folder) {
                                    assert.ok(!err);
                                    assert.ok(folder);

                                    // Sanity-check the full folder profile was returned
                                    assert.strictEqual(folder.canShare, true);
                                    assert.strictEqual(folder.canManage, true);
                                    assert.strictEqual(folder.canAddItem, true);
                                    assert.ok(_.isObject(folder.createdBy));
                                    assert.strictEqual(folder.createdBy.id, simong.user.id);

                                    // Update the content items in the folder
                                    RestAPI.Folders.updateFolderContentVisibility(simong.restContext, folder.id, 'loggedin', function(err, data) {
                                        assert.ok(!err);

                                        // Only 1 item should've failed
                                        assert.strictEqual(data.failedContent.length, 1);
                                        assert.strictEqual(data.failedContent[0].id, nicosLink.id);

                                        // The failed content items should have a signature
                                        assert.ok(data.failedContent[0].signature);

                                        // Assert that simonsLink's visibility changed
                                        RestAPI.Content.getContent(simong.restContext, simonsLink.id, function(err, content) {
                                            assert.ok(!err);
                                            assert.strictEqual(content.visibility, 'loggedin');

                                            // Assert that nicosLink's visibility did not change
                                            RestAPI.Content.getContent(simong.restContext, nicosLink.id, function(err, content) {
                                                assert.ok(!err);
                                                assert.strictEqual(content.visibility, 'public');

                                                FoldersTestUtil.assertFolderEquals(nico.restContext, folder.id, [simonsLink.id, nicosLink.id], function() {
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Get Folder', function() {

        /**
         * Test that verifies validation of getting a folder
         */
        it('verify get folder validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Ensure fetching using an invalid id results in an error
                    FoldersTestUtil.assertGetFolderFails(mrvisser.restContext, 'invalidid', 400, function() {

                        // Ensure fetching using a non-existing id results in a 404
                        FoldersTestUtil.assertGetFolderFails(mrvisser.restContext, 'x:oaetest:nonexistingid', 404, function() {

                            // Sanity check getting an existing folder
                            FoldersTestUtil.assertGetFolderSucceeds(mrvisser.restContext, folder.id, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting a folder
         */
        it('verify get folder authorization', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Make the private user from a tenant a member of the private folder
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.privateUser], function(err) {

                    // Make the public user from a different tenant a member of a loggedin and private folder
                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant1.adminRestContext, publicTenant1.adminRestContext, publicTenant1.loggedinFolder.id, [publicTenant.publicUser], function(err) {
                        FoldersTestUtil.assertShareFolderSucceeds(publicTenant1.adminRestContext, publicTenant1.adminRestContext, publicTenant1.privateFolder.id, [publicTenant.publicUser], function(err) {

                            // Ensure user from same tenant can see public, loggedin but only private folders to which they have explicit access
                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, function() {
                                FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, function() {
                                    FoldersTestUtil.assertGetFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, 401, function() {
                                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.privateUser.restContext, publicTenant.privateFolder.id, function() {

                                            // Ensure user from different tenant can see public, but only loggedin and private to which they have explicit access
                                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.loggedinUser.restContext, publicTenant1.publicFolder.id, function() {
                                                FoldersTestUtil.assertGetFolderFails(publicTenant.loggedinUser.restContext, publicTenant1.loggedinFolder.id, 401, function() {
                                                    FoldersTestUtil.assertGetFolderFails(publicTenant.loggedinUser.restContext, publicTenant1.privateFolder.id, 401, function() {
                                                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant1.loggedinFolder.id, function() {
                                                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant1.privateFolder.id, function() {
                                                                return callback();
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies getting a full folder profile will scrub the creator of the folder appropriately
         */
        it('verify get folder scrubs creator user', function(callback) {
            // Setup multi-tenant privacy entities without folders or content. We only need
            // multi-tenant privacy users for this test
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Create a public folder as the private user
                FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.privateUser.restContext, 'test', 'test', 'public', null, null, function(createdFolder) {

                    // Ensure the user themself gets the full creator profile when they get the folder
                    FoldersTestUtil.assertGetFolderSucceeds(publicTenant.privateUser.restContext, createdFolder.id, function(fetchedFolder) {
                        assert.ok(fetchedFolder.createdBy);
                        assert.equal(fetchedFolder.createdBy.tenant.alias, publicTenant.privateUser.user.tenant.alias);
                        assert.equal(fetchedFolder.createdBy.tenant.displayName, publicTenant.privateUser.user.tenant.displayName);
                        assert.equal(fetchedFolder.createdBy.id, publicTenant.privateUser.user.id);
                        assert.equal(fetchedFolder.createdBy.displayName, publicTenant.privateUser.user.displayName);
                        assert.equal(fetchedFolder.createdBy.visibility, publicTenant.privateUser.user.visibility);
                        assert.equal(fetchedFolder.createdBy.email, publicTenant.privateUser.user.email);
                        assert.equal(fetchedFolder.createdBy.locale, publicTenant.privateUser.user.locale);
                        assert.equal(fetchedFolder.createdBy.timezone, publicTenant.privateUser.user.timezone);
                        assert.equal(fetchedFolder.createdBy.publicAlias, publicTenant.privateUser.user.publicAlias);
                        assert.equal(fetchedFolder.createdBy.profilePath, publicTenant.privateUser.user.profilePath);
                        assert.equal(fetchedFolder.createdBy.resourceType, publicTenant.privateUser.user.resourceType);
                        assert.equal(fetchedFolder.createdBy.acceptedTC, publicTenant.privateUser.user.acceptedTC);

                        // Ensure an admin user gets the full creator profile when they get the folder
                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.adminRestContext, createdFolder.id, function(fetchedFolder) {
                            assert.ok(fetchedFolder.createdBy);
                            assert.equal(fetchedFolder.createdBy.tenant.alias, publicTenant.privateUser.user.tenant.alias);
                            assert.equal(fetchedFolder.createdBy.tenant.displayName, publicTenant.privateUser.user.tenant.displayName);
                            assert.equal(fetchedFolder.createdBy.id, publicTenant.privateUser.user.id);
                            assert.equal(fetchedFolder.createdBy.displayName, publicTenant.privateUser.user.displayName);
                            assert.equal(fetchedFolder.createdBy.visibility, publicTenant.privateUser.user.visibility);
                            assert.equal(fetchedFolder.createdBy.email, publicTenant.privateUser.user.email);
                            assert.equal(fetchedFolder.createdBy.locale, publicTenant.privateUser.user.locale);
                            assert.equal(fetchedFolder.createdBy.timezone, publicTenant.privateUser.user.timezone);
                            assert.equal(fetchedFolder.createdBy.publicAlias, publicTenant.privateUser.user.publicAlias);
                            assert.equal(fetchedFolder.createdBy.profilePath, publicTenant.privateUser.user.profilePath);
                            assert.equal(fetchedFolder.createdBy.resourceType, publicTenant.privateUser.user.resourceType);
                            assert.equal(fetchedFolder.createdBy.acceptedTC, publicTenant.privateUser.user.acceptedTC);

                            // Ensure another user from the tenant gets a scrubbed creator profile when they get the folder
                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.loggedinUser.restContext, createdFolder.id, function(fetchedFolder) {
                                assert.ok(fetchedFolder.createdBy);
                                assert.equal(fetchedFolder.createdBy.tenant.alias, publicTenant.privateUser.user.tenant.alias);
                                assert.equal(fetchedFolder.createdBy.tenant.displayName, publicTenant.privateUser.user.tenant.displayName);
                                assert.equal(fetchedFolder.createdBy.id, publicTenant.privateUser.user.id);
                                assert.equal(fetchedFolder.createdBy.displayName, publicTenant.privateUser.user.publicAlias);
                                assert.equal(fetchedFolder.createdBy.visibility, publicTenant.privateUser.user.visibility);
                                assert.ok(!fetchedFolder.createdBy.email);
                                assert.ok(!fetchedFolder.createdBy.locale);
                                assert.ok(!fetchedFolder.createdBy.timezone);
                                assert.ok(!fetchedFolder.createdBy.publicAlias);
                                assert.ok(!fetchedFolder.createdBy.profilePath);
                                assert.equal(fetchedFolder.createdBy.resourceType, publicTenant.privateUser.user.resourceType);
                                assert.strictEqual(fetchedFolder.createdBy.acceptedTC, undefined);
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the permission flags (e.g., `canShare`, `canAddItem`) of a full folder profile
         */
        it('verify get folder profile permission flags', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Create one more folder as the public user
                FoldersTestUtil.generateTestFolders(publicTenant.publicUser.restContext, 1, function(createdFolder) {

                    // Ensure permission flags for admin
                    FoldersTestUtil.assertGetFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, function(fetchedFolder) {
                        assert.strictEqual(fetchedFolder.canManage, true);
                        assert.strictEqual(fetchedFolder.canShare, true);
                        assert.strictEqual(fetchedFolder.canAddItem, true);

                        // Ensure permission flags for manager of a folder
                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, createdFolder.id, function(fetchedFolder) {
                            assert.strictEqual(fetchedFolder.canManage, true);
                            assert.strictEqual(fetchedFolder.canShare, true);
                            assert.strictEqual(fetchedFolder.canAddItem, true);

                            // Ensure permission flags for non-manager user on non-private folder
                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, function(fetchedFolder) {
                                assert.strictEqual(fetchedFolder.canManage, false);
                                assert.strictEqual(fetchedFolder.canShare, true);
                                assert.strictEqual(fetchedFolder.canAddItem, false);

                                // Ensure permission flags for non-manager user on private folder
                                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.publicUser], function() {
                                    FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, function(fetchedFolder) {
                                        assert.strictEqual(fetchedFolder.canManage, false);
                                        assert.strictEqual(fetchedFolder.canShare, false);
                                        assert.strictEqual(fetchedFolder.canAddItem, false);

                                        // Ensure permission flags for non-manager user in another public tenant
                                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, function(fetchedFolder) {
                                            assert.strictEqual(fetchedFolder.canManage, false);
                                            assert.strictEqual(fetchedFolder.canShare, true);
                                            assert.strictEqual(fetchedFolder.canAddItem, false);

                                            // Ensure permission flags for non-manager user in another private tenant
                                            FoldersTestUtil.assertGetFolderSucceeds(privateTenant.publicUser.restContext, publicTenant.publicFolder.id, function(fetchedFolder) {
                                                assert.strictEqual(fetchedFolder.canManage, false);
                                                assert.strictEqual(fetchedFolder.canShare, false);
                                                assert.strictEqual(fetchedFolder.canAddItem, false);
                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Delete Folder', function() {

        /**
         * Test that verifies validation of deleting a folder
         */
        it('verify delete folder validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(simong.restContext, 1, function(folder) {

                    // Ensure deleting using an invalid id results in an error
                    FoldersTestUtil.assertDeleteFolderFails(simong.restContext, 'invalidid', 400, function() {

                        // Ensure deleting using a non-existing id results in a 404
                        FoldersTestUtil.assertDeleteFolderFails(simong.restContext, 'f:oaetest:nonexistingid', 404, function() {

                            // Sanity-check it was not removed
                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(simong.restContext, simong.user.id, null, null, function(result) {
                                assert.strictEqual(result.results.length, 1);
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of deleting a folder
         */
        it('verify delete folder authorization', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, simong, nico, bert) {
                assert.ok(!err);

                // Create a folder and make Nico a member of it
                FoldersTestUtil.assertCreateFolderSucceeds(simong.restContext, 'test displayName', 'test description', 'public', [], [nico], function(folder) {

                    // Anonymous users cannot delete folders
                    FoldersTestUtil.assertDeleteFolderFails(camAnonymousRestContext, folder.id, 401, function() {

                        // Unrelated users cannot delete folders
                        FoldersTestUtil.assertDeleteFolderFails(bert.restContext, folder.id, 401, function() {

                            // Members cannot delete folders
                            FoldersTestUtil.assertDeleteFolderFails(nico.restContext, folder.id, 401, function() {

                                // Tenant admins from other tenants cannot delete the folder
                                FoldersTestUtil.assertDeleteFolderFails(gtAdminRestContext, folder.id, 401, function() {

                                    // Sanity-check it was not removed
                                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(simong.restContext, simong.user.id, null, null, function(result) {
                                        assert.strictEqual(result.results.length, 1);

                                        // Sanity-check a manager can delete it
                                        FoldersTestUtil.assertDeleteFolderSucceeds(simong.restContext, folder.id, false, function() {

                                            // Sanity-check it was not removed
                                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(simong.restContext, simong.user.id, null, null, function(result) {
                                                assert.strictEqual(result.results.length, 0);
                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Check if the members for a set of content items are set correctly
         *
         * @param  {String[]}       contentIds          The ids of the content items to check
         * @param  {String[]}       expectedMembers     The ids of the principals that are expected to have a role on each content item
         * @param  {Function}       callback            Standard callback function
         */
        var checkContentMembers = function(contentIds, expectedMembers, callback) {
            var done = _.after(contentIds.length, callback);
            _.each(contentIds, function(contentId) {
                AuthzAPI.getAuthzMembers(contentId, null, 10, function(err, members) {
                    assert.ok(!err);
                    var principalIds = _.pluck(members, 'id');
                    assert.strictEqual(principalIds.length, expectedMembers.length);
                    _.each(principalIds, function(principalId) {
                        assert.ok(_.contains(expectedMembers, principalId));
                    });

                    done();
                });
            });
        };

        /**
         * Test that verifies that when a folder gets deleted the authz membership on all the content items gets adjusted
         */
        it('verify delete folder removes the folder authz group from the content items', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Generate a test folder
                FoldersTestUtil.generateTestFolders(simong.restContext, 1, function(folder) {

                    // Generate 15 links that can be added to the folder
                    ContentTestUtil.generateTestLinks(simong.restContext, 15, function() {
                        var contentIds = _.pluck(arguments, 'id');

                        // Add the content to the folder
                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, contentIds, function() {

                            // Sanity-check each folder is an authz member of the content item
                            checkContentMembers(contentIds, [simong.user.id, folder.groupId], function() {

                                // Delete the folder
                                FoldersTestUtil.assertDeleteFolderSucceeds(simong.restContext, folder.id, false, function() {

                                    // The folder should no longer be an authz member of the content items
                                    checkContentMembers(contentIds, [simong.user.id], callback);
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that the delete folder operation can remove content items
         */
        it('verify delete folder can remove content items', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);

                // Generate a test folder
                FoldersTestUtil.generateTestFolders(simong.restContext, 1, function(folder) {

                    // Both users generate some content
                    ContentTestUtil.generateTestLinks(simong.restContext, 15, function() {
                        var simonsContentIds = _.pluck(arguments, 'id');
                        ContentTestUtil.generateTestLinks(nico.restContext, 15, function() {
                            var nicosContentIds = _.pluck(arguments, 'id');

                            // Add all the content items to the folder
                            var allContentIds = simonsContentIds.concat(nicosContentIds);
                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, allContentIds, function() {

                                // Delete the folder and the content in it
                                RestAPI.Folders.deleteFolder(simong.restContext, folder.id, true, function(err, data) {
                                    assert.ok(!err);

                                    // All failed content should be Nico's
                                    assert.strictEqual(data.failedContent.length, nicosContentIds.length);
                                    _.each(data.failedContent, function(contentItem) {
                                        assert.ok(_.contains(nicosContentIds, contentItem.id));

                                        // Each failed content item should have a signature
                                        assert.ok(contentItem.signature);
                                    });

                                    // All of Simon's items should be removed
                                    var done = _.after(simonsContentIds.length, callback);
                                    _.each(simonsContentIds, function(contentId) {
                                        RestAPI.Content.getContent(simong.restContext, contentId, function(err) {
                                            assert.strictEqual(err.code, 404);
                                            done();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Share Folder', function() {

        /**
         * Test that verifies sharing with multiple users gives all users access to the folder
         */
        it('verify sharing with multiple users gives all access to a folder', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant) {

                var userInfosToShare = [
                    publicTenant.publicUser,
                    publicTenant.loggedinUser,
                    publicTenant.privateUser
                ];

                // Give access to the private folder to a user
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, userInfosToShare, function() {

                    // Ensure the users can access the private folder
                    FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, function() {
                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.loggedinUser.restContext, publicTenant.privateFolder.id, function() {
                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.privateUser.restContext, publicTenant.privateFolder.id, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies sharing a folder with a manager does not demote them to viewer
         */
        it('verify sharing does not demote a member from manager to viewer', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Simon shares the folder with a manager
                    FoldersTestUtil.assertShareFolderSucceeds(mrvisser.restContext, simong.restContext, folder.id, [mrvisser], function() {

                        // Ensure mrvisser is still a manager
                        FoldersTestUtil.assertGetFolderSucceeds(mrvisser.restContext, folder.id, function(folder) {
                            assert.strictEqual(folder.canManage, true);
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation of sharing a folder
         */
        it('verify sharing validation', function(callback) {
            // Generate a user and a folder to test sharing with
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(camAdminRestContext, 1, function(folder) {

                    // Ensure a valid folder id must be provided
                    FoldersTestUtil.assertShareFolderFails(camAdminRestContext, camAdminRestContext, 'notavalidid', [mrvisser.user.id], 400, function() {

                        // Ensure an existing folder id must be provided
                        FoldersTestUtil.assertShareFolderFails(camAdminRestContext, camAdminRestContext, 'x:oaetest:nonexistingid', [mrvisser.user.id], 404, function() {

                            // Ensure a valid target principal id must be provided
                            FoldersTestUtil.assertShareFolderFails(camAdminRestContext, camAdminRestContext, folder.id, ['notavalidid'], 400, function() {
                                FoldersTestUtil.assertShareFolderFails(camAdminRestContext, camAdminRestContext, folder.id, ['c:oaetest:notaprincipalid'], 400, function() {

                                    // Ensure an existing target principal id must be provided
                                    FoldersTestUtil.assertShareFolderFails(camAdminRestContext, camAdminRestContext, folder.id, ['u:oaetest:nonexistingid'], 400, function() {
                                        FoldersTestUtil.assertShareFolderFails(camAdminRestContext, camAdminRestContext, folder.id, ['g:oaetest:nonexistingid'], 400, function() {

                                            // Sanity check we can share with the base input
                                            return FoldersTestUtil.assertShareFolderSucceeds(camAdminRestContext, camAdminRestContext, folder.id, [mrvisser], callback);
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies an anonymous user cannot share a folder
         */
        it('verify anonymous user cannot share', function(callback) {
            // Generate a user and folder to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(camAdminRestContext, 1, function(folder) {

                    // Ensure anonymous cannot share with Simong
                    FoldersTestUtil.assertShareFolderFails(camAdminRestContext, camAnonymousRestContext, folder.id, [simong.user.id], 401, function() {

                        // Sanity check mrvisser can share with Simong
                        return FoldersTestUtil.assertShareFolderSucceeds(camAdminRestContext, mrvisser.restContext, folder.id, [simong], callback);
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of sharing a folder for a regular (non-member) user of the same tenant
         */
        it('verify sharing authorization for a regular user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure regular user can only share public and loggedin folders
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.loggedinUser], function() {
                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinUser], function() {
                        FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.loggedinUser.user.id], 401, function() {

                            // Ensure regular user cannot share with user profiles with which they cannot interact
                            FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.privateUser.user.id], 401, function() {
                                FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant1.publicUser.user.id], 401, function() {
                                    FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant1.loggedinUser.user.id], 401, function() {
                                        FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant1.privateUser.user.id], 401, function() {
                                            FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [privateTenant.publicUser.user.id], 401, function() {
                                                FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [privateTenant.loggedinUser.user.id], 401, function() {
                                                    return FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [privateTenant.privateUser.user.id], 401, callback);
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of sharing a folder for a regular (non-member) user of a different tenant
         */
        it('verify sharing authorization for a cross-tenant user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure regular cross-tenant user can only share public folders of another tenant
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicUser], function() {
                    FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant1.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.publicUser.user.id], 401, function() {
                        return FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant1.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.publicUser.user.id], 401, callback);
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of sharing a folder for a manager user
         */
        it('verify sharing authorization for a manager user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Make the public user a manager of the private folder
                FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, _memberUpdate(publicTenant.publicUser, 'manager'), function() {

                    // Ensure manager user can share all items in own tenant
                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.loggedinUser], function() {
                        FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinUser], function() {
                            FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.loggedinUser], function() {

                                // Ensure manager user cannot share with user profiles to which they cannot interact
                                FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.privateUser.user.id], 401, function() {
                                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant1.publicUser], function() {
                                        FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant1.loggedinUser.user.id], 401, function() {
                                            FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant1.privateUser.user.id], 401, function() {
                                                FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [privateTenant.publicUser.user.id], 401, function() {
                                                    FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [privateTenant.loggedinUser.user.id], 401, function() {
                                                        return FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [privateTenant.privateUser.user.id], 401, callback);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of sharing a folder for an administrative user
         */
        it('verify sharing authorization for an admin user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure admin user can share all items in own tenant
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.loggedinUser], function() {
                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinUser], function() {
                        FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.loggedinUser], function() {

                            // Ensure admin user cannot share with user profiles to which they cannot interact
                            FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.privateUser], function() {
                                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant1.publicUser], function() {
                                    FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant1.loggedinUser.user.id], 401, function() {
                                        FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant1.privateUser.user.id], 401, function() {
                                            FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [privateTenant.publicUser.user.id], 401, function() {
                                                FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [privateTenant.loggedinUser.user.id], 401, function() {
                                                    return FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [privateTenant.privateUser.user.id], 401, callback);
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Get Folder Members', function() {

        /**
         * Test that verifies getting the members of a folder will return all viewers and managers of the folder
         */
        it('verify get folder members gets all viewers and managers', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 16, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {
                    users = _.values(users);

                    var managerUsers = users.slice(0, 8);
                    var viewerUsers = users.slice(8);

                    var memberUpdates = {};
                    var expectedMembership = {};
                    _.each(managerUsers, function(managerUser) {
                        expectedMembership[managerUser.user.id] = 'manager';
                        memberUpdates[managerUser.user.id] = _.extend({}, managerUser, {'role': 'manager'});
                    });

                    var viewerMemberUpdates = {};
                    _.each(viewerUsers, function(viewerUser) {
                        expectedMembership[viewerUser.user.id] = 'viewer';
                        memberUpdates[viewerUser.user.id] = _.extend({}, viewerUser, {'role': 'viewer'});
                    });

                    // Apply the roles
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(camAdminRestContext, camAdminRestContext, folder.id, memberUpdates, function() {

                        // Ensure all the users have been set
                        return FoldersTestUtil.assertFullFolderMembersEquals(mrvisser.restContext, folder.id, expectedMembership, callback);
                    });
                });
            });
        });

        /**
         * Test that verifies validation of getting folder members
         */
        it('verify get folder members validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 16, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(camAdminRestContext, 1, function(folder) {
                    var memberUpdates = {};
                    _.each(users, function(user, userId) {
                        memberUpdates[userId] = _.extend({}, user, {'role': 'viewer'});
                    });

                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(camAdminRestContext, camAdminRestContext, folder.id, memberUpdates, function() {

                        // Ensure the folder id must be a valid resource id
                        FoldersTestUtil.assertGetFolderMembersFails(mrvisser.restContext, 'notavalidid', null, null, 400, function() {

                            // Ensure the folder must exist
                            FoldersTestUtil.assertGetFolderMembersFails(mrvisser.restContext, 'x:oaetest:nonexistingid', null, null, 404, function() {

                                // Ensure limit has a minimum of 1
                                FoldersTestUtil.assertGetFolderMembersSucceeds(mrvisser.restContext, folder.id, null, 0, function(result) {
                                    assert.strictEqual(result.results.length, 1);

                                    // Ensure limit defaults to 10
                                    FoldersTestUtil.assertGetFolderMembersSucceeds(mrvisser.restContext, folder.id, null, null, function(result) {
                                        assert.strictEqual(result.results.length, 10);

                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting folder members
         */
        it('verify get folder members authorization', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Ensure access for anonymous user
                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.anonymousRestContext, publicTenant.publicFolder.id, null, null, function() {
                    FoldersTestUtil.assertGetFolderMembersFails(publicTenant.anonymousRestContext, publicTenant.loggedinFolder.id, null, null, 401, function() {
                        FoldersTestUtil.assertGetFolderMembersFails(publicTenant.anonymousRestContext, publicTenant.privateFolder.id, null, null, 401, function() {

                            // Ensure access for authenticated user
                            FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, null, null, function() {
                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, null, null, function() {
                                    FoldersTestUtil.assertGetFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, null, null, 401, function() {

                                        // Ensure access for admin user
                                        FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, null, null, function() {
                                            FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, null, null, function() {
                                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, null, null, function() {

                                                    // Ensure access for cross-tenant user
                                                    FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, null, null, function() {
                                                        FoldersTestUtil.assertGetFolderMembersFails(publicTenant1.publicUser.restContext, publicTenant.loggedinFolder.id, null, null, 401, function() {
                                                            FoldersTestUtil.assertGetFolderMembersFails(publicTenant1.publicUser.restContext, publicTenant.privateFolder.id, null, null, 401, function() {

                                                                // Ensure access for cross-tenant admin user
                                                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant1.adminRestContext, publicTenant.publicFolder.id, null, null, function() {
                                                                    FoldersTestUtil.assertGetFolderMembersFails(publicTenant1.adminRestContext, publicTenant.loggedinFolder.id, null, null, 401, function() {
                                                                        FoldersTestUtil.assertGetFolderMembersFails(publicTenant1.adminRestContext, publicTenant.privateFolder.id, null, null, 401, function() {

                                                                            // Give a same-tenant user access to the private folder
                                                                            FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.publicUser], function() {

                                                                                // Ensure same-tenant user with access can now view the private folder members
                                                                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, null, null, function() {

                                                                                    // Give a cross-tenant user access to the loggedin and private folders
                                                                                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant1.publicUser], function() {
                                                                                        FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant1.publicUser], function() {

                                                                                            // Ensure the cross-tenant user can now see the loggedin and private folders with explicit access
                                                                                            FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant1.publicUser.restContext, publicTenant.loggedinFolder.id, null, null, function() {
                                                                                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant1.publicUser.restContext, publicTenant.privateFolder.id, null, null, function() {
                                                                                                    return callback();
                                                                                                });
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verififes paging through the list of folder members
         */
        it('verify get folder members paging', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 16, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {
                    // Make all 16 users (except mrvisser, of course) a viewer
                    var memberUpdates = {};
                    _.each(users, function(user, userId) {
                        if (userId !== mrvisser.user.id) {
                            memberUpdates[userId] = _.extend({}, user, {'role': 'viewer'});
                        }
                    });

                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, mrvisser.restContext, folder.id, memberUpdates, function() {

                        // Fetch batches of 1 and ensure we get them all
                        FoldersTestUtil.getAllFolderMembers(mrvisser.restContext, folder.id, {'batchSize': 1}, function(members, responses) {
                            assert.strictEqual(members.length, 16);

                            // Ensure all members came from the users folder and that they all have the proper role
                            _.each(members, function(member) {
                                assert.ok(users[member.profile.id]);
                                if (member.profile.id === mrvisser.user.id) {
                                    assert.strictEqual(member.role, 'manager');
                                } else {
                                    assert.strictEqual(member.role, 'viewer');
                                }
                            });

                            // Ensure we made 17 requests to get the users and they all had exactly 1 member (the 17th request
                            // is an empty one since `nextToken` does not use any look-ahead)
                            assert.strictEqual(responses.length, 17);
                            _.each(responses.slice(0, -1), function(response) {
                                assert.strictEqual(response.results.length, 1);
                            });
                            assert.strictEqual(_.last(responses).results.length, 0);
                            assert.strictEqual(_.last(responses).nextToken, null);

                            // Fetch batches of 3 and ensure we get them all
                            FoldersTestUtil.getAllFolderMembers(mrvisser.restContext, folder.id, {'batchSize': 3}, function(members, responses) {
                                assert.strictEqual(members.length, 16);

                                // Ensure all members came from the users folder and that they all have the proper role
                                _.each(members, function(member) {
                                    assert.ok(users[member.profile.id]);
                                    if (member.profile.id === mrvisser.user.id) {
                                        assert.strictEqual(member.role, 'manager');
                                    } else {
                                        assert.strictEqual(member.role, 'viewer');
                                    }
                                });

                                // Ensure we made 6 requests to get the users and they all had the proper amount
                                // of users
                                assert.strictEqual(responses.length, 6);

                                // All but the last have 3
                                _.each(responses.slice(0, -1), function(response) {
                                    assert.strictEqual(response.results.length, 3);
                                });

                                // The last has 1 member and a null `nextToken`
                                assert.strictEqual(_.last(responses).results.length, 1);
                                assert.strictEqual(_.last(responses).nextToken, null);

                                // Fetch a batch of 16 and ensure we get them all
                                FoldersTestUtil.getAllFolderMembers(mrvisser.restContext, folder.id, {'batchSize': 16}, function(members, responses) {
                                    assert.strictEqual(members.length, 16);

                                    // Ensure all members came from the users folder and that they all have the proper role
                                    _.each(members, function(member) {
                                        assert.ok(users[member.profile.id]);
                                        if (member.profile.id === mrvisser.user.id) {
                                            assert.strictEqual(member.role, 'manager');
                                        } else {
                                            assert.strictEqual(member.role, 'viewer');
                                        }
                                    });

                                    // Ensure we made 1 request to get the users and it had 16. The second request is an empty
                                    // one since `nextToken` does not use any look-ahead
                                    assert.strictEqual(responses.length, 2);
                                    assert.strictEqual(responses[0].results.length, 16);
                                    assert.strictEqual(responses[1].results.length, 0);
                                    assert.strictEqual(responses[1].nextToken, null);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies private user profiles are scrubbed in content members lists
         */
        it('verify folder members are scrubbed in the members list', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant) {

                // Put a private user in the members list of a folder
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.privateUser, publicTenant.publicUser], function() {

                    // The public user now looks at the members list of the public folder
                    FoldersTestUtil.getAllFolderMembers(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, null, function(members) {
                        // There should be 2 members, get the private user and ensure the profile is scrubbed
                        var privateMember = _.chain(members)
                            .pluck('profile')
                            .findWhere({'visibility': 'private'})
                            .value();

                        assert.strictEqual(privateMember.displayName, publicTenant.privateUser.user.publicAlias);
                        assert.ok(publicTenant.privateUser.user.profilePath);
                        assert.ok(!privateMember.profilePath);
                        return callback();
                    });
                });
            });
        });
    });

    describe('Set Folder Members', function() {

        /**
         * Test that verifies viewers and managers can be set on and removed from a folder
         */
        it('verify viewers and managers can be set on and removed from a folder', function(callback) {
            // Create test users and a folder to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.assertCreateFolderSucceeds(mrvisser.restContext, 'test', 'test', 'private', null, null, function(folder) {

                    // Ensure Bert can be made a viewer
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, mrvisser.restContext, folder.id, _memberUpdate(bert), function() {

                        // Ensure Bert can view the folder
                        FoldersTestUtil.assertGetFolderSucceeds(bert.restContext, folder.id, function() {

                            // Ensure Bert can be removed from the members list
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, mrvisser.restContext, folder.id, _memberUpdate(bert, false), function() {

                                // Ensure Bert can no longer view the folder
                                FoldersTestUtil.assertGetFolderFails(bert.restContext, folder.id, 401, function() {

                                    // Ensure Bert can be made a manager
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, mrvisser.restContext, folder.id, _memberUpdate(bert, 'manager'), function() {

                                        // Ensure Bert can view the folder once again
                                        FoldersTestUtil.assertGetFolderSucceeds(bert.restContext, folder.id, function() {

                                            // Ensure Bert can now demote mrvisser to viewer, O noez!
                                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(bert.restContext, bert.restContext, folder.id, _memberUpdate(mrvisser), function() {

                                                // Ensure mrvisser can no longer update the permissions
                                                return FoldersTestUtil.assertUpdateFolderMembersFails(bert.restContext, mrvisser.restContext, folder.id, _memberUpdate(bert.user.id, 'manager'), 401, callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies a folder cannot be left without a manager
         */
        it('verify a folder cannot be left with no managers', function(callback) {
            // Create test users and a folder to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 5, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Try and make all the users viewer, including the creator mrvisser
                    var memberUpdates = {};
                    _.each(users, function(user, userId) {
                        memberUpdates[userId] = 'viewer';
                    });

                    FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, mrvisser.restContext, folder.id, memberUpdates, 400, function() {
                        memberUpdates[bert.user.id] = 'manager';

                        // Build an update that sets bert as manager and mrvisser as viewer
                        var memberUpdateInfos = {};
                        _.each(users, function(user, userId) {
                            memberUpdateInfos[userId] = _.extend({}, user, {'role': 'viewer'});
                        });
                        memberUpdateInfos[bert.user.id].role = 'manager';

                        // Ensure mrvisser can still update the members, and changing bert to manager while demoting himself is fair game
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(camAdminRestContext, mrvisser.restContext, folder.id, memberUpdateInfos, function() {

                            // Ensure bert cannot remove himself as that would now result in no manager
                            return FoldersTestUtil.assertUpdateFolderMembersFails(bert.restContext, bert.restContext, folder.id, _memberUpdate(bert.user.id, false), 400, callback);
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies a viewer cannot promote themselves to manager
         */
        it('verify a viewer cannot promote themselves to manager', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Make Bert a member
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, mrvisser.restContext, folder.id, _memberUpdate(bert), function() {

                        // Ensure Bert can't promote himself to manager
                        return FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, bert.restContext, folder.id, _memberUpdate(bert.user.id, 'manager'), 401, callback);
                    });
                });
            });
        });

        /**
         * Test that verifies validation of setting folder members
         */
        it('verify set folder members validation', function(callback) {
            // Generate a test user and folder for testing validation
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, bert) {
                assert.ok(!err);

                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {
                    // Ensure folder id must be a valid resource id
                    FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, mrvisser.restContext, 'notavalidid', _memberUpdate(bert.user.id), 400, function() {

                        // Ensure folder id must exist
                        FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, mrvisser.restContext, 'x:oaetest:nonexistingid', _memberUpdate(bert.user.id), 404, function() {

                            // Ensure one member update must be specified
                            FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, mrvisser.restContext, folder.id, {}, 400, function() {

                                // Ensure members must be valid principal ids
                                FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, mrvisser.restContext, folder.id, {'notavalidid': 'viewer'}, 400, function() {
                                    FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, mrvisser.restContext, folder.id, {'c:oaetest:notaprincipalid': 'viewer'}, 400, function() {

                                        // Ensure members must be existing principal ids
                                        FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, mrvisser.restContext, folder.id, {'u:oaetest:nonexistingid': 'viewer'}, 400, function() {
                                            FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, mrvisser.restContext, folder.id, {'g:oaetest:nonexistingid': 'viewer'}, 400, function() {

                                                // Sanity check the base input works
                                                return FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, mrvisser.restContext, folder.id, _memberUpdate(bert), callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies anonymous users cannot set members on a folder
         */
        it('verify an anonymous user cannot set folder members', function(callback) {
            // Generate a test user and folder to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Ensure anonymous cannot set the members
                    FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, camAnonymousRestContext, folder.id, _memberUpdate(bert.user.id), 401, function() {

                        // Sanity check mrvisser can perform the same share
                        return FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, mrvisser.restContext, folder.id, _memberUpdate(bert), callback);
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of setting folder members as an administrative user
         */
        it('verify set folder members authorization for an admin user', function(callback) {
            // Setup folders and users for different visibilities and tenants
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {
                // Create an extra folder that is not managed by an admin user
                FoldersTestUtil.generateTestFolders(publicTenant.publicUser.restContext, 1, function(folder) {

                    // Ensure admin can set members a folder they don't explicitly manage
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.adminRestContext, folder.id, _memberUpdate(publicTenant.loggedinUser, 'manager'), function() {

                        // Ensure admin cannot set members for user profiles with which they cannot interact
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(publicTenant.privateUser), function() {
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(publicTenant1.publicUser), function() {
                                FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(publicTenant1.loggedinUser.user.id), 401, function() {
                                    FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(publicTenant1.privateUser.user.id), 401, function() {
                                        FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(privateTenant.publicUser.user.id), 401, function() {
                                            FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(privateTenant.loggedinUser.user.id), 401, function() {
                                                return FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(privateTenant.privateUser.user.id), 401, callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of setting members on a folder as a regular user
         */
        it('verify set folder members authorization for a regular user', function(callback) {
            // Setup folders and users for different visibilities and tenants
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure the user cannot set members a folder they don't explicitly manage
                FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.loggedinUser.user.id), 401, function() {

                    // Make the user a viewer and ensure they still can't set permissions
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.publicUser), function() {
                        FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.loggedinUser.user.id), 401, function() {
                            // Make the user a manager so they can update permissions
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.publicUser, 'manager'), function() {

                                // Ensure the manager user cannot set members for user profiles with which they cannot interact
                                FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.privateUser.user.id), 401, function() {
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant1.publicUser), function() {
                                        FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant1.loggedinUser.user.id), 401, function() {
                                            FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant1.privateUser.user.id), 401, function() {
                                                FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(privateTenant.publicUser.user.id), 401, function() {
                                                    FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(privateTenant.loggedinUser.user.id), 401, function() {
                                                        return FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(privateTenant.privateUser.user.id), 401, callback);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Get Folders Library', function() {

        /**
         * Test that verifies getting a folders library returns the proper library visibility
         */
        it('verify users get the appropriate folders library visibility', function(callback) {
            // Generate users from a variety of tenants, as well as a library of public, loggedin and private folders for a user
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {
                FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant.publicUser.restContext, 3, 'public', function(publicFolder1, publicFolder2, publicFolder3) {
                    FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant.publicUser.restContext, 3, 'loggedin', function(loggedinFolder1, loggedinFolder2, loggedinFolder3) {
                        FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant.publicUser.restContext, 3, 'private', function(privateFolder1, privateFolder2, privateFolder3) {
                            var publicFolderIds = _.pluck([publicFolder1, publicFolder2, publicFolder3], 'id');
                            var loggedinFolderIds = _.pluck([loggedinFolder1, loggedinFolder2, loggedinFolder3], 'id');
                            var privateFolderIds = _.pluck([privateFolder1, privateFolder2, privateFolder3], 'id');

                            var expectedPublicFoldersLibraryIds = publicFolderIds.slice();
                            var expectedLoggedinFoldersLibraryIds = _.union(publicFolderIds, loggedinFolderIds);
                            var expectedPrivateFoldersLibraryIds = _.chain(publicFolderIds).union(loggedinFolderIds).union(privateFolderIds).value();

                            // Ensure the user themself gets the private library
                            FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant.publicUser.restContext, publicTenant.publicUser.user.id, expectedPrivateFoldersLibraryIds, false, function() {

                                // Ensure admin gets the private library as well
                                FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant.adminRestContext, publicTenant.publicUser.user.id, expectedPrivateFoldersLibraryIds, false, function() {

                                    // Ensure authenticated user gets the loggedin library
                                    FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant.loggedinUser.restContext, publicTenant.publicUser.user.id, expectedLoggedinFoldersLibraryIds, false, function() {

                                        // Ensure admin from another tenant gets the public library
                                        FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant1.adminRestContext, publicTenant.publicUser.user.id, expectedPublicFoldersLibraryIds, false, function() {

                                            // Ensure authenticated user from another tenant gets the public library
                                            FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant1.publicUser.restContext, publicTenant.publicUser.user.id, expectedPublicFoldersLibraryIds, false, function() {

                                                // Ensure anonymous user gets the public library
                                                return FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant.anonymousRestContext, publicTenant.publicUser.user.id, expectedPublicFoldersLibraryIds, false, callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting a public user library
         */
        it('verify get folders library authorization for public user library', function(callback) {
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Ensure authorization of public user library
                FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.anonymousRestContext, publicTenant.publicUser.user.id, null, null, function() {
                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.adminRestContext, publicTenant.publicUser.user.id, null, null, function() {
                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.publicUser.restContext, publicTenant.publicUser.user.id, null, null, function() {
                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.loggedinUser.restContext, publicTenant.publicUser.user.id, null, null, function() {
                                FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant1.publicUser.restContext, publicTenant.publicUser.user.id, null, null, function() {
                                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant1.adminRestContext, publicTenant.publicUser.user.id, null, null, function() {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting a loggedin user library
         */
        it('verify get folders library authorization for loggedin user library', function(callback) {
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Ensure authorization of public user library
                FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant.anonymousRestContext, publicTenant.loggedinUser.user.id, null, null, 401, function() {
                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.adminRestContext, publicTenant.loggedinUser.user.id, null, null, function() {
                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinUser.user.id, null, null, function() {
                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.loggedinUser.restContext, publicTenant.loggedinUser.user.id, null, null, function() {
                                FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant1.publicUser.restContext, publicTenant.loggedinUser.user.id, null, null, 401, function() {
                                    FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant1.adminRestContext, publicTenant.loggedinUser.user.id, null, null, 401, function() {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting a private user library
         */
        it('verify get folders library authorization for private user library', function(callback) {
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Ensure authorization of public user library
                FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant.anonymousRestContext, publicTenant.privateUser.user.id, null, null, 401, function() {
                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.adminRestContext, publicTenant.privateUser.user.id, null, null, function() {
                        FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant.publicUser.restContext, publicTenant.privateUser.user.id, null, null, 401, function() {
                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.privateUser.restContext, publicTenant.privateUser.user.id, null, null, function() {
                                FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant1.publicUser.restContext, publicTenant.privateUser.user.id, null, null, 401, function() {
                                    FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant1.adminRestContext, publicTenant.privateUser.user.id, null, null, 401, function() {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation of getting a folders library
         */
        it('verify get folders library validation', function(callback) {
            // Generate a user and give them more than 25 folders in their folders library
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 30, function() {

                    // Ensure we must provide a valid and existing principal id
                    FoldersTestUtil.assertGetFoldersLibraryFails(mrvisser.restContext, 'notavalidid', null, 15, 400, function() {
                        FoldersTestUtil.assertGetFoldersLibraryFails(mrvisser.restContext, 'c:oaetest:notaprincipalid', null, 15, 400, function() {
                            FoldersTestUtil.assertGetFoldersLibraryFails(mrvisser.restContext, 'g:oaetest:nonexistingid', null, 15, 404, function() {
                                FoldersTestUtil.assertGetFoldersLibraryFails(mrvisser.restContext, 'u:oaetest:nonexistingid', null, 15, 404, function() {

                                    // Ensure limit is greater than or equal to 1, less than or equal to 25, and defaults to 10
                                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(mrvisser.restContext, mrvisser.user.id, null, 0, function(result) {
                                        assert.strictEqual(result.results.length, 1);
                                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(mrvisser.restContext, mrvisser.user.id, null, null, function(result) {
                                            assert.strictEqual(result.results.length, 12);
                                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(mrvisser.restContext, mrvisser.user.id, null, 100, function(result) {
                                                assert.strictEqual(result.results.length, 25);

                                                // Ensure the base input provides the expected results
                                                FoldersTestUtil.assertGetFoldersLibrarySucceeds(mrvisser.restContext, mrvisser.user.id, null, 15, function(result) {
                                                    assert.strictEqual(result.results.length, 15);
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies paging of the folders library
         */
        it('verify get folders library paging', function(callback) {
            // Generate a user and give them enough folders in their library to page through
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 16, function() {

                    // Page items by 1 and ensure we get them all with the correct number of requests
                    FoldersTestUtil.getAllFoldersInLibrary(mrvisser.restContext, mrvisser.user.id, {'batchSize': 1}, function(folders, responses) {
                        assert.strictEqual(folders.length, 16);

                        // Ensure there are 16 responses for each request, plus 1 empty one to
                        // indicate that the library items are exhausted
                        assert.strictEqual(responses.length, 17);
                        assert.strictEqual(_.last(responses).results.length, 0);
                        assert.strictEqual(_.last(responses).nextToken, null);

                        // Page items by 3 and ensure we get them all with the correct number of requests
                        FoldersTestUtil.getAllFoldersInLibrary(mrvisser.restContext, mrvisser.user.id, {'batchSize': 3}, function(folders, responses) {
                            assert.strictEqual(folders.length, 16);

                            // Ensure there are 6 responses for each request, where the final one
                            // has only 1 element and indicates the list is exhausted
                            assert.strictEqual(responses.length, 6);
                            assert.strictEqual(_.last(responses).results.length, 1);
                            assert.strictEqual(_.last(responses).nextToken, null);

                            // Page items by the full amount and ensure we get them all with the correct number of requests
                            FoldersTestUtil.getAllFoldersInLibrary(mrvisser.restContext, mrvisser.user.id, {'batchSize': 16}, function(folders, responses) {
                                assert.strictEqual(folders.length, 16);

                                // Ensure there is 1 response for the request to get all, plus 1
                                // empty one that indicates the list is exhausted
                                assert.strictEqual(responses.length, 2);
                                assert.strictEqual(_.last(responses).results.length, 0);
                                assert.strictEqual(_.last(responses).nextToken, null);

                                // Page items by greater than the full amount and ensure we get them all with the correct number of requests
                                FoldersTestUtil.getAllFoldersInLibrary(mrvisser.restContext, mrvisser.user.id, {'batchSize': 17}, function(folders, responses) {
                                    assert.strictEqual(folders.length, 16);

                                    // Ensure there is 1 response with all the folders
                                    assert.strictEqual(responses.length, 1);
                                    assert.strictEqual(_.last(responses).results.length, 16);
                                    assert.strictEqual(_.last(responses).nextToken, null);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * This test manually triggers an update for folder libraries as that codepath
         * does not get triggered due to timeconstraints in the tests
         */
        it('verify updating folder libraries', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);

                FoldersTestUtil.assertCreateFolderSucceeds(simong.restContext, 'test displayName', 'test description', 'private', [nico], [], function(folder) {

                    // Page items by 1 and ensure we get them all with the correct number of requests
                    FoldersTestUtil.getAllFoldersInLibrary(simong.restContext, simong.user.id, {'batchSize': 1}, function(folders) {
                        assert.strictEqual(folders.length, 1);
                        assert.strictEqual(folders[0].id, folder.id);
                        FoldersTestUtil.getAllFoldersInLibrary(nico.restContext, nico.user.id, {'batchSize': 1}, function(folders) {
                            assert.strictEqual(folders.length, 1);
                            assert.strictEqual(folders[0].id, folder.id);

                            // Trigger a manual update
                            FoldersFolderLibrary.update([simong.user.id, nico.user.id], folder, null, function(err, newFolder) {
                                assert.ok(!err);
                                assert.notStrictEqual(folder.lastModified, newFolder.lastModified);

                                // Assert the folders are still in the libraries
                                FoldersTestUtil.getAllFoldersInLibrary(simong.restContext, simong.user.id, {'batchSize': 1}, function(folders) {
                                    assert.strictEqual(folders.length, 1);
                                    assert.strictEqual(folders[0].id, folder.id);
                                    assert.equal(folders[0].lastModified, newFolder.lastModified);
                                    FoldersTestUtil.getAllFoldersInLibrary(nico.restContext, nico.user.id, {'batchSize': 1}, function(folders) {
                                        assert.strictEqual(folders.length, 1);
                                        assert.strictEqual(folders[0].id, folder.id);
                                        assert.equal(folders[0].lastModified, newFolder.lastModified);

                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Get Managed Folders', function() {

        /**
         * Test that verifies that the folder the current user manages can be retrieved
         */
        it('verify get managed folders', function(callback) {
            // Generate 2 test users who each have a set of folders
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(simong.restContext, 1, function(simonsFolder) {
                    FoldersTestUtil.generateTestFolders(nico.restContext, 1, function(nicosFolder) {

                        // Nico makes Simon a viewer on his folder
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(nico.restContext, nico.restContext, nicosFolder.id, _memberUpdate(simong), function() {

                            // Only Simon's own folder should be returned as that's the only one he can manage
                            RestAPI.Folders.getManagedFolders(simong.restContext, function(err, folders) {
                                assert.ok(!err);
                                assert.strictEqual(folders.results.length, 1);
                                assert.strictEqual(folders.results[0].id, simonsFolder.id);

                                // Nico makes Simon a manager
                                FoldersTestUtil.assertUpdateFolderMembersSucceeds(nico.restContext, nico.restContext, nicosFolder.id, _memberUpdate(simong, 'manager'), function() {

                                    // Simon is now a manager of both folders
                                    RestAPI.Folders.getManagedFolders(simong.restContext, function(err, folders) {
                                        assert.ok(!err);
                                        assert.strictEqual(folders.results.length, 2);
                                        assert.ok(_.findWhere(folders.results, {'id': simonsFolder.id}));
                                        assert.ok(_.findWhere(folders.results, {'id': nicosFolder.id}));

                                        // Deleting the folder will cause it to remove from the managed folders list
                                        FoldersTestUtil.assertDeleteFolderSucceeds(simong.restContext, simonsFolder.id, false, function() {

                                            // Only Nico's folder should remain
                                            RestAPI.Folders.getManagedFolders(simong.restContext, function(err, folders) {
                                                assert.ok(!err);
                                                assert.strictEqual(folders.results.length, 1);
                                                assert.strictEqual(folders.results[0].id, nicosFolder.id);
                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that validation for the managed folders endpoint
         */
        it('verify get managed folders validation', function(callback) {
            // Anonymous users cannot list their managed folders
            RestAPI.Folders.getManagedFolders(camAnonymousRestContext, function(err, folders) {
                assert.ok(err);
                assert.strictEqual(err.code, 401);
                return callback();
            });
        });
    });

    describe('Remove folder from library', function() {

        /**
         * Test that verifies that the parameters are validated when removing a folder from a library
         */
        it('verify remove folder from library validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(simong.restContext, 1, function(folder) {

                    // Invalid principal id
                    FoldersTestUtil.assertRemoveFolderFromLibraryFails(simong.restContext, 'not a principal id', folder.id, 400, function() {
                        FoldersTestUtil.assertRemoveFolderFromLibraryFails(simong.restContext, 'c:cam:bleh', folder.id, 400, function() {

                            // Invalid folder id
                            FoldersTestUtil.assertRemoveFolderFromLibraryFails(simong.restContext, simong.user.id, 'not a folder id', 400, function() {
                                FoldersTestUtil.assertRemoveFolderFromLibraryFails(simong.restContext, simong.user.id, 'f:cam:doesnotexist', 404, callback);
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the authorization of removing a folder from a principal's library
         */
        it('verify remove folder from library authorization', function(callback) {
            // Create some test users and a group
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, simong, nico, bert) {
                assert.ok(!err);
                TestsUtil.generateTestGroups(simong.restContext, 1, function(group) {
                    group = group.group;
                    var groupUpdates = {};
                    groupUpdates[bert.user.id] = 'member';
                    RestAPI.Group.setGroupMembers(simong.restContext, group.id, groupUpdates, function(err) {
                        assert.ok(!err);

                        // Greate a test folder that both simon and the group manage
                        FoldersTestUtil.generateTestFolders(simong.restContext, 1, function(folder) {
                            var memberUpdate = {};
                            memberUpdate[group.id] = 'manager';
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                                // Anonymous users cannot remove anything
                                FoldersTestUtil.assertRemoveFolderFromLibraryFails(nico.restContext, simong.user.id, folder.id, 401, function() {
                                    FoldersTestUtil.assertRemoveFolderFromLibraryFails(nico.restContext, group.id, folder.id, 401, function() {

                                        // An unrelated user should not be able to remove another user's or group's folder
                                        FoldersTestUtil.assertRemoveFolderFromLibraryFails(nico.restContext, simong.user.id, folder.id, 401, function() {
                                            FoldersTestUtil.assertRemoveFolderFromLibraryFails(nico.restContext, group.id, folder.id, 401, function() {

                                                // Although bert is a manager of the folder by virtue of being a member of the group,
                                                // he cannot remove the folder from Simon's library
                                                FoldersTestUtil.assertRemoveFolderFromLibraryFails(bert.restContext, simong.user.id, folder.id, 401, function() {

                                                    // He can also *not* remove the folder from the group's library as he is only a member of the group
                                                    FoldersTestUtil.assertRemoveFolderFromLibraryFails(nico.restContext, group.id, folder.id, 401, function() {

                                                        // Tenant admins from other tenants cannot remove the folder from the principals their library
                                                        FoldersTestUtil.assertRemoveFolderFromLibraryFails(gtAdminRestContext, simong.user.id, folder.id, 401, function() {
                                                            FoldersTestUtil.assertRemoveFolderFromLibraryFails(gtAdminRestContext, group.id, folder.id, 401, callback);
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that removing a folder from a library revokes access to all the content that was inside the folder
         */
        it('verify removing a folder from a library revokes access to all the content that was inside the folder', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);

                // Generate a test folder that both Simon and Nico manage
                FoldersTestUtil.generateTestFolders(simong.restContext, 1, function(folder) {
                    var memberUpdate = {};
                    memberUpdate[nico.user.id] = 'manager';
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                        // Nico creates a private item and sticks it in the folder
                        RestAPI.Content.createLink(nico.restContext, 'test', 'test', 'private', 'http://www.google.ca', null, null, [], function(err, link) {
                            assert.ok(!err);
                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(nico.restContext, folder.id, [link.id], function() {

                                // Simon should now be able to access the private item
                                RestAPI.Content.getContent(simong.restContext, link.id, function(err, content) {
                                    assert.ok(!err);
                                    assert.strictEqual(content.id, link.id);

                                    // Simon removes the folder from his library
                                    FoldersTestUtil.assertRemoveFolderFromLibrarySucceeds(simong.restContext, simong.user.id, folder.id, function() {

                                        // Simon should no longer be able to access the private content item
                                        RestAPI.Content.getContent(simong.restContext, link.id, function(err, content) {
                                            assert.strictEqual(err.code, 401);
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a folder cannot end up with 0 managers
         */
        it('verify a folder cannot end up with 0 managers', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Generate a test folder that only Simon manages
                FoldersTestUtil.generateTestFolders(simong.restContext, 1, function(folder) {

                    // Simon cannot remove the folder from his library as that would leave it manager-less
                    FoldersTestUtil.assertRemoveFolderFromLibraryFails(simong.restContext, simong.user.id, folder.id, 400, callback);
                });
            });
        });
    });

    describe('Add Items to Folder', function() {

        /**
         * Test that verifies adding a single item to a folder succeeds
         */
        it('verify adding a single item to a folder', function(callback) {
            // Generate a user and give them a folder
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Create a content item that mrvisser will add to his folder
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link) {
                        assert.ok(!err);

                        // Ensure Mrvisser can add the item to his folder
                        return FoldersTestUtil.assertAddContentItemsToFolderSucceeds(mrvisser.restContext, folder.id, [link.id], callback);
                    });
                });
            });
        });

        /**
         * Test that verifies adding multiple content items to a folder succeeds
         */
        it('verify adding multiple items to a folder', function(callback) {
            // Generate a user and give them a folder
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Create 5 content items to add to the folder
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link1) {
                        assert.ok(!err);
                        RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link2) {
                            assert.ok(!err);
                            RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link3) {
                                assert.ok(!err);
                                RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link4) {
                                    assert.ok(!err);
                                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link5) {
                                        assert.ok(!err);

                                        // Ensure Mrvisser can add all the items to his folder
                                        return FoldersTestUtil.assertAddContentItemsToFolderSucceeds(mrvisser.restContext, folder.id, [link1.id, link2.id, link3.id, link4.id, link5.id], callback);
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies both managers and administrators can add content items to a folder
         */
        it('verify only administrators and managers of folders can add content items to them', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {
                RestAPI.User.getMe(publicTenant.adminRestContext, function(err, publicTenantAdminMe) {
                    assert.ok(!err);

                    // Ensure anonymous, regular user, admin from another tenant all cannot add a content item to the folder
                    FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.anonymousRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {
                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {
                            FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant1.adminRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {

                                // Ensure the folder still has no items
                                FoldersTestUtil.getAllFolderContentItems(publicTenant.adminRestContext, publicTenant.publicFolder.id, null, function(contentItems) {
                                    assert.ok(_.isEmpty(contentItems));

                                    // Add public user as a manager of the folder and remove admin as a manager
                                    var memberUpdates = _memberUpdate(publicTenant.publicUser, 'manager');
                                    memberUpdates[publicTenantAdminMe.id] = false;
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.publicFolder.id, memberUpdates, function() {

                                        // Ensure public user and admin can both add an item to the folder
                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], function() {
                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.loggedinContent.id], function() {

                                                // Ensure the folder now has 2 items
                                                FoldersTestUtil.getAllFolderContentItems(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, null, function(contentItems) {
                                                    assert.strictEqual(contentItems.length, 2);
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization for an administrator adding a content item to a folder
         */
        it('verify add items to folder authorization for an administrator', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {
                RestAPI.User.getMe(publicTenant.adminRestContext, function(err, publicTenantAdminMe) {
                    assert.ok(!err);

                    // Admin removes themself from managing each folder while adding a user. This is
                    // to ensure the test is accurate by admin having no explicit manage access
                    var memberUpdates = _memberUpdate(publicTenant.publicUser, 'manager');
                    memberUpdates[publicTenantAdminMe.id] = false;
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.publicFolder.id, memberUpdates, function() {
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, memberUpdates, function() {
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, memberUpdates, function() {

                                // Ensure admin can add the public, loggedin and private content items of their tenant to all the folders in their tenant
                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], function() {
                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.loggedinContent.id], function() {
                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.privateContent.id], function() {
                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.publicContent.id], function() {
                                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinContent.id], function() {
                                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.privateContent.id], function() {
                                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.publicContent.id], function() {
                                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.loggedinContent.id], function() {
                                                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.privateContent.id], function() {

                                                                    // Ensure admin can add only the public content item from another public tenant to a folder
                                                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.publicContent.id], function() {
                                                                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.loggedinContent.id], 401, function() {
                                                                            FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.privateContent.id], 401, function() {

                                                                                // Ensure admin cannot add any content item from another private tenant to a folder
                                                                                FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.publicContent.id], 401, function() {
                                                                                    FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.loggedinContent.id], 401, function() {
                                                                                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.privateContent.id], 401, function() {
                                                                                            return callback();
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization for an authenticated user adding a content item to a folder
         */
        it('verify add items to folder authorization for an authenticated user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Make the public user a manager of each folder so he can add items to them
                var memberUpdates = _memberUpdate(publicTenant.publicUser, 'manager');
                FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.publicFolder.id, memberUpdates, function() {
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.loggedinFolder.id, memberUpdates, function() {
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.privateFolder.id, memberUpdates, function() {

                            // Ensure a user can add the public and loggedin content items of their tenant to the folder
                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], function() {
                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.loggedinContent.id], function() {
                                    FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.privateContent.id], 401, function() {
                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.publicContent.id], function() {
                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinContent.id], function() {
                                                FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.privateContent.id], 401, function() {
                                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.publicContent.id], function() {
                                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.loggedinContent.id], function() {
                                                            FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.privateContent.id], 401, function() {

                                                                // Once a user has viewer rights, he should be able to add content to any folder he can manage
                                                                var contentMemberUpdate = _memberUpdate(publicTenant.publicUser.user.id);
                                                                RestAPI.Content.updateMembers(publicTenant.adminRestContext, publicTenant.privateContent.id, contentMemberUpdate, function(err) {
                                                                    assert.ok(!err);
                                                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.privateContent.id], function() {
                                                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.privateContent.id], function() {
                                                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.privateContent.id], function() {

                                                                                // Ensure a user can add only the public content item from another public tenant to a folder
                                                                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant1.publicContent.id], function() {
                                                                                    FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant1.loggedinContent.id], 401, function() {
                                                                                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant1.privateContent.id], 401, function() {

                                                                                            // Ensure a user cannot add any content item from another private tenant to a folder
                                                                                            FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [privateTenant.publicContent.id], 401, function() {
                                                                                                FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [privateTenant.loggedinContent.id], 401, function() {
                                                                                                    FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [privateTenant.privateContent.id], 401, function() {
                                                                                                        return callback();
                                                                                                    });
                                                                                                });
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies adding a content item to a folder allows permissions to propagate to the content
         * item from the folder's members
         */
        it('verify folders propagate user permission to content items that belong to them', function(callback) {
            // Create mrvisser, a folder that he manages, and a private content item that he does not have access to
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'private', 'http://www.google.ca', null, null, [], function(err, link) {
                        assert.ok(!err);

                        // Sanity check that mrvisser has no access to the content item
                        RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                            assert.ok(err);
                            assert.strictEqual(err.code, 401);

                            // Add the link to the folder
                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(camAdminRestContext, folder.id, [link.id], function() {

                                // Ensure that Mrvisser now has access to view the link
                                RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                                    assert.ok(!err);

                                    // Remove the content item from the folder
                                    FoldersTestUtil.assertRemoveContentItemsFromFolderSucceeds(camAdminRestContext, folder.id, [link.id], function() {

                                        // Ensure that Mrvisser lost his access to view the link
                                        RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                                            assert.ok(err);
                                            assert.strictEqual(err.code, 401);

                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies folders propagate group permission to content items that belong to them
         */
        it('verify folders propagate group permission to content items that belong to them', function(callback) {
            // Generate 2 test users and folder. mrvisser will be given access to the private link via a group and folder permissions chain
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(camAdminRestContext, 1, function(folder) {

                    // Create the private link to which will give mrvisser access VIA group and folder permissions chain
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'private', 'http://www.google.ca', null, null, [], function(err, link) {
                        assert.ok(!err);

                        // Generate an hierarchy of groups through which access will be propagated down to the user
                        TestsUtil.generateTestGroups(camAdminRestContext, 3, function(group1, group2, group3) {
                            TestsUtil.generateGroupHierarchy(camAdminRestContext, [group1.group.id, group2.group.id, group3.group.id, mrvisser.user.id], 'member', function(err) {
                                assert.ok(!err);

                                // Add simong to the parent group to sanity check permissions will not propagate the wrong way through groups
                                RestAPI.Group.setGroupMembers(camAdminRestContext, group1.group.id, _memberUpdate(simong.user.id, 'member'), function(err) {
                                    assert.ok(!err);

                                    // Add group2 as a member of the folder. This implies that group1 and it's members (the parent of group2) will not receive
                                    // access when the link is added to the folder
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(camAdminRestContext, camAdminRestContext, folder.id, _memberUpdate(group2), function() {

                                        // Sanity check that mrvisser and simong both have no access to the content item because it has not yet been added to the
                                        // folder to complete the permission chain
                                        RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                                            assert.ok(err);
                                            assert.strictEqual(err.code, 401);
                                            RestAPI.Content.getContent(simong.restContext, link.id, function(err) {
                                                assert.ok(err);
                                                assert.strictEqual(err.code, 401);

                                                // Finally add the link to the folder
                                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(camAdminRestContext, folder.id, [link.id], function() {

                                                    // Ensure mrvisser now has access by permission chain: link -> folder -> group1 -> group2 -> group3 -> mrvisser
                                                    RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                                                        assert.ok(!err);

                                                        // Sanity check that the reverse chain did not propagate access to simong
                                                        RestAPI.Content.getContent(simong.restContext, link.id, function(err) {
                                                            assert.ok(err);
                                                            assert.strictEqual(err.code, 401);

                                                            // Remove the link from the folder
                                                            FoldersTestUtil.assertRemoveContentItemsFromFolderSucceeds(camAdminRestContext, folder.id, [link.id], function() {

                                                                // Ensure that Mrvisser lost his access to view the link
                                                                RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                                                                    assert.ok(err);
                                                                    assert.strictEqual(err.code, 401);

                                                                    return callback();
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Remove Items from Folder', function() {

        /**
         * Test that verifies removing a single item from a folder succeeds
         */
        it('verify removing a single item from a folder', function(callback) {
            // Generate a user and give them a folder
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Create a content item that mrvisser will add to his folder
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link) {
                        assert.ok(!err);

                        // Ensure Mrvisser can add the item to his folder
                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(mrvisser.restContext, folder.id, [link.id], function() {

                            // Ensure Mrvisser can remove the item from his folder
                            return FoldersTestUtil.assertRemoveContentItemsFromFolderSucceeds(mrvisser.restContext, folder.id, [link.id], callback);
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies removing multiple content items from a folder succeeds
         */
        it('verify removing multiple items from a folder', function(callback) {
            // Generate a user and give them a folder
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Create 5 content items to add to the folder
                    RestAPI.Content.createLink(camAdminRestContext, 'test1', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link1) {
                        assert.ok(!err);
                        RestAPI.Content.createLink(camAdminRestContext, 'test2', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link2) {
                            assert.ok(!err);
                            RestAPI.Content.createLink(camAdminRestContext, 'test3', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link3) {
                                assert.ok(!err);
                                RestAPI.Content.createLink(camAdminRestContext, 'test4', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link4) {
                                    assert.ok(!err);
                                    RestAPI.Content.createLink(camAdminRestContext, 'test5', 'test', 'public', 'http://www.google.ca', null, null, [], function(err, link5) {
                                        assert.ok(!err);

                                        // Ensure Mrvisser can add all the items to his folder
                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(mrvisser.restContext, folder.id, [link1.id, link2.id, link3.id, link4.id, link5.id], function() {

                                            // Remove the first 2 content items
                                            FoldersTestUtil.assertRemoveContentItemsFromFolderSucceeds(mrvisser.restContext, folder.id, [link1.id, link2.id], function() {

                                                // Ensure that the other 3 items are still there
                                                FoldersTestUtil.getAllFolderContentItems(mrvisser.restContext, folder.id, null, function(contentItems, responses) {
                                                    assert.strictEqual(contentItems.length, 3);
                                                    assert.ok(_.findWhere(contentItems, {'id': link3.id}));
                                                    assert.ok(_.findWhere(contentItems, {'id': link4.id}));
                                                    assert.ok(_.findWhere(contentItems, {'id': link5.id}));
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies both managers and administrators can remove content items from a folder
         */
        it('verify only administrators and managers of folders can remove content items from a folder', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {
                RestAPI.User.getMe(publicTenant.adminRestContext, function(err, publicTenantAdminMe) {
                    assert.ok(!err);

                    // Stick the all the content items from the public tenant in the private folder
                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id, publicTenant.loggedinContent.id, publicTenant.privateContent.id], function() {

                        // Ensure anonymous, regular user, regular user from another tenant, admin from another tenant all cannot add a content item to the folder
                        FoldersTestUtil.assertRemoveContentItemsFromFolderFails(publicTenant.anonymousRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {
                            FoldersTestUtil.assertRemoveContentItemsFromFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {
                                FoldersTestUtil.assertRemoveContentItemsFromFolderFails(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {
                                    FoldersTestUtil.assertRemoveContentItemsFromFolderFails(publicTenant1.adminRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {

                                        // Ensure the folder still has all its content
                                        FoldersTestUtil.getAllFolderContentItems(publicTenant.adminRestContext, publicTenant.publicFolder.id, null, function(contentItems) {
                                            assert.strictEqual(contentItems.length, 3);

                                            // Add public user as a manager of the folder and remove admin as a manager
                                            var memberUpdates = _memberUpdate(publicTenant.publicUser, 'manager');
                                            memberUpdates[publicTenantAdminMe.id] = false;
                                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.adminRestContext, publicTenant.publicFolder.id, memberUpdates, function() {

                                                // Ensure public user and admin can both delete an item to the folder
                                                FoldersTestUtil.assertRemoveContentItemsFromFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], function() {
                                                    FoldersTestUtil.assertRemoveContentItemsFromFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.loggedinContent.id], function() {

                                                        // Ensure the folder now has 1 item
                                                        FoldersTestUtil.getAllFolderContentItems(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, null, function(contentItems) {
                                                            assert.strictEqual(contentItems.length, 1);
                                                            return callback();
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Get Folder Content Library', function() {

        /**
         Test that verifies the authorization of listing a folder's content library
         */
        it('verify get folder content library authorization', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'private', function(folder) {

                    // Create some content and add it to the folder
                    RestAPI.Content.createLink(simong.restContext, 'test', 'test', 'public', 'http://www.google.ca', null, [], [folder.id], function(err, link1) {
                        assert.ok(!err);
                        RestAPI.Content.createLink(simong.restContext, 'test', 'test', 'public', 'http://www.google.ca', null, [], [folder.id], function(err, link2) {
                            assert.ok(!err);
                            RestAPI.Content.createLink(simong.restContext, 'test', 'test', 'public', 'http://www.google.ca', null, [], [folder.id], function(err, link3) {
                                assert.ok(!err);

                                // Only Simon and the cambridge tenant admin should be able to view the folder's content library
                                FoldersTestUtil.assertGetFolderContentLibraryFails(camAnonymousRestContext, folder.id, null, null, 401, function() {
                                    FoldersTestUtil.assertGetFolderContentLibraryFails(nico.restContext, folder.id, null, null, 401, function() {
                                        FoldersTestUtil.assertGetFolderContentLibraryFails(gtAdminRestContext, folder.id, null, null, 401, function() {
                                            FoldersTestUtil.assertFolderEquals(simong.restContext, folder.id, [link1.id, link2.id, link3.id], function() {
                                                FoldersTestUtil.assertFolderEquals(camAdminRestContext, folder.id, [link1.id, link2.id, link3.id], callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that validation for the folder content endpoint
         */
        it('verify get folder content validation', function(callback) {
            FoldersTestUtil.assertGetFolderContentLibraryFails(camAnonymousRestContext, 'not a folder id', null, null, 400, function() {
                FoldersTestUtil.assertGetFolderContentLibraryFails(camAnonymousRestContext, 'f:camtest:notexisting', null, null, 404, function() {
                    return callback();
                });
            });
        });
    });

    describe('Content Integration', function() {

        /**
         * Test that verifies that folder ids can be specified when creating content
         */
        it('verify folder ids can be specified when creating content', function(callback) {
            // Create a test user with which to do stuff
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Create a few folders to which we'll add some content items
                FoldersTestUtil.generateTestFolders(simong.restContext, 3, function(folder1, folder2, folder3) {
                    var folderIds = [folder1.id, folder2.id, folder3.id];

                    // Create some content and add it to the folders
                    RestAPI.Content.createLink(simong.restContext, 'test', 'test', 'public', 'http://www.google.ca', null, [], folderIds, function(err, link) {
                        assert.ok(!err);
                        RestAPI.Content.createCollabDoc(simong.restContext, 'test', 'test', 'public', null, [], [], folderIds, function(err, collabDoc) {
                            assert.ok(!err);
                            RestAPI.Content.createFile(simong.restContext, 'test', 'test', 'public', _getFileStream, null, [], folderIds, function(err, file) {
                                assert.ok(!err);

                                // Assert that each folder contains all the content items
                                var contentIds = [link.id, collabDoc.id, file.id];
                                FoldersTestUtil.assertFolderEquals(simong.restContext, folder1.id, contentIds, function() {
                                    FoldersTestUtil.assertFolderEquals(simong.restContext, folder2.id, contentIds, function() {
                                        FoldersTestUtil.assertFolderEquals(simong.restContext, folder3.id, contentIds, callback);
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a content item that belongs to folders and has groups as members can list their members
         */
        it('verify a content item that belongs to folders and has groups as members can list their members', function(callback) {
            // Create a test user with which to do stuff
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);

                // Create a few folders that a content item will be added to
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 3, function() {
                    var folderIds = _.pluck(arguments, 'id');

                    // Create a few groups that will be added as a member of the content item
                    TestsUtil.generateTestGroups(mrvisser.restContext, 3, function() {
                        var groupIds = _.chain(arguments).pluck('group').pluck('id').value();

                        // Create a content item to add to the folders
                        RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, groupIds, [], function(err, link) {
                            assert.ok(!err);

                            FoldersTestUtil.assertAddContentItemToFoldersSucceeds(mrvisser.restContext, folderIds, link.id, function() {

                                // Ensure we can get the members of the content item
                                RestAPI.Content.getMembers(mrvisser.restContext, link.id, null, null, function(err, result) {
                                    assert.ok(!err);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that content visibility updates affect the folder libraries
         */
        it('verify content visibility updates rebuild folder libraries', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {
                TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);

                    // Create a content item to add to the folder
                    RestAPI.Content.createLink(publicTenant.adminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, [], [], function(err, link) {
                        assert.ok(!err);

                        // Add simon as member to the collection
                        var memberUpdates = {};
                        memberUpdates[simong.user.id] = 'viewer';
                        RestAPI.Folders.updateFolderMembers(publicTenant.adminRestContext, publicTenant.publicFolder.id, memberUpdates, function(err) {

                            // Add the link to the public folder
                            FoldersTestUtil.assertAddContentItemToFoldersSucceeds(publicTenant.adminRestContext, [publicTenant.publicFolder.id], link.id, function() {

                                // Everyone should be able to see the link in the folder
                                FoldersTestUtil.assertFolderEquals(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [link.id], function() {
                                    FoldersTestUtil.assertFolderEquals(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, [link.id], function() {
                                        FoldersTestUtil.assertFolderEquals(camAnonymousRestContext, publicTenant.publicFolder.id, [link.id], function() {
                                            FoldersTestUtil.assertFolderEquals(simong.restContext, publicTenant.publicFolder.id, [link.id], function() {

                                                // Update the visibility of the content item to loggedin
                                                RestAPI.Content.updateContent(publicTenant.adminRestContext, link.id, {'visibility': 'loggedin'}, function(err) {
                                                    assert.ok(!err);
                                                    FoldersLibrary.whenAllPurged(function() {

                                                        // The users from the other tenant can no longer see the content item
                                                        FoldersTestUtil.assertFolderEquals(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [link.id], function() {
                                                            FoldersTestUtil.assertFolderEquals(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, [], function() {
                                                                FoldersTestUtil.assertFolderEquals(camAnonymousRestContext, publicTenant.publicFolder.id, [], function() {
                                                                    FoldersTestUtil.assertFolderEquals(simong.restContext, publicTenant.publicFolder.id, [link.id], function() {

                                                                        // Update the visiblity of the content item to private
                                                                        RestAPI.Content.updateContent(publicTenant.adminRestContext, link.id, {'visibility': 'private'}, function(err) {
                                                                            assert.ok(!err);
                                                                            FoldersLibrary.whenAllPurged(function() {

                                                                                // Only members of the folder can see the link in the folder
                                                                                FoldersTestUtil.assertFolderEquals(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [], function() {
                                                                                    FoldersTestUtil.assertFolderEquals(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, [], function() {
                                                                                        FoldersTestUtil.assertFolderEquals(camAnonymousRestContext, publicTenant.publicFolder.id, [], function() {
                                                                                            FoldersTestUtil.assertFolderEquals(simong.restContext, publicTenant.publicFolder.id, [link.id], function() {
                                                                                                return callback();
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that when a content item is removed from the system it's also removed
         * from the folders it was placed in
         */
        it('verify removing a content item from the system removes it from the folders', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {
                TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);

                    // Create a content item to add to the folder
                    RestAPI.Content.createLink(publicTenant.adminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, [], [], function(err, link) {
                        assert.ok(!err);

                        // Add simon as member to the collection
                        var memberUpdates = {};
                        memberUpdates[simong.user.id] = 'viewer';
                        RestAPI.Folders.updateFolderMembers(publicTenant.adminRestContext, publicTenant.publicFolder.id, memberUpdates, function(err) {

                            // Add the link to the public folder
                            FoldersTestUtil.assertAddContentItemToFoldersSucceeds(publicTenant.adminRestContext, [publicTenant.publicFolder.id], link.id, function() {

                                // Everyone should be able to see the link in the folder
                                FoldersTestUtil.assertFolderEquals(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [link.id], function() {
                                    FoldersTestUtil.assertFolderEquals(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, [link.id], function() {
                                        FoldersTestUtil.assertFolderEquals(camAnonymousRestContext, publicTenant.publicFolder.id, [link.id], function() {
                                            FoldersTestUtil.assertFolderEquals(simong.restContext, publicTenant.publicFolder.id, [link.id], function() {

                                                // Delete the link
                                                RestAPI.Content.deleteContent(publicTenant.adminRestContext, link.id, function(err) {
                                                    assert.ok(!err);

                                                    FoldersLibrary.whenAllPurged(function() {

                                                        // It should be removed from all the libraries
                                                        FoldersTestUtil.assertFolderEquals(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [], function() {
                                                            FoldersTestUtil.assertFolderEquals(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, [], function() {
                                                                FoldersTestUtil.assertFolderEquals(camAnonymousRestContext, publicTenant.publicFolder.id, [], function() {
                                                                    FoldersTestUtil.assertFolderEquals(simong.restContext, publicTenant.publicFolder.id, [], function() {

                                                                        // Sanity-check it's been removed through the Library API as the REST API does it's own filtering
                                                                        FoldersContentLibrary.list(publicTenant.publicFolder, 'public', {}, function(err, contentIds, nextToken) {
                                                                            assert.ok(!err);
                                                                            assert.strictEqual(contentIds.length, 0);
                                                                            assert.ok(!nextToken);
                                                                            return callback();
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
