/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
var OAE = require('oae-util/lib/oae');

var AnnotationApi = require('./api');

/*! A handshake used by the annotator to confirm everything is up an running.*/
OAE.tenantServer.get('/api/annotations', function(req, response){
    response.send(200, {"name": "Annotator Store API",  "version": "2.0.0"});
});


// Return all annotations wich can be found on a specific page
OAE.tenantServer.get('/api/annotations/:revisionId/:page', function(req, response){
    AnnotationApi.getAnnotations(req.ctx, req.params.revisionId, req.params.page, function(err, data){
        if (err){
            response.send(err.code,err.msg);
        } else{
            response.send(200, data);
        }
    });
});


// Request a specific annotation form the server
OAE.tenantServer.get('/api/annotations/:revisionId/:page/:annotationId', function(req, response){
    AnnotationApi.getAnnotation(req.ctx, req.params.revisionId, req.params.annotationId, function(err, data){
        if (err){
            response.send(err.code,err.msg);
        }
        response.send(200, data);
    });
});

// Create a new annotation
OAE.tenantServer.post('/api/annotations/:revisionId/:page', function(req, response){
    AnnotationApi.createAnnotation(req.ctx, req.params.revisionId, req.params.page, req.body, function(err, data){
        if (err){
            response.send(err.code,err.msg);
        }else{
            response.setHeader('Location', '/api/annotations/' + req.params.revisionId + '/' + req.params.page + '/' + data.id);
            response.send(303);
        }
    });
});


// Update a annotation
OAE.tenantServer.put('/api/annotations/:revisionId/:page/:annotationId', function(req, response){
    AnnotationApi.updateAnnotation(req.ctx, req.params.revisionId, req.params.page, req.params.annotationId, req.body, function(err, data){
        if (err){
            response.send(err.code,err.msg);
        }else{
            response.setHeader('Location', '/api/annotations/' + req.params.revisionId + '/' + req.params.page + '/' + req.params.annotationId);
            response.send(303);
        }
    });  
});

// Delete a annotation
OAE.tenantServer.delete('/api/annotations/:revisionId/:annotationId', function(req, response){ 
    AnnotationApi.deleteAnnotation(req.ctx, req.params.revisionId, req.params.annotationId, function(err){
        if (err){
            response.send(err.code,err.msg);
        }else{
            response.send(204);
        }
    }); 
});


