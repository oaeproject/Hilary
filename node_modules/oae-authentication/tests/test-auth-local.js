/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 * 
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');
var request = require('request');

var RestAPI = require('oae-rest');
var Context = require('oae-context').Context;
var RestContext = require('oae-rest/lib/model').RestContext;
var TestsUtil = require('oae-tests');

var AuthenticationAPI = require('oae-authentication');


describe('Authentication', function() {

    // Rest context that can be used for anonymous requests on the cambridge tenant
    var anonymousCamRestContext = null;
    // Rest context that can be used for anonymous requests on the georgia tech tenant
    var anonymousGtRestContext = null;
    // Rest context that can be used every time we need to make a request as a tenant admin
    var camAdminRestContext = null;

    /**
     * Function that will fill up the tenant admin and anymous rest context
     */
    before(function(callback) {
        // Fill up the anonymous cam rest context
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        // Fill up the anonymous gt rest context
        anonymousGtRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host);
        // Fill up global admin rest context
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        callback();
    });


    describe('Local authentication', function() {

        /**
         * Test that verifies that users can log into the system using a local authorization strategy
         */
        it('verify local authentication', function(callback) {
            // Create a test user
            var userId = TestsUtil.generateTestUserId();
            RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', null, function(err, createdUser) {
                assert.ok(!err);
                assert.ok(createdUser);
                var userRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, userId, 'password');

                // Log the user out first, to make sure that the cookie jar for the user is empty
                RestAPI.Authentication.logout(userRestContext, function(err) {
                    assert.ok(!err);

                    // Login without a user id
                    RestAPI.Authentication.login(userRestContext, null, 'password', function(err) {
                        assert.ok(err);

                        // Log in with the wrong password
                        RestAPI.Authentication.login(userRestContext, userId, 'wrong-password', function(err) {
                            assert.ok(err);
    
                            // Log in with the correct password
                            RestAPI.Authentication.login(userRestContext, userId, 'password', function(err) {
                                assert.ok(!err);
                            
                                // Verify that we are actually logged in
                                RestAPI.User.getMe(userRestContext, function(err, meObj) {
                                    assert.ok(!err);
                                    assert.ok(meObj);
                                    assert.equal(meObj.userId, createdUser.id);
                                    
                                    // Logout
                                    RestAPI.Authentication.logout(userRestContext, function(err) {
                                        assert.ok(!err);
                                        
                                        // Verify that we are now logged out
                                        RestAPI.User.getMe(userRestContext, function(err, meObj) {
                                            assert.ok(!err);
                                            assert.ok(meObj);
                                            assert.equal(meObj.anon, true);
                                            callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
        
        /**
         * Test that verifies that loggin in with a non-existing user doesn't work
         */
        it('verify failed authentication', function(callback) {
            // Try to log in as an invalid user
            RestAPI.Authentication.login(anonymousCamRestContext, 'invalid-user', 'password', function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);
                
                // Try to log in as a non-existing user
                RestAPI.Authentication.login(anonymousCamRestContext, 'u:cam:non-existing-user', 'password', function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 401);
                    callback();
                });
            });
        });
    
        /**
         * Test that verifies that logging in is properly separated by tenant
         */
        it('verify tenant login separation', function(callback) {
            // Create a test user
            var userId = TestsUtil.generateTestUserId();
            RestAPI.User.createUser(camAdminRestContext, userId, 'password', 'Test User', null, function(err, createdUser) {
                assert.ok(!err);
                assert.ok(createdUser);
                var userRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, userId, 'password');

                // Verify that we cannot login on tenant B
                RestAPI.Authentication.login(anonymousGtRestContext, userId, 'password', function(err) {
                    assert.ok(err);
                    assert.equal(err.code, 401);
                    
                    // Verify that we can login on tenant A
                    RestAPI.Authentication.login(anonymousCamRestContext, userId, 'password', function(err) {
                        assert.ok(!err);
                        callback();
                    });
                });
            });
        });

    });
    
    
    describe('Admin login', function() {
        
        /**
         * Test that verifies that a global administrator can successfully login on the global admin tenant
         */
        it('verify global administrator authentication', function(callback) {
            var globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
            
            // Get the me feed, this should log in the global admin as well
            RestAPI.User.getMe(globalAdminRestContext, function(err, meObj) {
                assert.ok(!err);
                assert.ok(meObj);
                assert.equal(meObj.isGlobalAdmin, true);

                // Logout
                RestAPI.Authentication.logout(globalAdminRestContext, function(err) {
                    assert.ok(!err);
                    
                    // Verify that the global admin has been logged out
                    RestAPI.User.getMe(globalAdminRestContext, function(err, meObj) {
                        assert.ok(!err);
                        assert.ok(meObj);
                        assert.equal(meObj.anon, true);

                        // Log the global admin back in so the cookie jar can be restored
                        RestAPI.Authentication.login(globalAdminRestContext, globalAdminRestContext.userId, globalAdminRestContext. userPassword, function(err) {
                            assert.ok(!err);
                            callback();
                        });
                    });
                });
            });
        });
        
    });

    
    describe('#getOrCreateUser', function() {
       
       /**
        * Test that verifies the working of the getOrCreateUser function. This will use the internal
        * API as this would normally be called by Facebook, Twitter, etc. authentication
        */
       it('verify getOrCreateUser', function(callback) {
           var userId = TestsUtil.generateTestUserId();
           // Generate the non-existing user
           var ctx = new Context(global.oaeTests.tenants.cam);
           AuthenticationAPI.getOrCreateUser(ctx, userId, 'en_GB', 'Europe/London', 'Nicolaas', 'Matthijs', 'Nicolaas Matthijs', function(err, userObj) {
               assert.ok(!err);
               assert.ok(userObj);
               
               // Get the user again through the same function
               AuthenticationAPI.getOrCreateUser(ctx, userId, 'en_CA', 'Canada/Toronto', 'Branden', 'Visser', 'Branden Visser', function(err, userObj) {
                   assert.ok(!err);
                   assert.ok(userObj);
                   assert.equal(userObj.displayName, 'Nicolaas Matthijs');
                   callback();
               });
           });
       });
        
    });

});
