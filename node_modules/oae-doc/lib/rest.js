/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var OAE = require('oae-util/lib/oae');
var swagger = require('oae-util/lib/swagger');
var swaggerParam = require('oae-util/lib/swaggerParamTypes');
var DocAPI = require('./api');

/**
 * Get list of modules depending on the type
 *
 * Rest Endpoint:
 *
 * _GET_ `/api/doc/[type]`
 *
 * * returns JSON array of available backend or frontend modules
 */
OAE.tenantRouter.swag({
    'path': '/doc/{type}',
    'method': 'GET',
    'nickname': 'getDocModulesByType',
    'summary': 'Get a JSON array of available backend or frontend modules',
    'parameters': [
        swaggerParam.path('type', 'The type of modules to list', 'string', {'valueType': 'LIST', 'values': ['backend', 'frontend']})
    ],
    'responseClass': 'List[string]'
}, function(req, res) {
    DocAPI.getModules(req.params.type, function(err, modules) {
        if (err) {
            return res.send(err.code, err.msg);
        }
        res.send(200, modules);
    });
});

// Add the REST models for Docs
OAE.tenantRouter.addModel('Doc', {
    'id': 'Doc',
    'required': ['tags', 'description', 'code', 'ignore'],
    'properties': {
        'tags': {
            'type': 'array',
            'items': {
                '$ref': 'DocTag'
            }
        },
        'description': {
            'type': 'DocDesc'
        },
        'code': {
            'type': 'string'
        },
        'ignore': {
            'type': 'boolean'
        },
        'ctx': {
            'type': 'DocCtx'
        },
        'isPrivate': {
            'type': 'boolean'
        }
    }
});

OAE.tenantRouter.addModel('DocTag', {
    'id': 'DocTag',
    'required': ['type', 'types', 'name', 'description'],
    'properties': {
        'type': {
            'type': 'string'
        },
        'types': {
            'type': 'array',
            'items': {
                'type': 'string'
            }
        },
        'name': {
            'type': 'string'
        },
        'description': {
            'type': 'string'
        }
    }
});

OAE.tenantRouter.addModel('DocDesc', {
    'id': 'DocDesc',
    'required': ['full', 'summary', 'body'],
    'properties': {
        'full': {
            'type': 'string'
        },
        'summary': {
            'type': 'string'
        },
        'body': {
            'type': 'string'
        }
    }
});

OAE.tenantRouter.addModel('DocCtx', {
    'id': 'DocCtx',
    'required': ['type', 'name', 'value', 'string'],
    'properties': {
        'type' : {
            'type': 'string'
        },
        'name': {
            'type': 'string'
        },
        'value': {
            'type': 'string'
        },
        'string': {
            'type': 'string'
        }
    }
});

/**
 * Get documentation for a module
 *
 * Rest Endpoint:
 *
 * _GET_ `/api/doc/[type]/[moduleId]`
 *
 * * returns JSON representation of js in the module's `lib` directory
 *    formatted like
 *
 *         { "api.js" : {output from dox}, "rest.js": {output from dox} }
 *
 * The dox JSON is documented at https://github.com/visionmedia/dox
 */
OAE.tenantRouter.swag({
    'path': '/doc/{type}/{module}',
    'method': 'GET',
    'nickname': 'getDocModule',
    'summary': 'Get a JSON representation of the documentation for a module',
    'parameters': [
        swaggerParam.path('type', 'The type of modules to list', 'string', {'valueType': 'LIST', 'values': ['backend', 'frontend']}),
        swaggerParam.path('module', 'The name of the module', 'string')
    ],
    'responseClass': 'List[Doc]'
}, function(req, res) {
    DocAPI.getModuleDocumentation(req.params.module, req.params.type, function(err, docs) {
        if (err) {
            return res.send(err.code, err.msg);
        }
        res.send(200, docs);
    });
});

/**
 * Get the swagger resources json
 */
OAE.tenantRouter.on('get', '/api/swagger', function(req, res) {
    return res.send(200, swagger.getResources(req.ctx));
});

/**
 * Get the swagger apis json
 */
OAE.tenantRouter.on('get', '/api/swagger/:id', function(req, res) {
    return res.send(200, swagger.getApi(req.ctx, req.params.id));
});
