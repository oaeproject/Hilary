/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var util = require('util');

var log = require('oae-logger').logger('oae-activity-config');
var OaeUtil = require('oae-util/lib/util');

var DEFAULT_ACTIVITY_TTL = 2 * 7 * 24 * 60 * 60;    // 2 weeks (in seconds)
var DEFAULT_AGGREGATE_IDLE_EXPIRY = 3 * 60 * 60;    // 3 hours (in seconds)
var DEFAULT_AGGREGATE_MAX_EXPIRY = 24 * 60 * 60;    // 1 day (in seconds)
var DEFAULT_NUMBER_OF_PROCESSING_BUCKETS = 3;
var DEFAULT_COLLECTION_EXPIRY = 60;                 // 1 minute (in seconds)
var DEFAULT_MAX_CONCURRENT_COLLECTIONS = 3;
var DEFAULT_MAX_CONCURRENT_ROUTERS = 5;
var DEFAULT_COLLECTION_POLLING_FREQUENCY = 5;       // 5 seconds
var DEFAULT_COLLECTION_BATCH_SIZE = 1000;
var DEFAULT_MAIL_POLLING_FREQUENCY = 600;           // 10 minutes (in seconds)
var DEFAULT_MAIL_DAILY_HOUR = 0;                    // Midnight
var DEFAULT_MAIL_WEEKLY_DAY = 5;                    // Friday
var DEFAULT_MAIL_WEEKLY_HOUR = 12;                  // Noon
var MINIMUM_MAIL_POLLING_FREQUENCY = 60;            // 1 minute
var MAXIMUM_MAIL_POLLING_FREQUENCY = 3600;          // 1 hour

var config = {};

/**
 * Refresh the activities configuration. For list of available properties @see ActivityAPI#refreshConfiguration.
 *
 * @param  {Object}    [config]    The configuration options with which to refresh. See the `config.activity` object in the base `./config.js` for more information
 */
var refreshConfiguration = module.exports.refreshConfiguration = function(_config) {
    _config = _config || {};
    _config.mail = _config.mail || {};
    _config.mail.daily = _config.mail.daily || {};
    _config.mail.weekly = _config.mail.weekly || {};

    // Ensure that the mail polling frequence is set to a sane value and complain if it is not
    if (_config.mail.pollingFrequency < MINIMUM_MAIL_POLLING_FREQUENCY || _config.mail.pollingFrequency > MAXIMUM_MAIL_POLLING_FREQUENCY) {
        var msg = util.format('The activity-mail-polling frequency cannot be higher than an hour or lower than a minute, it will be defaulted to %d seconds', DEFAULT_MAIL_POLLING_FREQUENCY);
        log().warn(msg);

        // Default the value here as OaeUtil.getNumberParam uses the minimum (or maximum) when an incorrect value is given
        _config.mail.pollingFrequency = DEFAULT_MAIL_POLLING_FREQUENCY;
    }

    config = {
        'processActivityJobs': (_config.processActivityJobs !== false),
        'activityTtl': OaeUtil.getNumberParam(_config.activityTtl, DEFAULT_ACTIVITY_TTL),
        'numberOfProcessingBuckets': OaeUtil.getNumberParam(_config.numberOfProcessingBuckets, DEFAULT_NUMBER_OF_PROCESSING_BUCKETS),
        'aggregateIdleExpiry': OaeUtil.getNumberParam(_config.aggregateIdleExpiry, DEFAULT_AGGREGATE_IDLE_EXPIRY),
        'aggregateMaxExpiry': OaeUtil.getNumberParam(_config.aggregateMaxExpiry, DEFAULT_AGGREGATE_MAX_EXPIRY),
        'collectionExpiry': OaeUtil.getNumberParam(_config.collectionExpiry, DEFAULT_COLLECTION_EXPIRY),
        'maxConcurrentCollections': OaeUtil.getNumberParam(_config.maxConcurrentCollections, DEFAULT_MAX_CONCURRENT_COLLECTIONS),
        'maxConcurrentRouters': OaeUtil.getNumberParam(_config.maxConcurrentRouters, DEFAULT_MAX_CONCURRENT_ROUTERS),
        'collectionPollingFrequency': OaeUtil.getNumberParam(_config.collectionPollingFrequency, DEFAULT_COLLECTION_POLLING_FREQUENCY),
        'collectionBatchSize': OaeUtil.getNumberParam(_config.collectionBatchSize, DEFAULT_COLLECTION_BATCH_SIZE),
        'mail': {
            'pollingFrequency': OaeUtil.getNumberParam(_config.mail.pollingFrequency, DEFAULT_MAIL_POLLING_FREQUENCY, MINIMUM_MAIL_POLLING_FREQUENCY, MAXIMUM_MAIL_POLLING_FREQUENCY),
            'daily': {
                'hour': OaeUtil.getNumberParam(_config.mail.daily.hour, DEFAULT_MAIL_DAILY_HOUR)
            },
            'weekly': {
                'day': OaeUtil.getNumberParam(_config.mail.weekly.day, DEFAULT_MAIL_WEEKLY_DAY),
                'hour': OaeUtil.getNumberParam(_config.mail.weekly.hour, DEFAULT_MAIL_WEEKLY_HOUR)
            }
        },
        'redis': (_config.redis) ? _.extend({}, _config.redis) : null
    };

    return getConfig();
};

/**
 * @return {Object} the activities configuration.
 */
var getConfig = module.exports.getConfig = function() {
    return config;
};

