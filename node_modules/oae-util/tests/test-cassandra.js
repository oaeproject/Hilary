/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 * 
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');
var Cassandra = require('oae-util/lib/cassandra');

describe('Utilities', function() {
    describe('Cassandra', function() {

        it('should be able to create, check and drop keyspaces.', function(callback) {
            var keyspace = "keyspacetest" + Math.floor(Math.random()*100000000);
            Cassandra.createKeyspace(keyspace, function(err, created) {
                assert.ok(!err);
                assert.ok(created);

                Cassandra.keyspaceExists(keyspace, function(err, exists) {
                    assert.ok(!err);
                    assert.ok(exists);

                    Cassandra.dropKeyspace(keyspace, function(err, dropped) {
                        assert.ok(!err);
                        assert.ok(dropped);
                        callback();
                    });
                });
            });
        });

        it('should be able to create, check and drop column families.', function(callback) {
            var name = "cf" + Math.floor(Math.random()*10000000);
            Cassandra.createColumnFamily(name, "create table " + name + " (key_id text primary key)", function(err, created) {
                assert.ok(!err);
                assert.ok(created);

                 // Check if it exists.
                Cassandra.columnFamilyExists(name, function(err, exists) {
                    assert.ok(!err);
                    assert.ok(exists);

                    // Drop it.
                    Cassandra.dropColumnFamily(name, function(err, dropped) {
                        assert.ok(!err);
                        assert.ok(dropped);

                        // Make sure it's gone.
                        Cassandra.columnFamilyExists(name, function(err, exists) {
                            assert.ok(!err);
                            assert.ok(!exists);

                            callback();
                        });
                    });
                });
            })
        });

        it('should be able to create, check and drop multiple columnfamilies at once.', function(callback) {
            var name1 = 'cf' + Math.floor(Math.random()*10000000);
            var name2 = 'cf' + Math.floor(Math.random()*10000000);

            Cassandra.createColumnFamilies({
                name1: 'create table ' + name1 + ' (key_id text primary key)',
                name2: 'create table ' + name2 + ' (key_id text primary key)'
            }, function(err) {
                assert.ok(!err);
                // Check if it exists.
                Cassandra.columnFamilyExists(name1, function(err, exists) {
                    assert.ok(!err);
                    assert.ok(exists);
                    Cassandra.columnFamilyExists(name2, function(err, exists) {
                        assert.ok(!err);
                        assert.ok(exists);
                        // Remove them
                        Cassandra.dropColumnFamilies([name1, name2], function(err){
                            assert.ok(!err);
                            // Check if they still exist
                            Cassandra.columnFamilyExists(name1, function(err, exists) {
                                assert.ok(!err);
                                assert.ok(!exists);
                                Cassandra.columnFamilyExists(name2, function(err, exists) {
                                    assert.ok(!err);
                                    assert.ok(!exists);
                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });
        
        it('should be able to handlenull and undefined values.', function(callback) {
            // Create a CF first
            Cassandra.createColumnFamily('testQuery', "create table testQuery (key_id text primary key)", function(err, created) {
                assert.ok(!err);
                assert.ok(created);
                // Check if the CF exists
                Cassandra.columnFamilyExists('testQuery', function(err, exists) {
                    assert.ok(!err);
                    assert.ok(exists);
                    // Try to run a simple insert
                    Cassandra.runQuery('INSERT INTO testQuery (key_id, c1, c2) VALUES (?, ?, ?)', ['key1', 'value1', 'value2'], function (err) {
                        assert.ok(!err);
                        // Try to run an invalid insert
                        Cassandra.runQuery('INSERT INTO testQuery (key_id, c1, c2) VALUES (?, ?, ?)', ['key2', 'value', null], function (err) {
                            assert.ok(err);
                            // Try to run a simple select
                            Cassandra.runQuery('SELECT * FROM testQuery WHERE key_id = ?', ['key1'], function (err, rows) {
                                assert.ok(!err);
                                assert.equal(rows.rowCount(), 1);
                                // Try to run an invalid select
                                Cassandra.runQuery('SELECT * FROM testQuery WHERE key_id = ?', [null], function (err, rows) {
                                    assert.ok(err);
                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});