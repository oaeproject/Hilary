/*
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');

var PrincipalsDAO = require('oae-principals/lib/internal/dao');
var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');

describe('Principals DAO', function() {

    // Rest contexts that will be used for requests
    var anonymousRestContext = null;
    var camAdminRestContext = null;

    /**
     * Function that will fill up the anonymous and tenant admin REST context
     */
    before(function(callback) {
        anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);

        // Log in the tenant admin so their cookie jar is set up appropriately
        RestAPI.User.getMe(camAdminRestContext, function(err, meObj) {
            assert.ok(!err);
            callback();
        });
    });

    describe('#updatePrincipal', function() {

        /**
         * Test that verifies that restricted fields (i.e., admin:global and admin:tenant) cannot be set through
         * updatePrincipal.
         */
        it('verifies updatePrincipal does not allow setting of restricted fields', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users) {
                assert.ok(!err);
                var mrvisser = _.values(users)[0].user;

                // Sanity check valid update first
                PrincipalsDAO.updatePrincipal(mrvisser.id, {'publicAlias': 'haha'}, function(err) {
                    assert.ok(!err);

                    PrincipalsDAO.getPrincipal(mrvisser.id, function(err, mrvisserRaw) {
                        assert.ok(!err);
                        assert.equal(mrvisserRaw.publicAlias, 'haha');

                        PrincipalsDAO.updatePrincipal(mrvisser.id, {'admin:tenant': true}, function(err) {
                            assert.ok(err);
                            assert.equal(err.code, 400);
                            assert.equal(err.msg, 'Attempted to update an invalid property');

                            PrincipalsDAO.updatePrincipal(mrvisser.id, {'admin:global': true}, function(err) {
                                assert.ok(err);
                                assert.equal(err.code, 400);
                                assert.equal(err.msg, 'Attempted to update an invalid property');

                                PrincipalsDAO.updatePrincipal(mrvisser.id, {'admin:tenant': true, 'admin:global': true}, function(err) {
                                    assert.ok(err);
                                    assert.equal(err.code, 400);
                                    assert.equal(err.msg, 'Attempted to update an invalid property');

                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('#iterateAll', function() {

        /**
         * Test that verifies the iterateAll functionality of the principal DAO
         */
        it('verify PrincipalsDAO iterateAll functionality', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users) {
                assert.ok(!err);

                var mrvisser = users[_.keys(users)[0]].user;
                var mrvisserRestCtx = users[_.keys(users)[0]].restContext;
                var foundUser = false;

                /*!
                 * Verifies that each principal row only has the principalId
                 */
                var _onEach = function(principalRows, done) {
                    // Ensure we only get the principalId of the users
                    _.each(principalRows, function(principalRow) {
                        assert.equal(_.keys(principalRow).length, 1, 'Expected to have only one key on the principal row, the principal id');
                        assert.ok(principalRow.principalId, 'Expected the row to have principalId');

                        // Remember whether or not we found the principal
                        if (principalRow.principalId === mrvisser.id) {
                            foundUser = true;
                        }
                    });

                    done();
                };

                // Ensure that passing in `null` will result in only the principalId being returned from the principal rows
                PrincipalsDAO.iterateAll(null, 100, _onEach, function(err) {
                    assert.ok(!err, JSON.stringify(err, null, 4));
                    assert.ok(foundUser, 'Expected to find the user we just created');

                    foundUser = false;

                    /*!
                     * Verifies that we only get the principalId and displayName of each principalRow
                     */
                    var _onEach = function(principalRows, done) {
                        // Ensure we only get the principalId and displayName of the principal
                        _.each(principalRows, function(principalRow) {
                            assert.equal(_.keys(principalRow).length, 2, 'Expected to have only two keys on the principal row, the principal id and displayName');
                            assert.ok(principalRow.principalId, 'Expected the row to have principalId');

                            // Remember whether or not we found the user
                            if (principalRow.principalId === mrvisser.id) {
                                // Verify the displayName is accurate
                                assert.equal(principalRow.displayName, mrvisser.displayName);
                                foundUser = true;
                            }
                        });

                        done();
                    };

                    // Do the same thing but fetch the principalId and the displayName, and ensure they match
                    PrincipalsDAO.iterateAll(['principalId', 'displayName'], 100, _onEach, function(err) {
                        assert.ok(!err, JSON.stringify(err, null, 4));
                        assert.ok(foundUser, 'Expected to find the user we just created');
                        callback();
                    });
                });
            });
        });
    });
});
