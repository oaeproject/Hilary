/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var OAE = require('oae-util/lib/oae');

var StatsAPI = require('./api');

/*!
 * Convenience method to get all the statistics for a certain tenant. The tenant
 * is determined by checking the request parameters first. If no tenant is found, it
 * is defaulted to the tenant the request was made on.
 *
 * @param  {Request}    req     The ExpressJS request object
 * @param  {Response}   res     The ExpressJS response object
 * @api private
 */
var _handleGetAllStats = function(req, res) {
    var tenantAlias = req.params.tenantAlias || req.ctx.tenant().alias;

    StatsAPI.getAllStatistics(req.ctx, tenantAlias, function(err, stats) {
        if (err) {
            return res.send(err.code, err.msg);
        }

        res.send(200, {'items': stats});
    });
};

/*!
 * Convenience method to get a specific statistic for a certain tenant. The tenant
 * is determined by checking the request parameters first. If no tenant is found, it
 * is defaulted to the tenant the request was made on.
 *
 * @param  {Request}    req     The ExpressJS request object
 * @param  {Response}   res     The ExpressJS response object
 * @api private
 */
var _handleGetStatistic = function(req, res) {
    var tenantAlias = req.params.tenantAlias || req.ctx.tenant().alias;
    var name = req.params.name;

    StatsAPI.getStatistic(req.ctx, tenantAlias, name, function(err, value) {
        if (err) {
            return res.send(err.code, err.msg);
        }

        res.send(200, {
            'name': name,
            'value': value
        });
    });
};


/*!
 * Get configuration schemas for the global admin tenant and user tenants
 */
OAE.globalAdminRouter.on('get', '/api/stats/:tenantAlias', _handleGetAllStats);
OAE.tenantRouter.on('get', '/api/stats', _handleGetAllStats);

/*!
 * Get configuration schemas for the global admin tenant and user tenants
 */
OAE.globalAdminRouter.on('get', '/api/stats/:tenantAlias/:name', _handleGetStatistic);
OAE.tenantRouter.on('get', '/api/stats/:name', _handleGetStatistic);

