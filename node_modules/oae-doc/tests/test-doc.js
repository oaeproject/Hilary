/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * visibilitys and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');

var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');


describe('Docs', function() {

    // Rest context that can be used every time we need to make a request as an anonymous user
    var anonymousCamRestContext = null;

    /**
     * Function that will fill up the global admin, tenant admin and anymous rest context
     */
    before(function(callback) {
        // Fill up the anonymous cam rest context
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        callback();
    });


    describe('Get modules', function() {

        /**
         * Test that verifies that it is possible to get a list of all of the available modules
         */
        it('verify get modules', function(callback) {
            // Get the back-end modules
            RestAPI.Doc.getModules(anonymousCamRestContext, 'backend', function(err, backendModules) {
                assert.ok(!err);
                assert.ok(backendModules);
                assert.notEqual(backendModules.indexOf('oae-doc'), -1);

                // Get the front-end modules
                RestAPI.Doc.getModules(anonymousCamRestContext, 'frontend', function(err, frontendModules) {
                    assert.ok(!err);
                    assert.ok(frontendModules);
                    assert.notEqual(_.indexOf(frontendModules, 'oae.api.util.js'), -1);
                    // We want to exclude oae.core.js
                    assert.equal(_.indexOf(frontendModules, 'oae.core.js'), -1);
                    callback();
                });
            });
        });

        /**
         * Test that verifies that validation is done appropriately
         */
        it('verify validation', function(callback) {
            RestAPI.Doc.getModules(anonymousCamRestContext, 'invalid module type', function(err, modules) {
                assert.equal(err.code, 400);
                assert.ok(!modules);

                return callback();
            });
        });
    });


    describe('Get module documentation', function() {

        /**
         * Test that verifies that the JSDocs for an existing module can be retrieved
         */
        it('verify get module documentation', function(callback) {
            // Get the documentation for a back-end module
            RestAPI.Doc.getModuleDocumentation(anonymousCamRestContext, 'backend', 'oae-doc', function(err, docs) {
                assert.ok(!err);
                assert.ok(docs);
                assert.ok(_.keys(docs).length);
                assert.ok(_.keys(docs['api.js']).length);

                // Get the documentation for a front-end module
                RestAPI.Doc.getModuleDocumentation(anonymousCamRestContext, 'frontend', 'oae.api.util.js', function(err, docs) {
                    assert.ok(!err);
                    assert.ok(docs);
                    assert.ok(docs.length);
                    callback();
                });
            });
        });

        /**
         * Test that verifies that validation is done appropriately
         */
        it('verify validation', function(callback) {
            // Get non-existing back-end module
            RestAPI.Doc.getModuleDocumentation(anonymousCamRestContext, 'backend', 'oae-non-existing', function(err, docs) {
                assert.equal(err.code, 404);
                assert.ok(!docs);
                // Get non-existing back-end module
                RestAPI.Doc.getModuleDocumentation(anonymousCamRestContext, 'backend', 'oae.api.nonexisting', function(err, docs) {
                    assert.equal(err.code, 404);
                    assert.ok(!docs);

                    // Get non-OAE back-end module
                    RestAPI.Doc.getModuleDocumentation(anonymousCamRestContext, 'backend', 'helenus', function(err, docs) {
                        assert.equal(err.code, 404);
                        assert.ok(!docs);
                        // Get non-OAE front-end module
                        RestAPI.Doc.getModuleDocumentation(anonymousCamRestContext, 'frontend', 'test', function(err, docs) {
                            assert.equal(err.code, 404);
                            assert.ok(!docs);

                            // Get an invalid module type
                            RestAPI.Doc.getModuleDocumentation(anonymousCamRestContext, 'invalid module type', 'oae.api.util.js', function(err, docs) {
                                assert.equal(err.code, 400);
                                assert.ok(!docs);

                                return callback();
                            });
                        });
                    });
                });
            });
        });
    });
});
