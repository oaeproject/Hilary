/*
 * Copyright 2015 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');

var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');

describe('Authentication', function() {

    // Rest context that can be used for anonymous requests on the cambridge tenant
    var anonymousCamRestContext = null;
    // Rest context that can be used for anonymous requests on the global admin tenant
    var anonymousGlobalRestContext = null;
    // Rest context that can be used every time we need to make a request as a tenant admin
    var camAdminRestContext = null;
    // Rest context that can be used every time we need to make a request as a tenant admin
    var gtAdminRestContext = null;
    // Rest context that can be used every time we need to make a request as a global admin
    var globalAdminRestContext = null;

    /**
     * Function that will fill up the tenant admin and anymous rest context
     */
    before(function(callback) {
        // Prepare the contexts with which we'll perform requests
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        anonymousGlobalRestContext = TestsUtil.createGlobalRestContext();
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        gtAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();

        return callback();
    });

    /**
     * Test that verifies that a user's login ids can be requested
     */
    it('verify that only authorized admins can request a user\'s login ids', function(callback) {
        // Generate a user id
        var username = TestsUtil.generateTestUserId();
        var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);

        // Verify that an error is thrown when a malformed id was specified
        RestAPI.Authentication.getUserLoginIds(globalAdminRestContext, 'not an id', function(err, loginIds) {
            assert.ok(err);
            assert.strictEqual(err.code, 400);

            // Verify that an error is thrown when a non-user id is specified
            RestAPI.Authentication.getUserLoginIds(globalAdminRestContext, 'g:not:a-user-id', function(err, loginIds) {
                assert.ok(err);
                assert.strictEqual(err.code, 400);

                // Verify that an error is thrown when an unexisting user id was specified
                RestAPI.Authentication.getUserLoginIds(globalAdminRestContext, 'u:camtest:abcdefghij', function(err, loginIds) {
                    assert.ok(err);
                    assert.strictEqual(err.code, 404);

                    // Create a test user
                    RestAPI.User.createUser(camAdminRestContext, username, 'password', 'Test User', email, null, function(err, createdUser) {
                        assert.ok(!err);

                        // Verify that an error is thrown when an anonymous user on the global admin router requests the login ids for the test user
                        RestAPI.Authentication.getUserLoginIds(anonymousGlobalRestContext, createdUser.id, function(err, loginIds) {
                            assert.ok(err);
                            assert.strictEqual(err.code, 401);

                            // Verify that an error is thrown when an anonymous user on the tenant router requests the login ids for the test user
                            RestAPI.Authentication.getUserLoginIds(anonymousCamRestContext, createdUser.id, function(err, loginIds) {
                                assert.ok(err);
                                assert.strictEqual(err.code, 401);

                                // Verify that an error is thrown when an unauthorized tenant admin requests the login ids for the test user
                                RestAPI.Authentication.getUserLoginIds(gtAdminRestContext, createdUser.id, function(err, loginIds) {
                                    assert.ok(err);
                                    assert.strictEqual(err.code, 401);

                                    // Verify that a tenant admin can request the login ids for the test user
                                    RestAPI.Authentication.getUserLoginIds(camAdminRestContext, createdUser.id, function(err, loginIds) {
                                        assert.ok(!err);
                                        assert.ok(loginIds);

                                        // Verify that a global admin can request the login ids for the test user
                                        RestAPI.Authentication.getUserLoginIds(globalAdminRestContext, createdUser.id, function(err, loginIds) {
                                            assert.ok(!err);
                                            assert.ok(loginIds);

                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    /**
     * Verify that a user's login ids can be successfully returned
     */
    it('verify that a user\'s login ids can be successfully returned', function(callback) {
        // Generate a user id
        var username = TestsUtil.generateTestUserId();
        var email = TestsUtil.generateTestEmailAddress(null, global.oaeTests.tenants.cam.emailDomains[0]);

        // Create a test user
        RestAPI.User.createUser(camAdminRestContext, username, 'password', 'Test User', email, null, function(err, createdUser) {
            assert.ok(!err);

            // Verify that a global admin can request the login ids for the test user
            RestAPI.Authentication.getUserLoginIds(globalAdminRestContext, createdUser.id, function(err, loginIds) {
                assert.ok(!err);
                assert.ok(loginIds);
                assert.ok(loginIds.local);
                assert.strictEqual(loginIds.local, username.toLowerCase());

                return callback();
            });
        });
    });
});
