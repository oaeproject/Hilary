/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var util = require('util');

var ConfigTestUtil = require('oae-config/lib/test/util');
var RestAPI = require('oae-rest');
var SearchTestsUtil = require('oae-search/lib/test/util');
var TestsUtil = require('oae-tests');

var FoldersAPI = require('oae-folders');
var FoldersConstants = require('oae-folders/lib/constants').FoldersConstants;
var FoldersDAO = require('oae-folders/lib/internal/dao');
var FoldersLibrary = require('oae-folders/lib/library');
var FoldersTestUtil = require('oae-folders/lib/test/util');

describe('Folders', function() {

    var camAdminRestContext = null;
    var camAnonymousRestContext = null;
    var globalAdminRestContext = null;
    var gtAdminRestContext = null;
    var gtAnonymousRestContext = null;

    /*!
     * Set up all the REST contexts for admin and anonymous users with which we
     * will invoke requests
     */
    before(function(callback) {
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        camAnonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
        gtAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        gtAnonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host);
        return callback();
    });

    /**
     * Set up some tenants, users and content. The created content
     * will be placed in a new folder with the given visibility.
     *
     * @param  {String}             visibility                  The visibility of the created folder
     * @param  {Function}           callback                    Standard callback function
     * @param  {Object}             callback.simong             A user object who created the folder and content items as returned by `TestsUtil.generateTestUsers`
     * @param  {Folder}             callback.folder             The created folder
     * @param  {Content}            callback.publicContent      A public content item
     * @param  {Content}            callback.loggedinContent    A loggedin content item
     * @param  {Content}            callback.privateContent     A private content item
     * @param  {Tenant}             callback.publicTenant1      Tenant object as returned by `foldersTestUtil.setupMultiTenantPrivacyEntities`
     * @param  {Tenant}             callback.publicTenant2      Tenant object as returned by `foldersTestUtil.setupMultiTenantPrivacyEntities`
     * @param  {Tenant}             callback.privateTenant      Tenant object as returned by `foldersTestUtil.setupMultiTenantPrivacyEntities`
     * @param  {Tenant}             callback.privateTenant1     Tenant object as returned by `foldersTestUtil.setupMultiTenantPrivacyEntities`
     * @param  {Object}             callback.user               A user as returned by `TestsUtil.generateTestUsers` who will create the folder
     * @throws {AssertionError}                                 Throws an error if anything unexpected happens when setting up the entities
     */
    var _setup = function(visibility, callback) {
        FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant1, publicTenant2, privateTenant, privateTenant1) {

            // Create a test user who will generate a test folder
            TestsUtil.generateTestUsers(publicTenant1.adminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, visibility, function(folder) {

                    // Create 3 content items
                    RestAPI.Content.createLink(simong.restContext, 'public', 'public', 'public', 'http://www.google.com', null, [], [], function(err, publicContent) {
                        assert.ok(!err);
                        RestAPI.Content.createLink(simong.restContext, 'loggedin', 'loggedin', 'loggedin', 'http://www.google.com', null, [], [], function(err, loggedinContent) {
                            assert.ok(!err);
                            RestAPI.Content.createLink(simong.restContext, 'private', 'private', 'private', 'http://www.google.com', null, [], [], function(err, privateContent) {
                                assert.ok(!err);

                                // Add them to the folder
                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, [publicContent.id, loggedinContent.id, privateContent.id], function() {

                                    return callback(simong, folder, publicContent, loggedinContent, privateContent, publicTenant1, publicTenant2, privateTenant, privateTenant1);
                                });
                            });
                        });
                    });
                });
            });
        });
    };

    describe('Searching in folders', function() {

        /**
         * Test that verifies that folders can be searched through
         */
        it('verify folders are searchable', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Generate 2 test folders
                FoldersTestUtil.generateTestFolders(simong.restContext, 2, function(folder1, folder2) {

                    // Both folders should be empty
                    FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder1.id, null, [], function() {
                        FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder2.id, null, [], function() {

                            // Create some content items and add them to the first folder
                            RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.com', null, [], [], function(err, google) {
                                assert.ok(!err);
                                RestAPI.Content.createLink(camAdminRestContext, 'marsupilamisausage', 'marsupilamisausage', 'public', 'http://www.marsupilamisausage.com', null, [], [], function(err, mars) {
                                    assert.ok(!err);
                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder1.id, [google.id, mars.id], function() {

                                        // Searching through the first folder should give the
                                        // first 2 links. The other folder should still be empty
                                        FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder1.id, null, [google, mars], function() {
                                            FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder2.id, null, [], function() {

                                                // Assert that folders can be searched through
                                                FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder1.id, 'marsupilamisausage', [mars], function() {
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that all users can search public folders
         */
        it('verify public folder', function(callback) {
            _setup('public', function(simong, folder, publicContent, loggedinContent, privateContent, publicTenant1, publicTenant2, privateTenant, privateTenant1) {

                // Anonymous users only see the public content
                FoldersTestUtil.assertFolderSearchEquals(publicTenant1.anonymousRestContext, folder.id, null, [publicContent], function() {

                    // A user from another tenant only sees the public content
                    FoldersTestUtil.assertFolderSearchEquals(publicTenant2.publicUser.restContext, folder.id, null, [publicContent], function() {

                        // A user from the same tenant sees both public and loggedin content
                        FoldersTestUtil.assertFolderSearchEquals(publicTenant1.publicUser.restContext, folder.id, null, [publicContent, loggedinContent], function() {

                            // A tenant admin sees everything
                            FoldersTestUtil.assertFolderSearchEquals(publicTenant1.adminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                // A tenant admin from another tenant only sees the public content
                                FoldersTestUtil.assertFolderSearchEquals(publicTenant2.adminRestContext, folder.id, null, [publicContent], function() {

                                    // A manager sees everything
                                    FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                        // A global admin sees everything
                                        FoldersTestUtil.assertFolderSearchEquals(globalAdminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies anonymous and cross-tenant users cannot search loggedin folders
         */
        it('verify loggedin folder', function(callback) {
            _setup('loggedin', function(simong, folder, publicContent, loggedinContent, privateContent, publicTenant1, publicTenant2, privateTenant, privateTenant1) {

                // Anonymous users cannot search this folder
                FoldersTestUtil.assertFolderSearchFails(publicTenant1.anonymousRestContext, folder.id, 401, function() {

                    // A user from another tenant cannot search this folder
                    FoldersTestUtil.assertFolderSearchFails(publicTenant2.publicUser.restContext, folder.id, 401, function() {

                        // A user from the same tenant sees both public and loggedin content
                        FoldersTestUtil.assertFolderSearchEquals(publicTenant1.publicUser.restContext, folder.id, null, [publicContent, loggedinContent], function() {

                            // A tenant admin sees everything
                            FoldersTestUtil.assertFolderSearchEquals(publicTenant1.adminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                // A tenant admin from another tenant cannot search in this folder
                                FoldersTestUtil.assertFolderSearchFails(publicTenant2.adminRestContext, folder.id, 401, function() {

                                    // A manager sees everything
                                    FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                        // A global admin sees everything
                                        FoldersTestUtil.assertFolderSearchEquals(globalAdminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies only admin and the user themselves can search private folders
         */
        it('verify private folder', function(callback) {
            _setup('private', function(simong, folder, publicContent, loggedinContent, privateContent, publicTenant1, publicTenant2, privateTenant, privateTenant1) {

                // Anonymous users cannot search this folder
                FoldersTestUtil.assertFolderSearchFails(publicTenant1.anonymousRestContext, folder.id, 401, function() {

                    // A user from another tenant cannot search this folder
                    FoldersTestUtil.assertFolderSearchFails(publicTenant2.publicUser.restContext, folder.id, 401, function() {

                        // A user from the same tenant cannot search this folder
                        FoldersTestUtil.assertFolderSearchFails(publicTenant1.publicUser.restContext, folder.id, 401, function() {

                            // A tenant admin sees everything
                            FoldersTestUtil.assertFolderSearchEquals(publicTenant1.adminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                // A tenant admin from another tenant cannot search in this folder
                                FoldersTestUtil.assertFolderSearchFails(publicTenant2.adminRestContext, folder.id, 401, function() {

                                    // A manager sees everything
                                    FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                        // A global admin sees everything
                                        FoldersTestUtil.assertFolderSearchEquals(globalAdminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Searching for folders', function() {

        /**
         * Test that verifies that folders can be searched
         */
        it('verify folders can be searched for', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Setup a folder
                RestAPI.Folders.createFolder(simong.restContext, 'aaaaaa', null, null, null, null, function(err, folderA) {
                    assert.ok(!err);
                    RestAPI.Folders.createFolder(simong.restContext, 'bbbbbb', null, null, null, null, function(err, folderB) {
                        assert.ok(!err);

                        // Search for it
                        FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, null, [folderA, folderB], [], function() {

                            // Search on the display name
                            FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, folderA.displayName, [folderA], [folderB], callback);
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that folder search results can contain a thumbnail
         */
        it('verify folder search results can contain a thumbnail', function(callback) {
            _setup('public', function(simong, folder, publicContent, loggedinContent, privateContent, publicTenant1, publicTenant2, privateTenant, privateTenant1) {

                // Mock some previews on the folder
                FoldersDAO.setPreviews(folder, {'thumbnailUri': 'local:f/cam/bla/thumbnail.png', 'wideUri': 'local:f/cam/bla/wideUri'}, function(err, folder) {
                    assert.ok(!err);

                    FoldersAPI.emit(FoldersConstants.events.UPDATED_FOLDER_PREVIEWS, folder);

                    // When we search for the folder it should contain our thumbnail
                    FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, null, [folder], [], function() {

                        // When we remove the thumbnail, it should be removed from the search result
                        FoldersDAO.setPreviews(folder, {}, function(err, folder) {
                            assert.ok(!err);

                            FoldersAPI.emit(FoldersConstants.events.UPDATED_FOLDER_PREVIEWS, folder);

                            // When we search for the folder it should contain our thumbnail
                            FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, null, [folder], [], callback);
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that the visibility of folders is taken into account when searching for folders
         */
        it('verify folder visibility is taken into account', function(callback) {
            _setup('public', function(simong, folder, publicContent, loggedinContent, privateContent, publicTenant1, publicTenant2, privateTenant, privateTenant1) {

                // Setup a public, loggedin and private folder
                FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant1.publicUser.restContext, 1, 'public', function(publicFolder) {
                    FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant1.publicUser.restContext, 1, 'loggedin', function(loggedinFolder) {
                        FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant1.publicUser.restContext, 1, 'private', function(privateFolder) {

                            // Anonymous users can only see the public folder
                            FoldersTestUtil.assertGeneralFolderSearchEquals(publicTenant1.anonymousRestContext, 'disp', [publicFolder], [loggedinFolder, privateFolder], function() {
                                FoldersTestUtil.assertGeneralFolderSearchEquals(publicTenant2.anonymousRestContext, 'disp', [publicFolder], [loggedinFolder, privateFolder], function() {

                                    // Users from other tenants can only see the public folder
                                    FoldersTestUtil.assertGeneralFolderSearchEquals(publicTenant2.publicUser.restContext, 'disp', [publicFolder], [loggedinFolder, privateFolder], function() {

                                        // Authenticated users from the same tenant can see the public and logged in folders
                                        FoldersTestUtil.assertGeneralFolderSearchEquals(publicTenant1.privateUser.restContext, 'disp', [publicFolder, loggedinFolder], [privateFolder], function() {

                                            // Managers can see private folders they created. Keep in mind that
                                            // we need to search for some term as the endpoint would otherwise
                                            // only return implicit results (and not filtered by access)
                                            FoldersTestUtil.assertGeneralFolderSearchEquals(publicTenant1.publicUser.restContext, 'disp', [publicFolder, loggedinFolder, privateFolder], [], function() {

                                                // Tenant administrators can see everything
                                                FoldersTestUtil.assertGeneralFolderSearchEquals(publicTenant1.adminRestContext, 'disp', [publicFolder, loggedinFolder, privateFolder], [], function() {

                                                    // Tenant administrators from other tenants can only see public folders
                                                    FoldersTestUtil.assertGeneralFolderSearchEquals(publicTenant2.adminRestContext, 'disp', [publicFolder], [loggedinFolder, privateFolder], function() {

                                                        // Global administrators can see everything
                                                        FoldersTestUtil.assertGeneralFolderSearchEquals(globalAdminRestContext, 'disp', [publicFolder, loggedinFolder, privateFolder], [], callback);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies folders are searchable by their messages. Also verifies that
         * messages that are deleted no longer cause the folders to be returned in search
         */
        it('verify folders can be searched by messages', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                var searchTerm = TestsUtil.generateRandomText(5);

                // Create some folders we will test searching for
                FoldersTestUtil.generateTestFolders(simong.restContext, 20, function(folder1, folder2) {

                    // Verify that none of the folders return in the search results
                    FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, searchTerm, [], [folder1, folder2], function() {

                        // Create a message on the first folder
                        FoldersTestUtil.assertCreateMessageSucceeds(simong.restContext, folder1.id, searchTerm, null, function(message) {

                            // Verify that the first folder returns in the search result but not the second folder
                            FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, searchTerm, [folder1], [folder2], function() {

                                // Delete the message
                                FoldersTestUtil.assertDeleteMessageSucceeds(simong.restContext, folder1.id, message.created, function(message) {

                                    // Verify that none of the folders return in the search results
                                    FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, searchTerm, [], [folder1, folder2], callback);
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Searching for folders owned by a principal', function() {

        /**
         * Test that verifies only valid principal ids return results
         */
        it('verify the principal id gets validated', function(callback) {
            SearchTestsUtil.searchAll(camAdminRestContext, 'folder-library', [''], null, function(err, results) {
                assert.equal(err.code, 400);
                assert.ok(!results);

                SearchTestsUtil.searchAll(camAdminRestContext, 'folder-library', ['invalid-user-id'], null, function(err, results) {
                    assert.equal(err.code, 400);
                    assert.ok(!results);

                    return callback();
                });
            });
        });

        /**
         * Test that verifies that the visibility of folders is taken into account when searching for folders
         * in a principal's library
         */
        it('verify folder visibility is taken into account', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);
                TestsUtil.generateTestUsers(gtAdminRestContext, 1, function(err, users, stuartf) {
                    assert.ok(!err);

                    // Setup a public, loggedin and private folder
                    FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'public', function(publicFolder) {
                        FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'loggedin', function(loggedinFolder) {
                            FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'private', function(privateFolder) {

                                // Anonymous users can only see the public folder
                                FoldersTestUtil.assertFolderLibrarySearch(camAnonymousRestContext, simong.user.id, 'disp', [publicFolder], [loggedinFolder, privateFolder], function() {
                                    // Anonymous users from other tenants can only see the public folder
                                    FoldersTestUtil.assertFolderLibrarySearch(gtAnonymousRestContext, simong.user.id, 'disp', [publicFolder], [loggedinFolder, privateFolder], function() {
                                        // Users from other tenants can only see the public folder
                                        FoldersTestUtil.assertFolderLibrarySearch(stuartf.restContext, simong.user.id, 'disp', [publicFolder], [loggedinFolder, privateFolder], function() {

                                            // Authenticated users can only see the public and logged in folders
                                            FoldersTestUtil.assertFolderLibrarySearch(nico.restContext, simong.user.id, 'disp', [publicFolder, loggedinFolder], [privateFolder], function() {

                                                // Simong can see all folders as he created them. Keep in mind that
                                                // we need to search for some term as the endpoint would otherwise
                                                // only return implicit results (and not filtered by access)
                                                FoldersTestUtil.assertFolderLibrarySearch(simong.restContext, simong.user.id, 'disp', [publicFolder, loggedinFolder, privateFolder], [], function() {

                                                    // Tenant administrators can see everything
                                                    FoldersTestUtil.assertFolderLibrarySearch(camAdminRestContext, simong.user.id, 'disp', [publicFolder, loggedinFolder, privateFolder], [], function() {
                                                        // Tenant administrators from other tenants can only see the public folder
                                                        FoldersTestUtil.assertFolderLibrarySearch(gtAdminRestContext, simong.user.id, 'disp', [publicFolder], [loggedinFolder, privateFolder], callback);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Indexing', function() {

        /**
         * Test that verifies that folders can be reindexed
         */
        it('verify folders can be reindexed', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Setup a public folder with some content
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'public', function(folder) {

                    RestAPI.Content.createLink(simong.restContext, 'public', 'public', 'public', 'http://www.google.com', null, [], [], function(err, link) {
                        assert.ok(!err);

                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, [link.id], function() {

                            // Sanity-check that folder can be found in a general search
                            FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, 'disp', [folder], [], function() {

                                // Sanity-check we can search in the folder
                                FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [link], function() {

                                    // Delete all the things
                                    SearchTestsUtil.deleteAll(function() {

                                        // Check that we can no longer find the folder
                                        FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, 'disp', [], [folder], function() {

                                            // Sanity check that searching in the folder returns 0 results
                                            FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [], function() {

                                                // Reindex all the things
                                                SearchTestsUtil.reindexAll(globalAdminRestContext, function() {

                                                    // Check that we can now find the folder again
                                                    FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, 'disp', [folder], [], function() {

                                                        // Check that we can search in the folder again
                                                        FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [link], callback);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that updating a folder triggers a reindex for that folder
         */
        it('verify updating a folder triggers a reindex', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Setup a public folder
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'public', function(folder) {

                    // Sanity-check that it can be found
                    FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, 'disp', [folder], [], function() {

                        // Update the folder's name and visibility
                        var updates = {'displayName': 'New displayName', 'visibility': 'private'};
                        RestAPI.Folders.updateFolder(simong.restContext, folder.id, updates, function(err, updatedFolder) {
                            assert.ok(!err);

                            // Assert that the folder's metadata has changed
                            FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, 'display', [updatedFolder], [], callback);
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that updating a folder's visibility (and containing content) triggers updates in the search index
         */
        it('verify updating a folder\'s visibility affects the content that can be searched on', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);

                // Setup a public folder
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'public', function(folder) {

                    // Add some public content
                    RestAPI.Content.createLink(simong.restContext, 'displayName', 'description', 'public', 'http://www.google.com', null, [], [], function(err, link) {
                        assert.ok(!err);

                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, [link.id], function() {

                            // Sanity-check that the content item can be found by Nico
                            SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'content', 'q': 'displayName'}, function(err, results) {
                                assert.ok(!err);
                                assert.ok(_.findWhere(results.results, {'id': link.id}));

                                // Make the folder and all content in it private
                                var updates = {'visibility': 'private'};
                                RestAPI.Folders.updateFolder(simong.restContext, folder.id, updates, function(err, data) {
                                    assert.ok(!err);
                                    RestAPI.Folders.updateFolderContentVisibility(simong.restContext, folder.id, 'private', function(err, data) {
                                        assert.ok(!err);

                                        // Nico should no longer be able to see the content item
                                        SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'content', 'q': 'displayName'}, function(err, results) {
                                            assert.ok(!err);
                                            assert.ok(!_.findWhere(results.results, {'id': link.id}));

                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that updating a folder's members updates the index
         */
        it('verify updating a folder\'s members updates the index', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);

                // Setup a private folder
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'private', function(folder) {

                    // Sanity-check that the folder cannot be found by Nico
                    SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'folder', 'q': 'displayName'}, function(err, results) {
                        assert.ok(!err);
                        assert.ok(!_.findWhere(results.results, {'id': folder.id}));

                        // Make Nico a viewer
                        var memberUpdate = {};
                        memberUpdate[nico.user.id] = 'viewer';
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                            // Nico should now be able to search for the folder
                            SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'folder', 'q': 'displayName'}, function(err, results) {
                                assert.ok(!err);
                                assert.ok(_.findWhere(results.results, {'id': folder.id}));

                                // Make Nico a manager
                                memberUpdate[nico.user.id] = 'manager';
                                FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                                    // Nico should still be able to search for the folder
                                    SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'folder', 'q': 'displayName'}, function(err, results) {
                                        assert.ok(!err);
                                        assert.ok(_.findWhere(results.results, {'id': folder.id}));

                                        // Removing Nico's membership
                                        memberUpdate[nico.user.id] = false;
                                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                                            // Nico should no longer see the folder in the search results
                                            SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'folder', 'q': 'displayName'}, function(err, results) {
                                                assert.ok(!err);
                                                assert.ok(!_.findWhere(results.results, {'id': folder.id}));

                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that updating a folder's members updates those members their membership documents
         */
        it('verify updating a folder\'s members updates those members their membership documents', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);

                // Setup a private folder
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'private', function(folder) {

                    // Create a private content item
                    var uniqueString = TestsUtil.generateRandomText(5);
                    RestAPI.Content.createLink(simong.restContext, uniqueString, 'description', 'private', 'http://www.google.com', null, [], [], function(err, link) {
                        assert.ok(!err);

                        // Add the content item to the folder
                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, [link.id], function() {

                            // Sanity-check that the content item cannot be found by Nico
                            SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'content', 'q': uniqueString}, function(err, results) {
                                assert.ok(!err);
                                assert.ok(!_.findWhere(results.results, {'id': link.id}));

                                // Make Nico a viewer
                                var memberUpdate = {};
                                memberUpdate[nico.user.id] = 'viewer';
                                FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                                    // Nico should now be able to search for the content item
                                    SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'q': uniqueString, 'scope': '_network'}, function(err, results) {
                                        assert.ok(!err);
                                        assert.ok(_.findWhere(results.results, {'id': link.id}));

                                        // Make Nico a manager
                                        memberUpdate[nico.user.id] = 'manager';
                                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                                            // Nico should still be able to search for the content item
                                            SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'content', 'q': uniqueString}, function(err, results) {
                                                assert.ok(!err);
                                                assert.ok(_.findWhere(results.results, {'id': link.id}));

                                                // Removing Nico's membership
                                                memberUpdate[nico.user.id] = false;
                                                FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                                                    // Nico should no longer see the content item in the search results
                                                    SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'content', 'q': uniqueString}, function(err, results) {
                                                        assert.ok(!err);
                                                        assert.ok(!_.findWhere(results.results, {'id': link.id}));

                                                        return callback();
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that when a folder gets deleted it gets removed from the search index
         */
        it('verify deleting a folder removes it from the index', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Setup a public folder
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'public', function(folder) {

                    // Sanity-check that it can be found
                    FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, 'disp', [folder], [], function() {

                        // Delete the folder
                        FoldersTestUtil.assertDeleteFolderSucceeds(simong.restContext, folder.id, false, function() {

                            // Assert that the folder's metadata cannot be found
                            FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, 'disp', [], [folder], function() {

                                // Reindex everything
                                SearchTestsUtil.reindexAll(globalAdminRestContext, function() {

                                    // We still should not be able to find the folder
                                    FoldersTestUtil.assertGeneralFolderSearchEquals(simong.restContext, 'disp', [], [folder], callback);
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that users can find private content through search when its in a folder they are a member of
         */
        it('verify adding private content to a folder makes it searchable for the folder\'s members', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, simong, nico) {
                assert.ok(!err);

                // Setup a folder
                FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, 'private', function(folder) {

                    // Add some private content to the folder. We add it in two different ways
                    // to ensure that both mechanismes get properly indexed
                    RestAPI.Content.createLink(simong.restContext, 'private', 'private', 'private', 'http://www.google.com', null, [], [folder.id], function(err, link1) {
                        assert.ok(!err);

                        RestAPI.Content.createLink(simong.restContext, 'private', 'private', 'private', 'http://www.google.com', null, [], [], function(err, link2) {
                            assert.ok(!err);
                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, [link2.id], function() {

                                // Assert that Nico can't find the items through search yet
                                SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'content', 'q': 'private'}, function(err, results) {
                                    assert.ok(!err);
                                    assert.ok(!_.findWhere(results.results, {'id': link1.id}));
                                    assert.ok(!_.findWhere(results.results, {'id': link2.id}));

                                    // Make Nico a member
                                    var memberUpdate = {};
                                    memberUpdate[nico.user.id] = 'viewer';
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(simong.restContext, simong.restContext, folder.id, memberUpdate, function() {

                                        // Now Nico should be able to see the items
                                        SearchTestsUtil.searchAll(nico.restContext, 'general', null, {'resourceTypes': 'content', 'q': 'private'}, function(err, results) {
                                            assert.ok(!err);
                                            assert.ok(_.findWhere(results.results, {'id': link1.id}));
                                            assert.ok(_.findWhere(results.results, {'id': link2.id}));
                                            return callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
