/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
var assert = require('assert');
var fs = require('fs');

var log = require('oae-logger').logger('test-activity');
var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var TestsUtil = require('oae-tests');

describe('Content Activity', function() {

    // Rest context that can be used for anonymous requests on the cambridge tenant
    var anonymousCamRestContext = null;
    // Rest context that can be used every time we need to make a request as a tenant admin
    var camAdminRestContext = null;

    /**
     * Function that will fill up the tenant admin and anymous rest context
     */
    before(function(callback) {
        // Fill up the anonymous cam rest context
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        // Fill up global admin rest context
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        callback();
    });

    var _getActivity = function(activityStream, activityType, entityType, entityOaeId) {
        if (!activityStream || !activityStream.items) {
            return null;
        }

        for (var i = 0; i < activityStream.items.length; i++) {
            var activity = activityStream.items[i];
            if (activity['oae:activityType'] === activityType && activity[entityType] && activity[entityType]['oae:id'] === entityOaeId) {
                return activity;
            }
        }
        return null;
    };

    /**
     * @return {Stream}     A stream that points to sakaiger that can be uploaded.
     */
    var getFileStream = function() {
        var file = __dirname + '/data/sakaiger.png';
        return fs.createReadStream(file);
    };

    /**
     * @return {Stream}     A stream that points to the sakai logo that can be uploaded.
     */
    var getSakaiLogoStream = function() {
        var file = __dirname + '/data/sakai-logo.png';
        return fs.createReadStream(file);
    };


    describe('Routes', function() {

        /**
         * Test that verifies a content resource routes activities to its members when created, updated and shared
         */
        it('verify routing to content members', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            var janeUsername = TestsUtil.generateTestUserId('jane');
            var managerGroupAlias = TestsUtil.generateTestUserId('managerGroup');
            var viewerGroupAlias = TestsUtil.generateTestUserId('viewerGroup');
            var managerGroupMemberUsername = TestsUtil.generateTestUserId('managerGroupMember');

            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                RestAPI.User.createUser(camAdminRestContext, janeUsername, 'password', 'Jane', null, function(err, jane) {
                    assert.ok(!err);

                    RestAPI.User.createUser(camAdminRestContext, managerGroupMemberUsername, 'password', 'Jane', null, function(err, managerGroupMember) {
                        assert.ok(!err);

                        // Create the group that will be a viewer of the content
                        RestAPI.Group.createGroup(camAdminRestContext, viewerGroupAlias, viewerGroupAlias, viewerGroupAlias, 'public', 'no', [], [], function(err, viewerGroup) {
                            assert.ok(!err);

                            // Create a group that will be a manager of the content
                            RestAPI.Group.createGroup(camAdminRestContext, managerGroupAlias, managerGroupAlias, managerGroupAlias, 'public', 'no', [], [], function(err, managerGroup) {
                                assert.ok(!err);

                                // managerGroupMember should be a member of the manager group to verify indirect group member routing
                                var membership = {};
                                membership[managerGroupMember.id] = 'manager';
                                RestAPI.Group.setGroupMembers(camAdminRestContext, managerGroup.id, membership, function(err) {
                                    assert.ok(!err);
                                    
                                    // Create a content item with manager group and viewer group as members.
                                    RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [managerGroup.id], [viewerGroup.id], function(err, link) {
                                        assert.ok(!err);

                                        // Share the content item with jane
                                        RestAPI.Content.shareContent(jackCtx, link.contentId, [jane.id], function(err) {
                                            assert.ok(!err);

                                            // Update the content item
                                            RestAPI.Content.updateContent(jackCtx, link.contentId, {'description': 'Super awesome link'}, function(err) {
                                                assert.ok(!err);

                                                // Verify Jack got the create, share and update as he was the actor for all of them
                                                RestAPI.Activity.getActivityStream(jackCtx, jack.id, null, function(err, activityStream) {
                                                    assert.ok(!err);
                                                    assert.ok(_getActivity(activityStream, 'content-create', 'object', link.contentId));
                                                    assert.ok(_getActivity(activityStream, 'content-share', 'target', jane.id));
                                                    assert.ok(_getActivity(activityStream, 'content-update', 'object', link.contentId));
                                                    
                                                    // Verify the manager group received the create, share and update as they are a content member
                                                    RestAPI.Activity.getActivityStream(camAdminRestContext, managerGroup.id, null, function(err, activityStream) {
                                                        assert.ok(!err);
                                                        assert.ok(_getActivity(activityStream, 'content-create', 'object', link.contentId));
                                                        assert.ok(_getActivity(activityStream, 'content-share', 'target', jane.id));
                                                        assert.ok(_getActivity(activityStream, 'content-update', 'object', link.contentId));

                                                        // Verify the viewer group received only the create and update. only managers care about the sharing of the "object"
                                                        RestAPI.Activity.getActivityStream(camAdminRestContext, viewerGroup.id, null, function(err, activityStream) {
                                                            assert.ok(!err);
                                                            assert.ok(_getActivity(activityStream, 'content-create', 'object', link.contentId));
                                                            assert.ok(!_getActivity(activityStream, 'content-share', 'target', jane.id));
                                                            assert.ok(_getActivity(activityStream, 'content-update', 'object', link.contentId));

                                                            // Verify the manager group *member* got the same activities as the manager group, as they are a member
                                                            RestAPI.Activity.getActivityStream(camAdminRestContext, managerGroupMember.id, null, function(err, activityStream) {
                                                                assert.ok(!err);
                                                                assert.ok(_getActivity(activityStream, 'content-create', 'object', link.contentId));
                                                                assert.ok(_getActivity(activityStream, 'content-share', 'target', jane.id));
                                                                assert.ok(_getActivity(activityStream, 'content-update', 'object', link.contentId));
                                                                callback();
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies when a an activity is routed to a user that isn't in the routes of a private content item (e.g., content-share
         * when non-manager), the content item is still propagated to the route appropriately.
         */
        it('verify content propagation to non-route activity feeds', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);

                // Create a private content item
                RestAPI.Content.createLink(camAdminRestContext, 'Google', 'Google', 'private', 'http://www.google.ca', [], [], function(err, link) {
                    assert.ok(!err);

                    // Share the content item with Jack. Jack will get the activity in his feed because he is the target, but he will not be in
                    // the routes of the content item because he is not a manager. Despite this, we need to verify that Jack has the full content
                    // item propagated to him as he does have access to it.
                    RestAPI.Content.shareContent(camAdminRestContext, link.contentId, [jack.id], function(err) {
                        assert.ok(!err);

                        RestAPI.Activity.getActivityStream(camAdminRestContext, jack.id, null, function(err, activityStream) {
                            assert.ok(!err);
                            assert.ok(activityStream);
                            assert.equal(activityStream.items.length, 1);

                            // Ensure that the sensitive content info is available in jack's feed
                            var object = activityStream.items[0].object;
                            assert.equal(object['oae:visibility'], 'private');
                            assert.equal(object['oae:contentType'], 'link');
                            assert.equal(object['displayName'], 'Google');
                            callback();
                        });
                    });
                });
            });
        });
    });

    describe('Activity Entity Models', function() {

        /**
         * Test that verifies the properties of the content entity
         */
        it('verify the content entity model contains the correct content information', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Generate an activity with the content
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                    assert.ok(!err);

                    RestAPI.Activity.getActivityStream(jackCtx, jack.id, null, function(err, activityStream) {
                        assert.ok(!err);
                        assert.equal(activityStream.items[0].object['oae:visibility'], 'public');
                        assert.equal(activityStream.items[0].object['oae:contentType'], 'link');
                        assert.equal(activityStream.items[0].object['displayName'], 'Google');
                        assert.equal(activityStream.items[0].object['objectType'], 'content');
                        assert.equal(activityStream.items[0].object['oae:id'], link.contentId);
                        assert.ok(activityStream.items[0].object['url'].indexOf(link.contentId) !== -1);
                        assert.ok(activityStream.items[0].object['id'].indexOf(link.contentId) !== -1);
                        callback();
                    });
                });
            });
        });

        /**
         * Test that verifies the properties of a comment entity
         */
        it('verify the comment entity model contains the correct comment information', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Generate an activity with the content
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                    assert.ok(!err);

                    // Create 3 comments, including one reply. We want to make sure the context is properly aggregated in these comments as their activities are delivered.
                    RestAPI.Content.createComment(jackCtx, link.contentId, 'Comment A', null, function(err, commentA) {
                        assert.ok(!err);

                        RestAPI.Content.createComment(jackCtx, link.contentId, 'Comment B', null, function(err, commentB) {
                            assert.ok(!err);

                            RestAPI.Content.createComment(jackCtx, link.contentId, 'Reply Comment A', commentA.commentId, function(err, replyCommentA) {
                                assert.ok(!err);

                                RestAPI.Activity.getActivityStream(jackCtx, jack.id, null, function(err, activityStream) {
                                    assert.ok(!err);
                                    assert.ok(activityStream);

                                    // The first in the list (most recent) is the aggregated comment activity
                                    var activity = activityStream.items[0];
                                    var hadCommentA = false;
                                    var hadCommentB = false;
                                    var hadReplyCommentA = false;

                                    assert.ok(activity.object['oae:collection']);
                                    assert.equal(activity.object['oae:collection'].length, 3);

                                    /*!
                                     * Verifies the model of a comment and its context.
                                     *
                                     * @param   {ActivityEntity}    entity                      The comment entity to verify
                                     * @param   {Comment}           comment                     The comment with which to verify the entity
                                     * @param   {Comment}           [replyToComment]            Indicates the entity should have this comment as its oae:replyTo. If unspecified, the entity should have no parent.
                                     */
                                    var _validateComment = function(entity, comment, replyToComment) {
                                        assert.equal(entity['objectType'], 'content-comment');
                                        assert.equal(entity['content'], comment.body);
                                        assert.equal(entity['oae:id'], comment.commentId);
                                        assert.ok(entity['url'].indexOf(link.contentId) !== -1);
                                        assert.ok(entity['id'].indexOf('/comments/') !== -1);
                                        assert.ok(entity['id'].indexOf(comment.commentId) !== -1);
                                        assert.equal(entity['published'], comment.created);
                                        assert.equal(entity['oae:commentThreadKey'], comment.created);

                                        assert.ok(entity['author']);
                                        assert.ok(entity['author']['objectType'], 'user');
                                        assert.equal(entity['author']['oae:id'], comment.createdBy.id);

                                        if (replyToComment) {
                                            _validateComment(entity['oae:replyTo'], replyToComment);
                                        } else {
                                            assert.ok(!entity['oae:replyTo']);
                                        }
                                    };

                                    // Verify that the collection contains all comments, and their models are correct.
                                    activity.object['oae:collection'].forEach(function(entity) {
                                        if (entity.content === 'Comment A') {
                                            hadCommentA = true;

                                            // Ensures that comment A has correct data, and no parents
                                            _validateComment(entity, commentA);
                                        } else if (entity.content === 'Comment B') {
                                            hadCommentB = true;

                                            // Ensures that comment B has correct data, and no parents
                                            _validateComment(entity, commentB);
                                        } else if (entity.content === 'Reply Comment A') {
                                            hadReplyCommentA = true;

                                            // Verify that the reply to comment A has the right data and the parent (comment A)
                                            _validateComment(entity, replyCommentA, commentA);
                                        }
                                    });

                                    assert.ok(hadCommentA);
                                    assert.ok(hadCommentB);
                                    assert.ok(hadReplyCommentA);

                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Posting Activities', function() {

        /**
         * Test that verifies that a content-create and content-update activity are generated when a content item is created and updated.
         */
        it('verify content-create and content-update activities are posted when content is created and updated', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Generate an activity with the content
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                    assert.ok(!err);

                    RestAPI.Content.updateContent(jackCtx, link.contentId, {'description': 'Super awesome link'}, function(err) {
                        assert.ok(!err);

                        RestAPI.Activity.getActivityStream(jackCtx, jack.id, null, function(err, activityStream) {
                            assert.ok(!err);
                            var createActivity = _getActivity(activityStream, 'content-create', 'object', link.contentId);
                            var updateActivity = _getActivity(activityStream, 'content-update', 'object', link.contentId);
                            assert.ok(createActivity);
                            assert.equal(createActivity.verb, 'create');
                            assert.ok(updateActivity);
                            assert.equal(updateActivity.verb, 'update');
                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a content-share activity is generated when a content item is shared.
         */
        it('verify a content-share activity is generated when a content item is shared', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);

                RestAPI.Content.createLink(camAdminRestContext, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                    assert.ok(!err);

                    // Try and generate a share activity
                    RestAPI.Content.shareContent(camAdminRestContext, link.contentId, [jack.id], function(err) {
                        assert.ok(!err);

                        RestAPI.Activity.getActivityStream(camAdminRestContext, jack.id, null, function(err, activityStream) {
                            assert.ok(!err);
                            var shareActivity = _getActivity(activityStream, 'content-share', 'object', link.contentId);
                            assert.ok(shareActivity);
                            assert.equal(shareActivity.verb, 'share');
                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a content-revision activity is generated when a content item's body has been updated / uploaded.
         */
        it('verify a content-revision activity is generated when a content item\'s body has been updated', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create a revisable content item
                RestAPI.Content.createFile(jackCtx, 'Test Content 1', 'Test content description 1', 'private', getFileStream,  [], [], function(err, content) {
                    assert.ok(!err);
                    assert.ok(content);

                    // Create a new version
                    RestAPI.Content.updateFileBody(jackCtx, content.contentId, getSakaiLogoStream, function(err) {
                        assert.ok(!err);

                        // Verify the revision activity was created for jack
                        RestAPI.Activity.getActivityStream(camAdminRestContext, jack.id, null, function(err, activityStream) {
                            assert.ok(!err);
                            var revisionActivity = _getActivity(activityStream, 'content-revision', 'object', content.contentId);
                            assert.ok(revisionActivity);
                            assert.equal(revisionActivity.verb, 'update');

                            // Also verify that a content-update activity *doesn't* get generated. no one will want to see both a revision and a meta-data update
                            assert.ok(!_getActivity(activityStream, 'content-update', 'object', content.contentId));

                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a content-add-to-library activity is generated when a user adds a content item to their own library
         */
        it('verify a content-add-to-library activity is generated when a user adds a content item to their own library', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                RestAPI.Content.createLink(camAdminRestContext, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                    assert.ok(!err);

                    // Jack adds the content item to his own library
                    RestAPI.Content.shareContent(jackCtx, link.contentId, [jack.id], function(err) {
                        assert.ok(!err);

                        RestAPI.Activity.getActivityStream(camAdminRestContext, jack.id, null, function(err, activityStream) {
                            assert.ok(!err);
                            var addActivity = _getActivity(activityStream, 'content-add-to-library', 'object', link.contentId);
                            assert.ok(addActivity);
                            assert.equal(addActivity.verb, 'add');
                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a content-update-visibility activity is generated when a content's visibility is updated
         */
        it('verify a content-update-visibility activity is generated when a content\'s visibility is updated', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                RestAPI.Content.createLink(camAdminRestContext, 'Google', 'Google', 'public', 'http://www.google.ca', [], [jack.id], function(err, link) {
                    assert.ok(!err);

                    // Jack adds the content item to his own library
                    RestAPI.Content.updateContent(camAdminRestContext, link.contentId, {'visibility': 'private'}, function(err) {
                        assert.ok(!err);

                        RestAPI.Activity.getActivityStream(camAdminRestContext, jack.id, null, function(err, activityStream) {
                            assert.ok(!err);
                            var updateVisibilityActivity = _getActivity(activityStream, 'content-update-visibility', 'object', link.contentId);
                            assert.ok(updateVisibilityActivity);
                            assert.equal(updateVisibilityActivity.verb, 'update');
                            callback();
                        });
                    });
                });
            });
        });
    });

    describe('Activity Aggregation', function() {

        ////////////////////
        // CONTENT CREATE //
        ////////////////////

        /**
         * Test that verifies that when multiple content-create activities are done by the same actor, the content items get
         * aggregated into a collection.
         */
        it('verify content-create activities are pivoted by actor', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create a google link
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                    assert.ok(!err);

                    // Create a Yahoo link
                    RestAPI.Content.createLink(jackCtx, 'Yahoo!', 'Yahoo!', 'public', 'http://www.yahoo.ca', [], [], function(err, yahooLink) {
                        assert.ok(!err);

                        // Verify the activities were aggregated into one, pivoted by actor
                        RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                            assert.ok(!err);
                            assert.ok(activityStream);
                            assert.equal(activityStream.items.length, 1);

                            var aggregate = _getActivity(activityStream, 'content-create', 'actor', jack.id);
                            assert.ok(aggregate.object);
                            assert.ok(aggregate.object['oae:collection']);
                            assert.equal(aggregate.object['oae:collection'].length, 2);

                            if (aggregate.object['oae:collection'][0]['oae:id'] === googleLink.contentId && aggregate.object['oae:collection'][1]['oae:id'] === yahooLink.contentId) {
                                // Don't fail, we want one to be google and the other to be yahoo
                            } else if (aggregate.object['oae:collection'][0]['oae:id'] === yahooLink.contentId && aggregate.object['oae:collection'][1]['oae:id'] === googleLink.contentId) {
                                // Don't fail, we want one to be google and the other to be yahoo
                            } else {
                                assert.fail('Expected the collection of created content items to be one yahoo link and one google link.');
                            }

                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies when a content create activity is aggregated and re-delivered, the activity that it is replacing is
         * deleted properly
         */
        it('verify when a content-create activity is redelivered, it deletes the previous one', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create a google link
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                    assert.ok(!err);

                    // Force a collection of activities so that the individual activity is delivered
                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                        assert.ok(!err);
                        assert.ok(activityStream);
                        assert.ok(activityStream.items.length, 1);

                        // Create a Yahoo link
                        RestAPI.Content.createLink(jackCtx, 'Yahoo!', 'Yahoo!', 'public', 'http://www.yahoo.ca', [], [], function(err, yahooLink) {
                            assert.ok(!err);

                            // Collect again and ensure we still only have one activity
                            RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                assert.ok(!err);
                                assert.ok(activityStream);
                                assert.ok(activityStream.items.length, 1);

                                // Rinse and repeat once to ensure that the aggregates are removed properly as well
                                RestAPI.Content.createLink(jackCtx, 'Apereo!', 'Apereo!', 'public', 'http://www.apereo.org', [], [], function(err, apereoLink) {
                                    assert.ok(!err);

                                    // Collect again and ensure we still only have one activity
                                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                        assert.ok(!err);
                                        assert.ok(activityStream);
                                        assert.ok(activityStream.items.length, 1);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });


        ////////////////////
        // CONTENT UPDATE //
        ////////////////////

        /**
         * Test that verifies when a content item is updated multiple times, the actors that updated it are aggregated into a collection.
         */
        it('verify content-update activities are pivoted by object', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create a google link
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                    assert.ok(!err);

                    // Update the content once as jack
                    RestAPI.Content.updateContent(jackCtx, googleLink.contentId, {'name': 'The Google'}, function(err) {
                        assert.ok(!err);

                        // Update it a second time as jack, we use this to make sure we don't get duplicates in the aggregation
                        RestAPI.Content.updateContent(jackCtx, googleLink.contentId, {'name': 'Google'}, function(err) {
                            assert.ok(!err);

                            // Update it with a different user, this should be a second entry in the collection
                            RestAPI.Content.updateContent(camAdminRestContext, googleLink.contentId, {'name': 'Google'}, function(err) {
                                assert.ok(!err);

                                // Verify we get the 2 actors in the stream
                                RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                    assert.ok(!err);
                                    assert.ok(activityStream);
                                    
                                    var activity = activityStream.items[0];
                                    assert.ok(activity);
                                    assert.equal(activity['oae:activityType'], 'content-update');

                                    var actors = activity.actor['oae:collection'];
                                    assert.ok(actors);
                                    assert.equal(actors.length, 2);
                                    callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies two duplicate content updates do not result in an aggregation, but simply an activity with an updated
         * timestamp.
         */
        it('verify duplicate content-update activities are re-released with a more recent date, with no aggregations', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create a google link
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                    assert.ok(!err);

                    // Update the content once as jack
                    RestAPI.Content.updateContent(jackCtx, googleLink.contentId, {'name': 'The Google'}, function(err) {
                        assert.ok(!err);

                        // Add something to the activity feed that happened later than the previous update
                        RestAPI.Content.createLink(jackCtx, 'Yahoo!', 'Yahoo!', 'public', 'http://www.yahoo.ca', [], [], function(err, yahooLink) {
                            assert.ok(!err);

                            // Update it a second time as jack, we use this to make sure we don't get duplicates in the aggregation, and ensure the update jumps ahead of the last create activity in the feed
                            RestAPI.Content.updateContent(jackCtx, googleLink.contentId, {'name': 'Google'}, function(err) {
                                assert.ok(!err);

                                // Verify that the activity is still a non-aggregated activity, it just jumped to the front of the feed
                                RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                    assert.ok(!err);
                                    assert.ok(activityStream);

                                    // One for the "content-create" aggregation, one for the "update content" duplicates
                                    assert.ok(activityStream.items.length, 2);

                                    // Ensures that the actor is not a collection, but still an individual entity
                                    var activity = activityStream.items[0];
                                    assert.equal(activity['oae:activityType'], 'content-update');
                                    assert.ok(activity.actor['oae:id'], jack.id);
                                    assert.ok(activity.object['oae:id'], googleLink.contentId);

                                    // Send a new activity into the feed so it is the most recent
                                    RestAPI.Content.createLink(jackCtx, 'Apereo', 'Apereo', 'public', 'http://www.apereo.org', [], [], function(err, apereoLink) {
                                        assert.ok(!err);

                                        // Force a collection so that the most recent activity is in the feed
                                        RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                            assert.ok(!err);
                                            assert.ok(activityStream);
                                            assert.equal(activityStream.items.length, 2);

                                            // Jump the update activity to the top again
                                            RestAPI.Content.updateContent(jackCtx, googleLink.contentId, {'name': 'Google'}, function(err) {
                                                assert.ok(!err);

                                                // Verify update activity is at the top and still an individual activity
                                                RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                                    assert.ok(activityStream);
                                                    assert.equal(activityStream.items.length, 2);

                                                    // content-update activity should be the first in the list, it should still be a single activity
                                                    var activity = activityStream.items[0];
                                                    assert.equal(activity['oae:activityType'], 'content-update');
                                                    assert.equal(activity.actor['oae:id'], jack.id);
                                                    assert.ok(activity.object['oae:id'], googleLink.contentId);
                                                    callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        ///////////////////////////////
        // CONTENT UPDATE VISIBILITY //
        ///////////////////////////////

        /*
         * The "content-update-visibility" activity demonstrates an activity that has no pivot points, therefore it should be
         * treated as though it pivots on all three entities (actor, object, target) such that duplicate activities within the
         * aggregation period are not posted multiple times. Duplicates are instead pushed to the top of the feed.
         */

        /**
         * Test that verifies when a content-update-visibility activity is posted duplicate times, it does not result in multiple entries in the
         * activity feed. Instead, the activity should be updated and reposted as a recent item.
         */
        it('verify duplicate content-update-visibility activities are not duplicated in the feed', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create a google link
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                    assert.ok(!err);

                    // Update the content once as jack
                    RestAPI.Content.updateContent(jackCtx, googleLink.contentId, {'visibility': 'loggedin'}, function(err) {
                        assert.ok(!err);

                        // Add something to the activity feed that happened later than the previous update
                        RestAPI.Content.createLink(jackCtx, 'Yahoo!', 'Yahoo!', 'public', 'http://www.yahoo.ca', [], [], function(err, yahooLink) {
                            assert.ok(!err);

                            // Update it a second time as jack, we use this to make sure we don't get duplicates in the aggregation, and ensure the update jumps ahead of the last create activity in the feed
                            RestAPI.Content.updateContent(jackCtx, googleLink.contentId, {'visibility': 'private'}, function(err) {
                                assert.ok(!err);

                                // Verify that the activity is still a non-aggregated activity, it just jumped to the front of the feed
                                RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                    assert.ok(!err);
                                    assert.ok(activityStream);

                                    // One for the "content-create" aggregation, one for the "update content" duplicates
                                    assert.ok(activityStream.items.length, 2);

                                    // Ensures that the actor is not a collection, but still an individual entity
                                    var activity = activityStream.items[0];
                                    assert.equal(activity['oae:activityType'], 'content-update-visibility');
                                    assert.ok(activity.actor['oae:id'], jack.id);
                                    assert.ok(activity.object['oae:id'], googleLink.contentId);

                                    // Send a new activity into the feed so it is the most recent
                                    RestAPI.Content.createLink(jackCtx, 'Apereo', 'Apereo', 'public', 'http://www.apereo.org', [], [], function(err, apereoLink) {
                                        assert.ok(!err);

                                        // Force a collection so that the most recent activity is in the feed
                                        RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                            assert.ok(!err);
                                            assert.ok(activityStream);
                                            assert.equal(activityStream.items.length, 2);

                                            // Jump the update activity to the top again
                                            RestAPI.Content.updateContent(jackCtx, googleLink.contentId, {'visibility': 'public'}, function(err) {
                                                assert.ok(!err);

                                                // Verify update activity is at the top and still an individual activity
                                                RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                                    assert.ok(activityStream);
                                                    assert.equal(activityStream.items.length, 2);

                                                    // content-update activity should be the first in the list, it should still be a single activity
                                                    var activity = activityStream.items[0];
                                                    assert.equal(activity['oae:activityType'], 'content-update-visibility');
                                                    assert.equal(activity.actor['oae:id'], jack.id);
                                                    assert.ok(activity.object['oae:id'], googleLink.contentId);
                                                    callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });


        /////////////////////
        // CONTENT-COMMENT //
        /////////////////////

        /*
         * The content-comment activity demonstrates an activity that has all 3 entities, but only aggregates on 1 of them. This means that
         * 2 of the entity types are aggregated as more activities are generated instead of just one.
         */

        /**
         * Test that verifies that when content-comment activities are aggregated, both actor and object entities are collected into the activity
         * for display.
         */
        it('verify that content-comment activity aggregates both actor and object entities while pivoting on target', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create a google link
                RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                    assert.ok(!err);

                    // Post a content as jack
                    RestAPI.Content.createComment(jackCtx, link.contentId, 'Test Comment A', null, function(err) {
                        assert.ok(!err);

                        // Post a comment as the cambridge admin, we have now aggregated a 2nd comment posting on the same content item
                        RestAPI.Content.createComment(camAdminRestContext, link.contentId, 'Test Comment B', null, function(err) {
                            assert.ok(!err);

                            // Verify that both actors (camadmin and jack) and both objects (both comments) are available in the activity
                            RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                assert.ok(!err);
                                assert.ok(activityStream);
                                assert.equal(activityStream.items.length, 2);

                                var activity = activityStream.items[0];
                                assert.equal(activity['oae:activityType'], 'content-comment');

                                // Ensure we've aggregated all actors and objects
                                var actors = activity.actor['oae:collection'];
                                var objects = activity.object['oae:collection'];
                                assert.ok(actors);
                                assert.ok(objects);
                                assert.equal(actors.length, 2);
                                assert.equal(objects.length, 2);
                                assert.equal(activity.target['oae:id'], link.contentId);

                                // Post a 3rd comment as a user who has posted already
                                RestAPI.Content.createComment(jackCtx, link.contentId, 'Test Comment C', null, function(err) {
                                    assert.ok(!err);

                                    // Verify that the 3rd comment is aggregated into the object collection of the activity, however the actor collection has only the 2 unique actors
                                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                        assert.ok(!err);
                                        assert.ok(activityStream);
                                        assert.equal(activityStream.items.length, 2);

                                        var activity = activityStream.items[0];
                                        assert.equal(activity['oae:activityType'], 'content-comment');

                                        // Ensure we now have one additional object, but we should still only have 2 users because it was the same user that posted the 3rd time
                                        var actors = activity.actor['oae:collection'];
                                        var objects = activity.object['oae:collection'];
                                        assert.ok(actors);
                                        assert.ok(objects);
                                        assert.equal(actors.length, 2);
                                        assert.equal(objects.length, 3);
                                        assert.equal(activity.target['oae:id'], link.contentId);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        ///////////////////
        // CONTENT-SHARE //
        ///////////////////

        /*
         * The content-share activity demonstrates a case where you have 2 pivots for a single activity.
         *
         * One pivot is actor+object, which enables the aggregation: "Branden Visser shared Mythology with 4 users and groups"
         *
         * The other pivot is actor+target, which enables the aggregation: "Branden Visser shared 5 items with GroupA"
         */

        /**
         * Test that verifies that duplicating an activity that has multiple pivots does not result in redundant data in the
         * activity feed.
         */
        it('verify duplicate content-share activities do not result in redundant activities', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            var janeUsername = TestsUtil.generateTestUserId('jane');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create Jane, the user who will be shared with
                RestAPI.User.createUser(camAdminRestContext, janeUsername, 'password', 'Jane', null, function(err, jane) {
                    assert.ok(!err);
                    var janeCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, janeUsername, 'password');

                    // Create a google link
                    RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, link) {
                        assert.ok(!err);

                        // Share with jack, creates one activity item in cam admin's feed
                        RestAPI.Content.shareContent(jackCtx, link.contentId, [jane.id], function(err) {
                            assert.ok(!err);

                            var removeJane = {};
                            removeJane[jane.id] = false;

                            // Remove jane so we can duplicate the content share after
                            RestAPI.Content.updateMembers(jackCtx, link.contentId, removeJane, function(err) {
                                assert.ok(!err);

                                // Create some noise in the feed to ensure that the second share content will jump to the top
                                RestAPI.Content.createLink(jackCtx, 'Yahoo', 'Yahoo', 'public', 'http://www.google.ca', [], [], function(err, yahooLink) {
                                    assert.ok(!err);

                                    // Now re-add Jane
                                    RestAPI.Content.shareContent(jackCtx, link.contentId, [jane.id], function(err) {
                                        assert.ok(!err);

                                        // Verify that jack only has only one activity in his feed representing the content-share
                                        RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                            assert.ok(!err);
                                            assert.ok(activityStream);
                                            assert.equal(activityStream.items.length, 2);

                                            // The first activity should be the content share, and it should not be an aggregation
                                            var activity = activityStream.items[0];
                                            assert.equal(activity['oae:activityType'], 'content-share');
                                            assert.equal(activity.actor['oae:id'], jack.id);
                                            assert.equal(activity.object['oae:id'], link.contentId);
                                            assert.equal(activity.target['oae:id'], jane.id);

                                            // Repeat once more to ensure we don't duplicate when the aggregate is already active
                                            RestAPI.Content.updateMembers(jackCtx, link.contentId, removeJane, function(err) {
                                                assert.ok(!err);

                                                // Create some noise in the feed to ensure that the third share content will jump to the top
                                                RestAPI.Content.createLink(jackCtx, 'Apereo', 'Apereo', 'public', 'http://www.apereo.org', [], [], function(err, apereoLink) {
                                                    assert.ok(!err);

                                                    // Re-share with Jane for the 3rd time
                                                    RestAPI.Content.shareContent(jackCtx, link.contentId, [jane.id], function(err) {
                                                        assert.ok(!err);

                                                        // Verify that jack still has only one activity in his feed representing the content-share
                                                        RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                                            assert.ok(!err);
                                                            assert.ok(activityStream);
                                                            assert.equal(activityStream.items.length, 2);

                                                            // The first activity should be the content share, and it should still not be an aggregation
                                                            var activity = activityStream.items[0];
                                                            assert.equal(activity['oae:activityType'], 'content-share');
                                                            assert.equal(activity.actor['oae:id'], jack.id);
                                                            assert.equal(activity.object['oae:id'], link.contentId);
                                                            assert.equal(activity.target['oae:id'], jane.id);
                                                            callback();
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        it('verify content-share activities aggregate and are branched properly when all collected at once', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            var janeUsername = TestsUtil.generateTestUserId('jane');
            var brandenUsername = TestsUtil.generateTestUserId('mrvisser');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create Jane, the user who will be shared with
                RestAPI.User.createUser(camAdminRestContext, janeUsername, 'password', 'Jane', null, function(err, jane) {
                    assert.ok(!err);

                    // Create Branden, a second user to be shared with
                    RestAPI.User.createUser(camAdminRestContext, brandenUsername, 'password', 'Branden Visser', null, function(err, branden) {
                        assert.ok(!err);

                        // Create a google link and yahoo link to be shared around
                        RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                            assert.ok(!err);

                            RestAPI.Content.createLink(jackCtx, 'Yahoo', 'Yahoo', 'public', 'http://www.yahoo.ca', [], [], function(err, yahooLink) {
                                assert.ok(!err);

                                // Share google link with jane and branden
                                RestAPI.Content.shareContent(jackCtx, googleLink.contentId, [jane.id, branden.id], function(err) {
                                    assert.ok(!err);

                                    // Share Yahoo link with jane only
                                    RestAPI.Content.shareContent(jackCtx, yahooLink.contentId, [jane.id], function(err) {
                                        assert.ok(!err);

                                        // Verify that the share activities aggregated in both pivot points
                                        RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                            assert.ok(!err);
                                            assert.ok(activityStream);
                                            assert.equal(activityStream.items.length, 3);

                                            // 1. actor+target should have jack+(google,yahoo)+jane, and it would be most recent
                                            var activity = activityStream.items[0];
                                            assert.ok(activity.object['oae:collection']);
                                            assert.equal(activity.object['oae:collection'].length, 2);

                                            // 2. actor+object aggregate should have: jack+google+(jane,branden)
                                            activity = activityStream.items[1];
                                            assert.ok(activity.target['oae:collection']);
                                            assert.equal(activity.target['oae:collection'].length, 2);

                                            callback();
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        it('verify content-share activities aggregate and are branched properly when collected after first share', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            var janeUsername = TestsUtil.generateTestUserId('jane');
            var brandenUsername = TestsUtil.generateTestUserId('mrvisser');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create Jane, the user who will be shared with
                RestAPI.User.createUser(camAdminRestContext, janeUsername, 'password', 'Jane', null, function(err, jane) {
                    assert.ok(!err);

                    // Create Branden, a second user to be shared with
                    RestAPI.User.createUser(camAdminRestContext, brandenUsername, 'password', 'Branden Visser', null, function(err, branden) {
                        assert.ok(!err);

                        // Create a google link and yahoo link to be shared around
                        RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                            assert.ok(!err);

                            RestAPI.Content.createLink(jackCtx, 'Yahoo', 'Yahoo', 'public', 'http://www.yahoo.ca', [], [], function(err, yahooLink) {
                                assert.ok(!err);

                                // Share google link with jane
                                RestAPI.Content.shareContent(jackCtx, googleLink.contentId, [jane.id], function(err) {
                                    assert.ok(!err);

                                    // Perform a collection to activate some aggregates ahead of time
                                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                        assert.ok(!err);

                                        // Share google now with branden, should aggregate with the previous
                                        RestAPI.Content.shareContent(jackCtx, googleLink.contentId, [branden.id], function(err) {
                                            assert.ok(!err);

                                            // Share Yahoo link with jane only
                                            RestAPI.Content.shareContent(jackCtx, yahooLink.contentId, [jane.id], function(err) {
                                                assert.ok(!err);
                                                
                                                // Verify that the share activities aggregated in both pivot points
                                                RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                                    assert.ok(!err);
                                                    assert.ok(activityStream);
                                                    assert.equal(activityStream.items.length, 3);

                                                    // 1. actor+target should have jack+(google,yahoo)+jane, and it would be most recent
                                                    var activity = activityStream.items[0];
                                                    assert.ok(activity.object['oae:collection']);
                                                    assert.equal(activity.object['oae:collection'].length, 2);

                                                    // 2. actor+object aggregate should have: jack+google+(jane,branden)
                                                    activity = activityStream.items[1];
                                                    assert.ok(activity.target['oae:collection']);
                                                    assert.equal(activity.target['oae:collection'].length, 2);

                                                    callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        it('verify content-share activities aggregate and are branched properly when collected before last share', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            var janeUsername = TestsUtil.generateTestUserId('jane');
            var brandenUsername = TestsUtil.generateTestUserId('mrvisser');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create Jane, the user who will be shared with
                RestAPI.User.createUser(camAdminRestContext, janeUsername, 'password', 'Jane', null, function(err, jane) {
                    assert.ok(!err);

                    // Create Branden, a second user to be shared with
                    RestAPI.User.createUser(camAdminRestContext, brandenUsername, 'password', 'Branden Visser', null, function(err, branden) {
                        assert.ok(!err);

                        // Create a google link and yahoo link to be shared around
                        RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                            assert.ok(!err);

                            RestAPI.Content.createLink(jackCtx, 'Yahoo', 'Yahoo', 'public', 'http://www.yahoo.ca', [], [], function(err, yahooLink) {
                                assert.ok(!err);

                                // Share google link with jane and branden
                                RestAPI.Content.shareContent(jackCtx, googleLink.contentId, [jane.id, branden.id], function(err) {
                                    assert.ok(!err);

                                    // Perform a collection to activate some aggregates ahead of time
                                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                        assert.ok(!err);

                                        // Share Yahoo link with jane only
                                        RestAPI.Content.shareContent(jackCtx, yahooLink.contentId, [jane.id], function(err) {
                                            assert.ok(!err);

                                            // Verify that the share activities aggregated in both pivot points
                                            RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                                assert.ok(!err);
                                                assert.ok(activityStream);
                                                assert.equal(activityStream.items.length, 3);

                                                // 1. actor+target should have jack+(google,yahoo)+jane, and it would be most recent
                                                var activity = activityStream.items[0];
                                                assert.ok(activity.object['oae:collection']);
                                                assert.equal(activity.object['oae:collection'].length, 2);

                                                // 2. actor+object aggregate should have: jack+google+(jane,branden)
                                                activity = activityStream.items[1];
                                                assert.ok(activity.target['oae:collection']);
                                                assert.equal(activity.target['oae:collection'].length, 2);

                                                callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        it('verify content-share activities aggregate and are branched properly when collected after each share', function(callback) {
            var jackUsername = TestsUtil.generateTestUserId('jack');
            var janeUsername = TestsUtil.generateTestUserId('jane');
            var brandenUsername = TestsUtil.generateTestUserId('mrvisser');

            // Create Jack, the user whose will create content items
            RestAPI.User.createUser(camAdminRestContext, jackUsername, 'password', 'Jack McJackerson', null, function(err, jack) {
                assert.ok(!err);
                var jackCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, jackUsername, 'password');

                // Create Jane, the user who will be shared with
                RestAPI.User.createUser(camAdminRestContext, janeUsername, 'password', 'Jane', null, function(err, jane) {
                    assert.ok(!err);

                    // Create Branden, a second user to be shared with
                    RestAPI.User.createUser(camAdminRestContext, brandenUsername, 'password', 'Branden Visser', null, function(err, branden) {
                        assert.ok(!err);

                        // Create a google link and yahoo link to be shared around
                        RestAPI.Content.createLink(jackCtx, 'Google', 'Google', 'public', 'http://www.google.ca', [], [], function(err, googleLink) {
                            assert.ok(!err);

                            RestAPI.Content.createLink(jackCtx, 'Yahoo', 'Yahoo', 'public', 'http://www.yahoo.ca', [], [], function(err, yahooLink) {
                                assert.ok(!err);

                                // Share google link with jane
                                RestAPI.Content.shareContent(jackCtx, googleLink.contentId, [jane.id], function(err) {
                                    assert.ok(!err);

                                    // Perform a collection to activate some aggregates ahead of time
                                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                        assert.ok(!err);

                                        // Share google now with branden, should aggregate with the previous
                                        RestAPI.Content.shareContent(jackCtx, googleLink.contentId, [branden.id], function(err) {
                                            assert.ok(!err);

                                            // Perform a collection to activate some aggregates ahead of time
                                            RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                                assert.ok(!err);

                                                // Share Yahoo link with jane only
                                                RestAPI.Content.shareContent(jackCtx, yahooLink.contentId, [jane.id], function(err) {
                                                    assert.ok(!err);
                                                    
                                                    // Verify that the share activities aggregated in both pivot points
                                                    RestAPI.Activity.getCurrentActivityStream(jackCtx, null, function(err, activityStream) {
                                                        assert.ok(!err);
                                                        assert.ok(activityStream);
                                                        assert.equal(activityStream.items.length, 3);

                                                        // 1. actor+target should have jack+(google,yahoo)+jane, and it would be most recent
                                                        var activity = activityStream.items[0];
                                                        assert.ok(activity.object['oae:collection']);
                                                        assert.equal(activity.object['oae:collection'].length, 2);

                                                        // 2. actor+object aggregate should have: jack+google+(jane,branden)
                                                        activity = activityStream.items[1];
                                                        assert.ok(activity.target['oae:collection']);
                                                        assert.equal(activity.target['oae:collection'].length, 2);

                                                        callback();
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});

