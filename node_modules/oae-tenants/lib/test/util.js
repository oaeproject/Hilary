/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var ShortId = require('shortid');

var ConfigTestUtil = require('oae-config/lib/test/util');
var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');

/**
 * Create test tenants
 *
 * @param  {RestContext}    globalAdminRestCtx      The global admin rest context with which to create the tenants
 * @param  {Number}         numToCreate             How many tenants to create
 * @param  {Function}       callback                Invoked when the tenants are created
 * @param  {TenantNetwork}  callback.tenant0        The first tenant  that was created
 * @param  {TenantNetwork}  [callback.tenant...]    All tenants that were created as new callback arguments
 * @throws {AssertionError}                         Thrown if there is an error creating any of the tenants
 */
var generateTestTenants = module.exports.generateTestTenants = function(globalAdminRestCtx, numToCreate, callback, _created) {
    _created = _created || [];
    if (_created.length === numToCreate) {
        // Invoke the callback with all the tenants created
        return callback.apply(callback, _created);
    }

    // Create a tenant with random data
    var alias = TestsUtil.generateRandomText();
    var description = TestsUtil.generateRandomText();
    var host = TestsUtil.generateRandomText();
    createTenantAndWait(globalAdminRestCtx, alias, description, host, function(err, tenant) {
        assert.ok(!err);
        _created.push(tenant);
        return generateTestTenants(globalAdminRestCtx, numToCreate, callback, _created);
    });
};

/**
 * Create a tenant and wait for the event that indicates that the configuration has finished loading
 *
 * @param  {RestContext}    globalAdminRestCtx  The global admin rest context to use to create the tenant
 * @param  {String}         alias               The tenant alias of the tenant to create
 * @param  {String}         displayName         The display name of the tenant to create
 * @param  {String}         host                The host of the tenant to create
 * @param  {Function}       callback            Standard callback function, invoked after the tenant has been created and its configuration is complete
 * @param  {Object}         callback.err        An error that occurred, if any
 * @param  {Tenant}         callback.tenant     The tenant that was created
 */
var createTenantAndWait = module.exports.createTenantAndWait = function(globalAdminRestCtx, alias, displayName, host, callback) {
    RestAPI.Tenants.createTenant(globalAdminRestCtx, alias, displayName, host, function(err, tenant) {
        if (err) {
            return callback(err);
        }

        // Wait until all current config events have fired until calling back
        ConfigTestUtil.whenConfigUpdated(function() {
            return callback(null, tenant);
        });
    });
};

/**
 * Create test tenant networks
 *
 * @param  {RestContext}    globalAdminRestCtx              The global admin rest context with which to create the tenant networks
 * @param  {Number}         numToCreate                     How many tenant networks to create
 * @param  {Function}       callback                        Invoked when the tenant networks are created
 * @param  {TenantNetwork}  callback.tenantNetwork0         The first tenant network that was created
 * @param  {TenantNetwork}  [callback.tenantNetwork...]     All tenant networks that were created as new callback arguments
 * @throws {AssertionError}                                 Thrown if there is an error creating any of the tenant networks
 */
var generateTestTenantNetworks = module.exports.generateTestTenantNetworks = function(globalAdminRestCtx, numToCreate, callback, _created) {
    _created = _created || [];
    if (_created.length === numToCreate) {
        // Invoke the callback with all the tenant networks created
        return callback.apply(callback, _created);
    }

    // Create a tenant network with a random displayName
    RestAPI.Tenants.createTenantNetwork(globalAdminRestCtx, ShortId.generate(), function(err, tenantNetwork) {
        assert.ok(!err);
        _created.push(tenantNetwork);
        return generateTestTenantNetworks(globalAdminRestCtx, numToCreate, callback, _created);
    });
};

/**
 * Ensure one tenant is equal to another
 *
 * @param  {Tenant}         actual      The tenant to test
 * @param  {Tenant}         expected    The expected tenant object
 * @throws {AssertionError}             Thrown if the actual tenant does not match the expected model
 */
var assertTenantsEqual = module.exports.assertTenantsEqual = function(actual, expected) {
    assert.strictEqual(actual.alias, expected.alias);
    assert.strictEqual(actual.displayName, expected.displayName);
    assert.strictEqual(actual.host, expected.host);
    assert.strictEqual(actual.active, expected.active);
    assert.strictEqual(actual.deleted, expected.deleted);
    assert.strictEqual(actual.isGlobalAdminServer, expected.isGlobalAdminServer);
};
