/*
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
var _ = require('underscore');
var assert = require('assert');

var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var TestsUtil = require('oae-tests');

var TenantsAPI = require('oae-tenants');


describe('Tenants', function() {

    // Rest context that can be used every time we need to make a request as an anonymous user
    var anonymousRestContext = null;
    // Rest context that can be used for anonymous requests on the global tenant
    var anonymousGlobalRestContext = null;
    // Rest context that can be used every time we need to make a request as a Cambridge tenant admin
    var camAdminRestContext = null;
    // Rest context that can be used every time we need to use a request as a global admin
    var globalAdminRestContext = null;

    /**
     * Function that will fill up the anonymous and the tenant admin context
     */
    before(function(callback) {
        // Fill up anonymous rest context
        anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        // Fill up the anonymous global rest context
        anonymousGlobalRestContext = TestsUtil.createGlobalRestContext();
        // Fill up Cam tenant admin rest context
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        // Fill up the global admin rest context
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
        callback();
    });


    describe('Get tenant', function() {

        /**
         * Test that verifies that all tenants can be retrieved
         */
        it('verify get all tenants', function(callback) {
            // Get all tenants, check that there are 2
            RestAPI.Tenant.getAllTenants(globalAdminRestContext, function(err, tenants) {
                assert.ok(!err);
                assert.ok(tenants);
                assert.ok(tenants['camtest']);
                assert.equal(tenants['camtest'].host, 'cambridge.oae.com');
                assert.ok(tenants['gttest']);
                assert.equal(tenants['gttest'].host, 'gt.oae.com');

                // Create a new tenant
                RestAPI.Tenant.createTenant(globalAdminRestContext, 'oxfordtest', 'Oxford University', 'oxford.oae.com', function(err) {
                    assert.ok(!err);
                    // Get all tenants, check that there are 3
                    RestAPI.Tenant.getAllTenants(globalAdminRestContext, function(err, tenants) {
                        assert.ok(tenants);
                        assert.ok(tenants['camtest']);
                        assert.equal(tenants['camtest'].host, 'cambridge.oae.com');
                        assert.ok(tenants['gttest']);
                        assert.equal(tenants['gttest'].host, 'gt.oae.com');
                        assert.equal(tenants['camtest'].host, 'cambridge.oae.com');
                        assert.ok(tenants['oxfordtest']);
                        assert.equal(tenants['oxfordtest'].host, 'oxford.oae.com');

                        // Delete the previously created tenant
                        RestAPI.Tenant.deleteTenant(globalAdminRestContext, 'oxfordtest', function(err) {
                            assert.ok(!err);
                            RestAPI.Tenant.getAllTenants(globalAdminRestContext, function(err, tenants) {
                                assert.ok(!err);
                                assert.ok(tenants);
                                assert.ok(!tenants['oxfordtest']);
                                assert.ok(tenants['camtest']);
                                assert.equal(tenants['camtest'].host, 'cambridge.oae.com');
                                assert.ok(tenants['gttest']);
                                assert.equal(tenants['gttest'].host, 'gt.oae.com');
                                callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that the current tenant's information can be retrieved
         */
        it('verify get tenant', function(callback) {
            RestAPI.Tenant.getTenant(anonymousRestContext, null, function(err, tenant) {
                assert.ok(!err);
                assert.ok(tenant);
                assert.equal(tenant.alias, 'camtest');
                assert.equal(tenant.host, 'cambridge.oae.com');

                // Verify that the tenant information is available through the global tenant
                RestAPI.Tenant.getTenant(globalAdminRestContext, 'camtest', function(err, tenant) {
                    assert.ok(!err);
                    assert.ok(tenant);
                    assert.equal(tenant.alias, 'camtest');
                    assert.equal(tenant.host, 'cambridge.oae.com');
                    callback();
                });
            });
        });

        // Test that verifies that getting the global tenant succeeds
        it('verify get global tenant', function(callback) {
            RestAPI.Tenant.getTenant(globalAdminRestContext, null, function(err, tenant) {
                assert.ok(!err);
                assert.equal(tenant.isGlobalAdminServer, true);
                assert.equal(tenant.alias, 'admin');
                callback();
            });
        });

        /**
         * Test that verifies that getting the tenant information through the global server requires a valid ID
         */
        it('verify get tenant through global server requires valid id', function(callback) {
            RestAPI.Tenant.getTenant(globalAdminRestContext, ' ', function(err, tenant) {
                assert.ok(err);
                assert.equal(err.code, 404);
                callback();
            });
        });

        /**
         * Test that verifies that a tenant can be retrieved by its mapped alias. This uses the internal
         * API as there is no REST feed available that offers this functionality.
         */
        it('verify get tenant by alias', function(callback) {
            // Get the Cambridge tenant
            TenantsAPI.getTenantByAlias('camtest', function(err, tenant) {
                assert.ok(!err);
                assert.equal(tenant.alias, 'camtest');
                assert.equal(tenant.displayName, 'Cambridge University Test');
                assert.equal(tenant.host, 'cambridge.oae.com');

                // Get the GT tenant
                TenantsAPI.getTenantByAlias('gttest', function(err, tenant) {
                    assert.ok(!err);
                    assert.equal(tenant.alias, 'gttest');
                    assert.equal(tenant.displayName, 'Georgia Tech Test');
                    assert.equal(tenant.host, 'gt.oae.com');

                    // Get non-existing tenant
                    TenantsAPI.getTenantByAlias('non-existing', function(err, tenant) {
                        assert.ok(err);
                        assert.ok(!tenant);
                        callback();
                    });
                });
            });
        });
    });


    describe('Tenant actions', function() {

        /**
         * Test that verifies that a tenant can not be deleted by an anonymous user
         */
        it('verify create tenant as anonymous user fails', function(callback) {
            // Try to create a tenant as an anonymous user
            RestAPI.Tenant.createTenant(anonymousGlobalRestContext, 'nyutest', 'New York University', 'nyu.oae.com', function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);
                callback();
            });
        });

        /**
         * Test that verifies that it is possible to create a new tenant
         */
        it('verify creating tenant', function(callback) {
            RestAPI.Tenant.createTenant(globalAdminRestContext, 'nyutest', 'New York University', 'nyu.oae.com', function(err, tenant) {
                assert.ok(!err);
                assert.ok(tenant);
                assert.equal(tenant.alias, 'nyutest');
                assert.equal(tenant.host, 'nyu.oae.com');

                // Get the tenant
                var nyuRestContext = TestsUtil.createTenantRestContext('nyu.oae.com');
                RestAPI.Tenant.getTenant(nyuRestContext, null, function(err, tenant) {
                    assert.ok(!err);
                    assert.ok(tenant);
                    assert.equal(tenant.alias, 'nyutest');
                    assert.equal(tenant.host, 'nyu.oae.com');
                    callback();
                });
            });
        });

        /**
         * Test that verifies that creating a tenant needs an alias, a displayName and a host specified
         */
        it('verify tenant creation validations', function(callback) {
            // Try creating a tenant with no alias
            RestAPI.Tenant.createTenant(globalAdminRestContext, null, 'AAR', 'aar.oae.com', function(err) {
                assert.ok(err);

                // Try creating a tenant with an invalid alias (: in alias)
                RestAPI.Tenant.createTenant(globalAdminRestContext, 'aar:test', 'AAR', 'aar.oae.com', function(err) {
                    assert.ok(err);

                    // Try creating a tenant with no displayName
                    RestAPI.Tenant.createTenant(globalAdminRestContext, 'aartest', null, 'aar.oae.com', function(err) {
                        assert.ok(err);

                        // Try creating a tenant with no base URL
                        RestAPI.Tenant.createTenant(globalAdminRestContext, 'aartest', 'AAR', null, function(err) {
                            assert.ok(err);

                            // Verify that the tenant does not exist
                            var aarRestContext = TestsUtil.createTenantRestContext('aar.oae.com');

                            RestAPI.Tenant.getTenant(aarRestContext, null, function(err, tenant) {
                                assert.ok(err);
                                assert.ok(!tenant);
                                callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a tenant cannot be created with a duplicate alias
         */
        it('verify create tenant duplicate alias', function(callback) {
            RestAPI.Tenant.createTenant(globalAdminRestContext, 'camtest', 'AAR', 'camtest.oae.com', function(err) {
                assert.ok(err);

                // Verify that the existing tenant is still running
                RestAPI.Tenant.getTenant(anonymousRestContext, null, function(err, tenant) {
                    assert.ok(!err);
                    assert.ok(tenant);
                    assert.equal(tenant.alias, 'camtest');
                    assert.equal(tenant.host, 'cambridge.oae.com');
                    callback();
                });
            });
        });

        /**
         * Test that verifies that a tenant can be stopped
         */
        it('verify stop tenant', function(callback) {
            // Create a new tenant
            RestAPI.Tenant.createTenant(globalAdminRestContext, 'aartest', 'AAR', 'aar.oae.com', function(err, tenant) {
                assert.ok(!err);
                var aarRestContext = TestsUtil.createTenantRestContext('aar.oae.com');

                // Verify that the tenant is running
                RestAPI.Tenant.getTenant(aarRestContext, null, function(err, tenant) {
                    assert.ok(!err);
                    assert.ok(tenant);
                    assert.equal(tenant.alias, 'aartest');

                    // Verify it's in the list of running tenant aliases
                    assert.ok(_.contains(TenantsAPI.getRunningTenantAliases(), 'aartest'));

                    // Stop the tenant
                    RestAPI.Tenant.stopTenant(globalAdminRestContext, 'aartest', function(err) {
                        assert.ok(!err);

                        // Verify that the tenant is no longer running
                        RestAPI.Tenant.getTenant(aarRestContext, null, function(err, tenant) {
                            assert.ok(err);
                            assert.equal(err.code, 503);
                            assert.ok(!tenant);

                            // Verify it is no longer in the list of running tenant aliases
                            assert.ok(!_.contains(TenantsAPI.getRunningTenantAliases(), 'aartest'));

                            // Verify that it's still part of the all tenants feed
                            RestAPI.Tenant.getAllTenants(globalAdminRestContext, function(err, tenants) {
                                assert.ok(!err);
                                assert.ok(tenants);
                                assert.ok(tenants['aartest']);
                                assert.equal(tenants['aartest'].host, 'aar.oae.com');
                                assert.equal(tenants['aartest'].active, false);
                                callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a tenant can not be stopped by an anonymous user
         */
        it('verify stop tenant as anonymous user fails', function(callback) {
            // Try to stop the tenant as an anonymous user
            RestAPI.Tenant.stopTenant(anonymousGlobalRestContext, 'aartest', function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);
                callback();
            });
        });

        /**
         * Test that verifes that a non-existing tenant cannot be stopped
         */
        it('verify stop non-existing tenant', function(callback) {
            // Stop tenant with no alias
            RestAPI.Tenant.stopTenant(globalAdminRestContext, null, function(err) {
                assert.ok(err);
                callback();
            });
        });

        /**
         * Test that verifies that a stopped tenant can be started
         */
        it('verify start tenant', function(callback) {
            // Re-start the tenant from the previous test
            RestAPI.Tenant.startTenant(globalAdminRestContext, 'aartest', function(err) {
                assert.ok(!err);

                // Verify that the tenant is running again
                var aarRestContext = TestsUtil.createTenantRestContext('aar.oae.com');
                RestAPI.Tenant.getTenant(aarRestContext, null, function(err, tenant) {
                    assert.ok(!err);
                    assert.ok(tenant);
                    assert.equal(tenant.alias, 'aartest');
                    assert.equal(tenant.host, 'aar.oae.com');
                    callback();
                });
            });
        });

        /**
         * Test that verifies that a tenant can not be started by an anonymous user
         */
        it('verify start tenant as anonymous user fails', function(callback) {
            // Try to stop the tenant as an anonymous user
            RestAPI.Tenant.startTenant(anonymousGlobalRestContext, 'aartest', function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);
                callback();
            });
        });

        /**
         * Test that verifes that a non-existing tenant cannot be started
         */
        it('verify stop non-existing tenant', function(callback) {
            // Stop tenant with no alias
            RestAPI.Tenant.startTenant(globalAdminRestContext, null, function(err) {
                assert.ok(err);
                callback();
            });
        });

        /**
         * Test that verifies that a tenant can not be deleted by an anonymous user
         */
        it('verify delete tenant as anonymous user fails', function(callback) {
            // Try to stop the tenant as an anonymous user
            RestAPI.Tenant.deleteTenant(anonymousGlobalRestContext, 'aartest', function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);
                callback();
            });
        });

        /**
         * Test that verifies that a tenant can be deleted
         */
        it('verify delete tenant', function(callback) {
            // Try deleting a non-existing tenant
            RestAPI.Tenant.deleteTenant(globalAdminRestContext, null, function(err) {
                assert.ok(err);

                // Delete the tenant from the previous test
                RestAPI.Tenant.deleteTenant(globalAdminRestContext, 'aartest', function(err) {
                    assert.ok(!err);

                    // Verify that the tenant is no longer running
                    var aarRestContext = TestsUtil.createTenantRestContext('aar.oae.com');
                    RestAPI.Tenant.getTenant(aarRestContext, null, function(err, tenant) {
                        assert.ok(err);
                        assert.ok(!tenant);

                        // Verify that it's no longer a part of the all tenants feed
                        RestAPI.Tenant.getAllTenants(globalAdminRestContext, function(err, tenants) {
                            assert.ok(!err);
                            assert.ok(tenants);
                            assert.ok(!tenants['aartest']);
                            callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifes that a non-existing tenant cannot be deleted
         */
        it('verify delete non-existing tenant', function(callback) {
            // Stop tenant with no alias
            RestAPI.Tenant.deleteTenant(globalAdminRestContext, null, function(err) {
                assert.ok(err);
                callback();
            });
        });
    });

    describe('Update tenant', function() {
        /**
         * Test that verifies that a tenant's displayName can not be updated by an anonymous user
         */
        it('verify update tenant displayName as anonymous user fails', function(callback) {
            // Try to stop the tenant as an anonymous user
            RestAPI.Tenant.updateTenant(anonymousGlobalRestContext, 'camtest', 'Anglia Ruskin University', function(err) {
                assert.ok(err);
                assert.equal(err.code, 401);
                callback();
            });
        });

        /**
         * Test that verifies that a tenant's displayName can not be updated without specifying the new displayName
         */
        it('verify update tenant displayName requires a value', function(callback) {
            RestAPI.Tenant.updateTenant(camAdminRestContext, null, null, function(err) {
                assert.ok(err);
                assert.equal(err.code, 400);
                callback();
            });
        });

        /**
         * Test that verifies that a tenant displayName can be updated
         */
        it('verify update tenant displayName', function(callback) {
            // Try a valid update
            RestAPI.Tenant.updateTenant(globalAdminRestContext, 'camtest', 'Anglia Ruskin University', function(err) {
                assert.ok(!err);

                // Check if the update was successful
                RestAPI.Tenant.getTenant(camAdminRestContext, null, function(err, tenant) {
                    assert.ok(!err);
                    assert.ok(tenant);
                    assert.equal(tenant.alias, 'camtest');
                    assert.equal(tenant.host, 'cambridge.oae.com');
                    assert.equal(tenant.displayName, 'Anglia Ruskin University');

                    // Try an update as the tenant admin
                    RestAPI.Tenant.updateTenant(camAdminRestContext, 'camtest', 'Queens College', function(err) {
                        assert.ok(!err);

                        // Check if the update was successful
                        RestAPI.Tenant.getTenant(camAdminRestContext, null, function(err, tenant) {
                            assert.ok(!err);
                            assert.ok(tenant);
                            assert.equal(tenant.alias, 'camtest');
                            assert.equal(tenant.host, 'cambridge.oae.com');
                            assert.equal(tenant.displayName, 'Queens College');
                            callback();
                        });
                    });
                });
            });
        });

    });


    describe('Non-existing tenants', function() {

        it('verify non-existing tenant', function(callback) {
            // Get the me feed on an existing tenant
            RestAPI.User.getMe(anonymousRestContext, function(err, meObj) {
                assert.ok(!err);
                assert.equal(meObj.anon, true);

                // Get the me feed on a non-existing tenant
                anonymousNonExistingRestContext = TestsUtil.createTenantRestContext('harvard.oae.com');
                RestAPI.User.getMe(anonymousNonExistingRestContext, function(err, meObj) {
                    assert.ok(err);
                    assert.equal(err.code, 418);
                    callback();
                });
            });
        });

    });

});
