/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var util = require('util');

var ConfigTestUtil = require('oae-config/lib/test/util');
var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests');

var FoldersTestUtil = require('../lib/test/util');

describe('Folders', function() {

    var globalAdminRestContext = null;
    var camAdminRestContext = null;
    var camAnonymousRestContext = null;
    var gtAdminRestContext = null;
    var gtAnonymousRestContext = null;

    /*!
     * Before each test, set up all the REST contexts for admin and anonymous users with which we
     * will invoke requests
     */
    beforeEach(function(callback) {
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        camAnonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        gtAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        gtAnonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.gt.host);
        callback();
    });

    /*!
     * After each test, ensure the default folder visibility is the default value
     */
    afterEach(function(callback) {
        // Ensure the default folder visibility always starts fresh
        ConfigTestUtil.clearConfigAndWait(globalAdminRestContext, null, ['oae-folders/visibility/folder'], function(err) {
            assert.ok(!err);
            return callback();
        });
    });

    /*!
     * Create a member update object whose key is the provided principal id and the value is the
     * role change. This is simply a convenience for performing individual role updates on
     * folders
     *
     * @param  {String|Object}      principalInfo   The id of the principal whose role to change, or a principalInfo object. If an object, the `role` key will be added so it can be used in assert test utilities for updating membership
     * @param  {String|Boolean}     roleChange      The change to make to the principal's role. Should either be a role (`manager` or `viewer`, or `false` to remove them)
     */
    var _memberUpdate = function(principalInfo, roleChange) {
        roleChange = (_.isUndefined(roleChange)) ? 'viewer' : roleChange;

        var memberUpdate = {};
        if (_.isObject(principalInfo)) {
            // If the principal info is an object, then it contains the restContext and the profile,
            // and we extend the info object with the role change
            var profile = principalInfo.user || principalInfo.group;
            memberUpdate[profile.id] = _.extend({}, principalInfo, {'role': roleChange});
        } else {
            // If the principal info is not an object, it should be a string, representing the
            // id of the principal whose role to change
            memberUpdate[principalInfo] = roleChange;
        }

        return memberUpdate;
    };

    describe('Create Folder', function() {

        /**
         * Test that verifies creation of a folder
         */
        it('verify folder creation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, mrvisser, stuartf, sathomas) {
                assert.ok(!err);

                FoldersTestUtil.assertCreateFolderSucceeds(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf], [sathomas], function(createdFolder) {
                    // Ensure the returned folder model is accurate
                    assert.ok(createdFolder);
                    assert.ok(createdFolder.tenant);
                    assert.equal(createdFolder.tenant.alias, global.oaeTests.tenants.cam.alias);
                    assert.equal(createdFolder.tenant.displayName, global.oaeTests.tenants.cam.displayName);
                    assert.ok(createdFolder.id);
                    assert.ok(createdFolder.groupId);
                    assert.equal(createdFolder.displayName, 'test displayName');
                    assert.equal(createdFolder.description, 'test description');
                    assert.equal(createdFolder.visibility, 'private');
                    assert.ok(createdFolder.created);
                    assert.strictEqual(createdFolder.lastModified, createdFolder.created);
                    assert.equal(createdFolder.profilePath, util.format('/folder/%s/%s', global.oaeTests.tenants.cam.alias, createdFolder.id.split(':').pop()));
                    assert.equal(createdFolder.resourceType, 'folder');

                    // Sanity check that the folder was created
                    FoldersTestUtil.assertGetFolderSucceeds(mrvisser.restContext, createdFolder.id, function(fetchedFolder) {
                        // Ensure the fetched folder model is consistent with the created one
                        assert.ok(fetchedFolder);
                        assert.ok(fetchedFolder.tenant);
                        assert.equal(fetchedFolder.tenant.alias, createdFolder.tenant.alias);
                        assert.equal(fetchedFolder.tenant.displayName, createdFolder.tenant.displayName);
                        assert.equal(fetchedFolder.id, createdFolder.id);
                        assert.equal(fetchedFolder.groupId, createdFolder.groupId);
                        assert.equal(fetchedFolder.displayName, createdFolder.displayName);
                        assert.equal(fetchedFolder.description, createdFolder.description);
                        assert.equal(fetchedFolder.visibility, createdFolder.visibility);
                        assert.strictEqual(fetchedFolder.created, createdFolder.created);
                        assert.strictEqual(fetchedFolder.lastModified, createdFolder.lastModified);
                        assert.equal(fetchedFolder.profilePath, createdFolder.profilePath);
                        assert.equal(fetchedFolder.resourceType, createdFolder.resourceType);

                        // Ensure createdBy user model is consistent with the user who created it
                        assert.ok(fetchedFolder.createdBy);
                        assert.equal(fetchedFolder.createdBy.tenant.alias, mrvisser.user.tenant.alias);
                        assert.equal(fetchedFolder.createdBy.tenant.displayName, mrvisser.user.tenant.displayName);
                        assert.equal(fetchedFolder.createdBy.id, mrvisser.user.id);
                        assert.equal(fetchedFolder.createdBy.displayName, mrvisser.user.displayName);
                        assert.equal(fetchedFolder.createdBy.visibility, mrvisser.user.visibility);
                        assert.equal(fetchedFolder.createdBy.email, mrvisser.user.email);
                        assert.equal(fetchedFolder.createdBy.locale, mrvisser.user.locale);
                        assert.equal(fetchedFolder.createdBy.timezone, mrvisser.user.timezone);
                        assert.equal(fetchedFolder.createdBy.publicAlias, mrvisser.user.publicAlias);
                        assert.equal(fetchedFolder.createdBy.profilePath, mrvisser.user.profilePath);
                        assert.equal(fetchedFolder.createdBy.resourceType, mrvisser.user.resourceType);
                        assert.equal(fetchedFolder.createdBy.acceptedTC, mrvisser.user.acceptedTC);

                        // Ensure the initial roles are accurate, including the creator being a manager
                        var expectedRoles = {};
                        expectedRoles[stuartf.user.id] = 'manager';
                        expectedRoles[sathomas.user.id] = 'viewer';
                        expectedRoles[mrvisser.user.id] = 'manager';
                        return FoldersTestUtil.assertFullFolderMembersEquals(mrvisser.restContext, createdFolder.id, expectedRoles, callback);
                    });
                });
            });
        });

        /**
         * Test that verifies the validation of creating a folder
         */
        it('verify folder creation validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 3, function(err, users, mrvisser, stuartf, sathomas) {
                assert.ok(!err);

                // Ensure displayName is required
                FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, '', 'test description', 'private', [stuartf.user.id], [sathomas.user.id], 400, function() {
                    var longDisplayName = TestsUtil.generateRandomText(83);
                    assert.ok(longDisplayName.length > 1000);

                    // Ensure displayName must be less than 1000 characters
                    FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, longDisplayName, 'test description', 'private', [stuartf.user.id], [sathomas.user.id], 400, function() {
                        var longDescription = TestsUtil.generateRandomText(833);
                        assert.ok(longDescription.length > 10000);

                        // Ensure description must be less than 10000 characters
                        FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', longDescription, 'private', [stuartf.user.id], [sathomas.user.id], 400, function() {

                            // Ensure visibility must be valid
                            FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'notvalid', [stuartf.user.id], [sathomas.user.id], 400, function() {

                                // Ensure manager id must be a valid resource id
                                FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', ['notaresourceid'], [sathomas.user.id], 400, function() {

                                    // Ensure manager id must be a principal id
                                    FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', ['c:oaetest:contentid'], [sathomas.user.id], 400, function() {

                                        // Ensure manager id must be an existing principal id
                                        FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', ['u:oaetest:nonexistinguserid'], [sathomas.user.id], 400, function() {
                                            FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', ['g:oaetest:nonexistinggroupid'], [sathomas.user.id], 400, function() {

                                                // Ensure viewer id must be a valid resource id
                                                FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf.user.id], ['notaresourceid'], 400, function() {

                                                    // Ensure viewer id must be a principal id
                                                    FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf.user.id], ['c:oaetest:contentid'], 400, function() {

                                                        // Ensure viewer id must be an existing principal id
                                                        FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf.user.id], ['u:oaetest:nonexistinguserid'], 400, function() {
                                                            FoldersTestUtil.assertCreateFolderFails(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf.user.id], ['g:oaetest:nonexistinggroupid'], 400, function() {

                                                                // Sanity check that creating a folder works with base input
                                                                FoldersTestUtil.assertCreateFolderSucceeds(mrvisser.restContext, 'test displayName', 'test description', 'private', [stuartf], [sathomas], function() {
                                                                    return callback();
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the authorization of creating a folder and associating it with users
         */
        it('verify folder creation authorization', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant, privateTenant1) {

                // Ensure an anonymous user cannot create a folder
                FoldersTestUtil.assertCreateFolderFails(camAnonymousRestContext, 'test', 'test', 'private', null, null, 401, function() {

                    // Ensure a user cannot create a folder with a private user from the same tenant as a viewer
                    FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.loggedinUser.restContext, 'test', 'test', 'private', [publicTenant.publicUser], null, function() {
                        FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.loggedinUser], null, function() {
                            FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.privateUser.user.id], null, 400, function() {

                                // Ensure a user cannot create a folder with a loggedin or private user from another tenant as a viewer
                                FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant1.publicUser], null, function() {
                                    FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant1.loggedinUser.user.id], null, 400, function() {
                                        FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant1.privateUser.user.id], null, 400, function() {

                                            // Ensure a user cannot create a folder with any user from a private tenant as a viewer
                                            FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [privateTenant.publicUser.user.id], null, 400, function() {
                                                FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [privateTenant.loggedinUser.user.id], null, 400, function() {
                                                    FoldersTestUtil.assertCreateFolderFails(publicTenant.publicUser.restContext, 'test', 'test', 'private', [privateTenant.privateUser.user.id], null, 400, function() {

                                                        // Ensure a user from a private tenant cannot create a folder with any outside user
                                                        FoldersTestUtil.assertCreateFolderFails(privateTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.publicUser.user.id], null, 400, function() {
                                                            FoldersTestUtil.assertCreateFolderFails(privateTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.loggedinUser.user.id], null, 400, function() {
                                                                FoldersTestUtil.assertCreateFolderFails(privateTenant.publicUser.restContext, 'test', 'test', 'private', [publicTenant.privateUser.user.id], null, 400, function() {

                                                                    // Ensure an admin can create a folder with a private user from the same tenant as a viewer
                                                                    FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.publicUser], null, function() {
                                                                        FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.loggedinUser], null, function() {
                                                                            FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.privateUser], null, function() {

                                                                                // Ensure an admin cannot createa  folder with a loggedin or private user from another tenant as a viewer
                                                                                FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant1.publicUser], null, function() {
                                                                                    FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant1.loggedinUser.user.id], null, 400, function() {
                                                                                        FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [publicTenant1.privateUser.user.id], null, 400, function() {

                                                                                            // Ensure an admin cannot create a folder with any user from a private tenant as a viewer
                                                                                            FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [privateTenant.publicUser.user.id], null, 400, function() {
                                                                                                FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [privateTenant.loggedinUser.user.id], null, 400, function() {
                                                                                                    FoldersTestUtil.assertCreateFolderFails(publicTenant.adminRestContext, 'test', 'test', 'private', [privateTenant.privateUser.user.id], null, 400, function() {

                                                                                                        // Ensure an admin from a private tenant cannot create a folder with any outside user
                                                                                                        FoldersTestUtil.assertCreateFolderFails(privateTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.publicUser.user.id], null, 400, function() {
                                                                                                            FoldersTestUtil.assertCreateFolderFails(privateTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.loggedinUser.user.id], null, 400, function() {
                                                                                                                return FoldersTestUtil.assertCreateFolderFails(privateTenant.adminRestContext, 'test', 'test', 'private', [publicTenant.privateUser.user.id], null, 400, callback);
                                                                                                            });
                                                                                                        });
                                                                                                    });
                                                                                                });
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the visibility of a folder defaults to the tenant configuration
         */
        it('verify folder visibility defaults to the configured tenant default', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);

                // Ensure a folder created without a visibility defaults to public
                RestAPI.Folders.createFolder(mrvisser.restContext, 'test', 'test', null, null, null, function(err, createdFolder) {
                    assert.ok(!err);
                    assert.equal(createdFolder.visibility, 'public');

                    // Set the default privacy to private
                    ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, null, {'oae-folders/visibility/folder': 'private'}, function(err) {
                        assert.ok(!err);

                        // Ensure a folder created without a visibility now defaults to private
                        RestAPI.Folders.createFolder(mrvisser.restContext, 'test', 'test', null, null, null, function(err, createdFolder) {
                            assert.ok(!err);
                            assert.equal(createdFolder.visibility, 'private');
                            return callback();
                        });
                    });
                });
            });
        });
    });

    describe('Get Folder', function() {

        /**
         * Test that verifies validation of getting a folder
         */
        it('verify get folder validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Ensure fetching using an invalid id results in an error
                    FoldersTestUtil.assertGetFolderFails(mrvisser.restContext, 'invalidid', 400, function() {

                        // Ensure fetching using a non-existing id results in a 404
                        FoldersTestUtil.assertGetFolderFails(mrvisser.restContext, 'x:oaetest:nonexistingid', 404, function() {

                            // Sanity check getting an existing folder
                            FoldersTestUtil.assertGetFolderSucceeds(mrvisser.restContext, folder.id, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting a folder
         */
        it('verify get folder authorization', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Make the private user from a tenant a member of the private folder
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.privateUser], function(err) {

                    // Make the public user from a different tenant a member of a loggedin and private folder
                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant1.adminRestContext, publicTenant1.loggedinFolder.id, [publicTenant.publicUser], function(err) {
                        FoldersTestUtil.assertShareFolderSucceeds(publicTenant1.adminRestContext, publicTenant1.privateFolder.id, [publicTenant.publicUser], function(err) {

                            // Ensure user from same tenant can see public, loggedin but only private folders to which they have explicit access
                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, function() {
                                FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, function() {
                                    FoldersTestUtil.assertGetFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, 401, function() {
                                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.privateUser.restContext, publicTenant.privateFolder.id, function() {

                                            // Ensure user from different tenant can see public, but only loggedin and private to which they have explicit access
                                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.loggedinUser.restContext, publicTenant1.publicFolder.id, function() {
                                                FoldersTestUtil.assertGetFolderFails(publicTenant.loggedinUser.restContext, publicTenant1.loggedinFolder.id, 401, function() {
                                                    FoldersTestUtil.assertGetFolderFails(publicTenant.loggedinUser.restContext, publicTenant1.privateFolder.id, 401, function() {
                                                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant1.loggedinFolder.id, function() {
                                                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant1.privateFolder.id, function() {
                                                                return callback();
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies getting a full folder profile will scrub the creator of the folder appropriately
         */
        it('verify get folder scrubs creator user', function(callback) {
            // Setup multi-tenant privacy entities without folders or content. We only need
            // multi-tenant privacy users for this test
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Create a public folder as the private user
                FoldersTestUtil.assertCreateFolderSucceeds(publicTenant.privateUser.restContext, 'test', 'test', 'public', null, null, function(createdFolder) {

                    // Ensure the user themself gets the full creator profile when they get the folder
                    FoldersTestUtil.assertGetFolderSucceeds(publicTenant.privateUser.restContext, createdFolder.id, function(fetchedFolder) {
                        assert.ok(fetchedFolder.createdBy);
                        assert.equal(fetchedFolder.createdBy.tenant.alias, publicTenant.privateUser.user.tenant.alias);
                        assert.equal(fetchedFolder.createdBy.tenant.displayName, publicTenant.privateUser.user.tenant.displayName);
                        assert.equal(fetchedFolder.createdBy.id, publicTenant.privateUser.user.id);
                        assert.equal(fetchedFolder.createdBy.displayName, publicTenant.privateUser.user.displayName);
                        assert.equal(fetchedFolder.createdBy.visibility, publicTenant.privateUser.user.visibility);
                        assert.equal(fetchedFolder.createdBy.email, publicTenant.privateUser.user.email);
                        assert.equal(fetchedFolder.createdBy.locale, publicTenant.privateUser.user.locale);
                        assert.equal(fetchedFolder.createdBy.timezone, publicTenant.privateUser.user.timezone);
                        assert.equal(fetchedFolder.createdBy.publicAlias, publicTenant.privateUser.user.publicAlias);
                        assert.equal(fetchedFolder.createdBy.profilePath, publicTenant.privateUser.user.profilePath);
                        assert.equal(fetchedFolder.createdBy.resourceType, publicTenant.privateUser.user.resourceType);
                        assert.equal(fetchedFolder.createdBy.acceptedTC, publicTenant.privateUser.user.acceptedTC);

                        // Ensure an admin user gets the full creator profile when they get the folder
                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.adminRestContext, createdFolder.id, function(fetchedFolder) {
                            assert.ok(fetchedFolder.createdBy);
                            assert.equal(fetchedFolder.createdBy.tenant.alias, publicTenant.privateUser.user.tenant.alias);
                            assert.equal(fetchedFolder.createdBy.tenant.displayName, publicTenant.privateUser.user.tenant.displayName);
                            assert.equal(fetchedFolder.createdBy.id, publicTenant.privateUser.user.id);
                            assert.equal(fetchedFolder.createdBy.displayName, publicTenant.privateUser.user.displayName);
                            assert.equal(fetchedFolder.createdBy.visibility, publicTenant.privateUser.user.visibility);
                            assert.equal(fetchedFolder.createdBy.email, publicTenant.privateUser.user.email);
                            assert.equal(fetchedFolder.createdBy.locale, publicTenant.privateUser.user.locale);
                            assert.equal(fetchedFolder.createdBy.timezone, publicTenant.privateUser.user.timezone);
                            assert.equal(fetchedFolder.createdBy.publicAlias, publicTenant.privateUser.user.publicAlias);
                            assert.equal(fetchedFolder.createdBy.profilePath, publicTenant.privateUser.user.profilePath);
                            assert.equal(fetchedFolder.createdBy.resourceType, publicTenant.privateUser.user.resourceType);
                            assert.equal(fetchedFolder.createdBy.acceptedTC, publicTenant.privateUser.user.acceptedTC);

                            // Ensure another user from the tenant gets a scrubbed creator profile when they get the folder
                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.loggedinUser.restContext, createdFolder.id, function(fetchedFolder) {
                                assert.ok(fetchedFolder.createdBy);
                                assert.equal(fetchedFolder.createdBy.tenant.alias, publicTenant.privateUser.user.tenant.alias);
                                assert.equal(fetchedFolder.createdBy.tenant.displayName, publicTenant.privateUser.user.tenant.displayName);
                                assert.equal(fetchedFolder.createdBy.id, publicTenant.privateUser.user.id);
                                assert.equal(fetchedFolder.createdBy.displayName, publicTenant.privateUser.user.publicAlias);
                                assert.equal(fetchedFolder.createdBy.visibility, publicTenant.privateUser.user.visibility);
                                assert.ok(!fetchedFolder.createdBy.email);
                                assert.ok(!fetchedFolder.createdBy.locale);
                                assert.ok(!fetchedFolder.createdBy.timezone);
                                assert.ok(!fetchedFolder.createdBy.publicAlias);
                                assert.ok(!fetchedFolder.createdBy.profilePath);
                                assert.equal(fetchedFolder.createdBy.resourceType, publicTenant.privateUser.user.resourceType);
                                assert.strictEqual(fetchedFolder.createdBy.acceptedTC, undefined);
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the permission flags (e.g., `canShare`, `canAddItem`) of a full folder profile
         */
        it('verify get folder profile permission flags', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Create one more folder as the public user
                FoldersTestUtil.generateTestFolders(publicTenant.publicUser.restContext, 1, function(createdFolder) {

                    // Ensure permission flags for admin
                    FoldersTestUtil.assertGetFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, function(fetchedFolder) {
                        assert.strictEqual(fetchedFolder.canManage, true);
                        assert.strictEqual(fetchedFolder.canShare, true);
                        assert.strictEqual(fetchedFolder.canAddItem, true);

                        // Ensure permission flags for manager of a folder
                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, createdFolder.id, function(fetchedFolder) {
                            assert.strictEqual(fetchedFolder.canManage, true);
                            assert.strictEqual(fetchedFolder.canShare, true);
                            assert.strictEqual(fetchedFolder.canAddItem, true);

                            // Ensure permission flags for non-manager user on non-private folder
                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, function(fetchedFolder) {
                                assert.strictEqual(fetchedFolder.canManage, false);
                                assert.strictEqual(fetchedFolder.canShare, true);
                                assert.strictEqual(fetchedFolder.canAddItem, false);

                                // Ensure permission flags for non-manager user on private folder
                                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.publicUser], function() {
                                    FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, function(fetchedFolder) {
                                        assert.strictEqual(fetchedFolder.canManage, false);
                                        assert.strictEqual(fetchedFolder.canShare, false);
                                        assert.strictEqual(fetchedFolder.canAddItem, false);

                                        // Ensure permission flags for non-manager user in another public tenant
                                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, function(fetchedFolder) {
                                            assert.strictEqual(fetchedFolder.canManage, false);
                                            assert.strictEqual(fetchedFolder.canShare, true);
                                            assert.strictEqual(fetchedFolder.canAddItem, false);

                                            // Ensure permission flags for non-manager user in another private tenant
                                            FoldersTestUtil.assertGetFolderSucceeds(privateTenant.publicUser.restContext, publicTenant.publicFolder.id, function(fetchedFolder) {
                                                assert.strictEqual(fetchedFolder.canManage, false);
                                                assert.strictEqual(fetchedFolder.canShare, false);
                                                assert.strictEqual(fetchedFolder.canAddItem, false);
                                                return callback();
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Share Folder', function() {

        /**
         * Test that verifies sharing with multiple users gives all users access to the folder
         */
        it('verify sharing with multiple users gives all access to a folder', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant) {

                var userInfosToShare = [
                    publicTenant.publicUser,
                    publicTenant.loggedinUser,
                    publicTenant.privateUser
                ];

                // Give access to the private folder to a user
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, userInfosToShare, function() {

                    // Ensure the users can access the private folder
                    FoldersTestUtil.assertGetFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, function() {
                        FoldersTestUtil.assertGetFolderSucceeds(publicTenant.loggedinUser.restContext, publicTenant.privateFolder.id, function() {
                            FoldersTestUtil.assertGetFolderSucceeds(publicTenant.privateUser.restContext, publicTenant.privateFolder.id, function() {
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies sharing a folder with a manager does not demote them to viewer
         */
        it('verify sharing does not demote a member from manager to viewer', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Simon shares the folder with a manager
                    FoldersTestUtil.assertShareFolderSucceeds(simong.restContext, folder.id, [mrvisser], function() {

                        // Ensure mrvisser is still a manager
                        FoldersTestUtil.assertGetFolderSucceeds(mrvisser.restContext, folder.id, function(folder) {
                            assert.strictEqual(folder.canManage, true);
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation of sharing a folder
         */
        it('verify sharing validation', function(callback) {
            // Generate a user and a folder to test sharing with
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(camAdminRestContext, 1, function(folder) {

                    // Ensure a valid folder id must be provided
                    FoldersTestUtil.assertShareFolderFails(camAdminRestContext, 'notavalidid', [mrvisser.user.id], 400, function() {

                        // Ensure an existing folder id must be provided
                        FoldersTestUtil.assertShareFolderFails(camAdminRestContext, 'x:oaetest:nonexistingid', [mrvisser.user.id], 404, function() {

                            // Ensure a valid target principal id must be provided
                            FoldersTestUtil.assertShareFolderFails(camAdminRestContext, folder.id, ['notavalidid'], 400, function() {
                                FoldersTestUtil.assertShareFolderFails(camAdminRestContext, folder.id, ['c:oaetest:notaprincipalid'], 400, function() {

                                    // Ensure an existing target principal id must be provided
                                    FoldersTestUtil.assertShareFolderFails(camAdminRestContext, folder.id, ['u:oaetest:nonexistingid'], 400, function() {
                                        FoldersTestUtil.assertShareFolderFails(camAdminRestContext, folder.id, ['g:oaetest:nonexistingid'], 400, function() {

                                            // Sanity check we can share with the base input
                                            return FoldersTestUtil.assertShareFolderSucceeds(camAdminRestContext, folder.id, [mrvisser], callback);
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies an anonymous user cannot share a folder
         */
        it('verify anonymous user cannot share', function(callback) {
            // Generate a user and folder to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(camAdminRestContext, 1, function(folder) {

                    // Ensure anonymous cannot share with Simong
                    FoldersTestUtil.assertShareFolderFails(camAnonymousRestContext, folder.id, [simong.user.id], 401, function() {

                        // Sanity check mrvisser can share with Simong
                        return FoldersTestUtil.assertShareFolderSucceeds(mrvisser.restContext, folder.id, [simong], callback);
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of sharing a folder for a regular (non-member) user of the same tenant
         */
        it('verify sharing authorization for a regular user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure regular user can only share public and loggedin folders
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.loggedinUser], function() {
                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinUser], function() {
                        FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.loggedinUser.user.id], 401, function() {

                            // Ensure regular user cannot share with user profiles with which they cannot interact
                            FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.privateUser.user.id], 400, function() {
                                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant1.publicUser], function() {
                                    FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant1.loggedinUser.user.id], 400, function() {
                                        FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant1.privateUser.user.id], 400, function() {
                                            FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [privateTenant.publicUser.user.id], 400, function() {
                                                FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [privateTenant.loggedinUser.user.id], 400, function() {
                                                    return FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [privateTenant.privateUser.user.id], 400, callback);
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of sharing a folder for a regular (non-member) user of a different tenant
         */
        it('verify sharing authorization for a cross-tenant user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure regular cross-tenant user can only share public folders of another tenant
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicUser], function() {
                    FoldersTestUtil.assertShareFolderFails(publicTenant1.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.publicUser.user.id], 401, function() {
                        return FoldersTestUtil.assertShareFolderFails(publicTenant1.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.publicUser.user.id], 401, callback);
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of sharing a folder for a manager user
         */
        it('verify sharing authorization for a manager user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {
                // Make the public user a manager of the private folder
                FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, _memberUpdate(publicTenant.publicUser, 'manager'), function() {
                    // Ensure manager user can share all items in own tenant
                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.loggedinUser], function() {
                        FoldersTestUtil.assertShareFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinUser], function() {
                            FoldersTestUtil.assertShareFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.loggedinUser], function() {

                                // Ensure manager user cannot share with user profiles to which they cannot interact
                                FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant.privateUser.user.id], 400, function() {
                                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant1.publicUser], function() {
                                        FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant1.loggedinUser.user.id], 400, function() {
                                            FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [publicTenant1.privateUser.user.id], 400, function() {
                                                FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [privateTenant.publicUser.user.id], 400, function() {
                                                    FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [privateTenant.loggedinUser.user.id], 400, function() {
                                                        return FoldersTestUtil.assertShareFolderFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, [privateTenant.privateUser.user.id], 400, callback);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of sharing a folder for an administrative user
         */
        it('verify sharing authorization for an admin user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure admin user can share all items in own tenant
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.loggedinUser], function() {
                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinUser], function() {
                        FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.loggedinUser], function() {

                            // Ensure admin user cannot share with user profiles to which they cannot interact
                            FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.privateUser], function() {
                                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant1.publicUser], function() {
                                    FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant1.loggedinUser.user.id], 400, function() {
                                        FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant1.privateUser.user.id], 400, function() {
                                            FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.privateFolder.id, [privateTenant.publicUser.user.id], 400, function() {
                                                FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.privateFolder.id, [privateTenant.loggedinUser.user.id], 400, function() {
                                                    return FoldersTestUtil.assertShareFolderFails(publicTenant.adminRestContext, publicTenant.privateFolder.id, [privateTenant.privateUser.user.id], 400, callback);
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Get Folder Members', function() {

        /**
         * Test that verifies getting the members of a folder will return all viewers and managers of the folder
         */
        it('verify get folder members gets all viewers and managers', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 16, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {
                    users = _.values(users);

                    var managerUsers = users.slice(0, 8);
                    var viewerUsers = users.slice(8);

                    var memberUpdates = {};
                    var expectedMembership = {};
                    _.each(managerUsers, function(managerUser) {
                        expectedMembership[managerUser.user.id] = 'manager';
                        memberUpdates[managerUser.user.id] = _.extend({}, managerUser, {'role': 'manager'});
                    });

                    var viewerMemberUpdates = {};
                    _.each(viewerUsers, function(viewerUser) {
                        expectedMembership[viewerUser.user.id] = 'viewer';
                        memberUpdates[viewerUser.user.id] = _.extend({}, viewerUser, {'role': 'viewer'});
                    });

                    // Apply the roles
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(camAdminRestContext, folder.id, memberUpdates, function() {

                        // Ensure all the users have been set
                        return FoldersTestUtil.assertFullFolderMembersEquals(mrvisser.restContext, folder.id, expectedMembership, callback);
                    });
                });
            });
        });

        /**
         * Test that verifies validation of getting folder members
         */
        it('verify get folder members validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 16, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(camAdminRestContext, 1, function(folder) {
                    var memberUpdates = {};
                    _.each(users, function(user, userId) {
                        memberUpdates[userId] = _.extend({}, user, {'role': 'viewer'});
                    });

                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(camAdminRestContext, folder.id, memberUpdates, function() {

                        // Ensure the folder id must be a valid resource id
                        FoldersTestUtil.assertGetFolderMembersFails(mrvisser.restContext, 'notavalidid', null, null, 400, function() {

                            // Ensure the folder must exist
                            FoldersTestUtil.assertGetFolderMembersFails(mrvisser.restContext, 'x:oaetest:nonexistingid', null, null, 404, function() {

                                // Ensure limit has a minimum of 1
                                FoldersTestUtil.assertGetFolderMembersSucceeds(mrvisser.restContext, folder.id, null, 0, function(result) {
                                    assert.strictEqual(result.results.length, 1);

                                    // Ensure limit defaults to 10
                                    FoldersTestUtil.assertGetFolderMembersSucceeds(mrvisser.restContext, folder.id, null, null, function(result) {
                                        assert.strictEqual(result.results.length, 10);

                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting folder members
         */
        it('verify get folder members authorization', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Ensure access for anonymous user
                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.anonymousRestContext, publicTenant.publicFolder.id, null, null, function() {
                    FoldersTestUtil.assertGetFolderMembersFails(publicTenant.anonymousRestContext, publicTenant.loggedinFolder.id, null, null, 401, function() {
                        FoldersTestUtil.assertGetFolderMembersFails(publicTenant.anonymousRestContext, publicTenant.privateFolder.id, null, null, 401, function() {

                            // Ensure access for authenticated user
                            FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, null, null, function() {
                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinFolder.id, null, null, function() {
                                    FoldersTestUtil.assertGetFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, null, null, 401, function() {

                                        // Ensure access for admin user
                                        FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, null, null, function() {
                                            FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, null, null, function() {
                                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, null, null, function() {

                                                    // Ensure access for cross-tenant user
                                                    FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant1.publicUser.restContext, publicTenant.publicFolder.id, null, null, function() {
                                                        FoldersTestUtil.assertGetFolderMembersFails(publicTenant1.publicUser.restContext, publicTenant.loggedinFolder.id, null, null, 401, function() {
                                                            FoldersTestUtil.assertGetFolderMembersFails(publicTenant1.publicUser.restContext, publicTenant.privateFolder.id, null, null, 401, function() {

                                                                // Ensure access for cross-tenant admin user
                                                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant1.adminRestContext, publicTenant.publicFolder.id, null, null, function() {
                                                                    FoldersTestUtil.assertGetFolderMembersFails(publicTenant1.adminRestContext, publicTenant.loggedinFolder.id, null, null, 401, function() {
                                                                        FoldersTestUtil.assertGetFolderMembersFails(publicTenant1.adminRestContext, publicTenant.privateFolder.id, null, null, 401, function() {

                                                                            // Give a same-tenant user access to the private folder
                                                                            FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.publicUser], function() {

                                                                                // Ensure same-tenant user with access can now view the private folder members
                                                                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.privateFolder.id, null, null, function() {

                                                                                    // Give a cross-tenant user access to the loggedin and private folders
                                                                                    FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant1.publicUser], function() {
                                                                                        FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant1.publicUser], function() {

                                                                                            // Ensure the cross-tenant user can now see the loggedin and private folders with explicit access
                                                                                            FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant1.publicUser.restContext, publicTenant.loggedinFolder.id, null, null, function() {
                                                                                                FoldersTestUtil.assertGetFolderMembersSucceeds(publicTenant1.publicUser.restContext, publicTenant.privateFolder.id, null, null, function() {
                                                                                                    return callback();
                                                                                                });
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verififes paging through the list of folder members
         */
        it('verify get folder members paging', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 16, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {
                    // Make all 16 users (except mrvisser, of course) a viewer
                    var memberUpdates = {};
                    _.each(users, function(user, userId) {
                        if (userId !== mrvisser.user.id) {
                            memberUpdates[userId] = _.extend({}, user, {'role': 'viewer'});
                        }
                    });

                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, folder.id, memberUpdates, function() {

                        // Fetch batches of 1 and ensure we get them all
                        FoldersTestUtil.getAllFolderMembers(mrvisser.restContext, folder.id, {'batchSize': 1}, function(members, responses) {
                            assert.strictEqual(members.length, 16);

                            // Ensure all members came from the users folder and that they all have the proper role
                            _.each(members, function(member) {
                                assert.ok(users[member.profile.id]);
                                if (member.profile.id === mrvisser.user.id) {
                                    assert.strictEqual(member.role, 'manager');
                                } else {
                                    assert.strictEqual(member.role, 'viewer');
                                }
                            });

                            // Ensure we made 17 requests to get the users and they all had exactly 1 member (the 17th request
                            // is an empty one since `nextToken` does not use any look-ahead)
                            assert.strictEqual(responses.length, 17);
                            _.each(responses.slice(0, -1), function(response) {
                                assert.strictEqual(response.results.length, 1);
                            });
                            assert.strictEqual(_.last(responses).results.length, 0);
                            assert.strictEqual(_.last(responses).nextToken, null);

                            // Fetch batches of 3 and ensure we get them all
                            FoldersTestUtil.getAllFolderMembers(mrvisser.restContext, folder.id, {'batchSize': 3}, function(members, responses) {
                                assert.strictEqual(members.length, 16);

                                // Ensure all members came from the users folder and that they all have the proper role
                                _.each(members, function(member) {
                                    assert.ok(users[member.profile.id]);
                                    if (member.profile.id === mrvisser.user.id) {
                                        assert.strictEqual(member.role, 'manager');
                                    } else {
                                        assert.strictEqual(member.role, 'viewer');
                                    }
                                });

                                // Ensure we made 6 requests to get the users and they all had the proper amount
                                // of users
                                assert.strictEqual(responses.length, 6);

                                // All but the last have 3
                                _.each(responses.slice(0, -1), function(response) {
                                    assert.strictEqual(response.results.length, 3);
                                });

                                // The last has 1 member and a null `nextToken`
                                assert.strictEqual(_.last(responses).results.length, 1);
                                assert.strictEqual(_.last(responses).nextToken, null);

                                // Fetch a batch of 16 and ensure we get them all
                                FoldersTestUtil.getAllFolderMembers(mrvisser.restContext, folder.id, {'batchSize': 16}, function(members, responses) {
                                    assert.strictEqual(members.length, 16);

                                    // Ensure all members came from the users folder and that they all have the proper role
                                    _.each(members, function(member) {
                                        assert.ok(users[member.profile.id]);
                                        if (member.profile.id === mrvisser.user.id) {
                                            assert.strictEqual(member.role, 'manager');
                                        } else {
                                            assert.strictEqual(member.role, 'viewer');
                                        }
                                    });

                                    // Ensure we made 1 request to get the users and it had 16. The second request is an empty
                                    // one since `nextToken` does not use any look-ahead
                                    assert.strictEqual(responses.length, 2);
                                    assert.strictEqual(responses[0].results.length, 16);
                                    assert.strictEqual(responses[1].results.length, 0);
                                    assert.strictEqual(responses[1].nextToken, null);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies private user profiles are scrubbed in content members lists
         */
        it('verify folder members are scrubbed in the members list', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant) {

                // Put a private user in the members list of a folder
                FoldersTestUtil.assertShareFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.privateUser, publicTenant.publicUser], function() {

                    // The public user now looks at the members list of the public folder
                    FoldersTestUtil.getAllFolderMembers(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, null, function(members) {
                        // There should be 2 members, get the private user and ensure the profile is scrubbed
                        var privateMember = _.chain(members)
                            .pluck('profile')
                            .findWhere({'visibility': 'private'})
                            .value();

                        assert.strictEqual(privateMember.displayName, publicTenant.privateUser.user.publicAlias);
                        assert.ok(publicTenant.privateUser.user.profilePath);
                        assert.ok(!privateMember.profilePath);
                        return callback();
                    });
                });
            });
        });
    });

    describe('Set Folder Members', function() {

        /**
         * Test that verifies viewers and managers can be set on and removed from a folder
         */
        it('verify viewers and managers can be set on and removed from a folder', function(callback) {
            // Create test users and a folder to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.assertCreateFolderSucceeds(mrvisser.restContext, 'test', 'test', 'private', null, null, function(folder) {

                    // Ensure Bert can be made a viewer
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, folder.id, _memberUpdate(bert), function() {

                        // Ensure Bert can view the folder
                        FoldersTestUtil.assertGetFolderSucceeds(bert.restContext, folder.id, function() {

                            // Ensure Bert can be removed from the members list
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, folder.id, _memberUpdate(bert, false), function() {

                                // Ensure Bert can no longer view the folder
                                FoldersTestUtil.assertGetFolderFails(bert.restContext, folder.id, 401, function() {

                                    // Ensure Bert can be made a manager
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, folder.id, _memberUpdate(bert, 'manager'), function() {

                                        // Ensure Bert can view the folder once again
                                        FoldersTestUtil.assertGetFolderSucceeds(bert.restContext, folder.id, function() {

                                            // Ensure Bert can now demote mrvisser to viewer, O noez!
                                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(bert.restContext, folder.id, _memberUpdate(mrvisser), function() {

                                                // Ensure mrvisser can no longer update the permissions
                                                return FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, folder.id, _memberUpdate(bert.user.id, 'manager'), 401, callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies a folder cannot be left without a manager
         */
        it('verify a folder cannot be left with no managers', function(callback) {
            // Create test users and a folder to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 5, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Try and make all the users viewer, including the creator mrvisser
                    var memberUpdates = {};
                    _.each(users, function(user, userId) {
                        memberUpdates[userId] = 'viewer';
                    });

                    FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, folder.id, memberUpdates, 400, function() {
                        memberUpdates[bert.user.id] = 'manager';

                        // Build an update that sets bert as manager and mrvisser as viewer
                        var memberUpdateInfos = {};
                        _.each(users, function(user, userId) {
                            memberUpdateInfos[userId] = _.extend({}, user, {'role': 'viewer'});
                        });
                        memberUpdateInfos[bert.user.id].role = 'manager';

                        // Ensure mrvisser can still update the members, and changing bert to manager while demoting himself is fair game
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, folder.id, memberUpdateInfos, function() {

                            // Ensure bert cannot remove himself as that would now result in no manager
                            return FoldersTestUtil.assertUpdateFolderMembersFails(bert.restContext, folder.id, _memberUpdate(bert.user.id, false), 400, callback);
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies a viewer cannot promote themselves to manager
         */
        it('verify a viewer cannot promote themselves to manager', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Make Bert a member
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, folder.id, _memberUpdate(bert), function() {

                        // Ensure Bert can't promote himself to manager
                        return FoldersTestUtil.assertUpdateFolderMembersFails(bert.restContext, folder.id, _memberUpdate(bert.user.id, 'manager'), 401, callback);
                    });
                });
            });
        });

        /**
         * Test that verifies validation of setting folder members
         */
        it('verify set folder members validation', function(callback) {
            // Generate a test user and folder for testing validation
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {
                    // Ensure folder id must be a valid resource id
                    FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, 'notavalidid', _memberUpdate(bert.user.id), 400, function() {

                        // Ensure folder id must exist
                        FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, 'x:oaetest:nonexistingid', _memberUpdate(bert.user.id), 404, function() {

                            // Ensure one member update must be specified
                            FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, folder.id, {}, 400, function() {

                                // Ensure members must be valid principal ids
                                FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, folder.id, {'notavalidid': 'viewer'}, 400, function() {
                                    FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, folder.id, {'c:oaetest:notaprincipalid': 'viewer'}, 400, function() {

                                        // Ensure members must be existing principal ids
                                        FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, folder.id, {'u:oaetest:nonexistingid': 'viewer'}, 400, function() {
                                            FoldersTestUtil.assertUpdateFolderMembersFails(mrvisser.restContext, folder.id, {'g:oaetest:nonexistingid': 'viewer'}, 400, function() {

                                                // Sanity check the base input works
                                                return FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, folder.id, _memberUpdate(bert), callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies anonymous users cannot set members on a folder
         */
        it('verify an anonymous user cannot set folder members', function(callback) {
            // Generate a test user and folder to test with
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, bert) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Ensure anonymous cannot set the members
                    FoldersTestUtil.assertUpdateFolderMembersFails(camAnonymousRestContext, folder.id, _memberUpdate(bert.user.id), 401, function() {

                        // Sanity check mrvisser can perform the same share
                        return FoldersTestUtil.assertUpdateFolderMembersSucceeds(mrvisser.restContext, folder.id, _memberUpdate(bert), callback);
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of setting folder members as an administrative user
         */
        it('verify set folder members authorization for an admin user', function(callback) {
            // Setup folders and users for different visibilities and tenants
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {
                // Create an extra folder that is not managed by an admin user
                FoldersTestUtil.generateTestFolders(publicTenant.publicUser.restContext, 1, function(folder) {

                    // Ensure admin can set members a folder they don't explicitly manage
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, folder.id, _memberUpdate(publicTenant.loggedinUser, 'manager'), function() {

                        // Ensure admin cannot set members for user profiles with which they cannot interact
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(publicTenant.privateUser), function() {
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(publicTenant1.publicUser), function() {
                                FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(publicTenant1.loggedinUser.user.id), 400, function() {
                                    FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(publicTenant1.privateUser.user.id), 400, function() {
                                        FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(privateTenant.publicUser.user.id), 400, function() {
                                            FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(privateTenant.loggedinUser.user.id), 400, function() {
                                                return FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, _memberUpdate(privateTenant.privateUser.user.id), 400, callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of setting members on a folder as a regular user
         */
        it('verify set folder members authorization for a regular user', function(callback) {
            // Setup folders and users for different visibilities and tenants
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure the user cannot set members a folder they don't explicitly manage
                FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.loggedinUser.user.id), 401, function() {

                    // Make the user a viewer and ensure they still can't set permissions
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.publicUser), function() {
                        FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.loggedinUser.user.id), 401, function() {

                            // Make the user a manager so they can update permissions
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.publicUser, 'manager'), function() {

                                // Ensure the manager user cannot set members for user profiles with which they cannot interact
                                FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant.privateUser.user.id), 400, function() {
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant1.publicUser), function() {
                                        FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant1.loggedinUser.user.id), 400, function() {
                                            FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(publicTenant1.privateUser.user.id), 400, function() {
                                                FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(privateTenant.publicUser.user.id), 400, function() {
                                                    FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(privateTenant.loggedinUser.user.id), 400, function() {
                                                        return FoldersTestUtil.assertUpdateFolderMembersFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, _memberUpdate(privateTenant.privateUser.user.id), 400, callback);
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Get Folders Library', function() {

        /**
         * Test that verifies getting a folders library returns the proper library visibility
         */
        it('verify users get the appropriate folders library visibility', function(callback) {
            // Generate users from a variety of tenants, as well as a library of public, loggedin and private folders for a user
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {
                FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant.publicUser.restContext, 3, 'public', function(publicFolder1, publicFolder2, publicFolder3) {
                    FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant.publicUser.restContext, 3, 'loggedin', function(loggedinFolder1, loggedinFolder2, loggedinFolder3) {
                        FoldersTestUtil.generateTestFoldersWithVisibility(publicTenant.publicUser.restContext, 3, 'private', function(privateFolder1, privateFolder2, privateFolder3) {
                            var publicFolderIds = _.pluck([publicFolder1, publicFolder2, publicFolder3], 'id');
                            var loggedinFolderIds = _.pluck([loggedinFolder1, loggedinFolder2, loggedinFolder3], 'id');
                            var privateFolderIds = _.pluck([privateFolder1, privateFolder2, privateFolder3], 'id');

                            var expectedPublicFoldersLibraryIds = publicFolderIds.slice();
                            var expectedLoggedinFoldersLibraryIds = _.union(publicFolderIds, loggedinFolderIds);
                            var expectedPrivateFoldersLibraryIds = _.chain(publicFolderIds).union(loggedinFolderIds).union(privateFolderIds).value();

                            // Ensure the user themself gets the private library
                            FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant.publicUser.restContext, publicTenant.publicUser.user.id, expectedPrivateFoldersLibraryIds, false, function() {

                                // Ensure admin gets the private library as well
                                FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant.adminRestContext, publicTenant.publicUser.user.id, expectedPrivateFoldersLibraryIds, false, function() {

                                    // Ensure authenticated user gets the loggedin library
                                    FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant.loggedinUser.restContext, publicTenant.publicUser.user.id, expectedLoggedinFoldersLibraryIds, false, function() {

                                        // Ensure admin from another tenant gets the public library
                                        FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant1.adminRestContext, publicTenant.publicUser.user.id, expectedPublicFoldersLibraryIds, false, function() {

                                            // Ensure authenticated user from another tenant gets the public library
                                            FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant1.publicUser.restContext, publicTenant.publicUser.user.id, expectedPublicFoldersLibraryIds, false, function() {

                                                // Ensure anonymous user gets the public library
                                                return FoldersTestUtil.assertFullFoldersLibraryEquals(publicTenant.anonymousRestContext, publicTenant.publicUser.user.id, expectedPublicFoldersLibraryIds, false, callback);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting a public user library
         */
        it('verify get folders library authorization for public user library', function(callback) {
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Ensure authorization of public user library
                FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.anonymousRestContext, publicTenant.publicUser.user.id, null, null, function() {
                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.adminRestContext, publicTenant.publicUser.user.id, null, null, function() {
                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.publicUser.restContext, publicTenant.publicUser.user.id, null, null, function() {
                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.loggedinUser.restContext, publicTenant.publicUser.user.id, null, null, function() {
                                FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant1.publicUser.restContext, publicTenant.publicUser.user.id, null, null, function() {
                                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant1.adminRestContext, publicTenant.publicUser.user.id, null, null, function() {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting a loggedin user library
         */
        it('verify get folders library authorization for loggedin user library', function(callback) {
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Ensure authorization of public user library
                FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant.anonymousRestContext, publicTenant.loggedinUser.user.id, null, null, 401, function() {
                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.adminRestContext, publicTenant.loggedinUser.user.id, null, null, function() {
                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.publicUser.restContext, publicTenant.loggedinUser.user.id, null, null, function() {
                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.loggedinUser.restContext, publicTenant.loggedinUser.user.id, null, null, function() {
                                FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant1.publicUser.restContext, publicTenant.loggedinUser.user.id, null, null, 401, function() {
                                    FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant1.adminRestContext, publicTenant.loggedinUser.user.id, null, null, 401, function() {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization of getting a private user library
         */
        it('verify get folders library authorization for private user library', function(callback) {
            TestsUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {

                // Ensure authorization of public user library
                FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant.anonymousRestContext, publicTenant.privateUser.user.id, null, null, 401, function() {
                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.adminRestContext, publicTenant.privateUser.user.id, null, null, function() {
                        FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant.publicUser.restContext, publicTenant.privateUser.user.id, null, null, 401, function() {
                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(publicTenant.privateUser.restContext, publicTenant.privateUser.user.id, null, null, function() {
                                FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant1.publicUser.restContext, publicTenant.privateUser.user.id, null, null, 401, function() {
                                    FoldersTestUtil.assertGetFoldersLibraryFails(publicTenant1.adminRestContext, publicTenant.privateUser.user.id, null, null, 401, function() {
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies validation of getting a folders library
         */
        it('verify get folders library validation', function(callback) {
            // Generate a user and give them more than 25 folders in their folders library
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 30, function() {

                    // Ensure we must provide a valid and existing principal id
                    FoldersTestUtil.assertGetFoldersLibraryFails(mrvisser.restContext, 'notavalidid', null, 15, 400, function() {
                        FoldersTestUtil.assertGetFoldersLibraryFails(mrvisser.restContext, 'c:oaetest:notaprincipalid', null, 15, 400, function() {
                            FoldersTestUtil.assertGetFoldersLibraryFails(mrvisser.restContext, 'g:oaetest:nonexistingid', null, 15, 404, function() {
                                FoldersTestUtil.assertGetFoldersLibraryFails(mrvisser.restContext, 'u:oaetest:nonexistingid', null, 15, 404, function() {

                                    // Ensure limit is greater than or equal to 1, less than or equal to 25, and defaults to 10
                                    FoldersTestUtil.assertGetFoldersLibrarySucceeds(mrvisser.restContext, mrvisser.user.id, null, 0, function(result) {
                                        assert.strictEqual(result.results.length, 1);
                                        FoldersTestUtil.assertGetFoldersLibrarySucceeds(mrvisser.restContext, mrvisser.user.id, null, null, function(result) {
                                            assert.strictEqual(result.results.length, 12);
                                            FoldersTestUtil.assertGetFoldersLibrarySucceeds(mrvisser.restContext, mrvisser.user.id, null, 100, function(result) {
                                                assert.strictEqual(result.results.length, 25);

                                                // Ensure the base input provides the expected results
                                                FoldersTestUtil.assertGetFoldersLibrarySucceeds(mrvisser.restContext, mrvisser.user.id, null, 15, function(result) {
                                                    assert.strictEqual(result.results.length, 15);
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies paging of the folders library
         */
        it('verify get folders library paging', function(callback) {
            // Generate a user and give them enough folders in their library to page through
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 16, function() {

                    // Page items by 1 and ensure we get them all with the correct number of requests
                    FoldersTestUtil.getAllFoldersInLibrary(mrvisser.restContext, mrvisser.user.id, {'batchSize': 1}, function(folders, responses) {
                        assert.strictEqual(folders.length, 16);

                        // Ensure there are 16 responses for each request, plus 1 empty one to
                        // indicate that the library items are exhausted
                        assert.strictEqual(responses.length, 17);
                        assert.strictEqual(_.last(responses).results.length, 0);
                        assert.strictEqual(_.last(responses).nextToken, null);

                        // Page items by 3 and ensure we get them all with the correct number of requests
                        FoldersTestUtil.getAllFoldersInLibrary(mrvisser.restContext, mrvisser.user.id, {'batchSize': 3}, function(folders, responses) {
                            assert.strictEqual(folders.length, 16);

                            // Ensure there are 6 responses for each request, where the final one
                            // has only 1 element and indicates the list is exhausted
                            assert.strictEqual(responses.length, 6);
                            assert.strictEqual(_.last(responses).results.length, 1);
                            assert.strictEqual(_.last(responses).nextToken, null);

                            // Page items by the full amount and ensure we get them all with the correct number of requests
                            FoldersTestUtil.getAllFoldersInLibrary(mrvisser.restContext, mrvisser.user.id, {'batchSize': 16}, function(folders, responses) {
                                assert.strictEqual(folders.length, 16);

                                // Ensure there is 1 response for the request to get all, plus 1
                                // empty one that indicates the list is exhausted
                                assert.strictEqual(responses.length, 2);
                                assert.strictEqual(_.last(responses).results.length, 0);
                                assert.strictEqual(_.last(responses).nextToken, null);

                                // Page items by greater than the full amount and ensure we get them all with the correct number of requests
                                FoldersTestUtil.getAllFoldersInLibrary(mrvisser.restContext, mrvisser.user.id, {'batchSize': 17}, function(folders, responses) {
                                    assert.strictEqual(folders.length, 16);

                                    // Ensure there is 1 response with all the folders
                                    assert.strictEqual(responses.length, 1);
                                    assert.strictEqual(_.last(responses).results.length, 16);
                                    assert.strictEqual(_.last(responses).nextToken, null);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Add Items to Folder', function() {

        /**
         * Test that verifies adding a single item to a folder succeeds
         */
        it('verify adding a single item to a folder', function(callback) {
            // Generate a user and give them a folder
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Create a content item that mrvisser will add to his folder
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, function(err, link) {
                        assert.ok(!err);

                        // Ensure Mrvisser can add the item to his folder
                        return FoldersTestUtil.assertAddContentItemsToFolderSucceeds(mrvisser.restContext, folder.id, [link.id], callback);
                    });
                });
            });
        });

        /**
         * Test that verifies adding multiple content items to a folder succeeds
         */
        it('verify adding multiple items to a folder', function(callback) {
            // Generate a user and give them a folder
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {

                    // Create 5 content items to add to the folder
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, function(err, link1) {
                        assert.ok(!err);
                        RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, function(err, link2) {
                            assert.ok(!err);
                            RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, function(err, link3) {
                                assert.ok(!err);
                                RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, function(err, link4) {
                                    assert.ok(!err);
                                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, null, function(err, link5) {
                                        assert.ok(!err);

                                        // Ensure Mrvisser can add all the items to his folder
                                        return FoldersTestUtil.assertAddContentItemsToFolderSucceeds(mrvisser.restContext, folder.id, [link1.id, link2.id, link3.id, link4.id, link5.id], callback);
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies both managers and administrators can add content items to a folder
         */
        it('verify only administrators and managers of folders can add content items to them', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1) {
                RestAPI.User.getMe(publicTenant.adminRestContext, function(err, publicTenantAdminMe) {
                    assert.ok(!err);

                    // Ensure anonymous, regular user, admin from another tenant all cannot add a content item to the folder
                    FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.anonymousRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {
                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {
                            FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant1.adminRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], 401, function() {

                                // Ensure the folder still has no items
                                FoldersTestUtil.getAllFolderContentItems(publicTenant.adminRestContext, publicTenant.publicFolder.id, null, function(contentItems) {
                                    assert.ok(_.isEmpty(contentItems));

                                    // Add public user as a manager of the folder and remove admin as a manager
                                    var memberUpdates = _memberUpdate(publicTenant.publicUser, 'manager');
                                    memberUpdates[publicTenantAdminMe.id] = false;
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, memberUpdates, function() {

                                        // Ensure public user and admin can both add an item to the folder
                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], function() {
                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.loggedinContent.id], function() {

                                                // Ensure the folder now has 2 items
                                                FoldersTestUtil.getAllFolderContentItems(publicTenant.publicUser.restContext, publicTenant.publicFolder.id, null, function(contentItems) {
                                                    assert.strictEqual(contentItems.length, 2);
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization for an administrator adding a content item to a folder
         */
        it('verify add items to folder authorization for an administrator', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {
                RestAPI.User.getMe(publicTenant.adminRestContext, function(err, publicTenantAdminMe) {
                    assert.ok(!err);

                    // Admin removes themself from managing each folder while adding a user. This is
                    // to ensure the test is accurate by admin having no explicit manage access
                    var memberUpdates = _memberUpdate(publicTenant.publicUser, 'manager');
                    memberUpdates[publicTenantAdminMe.id] = false;
                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, memberUpdates, function() {
                        FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, memberUpdates, function() {
                            FoldersTestUtil.assertUpdateFolderMembersSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, memberUpdates, function() {

                                // Ensure admin can add the public, loggedin and private content items of their tenant to all the folders in their tenant
                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], function() {
                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.loggedinContent.id], function() {
                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.privateContent.id], function() {
                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.publicContent.id], function() {
                                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinContent.id], function() {
                                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.privateContent.id], function() {
                                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.publicContent.id], function() {
                                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.loggedinContent.id], function() {
                                                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.privateContent.id], function() {

                                                                    // Ensure admin can add only the public content item from another public tenant to a folder
                                                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.publicContent.id], function() {
                                                                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.loggedinContent.id], 400, function() {
                                                                            FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.privateContent.id], 400, function() {

                                                                                // Ensure admin cannot add any content item from another private tenant to a folder
                                                                                FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.publicContent.id], 400, function() {
                                                                                    FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.loggedinContent.id], 400, function() {
                                                                                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.privateContent.id], 400, function() {
                                                                                            return callback();
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies authorization for an authenticated user adding a content item to a folder
         */
        it('verify add items to folder authorization for an authenticated user', function(callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant) {

                // Ensure a user can add the public and loggedin content items of their tenant to the folder
                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.publicContent.id], function() {
                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.loggedinContent.id], function() {
                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant.privateContent.id], function() {
                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.publicContent.id], function() {
                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.loggedinContent.id], function() {
                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.loggedinFolder.id, [publicTenant.privateContent.id], function() {
                                        FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.publicContent.id], function() {
                                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.loggedinContent.id], function() {
                                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.privateFolder.id, [publicTenant.privateContent.id], function() {

                                                    // Ensure admin can add only the public content item from another public tenant to a folder
                                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.publicContent.id], function() {
                                                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.loggedinContent.id], 400, function() {
                                                            FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [publicTenant1.privateContent.id], 400, function() {

                                                                // Ensure admin cannot add any content item from another private tenant to a folder
                                                                FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.publicContent.id], 400, function() {
                                                                    FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.loggedinContent.id], 400, function() {
                                                                        FoldersTestUtil.assertAddContentItemsToFolderFails(publicTenant.adminRestContext, publicTenant.publicFolder.id, [privateTenant.privateContent.id], 400, function() {
                                                                            return callback();
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies adding a content item to a folder allows permissions to propagate to the content
         * item from the folder's members
         */
        it('verify folders propagate user permission to content items that belong to them', function(callback) {
            // Create mrvisser, a folder that he manages, and a private content item that he does not have access to
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 1, function(folder) {
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'private', 'http://www.google.ca', null, null, function(err, link) {
                        assert.ok(!err);

                        // Sanity check that mrvisser has no access to the content item
                        RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                            assert.ok(err);
                            assert.strictEqual(err.code, 401);

                            // Add the link to the folder
                            FoldersTestUtil.assertAddContentItemsToFolderSucceeds(camAdminRestContext, folder.id, [link.id], function() {

                                // Ensure that Mrvisser now has access to view the link
                                RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                                    assert.ok(!err);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies folders propagate group permission to content items that belong to them
         */
        it('verify folders propagate group permission to content items that belong to them', function(callback) {
            // Generate 2 test users and folder. mrvisser will be given access to the private link via a group and folder permissions chain
            TestsUtil.generateTestUsers(camAdminRestContext, 2, function(err, users, mrvisser, simong) {
                assert.ok(!err);
                FoldersTestUtil.generateTestFolders(camAdminRestContext, 1, function(folder) {

                    // Create the private link to which will give mrvisser access VIA group and folder permissions chain
                    RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'private', 'http://www.google.ca', null, null, function(err, link) {
                        assert.ok(!err);

                        // Generate an hierarchy of groups through which access will be propagated down to the user
                        TestsUtil.generateTestGroups(camAdminRestContext, 3, function(group1, group2, group3) {
                            TestsUtil.generateGroupHierarchy(camAdminRestContext, [group1.group.id, group2.group.id, group3.group.id, mrvisser.user.id], 'member', function(err) {
                                assert.ok(!err);

                                // Add simong to the parent group to sanity check permissions will not propagate the wrong way through groups
                                RestAPI.Group.setGroupMembers(camAdminRestContext, group1.group.id, _memberUpdate(simong.user.id), function(err) {
                                    assert.ok(!err);

                                    // Add group2 as a member of the folder. This implies that group1 and it's members (the parent of group2) will not receive
                                    // access when the link is added to the folder
                                    FoldersTestUtil.assertUpdateFolderMembersSucceeds(camAdminRestContext, folder.id, _memberUpdate(group2), function() {

                                        // Sanity check that mrvisser and simong both have no access to the content item because it has not yet been added to the
                                        // folder to complete the permission chain
                                        RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                                            assert.ok(err);
                                            assert.strictEqual(err.code, 401);
                                            RestAPI.Content.getContent(simong.restContext, link.id, function(err) {
                                                assert.ok(err);
                                                assert.strictEqual(err.code, 401);

                                                // Finally add the link to the folder
                                                FoldersTestUtil.assertAddContentItemsToFolderSucceeds(camAdminRestContext, folder.id, [link.id], function() {

                                                    // Ensure mrvisser now has access by permission chain: link -> folder -> group1 -> group2 -> group3 -> mrvisser
                                                    RestAPI.Content.getContent(mrvisser.restContext, link.id, function(err) {
                                                        assert.ok(!err);

                                                        // Sanity check that the reverse chain did not propagate access to simong
                                                        RestAPI.Content.getContent(simong.restContext, link.id, function(err) {
                                                            assert.ok(err);
                                                            assert.strictEqual(err.code, 401);
                                                            return callback();
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });

    describe('Content Integration', function() {

        it('verify a content item that belongs to folders and has groups as members can list their members', function(callback) {
            // Create a test user with which to do stuff
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, mrvisser) {
                assert.ok(!err);

                // Create a few folders that a content item will be added to
                FoldersTestUtil.generateTestFolders(mrvisser.restContext, 3, function() {
                    var folderIds = _.pluck(arguments, 'id');

                    // Create a few groups that will be added as a member of the content item
                    TestsUtil.generateTestGroups(mrvisser.restContext, 3, function() {
                        var groupIds = _.chain(arguments).pluck('group').pluck('id').value();

                        // Create a content item to add to the folders
                        RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.ca', null, groupIds, function(err, link) {
                            assert.ok(!err);

                            FoldersTestUtil.assertAddContentItemToFoldersSucceeds(mrvisser.restContext, folderIds, link.id, function() {

                                // Ensure we can get the members of the content item
                                RestAPI.Content.getMembers(mrvisser.restContext, link.id, null, null, function(err, result) {
                                    assert.ok(!err);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

    });
});
