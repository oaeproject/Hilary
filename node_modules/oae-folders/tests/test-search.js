/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var util = require('util');

var ConfigTestUtil = require('oae-config/lib/test/util');
var RestAPI = require('oae-rest');
var SearchTestsUtil = require('oae-search/lib/test/util');
var TestsUtil = require('oae-tests');

var FoldersLibrary = require('oae-folders/lib/library');
var FoldersTestUtil = require('oae-folders/lib/test/util');

describe('Folders', function() {

    var camAdminRestContext = null;

    /*!
     * Before each test, set up all the REST contexts for admin and anonymous users with which we
     * will invoke requests
     */
    beforeEach(function(callback) {
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        return callback();
    });

    describe('Folder search', function() {

        /**
         * Set up some tenants, users and content. The created content
         * will be placed in a new folder with the given visibility.
         *
         * @param  {String}             visibility                  The visibility of the created folder
         * @param  {Function}           callback                    Standard callback function
         * @param  {Folder}             callback.folder             The created folder
         * @param  {Tenant}             callback.publicTenant       Tenant object as returned by `foldersTestUtil.setupMultiTenantPrivacyEntities`
         * @param  {Tenant}             callback.publicTenant1      Tenant object as returned by `foldersTestUtil.setupMultiTenantPrivacyEntities`
         * @param  {Tenant}             callback.privateTenant      Tenant object as returned by `foldersTestUtil.setupMultiTenantPrivacyEntities`
         * @param  {Tenant}             callback.privateTenant1     Tenant object as returned by `foldersTestUtil.setupMultiTenantPrivacyEntities`
         * @param  {Content}            callback.publicContent      A public content item
         * @param  {Content}            callback.loggedinContent    A loggedin content item
         * @param  {Content}            callback.privateContent     A private content item
         * @param  {Object}             callback.user               A user as returned by `TestsUtil.generateTestUsers` who will create the folder
         * @throws {AssertionError}                                 Throws an error if anything unexpected happens when setting up the entities
         */
        var _setup = function(visibility, callback) {
            FoldersTestUtil.setupMultiTenantPrivacyEntities(function(publicTenant, publicTenant1, privateTenant, privateTenant1) {

                // Create a test user who will generate a test folder
                TestsUtil.generateTestUsers(publicTenant.adminRestContext, 1, function(err, users, simong) {
                    assert.ok(!err);
                    FoldersTestUtil.generateTestFoldersWithVisibility(simong.restContext, 1, visibility, function(folder) {

                        // Create 3 content items
                        RestAPI.Content.createLink(simong.restContext, 'public', 'public', 'public', 'http://www.google.com', null, [], function(err, publicContent) {
                            assert.ok(!err);
                            RestAPI.Content.createLink(simong.restContext, 'loggedin', 'loggedin', 'loggedin', 'http://www.google.com', null, [], function(err, loggedinContent) {
                                assert.ok(!err);
                                RestAPI.Content.createLink(simong.restContext, 'private', 'private', 'private', 'http://www.google.com', null, [], function(err, privateContent) {
                                    assert.ok(!err);

                                    // Add them to the folder
                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder.id, [publicContent.id, loggedinContent.id, privateContent.id], function() {

                                        return callback(simong, folder, publicContent, loggedinContent, privateContent, publicTenant, publicTenant1, privateTenant, privateTenant1);
                                    });
                                });
                            });
                        });
                    });
                });
            });
        };

        /**
         * Test that verifies that folders can searched through
         */
        it('verify folders are searchable', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, users, simong) {
                assert.ok(!err);

                // Generate 2 test folders
                FoldersTestUtil.generateTestFolders(simong.restContext, 2, function(folder1, folder2) {

                    // Both folders should be empty
                    FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder1.id, null, [], function() {
                        FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder2.id, null, [], function() {

                            // Create some content items and add them to the first folder
                            RestAPI.Content.createLink(camAdminRestContext, 'test', 'test', 'public', 'http://www.google.com', null, [], function(err, google) {
                                assert.ok(!err);
                                RestAPI.Content.createLink(camAdminRestContext, 'marsupilamisausage', 'marsupilamisausage', 'public', 'http://www.marsupilamisausage.com', null, [], function(err, mars) {
                                    assert.ok(!err);
                                    FoldersTestUtil.assertAddContentItemsToFolderSucceeds(simong.restContext, folder1.id, [google.id, mars.id], function() {

                                        // Searching through the first folder should give the
                                        // 2 links. The other folder should still be empty
                                        FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder1.id, null, [google, mars], function() {
                                            FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder2.id, null, [], function() {

                                                // Assert that folders can be searched through
                                                FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder1.id, 'marsupilamisausage', [mars], function() {
                                                    return callback();
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        it('verify all users see content in the public folder', function(callback) {
            _setup('public', function(simong, folder, publicContent, loggedinContent, privateContent, publicTenant, publicTenant1, privateTenant, privateTenant1) {

                // Anonymous users only see the public content
                FoldersTestUtil.assertFolderSearchEquals(publicTenant.anonymousRestContext, folder.id, null, [publicContent], function() {

                    // A user from another tenant only sees the public content
                    FoldersTestUtil.assertFolderSearchEquals(publicTenant1.publicUser.restContext, folder.id, null, [publicContent], function() {

                        // A user from the same tenant sees both public and loggedin content
                        FoldersTestUtil.assertFolderSearchEquals(publicTenant.publicUser.restContext, folder.id, null, [publicContent, loggedinContent], function() {

                            // A tenant admin sees everything
                            FoldersTestUtil.assertFolderSearchEquals(publicTenant.adminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                // A manager sees everything
                                FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies anonymous and cross-tenant user cannot see loggedin folder items
         */
        it('verify anonymous and cross-tenant user cannot see loggedin folder items', function(callback) {
            _setup('loggedin', function(simong, folder, publicContent, loggedinContent, privateContent, publicTenant, publicTenant1, privateTenant, privateTenant1) {

                // Anonymous users cannot search this folder
                FoldersTestUtil.assertFolderSearchFails(publicTenant.anonymousRestContext, folder.id, 401, function() {

                    // A user from another tenant cannot search this folder
                    FoldersTestUtil.assertFolderSearchFails(publicTenant1.publicUser.restContext, folder.id, 401, function() {

                        // A user from the same tenant sees both public and loggedin content
                        FoldersTestUtil.assertFolderSearchEquals(publicTenant.publicUser.restContext, folder.id, null, [publicContent, loggedinContent], function() {

                            // A tenant admin sees everything
                            FoldersTestUtil.assertFolderSearchEquals(publicTenant.adminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                // A manager sees everything
                                FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies anonymous and cross-tenant user cannot see loggedin folder items
         */
        it('verify only self and admin can see private user library items', function(callback) {
            _setup('private', function(simong, folder, publicContent, loggedinContent, privateContent, publicTenant, publicTenant1, privateTenant, privateTenant1) {

                // Anonymous users cannot search this folder
                FoldersTestUtil.assertFolderSearchFails(publicTenant.anonymousRestContext, folder.id, 401, function() {

                    // A user from another tenant cannot search this folder
                    FoldersTestUtil.assertFolderSearchFails(publicTenant1.publicUser.restContext, folder.id, 401, function() {

                        // A user from the same tenant cannot search this folder
                        FoldersTestUtil.assertFolderSearchFails(publicTenant.publicUser.restContext, folder.id, 401, function() {

                            // A tenant admin sees everything
                            FoldersTestUtil.assertFolderSearchEquals(publicTenant.adminRestContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                // A manager sees everything
                                FoldersTestUtil.assertFolderSearchEquals(simong.restContext, folder.id, null, [publicContent, loggedinContent, privateContent], function() {

                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
