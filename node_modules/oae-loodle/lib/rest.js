
// Get a named logger so we can post messages in the log
var log = require('oae-logger').logger('oae-loodle-rest');

// Import the core OAE utility that contains the Express servers on which we can bind routes
var OAE = require('oae-util/lib/oae');

// Import the API component to get the task create and listing functionality
var LoodleAPI = require('./api');

var async = require('async');

OAE.tenantRouter.on('post', '/api/loodle/:id/schedule', function (req, res) {
    LoodleAPI.addSchedule(req.ctx, req.params.id, req.body, function (err) {
        res.end(err);
    });
});

OAE.tenantRouter.on('put', '/api/loodle/:loodleId/votes', function (req, res) {
	LoodleAPI.updateVotes(req.ctx, req.body, req.params.loodleId, function (err) {
		res.end(err);
	});
});

OAE.tenantRouter.on('delete', '/api/loodle/:loodleId/schedule/:scheduleId', function (req, res) {
	LoodleAPI.deleteSchedule(req.ctx, req.params.loodleId, req.params.scheduleId, function (err) {
		res.end(err);
	});
});

OAE.tenantRouter.on('post', '/api/loodle/:contentId/notifications', function (req, res) {
	if (req.body.notificationType === 'schedule') {
		LoodleAPI.emitUpdateScheduleNotification(req.ctx, req.params.contentId, function (err) {
			res.end(err);
		});
	}
	else if (req.body.notificationType === 'vote') {
		LoodleAPI.emitUpdateVoteNotification(req.ctx, req.params.contentId, function (err) {
			res.end(err);
		});
	}
	else {
		res.end();
	}
});

OAE.tenantRouter.on('get', '/api/loodle/:loodleId', function (req, res) {
	LoodleAPI.getData(req.ctx, req.params.loodleId, function (err, data) {
		if (err) return res.end(err);
        return res.json(data);
	});
});

OAE.tenantRouter.on('post', '/api/loodle/:id/user', function (req, res) {
    LoodleAPI.addMemberWithVotes(req.ctx, req.params.id, req.body.firstName, req.body.lastName, req.body.votes, function (err, data) {
        if (err) return res.end(err);
        res.json(data);
    });
});
