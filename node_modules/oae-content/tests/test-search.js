/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
var _ = require('underscore');
var assert = require('assert');

var ElasticSearch = require('oae-search/lib/internal/elasticsearch');
var MQ = require('oae-util/lib/mq');
var RestAPI = require('oae-rest');
var SearchConstants = require('oae-search/lib/constants').SearchConstants;
var SearchTestsUtil = require('oae-search/lib/test/util');
var TestsUtil = require('oae-tests');

describe('Search', function() {

    // REST contexts we can use to do REST requests
    var anonymousRestContext = null;
    var camAdminRestContext = null;
    var gtAdminRestContext = null;

    before(function(callback) {
        anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        gtAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        callback();
    });

    /*!
     * Get the document with the specified id from the search results.
     *
     * @param   {SearchResult}  results     The search results object
     * @param   {String}        docId       The id of the document to search
     * @returns {Object}                    The search document. `null` if it didn't exist
     */
    var _getDocById = function(results, docId) {
        for (var i = 0; i < results.results.length; i++) {
            var doc = results.results[i];
            if (doc.id === docId) {
                return doc;
            }
        }
        return null;
    };

    describe('Indexing', function() {

        /**
         * Test that verifies when a content item is indexed with just the content id, it still indexes the content
         * item.
         */
        it('verify indexing without full content item', function(callback) {
            // Create a content item to verify re-indexing
            var doerUsername = TestsUtil.generateTestUserId('doer');
            RestAPI.User.createUser(camAdminRestContext, doerUsername, 'password', 'Doer', null, function(err, doer) {
                var doerRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host, doerUsername, 'password');

                RestAPI.Content.createLink(doerRestContext, 'Test Content 1', 'Test content description 1', 'public', 'http://www.sakaiproject.org/',  [], [], function(err, link) {
                    assert.ok(!err);
                    
                    // Verify the content item exists
                    SearchTestsUtil.searchAll(doerRestContext, 'general', ['content'], {'q': 'Test'}, function(err, results) {
                        assert.ok(!err);
                        var contentDoc = _getDocById(results, link.contentId);
                        assert.ok(contentDoc);

                        // Delete the content item from the index under the hood, this is to avoid the automatic index events invalidating the test
                        ElasticSearch.del('resource', link.contentId, function(err) {
                            assert.ok(!err);

                            // Verify the content item no longer exists
                            SearchTestsUtil.searchAll(doerRestContext, 'general', ['content'], {'q': 'Test'}, function(err, results) {
                                assert.ok(!err);
                                var contentDoc = _getDocById(results, link.contentId);
                                assert.ok(!contentDoc);

                                // This is the indexing job data that only provides the id, and not the full content item
                                var indexJob = {
                                    'resourceType': 'content',
                                    'resources': [{
                                        'id': link.contentId,
                                        'opts': {
                                            'indexResource': true,
                                            'indexMembers': false
                                        }
                                    }]
                                };

                                console.log('Submitting: ' + link.contentId);
                                // Fire off an indexing task using just the content id
                                MQ.submit(SearchConstants.mq.TASK_INDEX_DOCUMENT, indexJob, function() {

                                    // Ensure that the full content item is now back in the search index
                                    SearchTestsUtil.searchAll(doerRestContext, 'general', ['content'], {'q': 'Test'}, function(err, results) {
                                        assert.ok(!err);
                                        var contentDoc = _getDocById(results, link.contentId);
                                        assert.ok(contentDoc);
                                        callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
});
