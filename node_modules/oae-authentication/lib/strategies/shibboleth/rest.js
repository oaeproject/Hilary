/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var passport = require('passport');

var ConfigAPI = require('oae-config');
var OAE = require('oae-util/lib/oae');
var OaeServer = require('oae-util/lib/server');

var AuthenticationConfig = ConfigAPI.config('oae-authentication');
var AuthenticationConstants = require('oae-authentication/lib/constants').AuthenticationConstants;
var AuthenticationUtil = require('oae-authentication/lib/util');


// Ensure that the Shibboleth callback URL bypass CSRF validation. It has its own authenticity handling.
OaeServer.addSafePathPrefix('/api/auth/shibboleth/callback');

/**
 * @REST postAuthShibboleth
 *
 * Log in using Shibboleth authentication
 *
 * @Server      tenant
 * @Method      POST
 * @Path        /auth/shibboleth
 * @Return      {void}
 */
OAE.tenantRouter.on('post', '/api/auth/shibboleth', function(req, res, next) {
    // Get the ID under which we registered this strategy for this tenant
    var strategyId = AuthenticationUtil.getStrategyId(req.tenant, AuthenticationConstants.providers.SHIBBOLETH);

    // Perform the initial authentication step
    AuthenticationUtil.handleExternalSetup(strategyId, null, req, res, next);
});

/**
 * @REST getAuthShibbolethCallback
 *
 * Callback URL after the user has logged in using Shibboleth authentication
 *
 * @Api         private
 * @Server      tenant
 * @Method      POST
 * @Path        /auth/shibboleth/callback
 * @Return      {void}
 */
OAE.tenantRouter.on('post', '/api/auth/shibboleth/callback', function(req, res, next) {
    // Get the ID under which we registered this strategy for this tenant
    var strategyId = AuthenticationUtil.getStrategyId(req.tenant, AuthenticationConstants.providers.SHIBBOLETH);

    // Log the user in
    AuthenticationUtil.handleExternalCallback(strategyId, req, res, next);
});

/**
 * @REST getAuthShibbolethMetadata
 *
 * Get the Shibboleth Service Provider metadata
 *
 * @Api         private
 * @Server      tenant
 * @Method      GET
 * @Path        /auth/shibboleth/metadata
 * @Return      {document}                  The Service Provider XMLmetadata
 * @HttpResponse                    200     Metadata available
 * @HttpResponse                    400     Shibboleth is not enabled on this tenant.
 */
OAE.tenantRouter.on('get', '/api/auth/shibboleth/metadata', function(req, res) {
    _getShibbolethSPMetadata(req.ctx, function(err, metadata) {
        if (err) {
            return res.send(err.code, err.msg);
        }
        res.send(200, metadata);
    });
});

/**
 * Get the Shibboleth metadata in XML format. This can be used to register this app
 * as a Service Provider with an Identity Provider
 *
 * @param  {Context}    ctx                 Standard context object containing the current user and the current tenant
 * @param  {Function}   callback            Standard callback function
 * @param  {Object}     callback.err        An error that occurred, if any
 * @param  {String}     callback.metadata   The Service Provider XMLmetadata
 * @api private
 */
var _getShibbolethSPMetadata = function(ctx, callback) {
    // Check if this tenant even has Shibboleth enabled.
    var isEnabled = AuthenticationConfig.getValue(ctx.tenant().alias, AuthenticationConstants.providers.SHIBBOLETH, 'enabled');
    if (!isEnabled) {
        return callback({'code': 400, 'msg': 'Shibboleth is not enabled on this tenant.'});
    }

    // Get the SamlStrategy.
    var strategyId = AuthenticationUtil.getStrategyId(ctx.tenant(), AuthenticationConstants.providers.SHIBBOLETH);
    var samlStrategy = passport._strategy(strategyId);
    var metadata = samlStrategy.getShibbolethMetadata();
    callback(null, metadata);
};
