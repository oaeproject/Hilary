/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');
var util = require('util');

var LoggerAPI = require('oae-logger');
var RestAPI = require('oae-rest');
var TelemetryAPI = require('oae-telemetry');
var TestsUtil = require('oae-tests/lib/util');

describe('Logger', function() {

    // Rest context that can be used every time we need to make a request as a global admin
    var globalAdminRestContext = null;

    /**
     * Function that will fill up the global admin rest context and enable the API
     */
    before(function(callback) {
        // Fill up the global admin rest context
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();

        // Enable the telemetry API
        TelemetryAPI.init({'enabled': true}, function(err) {
            assert.ok(!err);
            return callback();
        });
    });

    /**
     * Function that will disable the telemetry API
     */
    after(function(callback) {
        TelemetryAPI.init({'enabled': false}, function(err) {
            assert.ok(!err);
            return callback();
        });
    });

    /**
     * Test that verifies that error counts are counted through the telemetry API
     */
    it('verify that error logs are counted through the telemetry API', function(callback) {
        // Construct a logger specificly for this test
        var loggerName = TestsUtil.generateRandomText();
        var log = LoggerAPI.logger(loggerName);

        // Get the initial count
        RestAPI.Telemetry.getTelemetryData(globalAdminRestContext, function(err, initialTelemetryData) {
            assert.ok(!err);

            // Generate some error logs by using a variation of parameter values
            log().error('Simple error log');
            log().error({'err': new Error('error object')});
            log().error({'err': new Error('error object')}, 'With a message');
            log().error({'err': {'foo': 'bar'}});
            log().error({'foo': 'bar'});
            log().error({'foo': 'bar'}, 'With a message');

            // Get the new telemetry daya
            RestAPI.Telemetry.getTelemetryData(globalAdminRestContext, function(err, newTelemetryData) {
                assert.ok(!err);

                // Get the initial total error count
                var initialTotalCount = 0;
                if (initialTelemetryData['logger'] && initialTelemetryData['logger']['error.count']) {
                    initialTotalCount = initialTelemetryData['logger']['error.count'];
                }

                // The total error count should've increased with 6
                assert.strictEqual(newTelemetryData['logger']['error.count'], initialTotalCount + 6);

                // The error count for this specific logger should be 6
                var telemetryName = util.format('error.%s.count', loggerName);
                assert.strictEqual(newTelemetryData['logger'][telemetryName], 6);
                return callback();
            });
        });
    });
});
