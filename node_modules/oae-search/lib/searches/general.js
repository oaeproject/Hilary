/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
var _ = require('underscore');
var AuthzAPI = require('oae-authz');
var TenantsUtil = require('oae-tenants/lib/util');

var SearchConstants = require('oae-search/lib/constants').SearchConstants;
var SearchUtil = require('oae-search/lib/util');

var RESOURCE_TYPES_ACCESS_SCOPED = [ SearchConstants.general.RESOURCE_TYPE_ALL,
        SearchConstants.general.RESOURCE_TYPE_CONTENT, SearchConstants.general.RESOURCE_TYPE_GROUP ];

/**
 * General search that searches a 'general' analyzed field on content, scoping it by user access.
 *
 * @param   {Context}       ctx                 The context of the current request
 * @param   {Object}        opts                General search options
 * @param   {String}        opts.resourceType   The resource type to search
 * @param   {Function}      callback            Invoked when the process completes
 * @param   {Object}        callback.err        An error that occurred, if any
 * @param   {SearchResult}  callback.results    An object that represents the results of the query
 */
module.exports = function(ctx, opts, callback) {
    // Sanitize the search options
    opts = opts || {};
    opts = {
        'resourceType': SearchUtil.getResourceTypeParam(opts.params[0]),
        'includeExternal': (opts.includeExternal === 'true'),
        'q': SearchUtil.getQueryParam(opts.q),
        'limit': isNaN(opts.limit) ? 10 : opts.limit,
        'start': isNaN(opts.start) ? 0 : opts.start,
        'sort': SearchUtil.getSortParam(opts.sort)
    };

    if (_needsFilterByAccess(ctx, opts)) {
        // We'll need to know the group membership of this user to scope by content they have access to
        AuthzAPI.getPrincipalMemberships(ctx.user().id, null, 10000, function(err, groups) {
            if (err) {
                return callback(err);
            }

            // Bind the access array to the search options
            var access = groups || [];
            access.push(ctx.user().id);
            opts.access = access;

            _search(ctx, opts, callback);
        });
    } else {
        _search(ctx, opts, callback);
    }
};

/**
 * Perform the search that searches a 'general' analyzed field on content, scoping it by user access. This is delegated from the
 * `module.exports` function for convenience, as it will access the members array only if necessary.
 *
 * @param   {Context}       ctx                 The context of the current request
 * @param   {Object}        opts                General search options
 * @param   {Function}      callback            Invoked when the process completes
 * @param   {Object}        callback.err        An error that occurred, if any
 * @param   {SearchResult}  callback.results    An object that represents the results of the query
 */
var _search = function(ctx, opts, callback) {
    var data = {};

    // The query object for the Query DSL
    var query = SearchUtil.createQueryStringQuery(opts.q);

    // The filter object for the Query DSL
    var filter = null;
    var typeFilter = SearchUtil.filterTerm('_type', SearchConstants.resourceMappingName);

    // The resource type filter will filter by a particular document type (e.g., content, user, group)
    var resourceTypeFilter = (opts.resourceType !== SearchConstants.general.RESOURCE_TYPE_ALL) ? SearchUtil.filterTerm('resourceType', opts.resourceType) : null;

    // The access filter will filter by the user's group membership, or the whole tenant if it is tenant admin
    var accessFilter = (ctx.user() && ctx.user().isTenantAdmin(ctx.tenant().alias)) ?
            SearchUtil.filterTerm('tenantAlias', ctx.tenant().alias) : SearchUtil.filterMembers(opts.access);

    // This base filter gets applied to the query unconditionally.
    var baseFilter = SearchUtil.filterAnd(typeFilter, resourceTypeFilter);

    if (ctx.user() && ctx.user().isGlobalAdmin()) {
        // Tf user is global admin, forget filtering by members and visibility, just query *everything*
        filter = baseFilter;
    } else if (ctx.user()) {
        var interactingTenantAliases = TenantsUtil.getAllTenantsForInteraction(ctx.tenant().alias);
        // The user is authenticated
        filter = SearchUtil.filterAnd(
            baseFilter,
            SearchUtil.filterOr(

                // I can always see content that I have explicit access to, even if it belongs to another tenant and I haven't specified `includeExternal`
                accessFilter,

                SearchUtil.filterAnd(

                    // I will only get resources from my own tenant if I have not specified to include external
                    (!opts.includeExternal) ? SearchUtil.filterTerm('tenantAlias', ctx.tenant().alias) : null,

                    // This or statement applies visibility restrictions
                    SearchUtil.filterOr(

                        // I can see all public resources
                        SearchUtil.filterTerm('visibility', 'public'),

                        // I can see all joinable resources from my own tenant
                        // I can see joinable resources from other tenants that I can interact with (if any) if I have specified to view external resources
                        SearchUtil.filterAnd(
                            SearchUtil.filterOr(
                                SearchUtil.filterTerm('tenantAlias', ctx.tenant().alias),
                                (opts.includeExternal && interactingTenantAliases.length > 0) ? SearchUtil.filterTerms('tenantAlias', interactingTenantAliases) : null
                            ),
                            SearchUtil.filterTerms('joinable', ['yes', 'request'])
                        ),

                        // I can only see loggedin resources from my own tenant
                        SearchUtil.filterAnd(
                            SearchUtil.filterTerm('tenantAlias', ctx.tenant().alias),
                            SearchUtil.filterTerm('visibility', 'loggedin')
                        )   
                    )
                )
            )
        );
    } else {
        // for anonymous users, only show public resources
        filter = SearchUtil.filterAnd(
            baseFilter,

            // limit to the current tenant unless specified otherwise
            (!opts.includeExternal) ? SearchUtil.filterTerm('tenantAlias', ctx.tenant().alias) : null,

            // resources must be public
            SearchUtil.filterTerm('visibility', 'public')
        );
    }

    // wrap the query and filter into the top-level Query DSL "query" object
    return callback(null, SearchUtil.createQuery(query, filter, opts));
};

/**
 * Determines whether or not the search needs to be scoped by the user's access privileges. This is true when:
 * 
 *  * The user is authenticated; and
 *  * The user is not a global administrator; and
 *  * The search includes content and groups (users are not filtered by access); and
 *  * The search is actually specifying a query (e.g., if the search is '*', then we only include content that is public / loggedin)
 *
 * @param   {Context}   ctx         The context of the current request performing the search
 * @param   {Object}    opts        The (sanitized) search options
 * @return  {Boolean}               Whether or not the query specified by this user and options requires filtering by access privileges
 * @api private
 */
var _needsFilterByAccess = function(ctx, opts) {
    return ctx.user() && !ctx.user().isGlobalAdmin() && _.contains(RESOURCE_TYPES_ACCESS_SCOPED, opts.resourceType) &&
            opts.q !== SearchConstants.query.ALL;
};
