/*
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');
var request = require('request');

var ConfigTestUtil = require('oae-config/lib/test/util');
var Context = require('oae-context').Context;
var PrincipalsAPI = require('oae-principals');
var RestAPI = require('oae-rest');
var RestUtil = require('oae-rest/lib/util');
var RestContext = require('oae-rest/lib/model').RestContext;
var TestsUtil = require('oae-tests');

var AuthenticationAPI = require('oae-authentication');
var AuthenticationConstants = require('oae-authentication/lib/constants').AuthenticationConstants;
var LoginId = require('oae-authentication/lib/model').LoginId;

describe('Authentication', function() {

    // Rest context that can be used for anonymous requests on the tenant
    var anonymousTenantRestContext = null;
    // Rest context that can be used for anonymous requests on the global tenant
    var anonymousGlobalRestContext = null;
    // Rest context that can be used every time we need to make a request as a global admin
    var globalAdminRestContext = null;

    /**
     * Function that will fill up the tenant admin and anymous rest context
     */
    before(function() {
        // Fill up the anonymous tenant rest context
        anonymousTenantRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.localhost.host);
        // Fill up the anonymous global rest context
        anonymousGlobalRestContext = TestsUtil.createGlobalRestContext();
        // Fill up global admin rest context
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();
    });

    /**
     * We've changed the expires configuration value, revert it back so we don't accidentally fail any other tests.
     */
    after(function(callback) {
        ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, 'localhost', {'oae-authentication/signed/expires': 120000}, function(err) {
            assert.ok(!err);
            callback();
        });
    });


    describe('Signed authentication', function() {

        describe('Get token', function() {

            /**
             * Verifies that you need to be logged in to generate a token.
             */
            it('verify anonymous users cannot generate a url', function(callback) {
                RestAPI.Admin.loginOnTenant(anonymousGlobalRestContext, 'localhost', function(err, restCtx) {
                    assert.ok(err);
                    assert.equal(err.code, 401);
                    assert.ok(!restCtx);
                    callback();
                });
            });

            /**
             * Verifies that no tokens are returned when a parameter is missing or invalid.
             */
            it('verify parameter validation', function(callback) {
                RestAPI.Admin.getSignedToken(globalAdminRestContext, null, function(err, token) {
                    assert.ok(err);
                    assert.equal(err.code, 400);
                    assert.ok(!token);
                    RestAPI.Admin.getSignedToken(globalAdminRestContext, 'some non existing tenant alias', function(err, token) {
                        assert.ok(err);
                        assert.equal(err.code, 404);
                        assert.ok(!token);
                        callback();
                    });
                });
            });
        });

        describe('Login', function() {

            /**
             * Verifies that you can actually log in to a tenant.
             */
            it('verify login on tenant works', function(callback) {
                RestAPI.Admin.loginOnTenant(globalAdminRestContext, 'localhost', function(err, restCtx) {
                    assert.ok(!err);
                    RestAPI.User.getMe(restCtx, function(err, user) {
                        assert.ok(!err);
                        assert.ok(!user.anon);
                        assert.ok(user.isGlobalAdmin, 'The user should still be a global administrator');
                        callback();
                    });
                });
            });


            /**
             * Tries to login to the signed authentication endpoint by using the provided parameters.
             * The response code will be checked.
             *
             * @param  {Number}   expires      When the signature expires.
             * @param  {String}   signature    The signature
             * @param  {String}   userId       The user to log on as.
             * @param  {Boolean}  isLoggedIn   Whether or not the user should be logged in.
             * @param  {Function} callback     Standard callback method
             * @api private
             */
            var performSignedTokenRequest = function(expires, signature, userId, isLoggedIn, callback) {
                var token = {
                    'expires': expires,
                    'signature': signature,
                    'userId': userId
                };

                var restCtx = new RestContext('http://' + global.oaeTests.tenants.localhost.host, {'hostHeader': global.oaeTests.tenants.localhost.host});
                RestAPI.Admin.loginWithSignedToken(restCtx, token, function(err) {
                    assert.ok(!err);

                    RestAPI.User.getMe(restCtx, function(err, user) {
                        assert.ok(!err);
                        if (isLoggedIn) {
                            assert.ok(!user.anon);
                        } else {
                            assert.ok(user.anon);
                        }
                        callback();
                    });
                });
            };

            /**
             * Verifies that the login request fails if one the parameters is missing.
             */
            it('verify parameter validation', function(callback) {
                RestAPI.Admin.getSignedToken(globalAdminRestContext, 'localhost', function(err, token) {
                    assert.ok(!err);

                    // Ensure that authentication with this token works.
                    performSignedTokenRequest(token.expires, token.signature, token.userId, true, function() {

                        // Permutations of missing parameters
                        performSignedTokenRequest(null, token.signature, token.userId, false, function() {
                            performSignedTokenRequest(token.expires, null, token.userId, false, function() {
                                performSignedTokenRequest(token.expires, token.signature, null, false, function() {

                                    // All parameters are present, but some are invalid.
                                    performSignedTokenRequest('Not a number', token.signature, token.userId, false, function() {
                                        performSignedTokenRequest(token.expires, 'Bad signature', token.userId, false, function() {
                                            performSignedTokenRequest(token.expires, token.signature, 'Bad userId', false, callback);
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });

            /**
             * Sets the window of a valid token to something very short and tries to login with an expired token.
             */
            it('verify expiring signature', function(callback) {
                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, 'localhost', {'oae-authentication/signed/expires': 2}, function() {
                    RestAPI.Admin.getSignedToken(globalAdminRestContext, 'localhost', function(err, token) {
                        assert.ok(!err);
                        // Let the token expire by waiting for 10 msecs
                        setTimeout(function() {
                            performSignedTokenRequest(token.expires, token.signature, token.userId, false, function() {
                                // Set the original value back
                                ConfigTestUtil.updateConfigAndWait(globalAdminRestContext, 'localhost', {'oae-authentication/signed/expires': 120000}, callback);
                            });
                        }, 10);
                    });
                });
            });

            /**
             * Test that verifies that the user is redirected to `redirectUrl` or `/me` if nothing has been specified
             */
            it('verify redirection', function(callback) {
                RestAPI.Admin.getSignedToken(globalAdminRestContext, 'localhost', function(err, token) {
                    assert.ok(!err);

                    // Performing a request without the redirectUrl should redirect to /me
                    request({
                        'url': 'http://' + global.oaeTests.tenants.localhost.host + '/api/auth/signed',
                        'form': token,
                        'headers': {
                            'host': global.oaeTests.tenants.localhost.host
                        },
                        'method': 'POST',
                        'jar': request.jar()
                    }, function(err, response, body) {
                        assert.ok(!err);
                        assert.equal(response.statusCode, 302);
                        assert.equal(response.headers.location, '/me');

                        // Performing a request with a redirectUrl parameter should redirect to the value of that parameter
                        var form = token;
                        form.redirectUrl = '/foo';
                        request({
                            'url': 'http://' + global.oaeTests.tenants.localhost.host + '/api/auth/signed',
                            'form': form,
                            'headers': {
                                'host': global.oaeTests.tenants.localhost.host
                            },
                            'method': 'POST',
                            'jar': request.jar()
                        }, function(err, response, body) {
                            assert.ok(!err);
                            assert.equal(response.statusCode, 302);
                            assert.equal(response.headers.location, '/foo');

                             // Performing a request with a redirectUrl parameter pointing out of OAE should redirect to /me
                            var form = token;
                            form.redirectUrl = 'http://www.attacker.com';
                            request({
                                'url': 'http://' + global.oaeTests.tenants.localhost.host + '/api/auth/signed',
                                'form': form,
                                'headers': {
                                    'host': global.oaeTests.tenants.localhost.host
                                },
                                'method': 'POST',
                                'jar': request.jar()
                            }, function(err, response, body) {
                                assert.ok(!err);
                                assert.equal(response.statusCode, 302);
                                assert.equal(response.headers.location, '/me');
                                callback();
                            });
                        });
                    });
                });
            });
        });
    });
});
