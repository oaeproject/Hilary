/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var OaeUtil = require('oae-util/lib/util');

var DEFAULT_ACTIVITY_TTL = 2 * 7 * 24 * 60 * 60;    // 2 weeks (in seconds)
var DEFAULT_AGGREGATE_IDLE_EXPIRY = 3 * 60 * 60;    // 3 hours (in seconds)
var DEFAULT_AGGREGATE_MAX_EXPIRY = 24 * 60 * 60;    // 1 day (in seconds)
var DEFAULT_NUMBER_OF_PROCESSING_BUCKETS = 3;
var DEFAULT_COLLECTION_EXPIRY = 60;                 // 1 minute (in seconds)
var DEFAULT_MAX_CONCURRENT_COLLECTIONS = 3;
var DEFAULT_MAX_CONCURRENT_ROUTERS = 5;
var DEFAULT_COLLECTION_POLLING_FREQUENCY = 5;       // 5 seconds
var DEFAULT_COLLECTION_BATCH_SIZE = 1000;

var config = {};

/**
 * Refresh the activities configuration. For list of available properties @see ActivityAPI#refreshConfiguration.
 *
 * @param  {Object}    [config]    The configuration options with which to refresh. See the `config.activity` object in the base `./config.js` for more information
 */
var refreshConfiguration = module.exports.refreshConfiguration = function(_config) {
    _config = _config || {};
    config = {
        'processActivityJobs': (_config.processActivityJobs !== false),
        'activityTtl': OaeUtil.getNumberParam(_config.activityTtl, DEFAULT_ACTIVITY_TTL),
        'numberOfProcessingBuckets': OaeUtil.getNumberParam(_config.numberOfProcessingBuckets, DEFAULT_NUMBER_OF_PROCESSING_BUCKETS),
        'aggregateIdleExpiry': OaeUtil.getNumberParam(_config.aggregateIdleExpiry, DEFAULT_AGGREGATE_IDLE_EXPIRY),
        'aggregateMaxExpiry': OaeUtil.getNumberParam(_config.aggregateMaxExpiry, DEFAULT_AGGREGATE_MAX_EXPIRY),
        'collectionExpiry': OaeUtil.getNumberParam(_config.collectionExpiry, DEFAULT_COLLECTION_EXPIRY),
        'maxConcurrentCollections': OaeUtil.getNumberParam(_config.maxConcurrentCollections, DEFAULT_MAX_CONCURRENT_COLLECTIONS),
        'maxConcurrentRouters': OaeUtil.getNumberParam(_config.maxConcurrentRouters, DEFAULT_MAX_CONCURRENT_ROUTERS),
        'collectionPollingFrequency': OaeUtil.getNumberParam(_config.collectionPollingFrequency, DEFAULT_COLLECTION_POLLING_FREQUENCY),
        'collectionBatchSize': OaeUtil.getNumberParam(_config.collectionBatchSize, DEFAULT_COLLECTION_BATCH_SIZE),
        'redis': (_config.redis) ? _.extend({}, _config.redis) : null
    };

    return getConfig();
};

/**
 * @return {Object} the activities configuration.
 */
var getConfig = module.exports.getConfig = function() {
    return config;
};

