/*
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var assert = require('assert');
var request = require('request');

var Context = require('oae-context').Context;
var PrincipalsAPI = require('oae-principals');
var Tenant = require('oae-tenants/lib/model').Tenant;
var TestAPI = require('oae-tests');

var ConfigAPI = require('oae-config');

describe('Config Aggregator', function() {

    describe('Modules', function() {
        it('Test getting all available modules succeeds', function(callback) {
            request.get({
                'uri': 'http://localhost:2000/api/modules'
            }, function(err, response, body) {
                assert.equal(response.statusCode, 200);
                body = JSON.parse(body);
                assert.ok(body['oae-authentication']);
                assert.ok(body['oae-authentication'].id);
                assert.ok(body['oae-authentication'].config);
                assert.ok(body['oae-authentication'].config.options);
                callback();
            });
        });
    });

    describe('Admin UI', function() {

        it('Test accessing the global admin UI succeeds', function(callback) {
            request.get({
                'uri': 'http://localhost:2000/admin.html'
            }, function(err, response, body) {
                assert.equal(response.statusCode, 200);
                callback();
            });
        });

        it('Test accessing the tenant admin UI succeeds', function(callback) {
            request.get({
                'uri': 'http://localhost:2001/admin/tenant/camtest'
            }, function(err, response, body) {
                assert.equal(response.statusCode, 200);
                callback();
            });
        });

    });

    describe('Configuration', function() {

        it('Test configuration retrieval succeeds', function(callback) {
            request.get({
                'uri': 'http://localhost:2000/api/config'
            }, function(err, response, body) {
                assert.equal(response.statusCode, 200);
                body = JSON.parse(body);
                assert.ok(body['oae-authentication']);
                assert.ok(body['oae-authentication'].config);
                assert.ok(body['oae-authentication'].config.options);
                assert.equal(body['oae-authentication'].id, 'oae-authentication');1
                callback();
            });
        });

        it('Test persisting a global configuration value succeeds', function(callback) {
            request.post({
                'uri': 'http://localhost:2000/api/config',
                'json': {
                    'oae-authentication/twitter-authentication/twitter-authentication-enabled': false
                }
            }, function(err, response, body) {
                assert.equal(response.statusCode, 200);
                callback();
            });
        });

        it('Test global configuration value overrides config.json value', function(callback) {
            request.get({
                'uri': 'http://localhost:2000/api/config'
            }, function(err, response, modules) {
                var val = true;
                modules = JSON.parse(modules);
                for (module in modules) {
                    if (modules[module].id === 'oae-authentication') {
                        for (var opt in modules[module].config.options) {
                            if (opt === 'twitter-authentication') {
                                for (var el in modules[module].config.options[opt].elements) {
                                    if (el === 'twitter-authentication-enabled') {
                                        if (modules[module].config.options[opt].elements[el].value === false) {
                                            val = modules[module].config.options[opt].elements[el].value;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                assert.equal(val, false);
                callback();
            });
        });

        it('Test persisting a tenant configuration value succeeds', function(callback) {
            request.post({
                'uri': 'http://localhost:2000/api/config',
                'json': {
                    'oae-authentication/twitter-authentication/twitter-authentication-enabled': false
                }
            }, function(err, response, body) {
                assert.ok(!err);
                assert.equal(response.statusCode, 200);
                request.get({
                    'uri': 'http://localhost:2000/api/config'
                }, function(err, response, modules) {
                    assert.ok(!err);

                    var val = true;
                    modules = JSON.parse(modules);
                    for (module in modules) {
                        if (modules[module].id === 'oae-authentication') {
                            for (var opt in modules[module].config.options) {
                                if (opt === 'twitter-authentication') {
                                    for (var el in modules[module].config.options[opt].elements) {
                                        if (el === 'twitter-authentication-enabled') {
                                            if (modules[module].config.options[opt].elements[el].value === false) {
                                                val = modules[module].config.options[opt].elements[el].value;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    assert.equal(val, false);

                    request.post({
                        'uri': 'http://localhost:2001/api/config',
                        'json': {
                            "oae-authentication/twitter-authentication/twitter-authentication-enabled": true
                        }
                    }, function(err, response, body) {
                        assert.ok(!err);
                        assert.equal(response.statusCode, 200);
                        callback();
                    });
                });
            });
        });

        it('Test tenant configuration value overrides global value', function(callback) {
            request.get({
                'uri': 'http://localhost:2001/api/config'
            }, function(err, response, modules) {
                var val = false;
                modules = JSON.parse(modules);
                for (module in modules) {
                    if (modules[module].id === 'oae-authentication') {
                        for (var opt in modules[module].config.options) {
                            if (opt === 'twitter-authentication') {
                                for (var el in modules[module].config.options[opt].elements) {
                                    if (el === 'twitter-authentication-enabled') {
                                        if (modules[module].config.options[opt].elements[el].value === true) {
                                            val = modules[module].config.options[opt].elements[el].value;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                assert.equal(val, true);
                callback();
            });
        });

        it('Test saving tenant configuration value requires configuration', function(callback) {
            request.post({
                'uri': 'http://localhost:2001/api/config'
            }, function(err, response, body) {
                assert.ok(!err);
                assert.equal(400, response.statusCode);
                assert.ok(body.indexOf('Missing configuration') != -1, body);
                callback();
            });
        });

    });

    describe('Authentication', function() {
        it('Test a global administrator can log in and log out of the administration panel', function(callback) {
            var r = Math.floor(Math.random()*10000000);
            var username = 'user-' + r;

            var serverTenant = new Tenant('global', 'Global Administration', 2000, 'localhost:2000', true, false);
            var ctx = new Context(serverTenant, null);

            PrincipalsAPI.createUser(ctx, username, 'password', 'public', 'en_GB', 'Europe/London', 'John', 'Doe', 'John Doe', function(err, userId) {
                assert.ok(!err);

                // Log in.
                request.post({
                    'uri': 'http://localhost:2000/api/auth/login',
                    'method': 'POST',
                    'form': {'username': username, 'password': 'password'}
                }, function(err, response, body) {
                    assert.ok(!err);
                    assert.equal(200, response.statusCode, "Expected to be logged in.");

                    // the request module has a built-in cookie jar.
                    request.get('http://localhost:2000/api/me', function(err, response, body) {
                        assert.ok(!err);
                        assert.equal(200, response.statusCode);
                        var data = JSON.parse(body);
                        assert.equal(userId, data.userId);
                        assert.equal('John', data.profile.firstName);
                        assert.equal('Doe', data.profile.lastName);
                        assert.equal('John Doe', data.profile.displayName);

                        // logout.
                        request.post({
                            'uri': 'http://localhost:2000/api/auth/logout',
                            'followRedirect': false
                        }, function(err, response, body) {
                            assert.ok(!err);
                            assert.equal(200, response.statusCode, "Expected to be succesfully logged out.");

                            request.get('http://localhost:2000/api/me', function(err, response, body) {
                                assert.ok(!err);
                                assert.equal(200, response.statusCode);
                                var j = JSON.parse(body);
                                assert.equal(true, j.anon);
                                callback();
                            });
                        });
                    });
                });
            });
        });
        });

});
