language: node_js
node_js:
  - "0.10"

branches:
  only:
    - master

env:
  global:
    - secure: T23GAZQqZsNKK7OXEr0d3UwFoE/8hAgPOF5jgdTAJTHI6Jq+OjOv9jt+QvuKxpfqt3/yz+JzztRJAw12CD1BHej4L6NSXIalUfnn2EF93otFRSTRBQ2uzofBJ+MtUQqyCRG7Ha8sjEWoWc/QkdZbFGTaJpQpUuBt1oSabT0D3zA=
    - secure: T1wEYmk7AhKxIGtDbb12ERT18sNb/92vL1VBo42Q4JMd4ww/Z3E7su5T3IsVY3cjaE2X7oKNVBWx9TWvkJJnHk5UiN3SmKiIGcFNKOvp6ha9BW0JyVAk5lPRh5poq33GrCvkZT3YKX7AgI/+7TutrbYVE/o5Bs599rF+8l8dSkk=

before_install:
  # Add DataStax apt repo for Cassandra
  - curl -L http://debian.datastax.com/debian/repo_key | sudo apt-key add -
  - echo "deb http://debian.datastax.com/community stable main" | sudo tee -a /etc/apt/sources.list.d/dsc.sources.list

  # Add PPA repos for miscellaneous dependencies
  - echo 'yes' | sudo add-apt-repository ppa:oae/deps
  - echo 'yes' | sudo add-apt-repository ppa:coolwanglu/pdf2htmlex
  - sudo apt-get update

  # Position ourselves to start the test in "script" phase
  - cd ~/build/oaeproject/Hilary

  - etc/scripts/travis/setup-cassandra.sh &
  - etc/scripts/travis/turn-off-unneeded.sh &
  - etc/scripts/travis/install-hilary-deps.sh &
  - etc/scripts/travis/setup-etherpad.sh &
  - etc/scripts/travis/enable-preview-processing.sh &

services:
  - elasticsearch
  - rabbitmq
  - redis-server

script:
  - grunt test-coverage-coveralls

after_success:
  # Package and upload to Amazon S3
  - etc/scripts/travis/travis-upload.sh

after_failure:
  # Compress the logs and upload them to Amazon S3
  - gzip tests.log
  - bin/upload_logs

notifications:
  email:
    - oae-team@collab.sakaiproject.org
  irc: "irc.freenode.org#oae"
